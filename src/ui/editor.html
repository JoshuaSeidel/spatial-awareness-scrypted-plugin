<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Spatial Awareness - Topology Editor</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, sans-serif;
      background: #1a1a2e;
      color: #eee;
      min-height: 100vh;
    }

    .container {
      display: flex;
      height: 100vh;
    }

    /* Sidebar */
    .sidebar {
      width: 300px;
      background: #16213e;
      border-right: 1px solid #0f3460;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .sidebar-header {
      padding: 20px;
      border-bottom: 1px solid #0f3460;
    }

    .sidebar-header h1 {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 5px;
    }

    .sidebar-header p {
      font-size: 12px;
      color: #888;
    }

    .sidebar-content {
      flex: 1;
      overflow-y: auto;
      padding: 15px;
    }

    .section {
      margin-bottom: 20px;
    }

    .section-title {
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      color: #888;
      margin-bottom: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .btn {
      background: #0f3460;
      color: #fff;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 13px;
      transition: background 0.2s;
    }

    .btn:hover {
      background: #1a4a7a;
    }

    .btn-primary {
      background: #e94560;
    }

    .btn-primary:hover {
      background: #ff6b6b;
    }

    .btn-small {
      padding: 4px 8px;
      font-size: 11px;
    }

    .camera-item, .connection-item {
      background: #0f3460;
      border-radius: 6px;
      padding: 12px;
      margin-bottom: 8px;
      cursor: pointer;
      transition: background 0.2s;
    }

    .camera-item:hover, .connection-item:hover {
      background: #1a4a7a;
    }

    .camera-item.selected, .connection-item.selected {
      outline: 2px solid #e94560;
    }

    .camera-name {
      font-weight: 500;
      margin-bottom: 4px;
    }

    .camera-info {
      font-size: 11px;
      color: #888;
    }

    /* Main editor area */
    .editor {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .toolbar {
      background: #16213e;
      border-bottom: 1px solid #0f3460;
      padding: 10px 20px;
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .toolbar-group {
      display: flex;
      gap: 5px;
      padding-right: 15px;
      border-right: 1px solid #0f3460;
      margin-right: 5px;
    }

    .toolbar-group:last-child {
      border-right: none;
    }

    .canvas-container {
      flex: 1;
      position: relative;
      overflow: hidden;
      background: #0f0f1a;
    }

    #floor-plan-canvas {
      position: absolute;
      top: 0;
      left: 0;
    }

    .canvas-placeholder {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
      color: #666;
    }

    .canvas-placeholder h2 {
      margin-bottom: 15px;
    }

    /* Properties panel */
    .properties-panel {
      width: 280px;
      background: #16213e;
      border-left: 1px solid #0f3460;
      overflow-y: auto;
      padding: 15px;
    }

    .properties-panel h3 {
      font-size: 14px;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 1px solid #0f3460;
    }

    .form-group {
      margin-bottom: 15px;
    }

    .form-group label {
      display: block;
      font-size: 12px;
      color: #888;
      margin-bottom: 5px;
    }

    .form-group input,
    .form-group select {
      width: 100%;
      padding: 8px 10px;
      background: #0f3460;
      border: 1px solid #1a4a7a;
      border-radius: 4px;
      color: #fff;
      font-size: 13px;
    }

    .form-group input:focus,
    .form-group select:focus {
      outline: none;
      border-color: #e94560;
    }

    .checkbox-group {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .checkbox-group input[type="checkbox"] {
      width: auto;
    }

    .transit-time-inputs {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 8px;
    }

    .transit-time-inputs input {
      text-align: center;
    }

    .transit-time-labels {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 8px;
      font-size: 10px;
      color: #666;
      text-align: center;
    }

    /* Modal */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .modal-overlay.active {
      display: flex;
    }

    .modal {
      background: #16213e;
      border-radius: 8px;
      padding: 25px;
      max-width: 500px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
    }

    .modal h2 {
      margin-bottom: 20px;
    }

    .modal-actions {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      margin-top: 20px;
    }

    /* File upload */
    .upload-zone {
      border: 2px dashed #0f3460;
      border-radius: 8px;
      padding: 40px;
      text-align: center;
      cursor: pointer;
      transition: border-color 0.2s, background 0.2s;
    }

    .upload-zone:hover {
      border-color: #e94560;
      background: rgba(233, 69, 96, 0.1);
    }

    .upload-zone input {
      display: none;
    }

    /* Status bar */
    .status-bar {
      background: #0f3460;
      padding: 8px 20px;
      font-size: 12px;
      color: #888;
      display: flex;
      justify-content: space-between;
    }

    .status-indicator {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #4caf50;
    }

    .status-dot.warning {
      background: #ff9800;
    }

    .status-dot.error {
      background: #f44336;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Sidebar -->
    <div class="sidebar">
      <div class="sidebar-header">
        <h1>Spatial Awareness</h1>
        <p>Topology Editor</p>
      </div>
      <div class="sidebar-content">
        <!-- Cameras section -->
        <div class="section">
          <div class="section-title">
            <span>Cameras</span>
            <button class="btn btn-small" onclick="openAddCameraModal()">+ Add</button>
          </div>
          <div id="camera-list">
            <div class="camera-item" style="color: #666; text-align: center; cursor: default;">
              No cameras configured
            </div>
          </div>
        </div>

        <!-- Connections section -->
        <div class="section">
          <div class="section-title">
            <span>Connections</span>
            <button class="btn btn-small" onclick="openAddConnectionModal()">+ Add</button>
          </div>
          <div id="connection-list">
            <div class="connection-item" style="color: #666; text-align: center; cursor: default;">
              No connections configured
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Main editor -->
    <div class="editor">
      <div class="toolbar">
        <div class="toolbar-group">
          <button class="btn" onclick="uploadFloorPlan()">
            üìÅ Upload Floor Plan
          </button>
        </div>
        <div class="toolbar-group">
          <button class="btn" onclick="setTool('select')">üîç Select</button>
          <button class="btn" onclick="setTool('camera')">üì∑ Place Camera</button>
          <button class="btn" onclick="setTool('connect')">üîó Connect</button>
        </div>
        <div class="toolbar-group">
          <button class="btn btn-primary" onclick="saveTopology()">üíæ Save</button>
        </div>
      </div>

      <div class="canvas-container">
        <canvas id="floor-plan-canvas"></canvas>
        <div class="canvas-placeholder" id="canvas-placeholder">
          <h2>üìê Floor Plan Editor</h2>
          <p>Upload a floor plan image to get started</p>
          <br>
          <button class="btn btn-primary" onclick="uploadFloorPlan()">Upload Floor Plan</button>
        </div>
      </div>

      <div class="status-bar">
        <div class="status-indicator">
          <div class="status-dot" id="status-dot"></div>
          <span id="status-text">Ready</span>
        </div>
        <div>
          <span id="camera-count">0</span> cameras | <span id="connection-count">0</span> connections
        </div>
      </div>
    </div>

    <!-- Properties panel -->
    <div class="properties-panel" id="properties-panel">
      <h3>Properties</h3>
      <p style="color: #666; font-size: 13px;">Select a camera or connection to edit its properties.</p>
    </div>
  </div>

  <!-- Add Camera Modal -->
  <div class="modal-overlay" id="add-camera-modal">
    <div class="modal">
      <h2>Add Camera</h2>
      <div class="form-group">
        <label>Camera Device</label>
        <select id="camera-device-select">
          <option value="">Loading cameras...</option>
        </select>
      </div>
      <div class="form-group">
        <label>Display Name</label>
        <input type="text" id="camera-name-input" placeholder="e.g., Front Door Camera">
      </div>
      <div class="form-group">
        <label class="checkbox-group">
          <input type="checkbox" id="camera-entry-checkbox">
          Entry Point (objects can enter property here)
        </label>
      </div>
      <div class="form-group">
        <label class="checkbox-group">
          <input type="checkbox" id="camera-exit-checkbox">
          Exit Point (objects can exit property here)
        </label>
      </div>
      <div class="modal-actions">
        <button class="btn" onclick="closeModal('add-camera-modal')">Cancel</button>
        <button class="btn btn-primary" onclick="addCamera()">Add Camera</button>
      </div>
    </div>
  </div>

  <!-- Add Connection Modal -->
  <div class="modal-overlay" id="add-connection-modal">
    <div class="modal">
      <h2>Add Connection</h2>
      <div class="form-group">
        <label>Connection Name</label>
        <input type="text" id="connection-name-input" placeholder="e.g., Driveway to Front Door">
      </div>
      <div class="form-group">
        <label>From Camera</label>
        <select id="connection-from-select"></select>
      </div>
      <div class="form-group">
        <label>To Camera</label>
        <select id="connection-to-select"></select>
      </div>
      <div class="form-group">
        <label>Transit Time (seconds)</label>
        <div class="transit-time-inputs">
          <input type="number" id="transit-min" placeholder="Min" value="3">
          <input type="number" id="transit-typical" placeholder="Typical" value="10">
          <input type="number" id="transit-max" placeholder="Max" value="30">
        </div>
        <div class="transit-time-labels">
          <span>Minimum</span>
          <span>Typical</span>
          <span>Maximum</span>
        </div>
      </div>
      <div class="form-group">
        <label class="checkbox-group">
          <input type="checkbox" id="connection-bidirectional" checked>
          Bidirectional (works both ways)
        </label>
      </div>
      <div class="modal-actions">
        <button class="btn" onclick="closeModal('add-connection-modal')">Cancel</button>
        <button class="btn btn-primary" onclick="addConnection()">Add Connection</button>
      </div>
    </div>
  </div>

  <!-- Floor Plan Upload Modal -->
  <div class="modal-overlay" id="upload-modal">
    <div class="modal">
      <h2>Upload Floor Plan</h2>
      <div class="upload-zone" onclick="document.getElementById('floor-plan-input').click()">
        <p>Click to select an image<br><small>PNG, JPG, or SVG</small></p>
        <input type="file" id="floor-plan-input" accept="image/*" onchange="handleFloorPlanUpload(event)">
      </div>
      <div class="modal-actions">
        <button class="btn" onclick="closeModal('upload-modal')">Cancel</button>
      </div>
    </div>
  </div>

  <script>
    // State
    let topology = {
      version: '1.0',
      cameras: [],
      connections: [],
      globalZones: [],
      floorPlan: null
    };
    let selectedItem = null;
    let currentTool = 'select';
    let floorPlanImage = null;
    let availableCameras = [];

    // Canvas
    const canvas = document.getElementById('floor-plan-canvas');
    const ctx = canvas.getContext('2d');

    // Initialize
    async function init() {
      await loadTopology();
      await loadAvailableCameras();
      resizeCanvas();
      render();
      updateUI();
    }

    // Load topology from API
    async function loadTopology() {
      try {
        const response = await fetch('api/topology');
        if (response.ok) {
          topology = await response.json();
          if (topology.floorPlan?.imageData) {
            await loadFloorPlanImage(topology.floorPlan.imageData);
          }
        }
      } catch (e) {
        console.error('Failed to load topology:', e);
      }
    }

    // Load available cameras from Scrypted
    async function loadAvailableCameras() {
      // For now, use topology cameras
      // In production, this would query Scrypted for ObjectDetector devices
      availableCameras = topology.cameras.map(c => ({
        id: c.deviceId,
        name: c.name
      }));
      updateCameraSelects();
    }

    // Save topology to API
    async function saveTopology() {
      try {
        setStatus('Saving...', 'warning');
        const response = await fetch('api/topology', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(topology)
        });
        if (response.ok) {
          setStatus('Saved successfully', 'success');
        } else {
          setStatus('Failed to save', 'error');
        }
      } catch (e) {
        console.error('Failed to save topology:', e);
        setStatus('Failed to save', 'error');
      }
    }

    // Canvas rendering
    function resizeCanvas() {
      const container = canvas.parentElement;
      canvas.width = container.clientWidth;
      canvas.height = container.clientHeight;
    }

    function render() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      // Draw floor plan
      if (floorPlanImage) {
        document.getElementById('canvas-placeholder').style.display = 'none';
        const scale = Math.min(
          canvas.width / floorPlanImage.width,
          canvas.height / floorPlanImage.height
        ) * 0.9;
        const x = (canvas.width - floorPlanImage.width * scale) / 2;
        const y = (canvas.height - floorPlanImage.height * scale) / 2;
        ctx.drawImage(floorPlanImage, x, y, floorPlanImage.width * scale, floorPlanImage.height * scale);
      } else {
        document.getElementById('canvas-placeholder').style.display = 'block';
      }

      // Draw connections
      for (const conn of topology.connections) {
        const fromCam = topology.cameras.find(c => c.deviceId === conn.fromCameraId);
        const toCam = topology.cameras.find(c => c.deviceId === conn.toCameraId);
        if (fromCam?.floorPlanPosition && toCam?.floorPlanPosition) {
          drawConnection(fromCam.floorPlanPosition, toCam.floorPlanPosition, conn);
        }
      }

      // Draw cameras
      for (const camera of topology.cameras) {
        if (camera.floorPlanPosition) {
          drawCamera(camera);
        }
      }
    }

    function drawCamera(camera) {
      const pos = camera.floorPlanPosition;
      const isSelected = selectedItem?.type === 'camera' && selectedItem?.id === camera.deviceId;

      ctx.beginPath();
      ctx.arc(pos.x, pos.y, 20, 0, Math.PI * 2);
      ctx.fillStyle = isSelected ? '#e94560' : '#0f3460';
      ctx.fill();
      ctx.strokeStyle = '#fff';
      ctx.lineWidth = 2;
      ctx.stroke();

      // Camera icon
      ctx.fillStyle = '#fff';
      ctx.font = '16px sans-serif';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.fillText('üì∑', pos.x, pos.y);

      // Label
      ctx.font = '12px sans-serif';
      ctx.fillStyle = '#fff';
      ctx.fillText(camera.name, pos.x, pos.y + 35);
    }

    function drawConnection(from, to, conn) {
      const isSelected = selectedItem?.type === 'connection' && selectedItem?.id === conn.id;

      ctx.beginPath();
      ctx.moveTo(from.x, from.y);
      ctx.lineTo(to.x, to.y);
      ctx.strokeStyle = isSelected ? '#e94560' : '#4caf50';
      ctx.lineWidth = isSelected ? 4 : 2;
      ctx.stroke();

      // Arrow
      const angle = Math.atan2(to.y - from.y, to.x - from.x);
      const midX = (from.x + to.x) / 2;
      const midY = (from.y + to.y) / 2;

      if (!conn.bidirectional) {
        ctx.beginPath();
        ctx.moveTo(midX, midY);
        ctx.lineTo(midX - 10 * Math.cos(angle - 0.5), midY - 10 * Math.sin(angle - 0.5));
        ctx.lineTo(midX - 10 * Math.cos(angle + 0.5), midY - 10 * Math.sin(angle + 0.5));
        ctx.closePath();
        ctx.fillStyle = isSelected ? '#e94560' : '#4caf50';
        ctx.fill();
      }
    }

    // Floor plan handling
    function uploadFloorPlan() {
      document.getElementById('upload-modal').classList.add('active');
    }

    async function handleFloorPlanUpload(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = async (e) => {
        const imageData = e.target.result;
        await loadFloorPlanImage(imageData);
        topology.floorPlan = {
          imageData,
          width: floorPlanImage.width,
          height: floorPlanImage.height
        };
        closeModal('upload-modal');
        render();
      };
      reader.readAsDataURL(file);
    }

    function loadFloorPlanImage(imageData) {
      return new Promise((resolve) => {
        floorPlanImage = new Image();
        floorPlanImage.onload = resolve;
        floorPlanImage.src = imageData;
      });
    }

    // Camera handling
    function openAddCameraModal() {
      document.getElementById('add-camera-modal').classList.add('active');
    }

    function addCamera() {
      const deviceId = document.getElementById('camera-device-select').value;
      const name = document.getElementById('camera-name-input').value || 'New Camera';
      const isEntry = document.getElementById('camera-entry-checkbox').checked;
      const isExit = document.getElementById('camera-exit-checkbox').checked;

      if (!deviceId) {
        alert('Please select a camera device');
        return;
      }

      const camera = {
        deviceId: deviceId || `camera-${Date.now()}`,
        nativeId: `cam-${Date.now()}`,
        name,
        isEntryPoint: isEntry,
        isExitPoint: isExit,
        trackClasses: ['person', 'car', 'animal'],
        floorPlanPosition: {
          x: canvas.width / 2 + Math.random() * 100 - 50,
          y: canvas.height / 2 + Math.random() * 100 - 50
        }
      };

      topology.cameras.push(camera);
      closeModal('add-camera-modal');
      updateUI();
      render();
    }

    // Connection handling
    function openAddConnectionModal() {
      if (topology.cameras.length < 2) {
        alert('Add at least 2 cameras before creating connections');
        return;
      }
      updateCameraSelects();
      document.getElementById('add-connection-modal').classList.add('active');
    }

    function updateCameraSelects() {
      const options = topology.cameras.map(c =>
        `<option value="${c.deviceId}">${c.name}</option>`
      ).join('');

      document.getElementById('connection-from-select').innerHTML = options;
      document.getElementById('connection-to-select').innerHTML = options;
    }

    function addConnection() {
      const name = document.getElementById('connection-name-input').value;
      const fromId = document.getElementById('connection-from-select').value;
      const toId = document.getElementById('connection-to-select').value;
      const minTransit = parseInt(document.getElementById('transit-min').value) * 1000;
      const typicalTransit = parseInt(document.getElementById('transit-typical').value) * 1000;
      const maxTransit = parseInt(document.getElementById('transit-max').value) * 1000;
      const bidirectional = document.getElementById('connection-bidirectional').checked;

      if (fromId === toId) {
        alert('Please select different cameras');
        return;
      }

      const connection = {
        id: `conn-${Date.now()}`,
        fromCameraId: fromId,
        toCameraId: toId,
        name: name || `${fromId} ‚Üí ${toId}`,
        exitZone: [],
        entryZone: [],
        transitTime: {
          min: minTransit,
          typical: typicalTransit,
          max: maxTransit
        },
        bidirectional
      };

      topology.connections.push(connection);
      closeModal('add-connection-modal');
      updateUI();
      render();
    }

    // UI updates
    function updateUI() {
      // Update camera list
      const cameraList = document.getElementById('camera-list');
      if (topology.cameras.length === 0) {
        cameraList.innerHTML = '<div class="camera-item" style="color: #666; text-align: center; cursor: default;">No cameras configured</div>';
      } else {
        cameraList.innerHTML = topology.cameras.map(c => `
          <div class="camera-item ${selectedItem?.type === 'camera' && selectedItem?.id === c.deviceId ? 'selected' : ''}"
               onclick="selectCamera('${c.deviceId}')">
            <div class="camera-name">üì∑ ${c.name}</div>
            <div class="camera-info">
              ${c.isEntryPoint ? 'üö™ Entry' : ''} ${c.isExitPoint ? 'üö∂ Exit' : ''}
            </div>
          </div>
        `).join('');
      }

      // Update connection list
      const connectionList = document.getElementById('connection-list');
      if (topology.connections.length === 0) {
        connectionList.innerHTML = '<div class="connection-item" style="color: #666; text-align: center; cursor: default;">No connections configured</div>';
      } else {
        connectionList.innerHTML = topology.connections.map(c => `
          <div class="connection-item ${selectedItem?.type === 'connection' && selectedItem?.id === c.id ? 'selected' : ''}"
               onclick="selectConnection('${c.id}')">
            <div class="camera-name">üîó ${c.name}</div>
            <div class="camera-info">
              ${c.transitTime.typical / 1000}s typical ${c.bidirectional ? '‚ÜîÔ∏è' : '‚Üí'}
            </div>
          </div>
        `).join('');
      }

      // Update counts
      document.getElementById('camera-count').textContent = topology.cameras.length;
      document.getElementById('connection-count').textContent = topology.connections.length;
    }

    function selectCamera(deviceId) {
      selectedItem = { type: 'camera', id: deviceId };
      const camera = topology.cameras.find(c => c.deviceId === deviceId);
      showCameraProperties(camera);
      updateUI();
      render();
    }

    function selectConnection(connId) {
      selectedItem = { type: 'connection', id: connId };
      const connection = topology.connections.find(c => c.id === connId);
      showConnectionProperties(connection);
      updateUI();
      render();
    }

    function showCameraProperties(camera) {
      const panel = document.getElementById('properties-panel');
      panel.innerHTML = `
        <h3>Camera Properties</h3>
        <div class="form-group">
          <label>Name</label>
          <input type="text" value="${camera.name}" onchange="updateCameraName('${camera.deviceId}', this.value)">
        </div>
        <div class="form-group">
          <label class="checkbox-group">
            <input type="checkbox" ${camera.isEntryPoint ? 'checked' : ''} onchange="updateCameraEntry('${camera.deviceId}', this.checked)">
            Entry Point
          </label>
        </div>
        <div class="form-group">
          <label class="checkbox-group">
            <input type="checkbox" ${camera.isExitPoint ? 'checked' : ''} onchange="updateCameraExit('${camera.deviceId}', this.checked)">
            Exit Point
          </label>
        </div>
        <div class="form-group">
          <button class="btn" style="width: 100%; background: #f44336;" onclick="deleteCamera('${camera.deviceId}')">Delete Camera</button>
        </div>
      `;
    }

    function showConnectionProperties(connection) {
      const panel = document.getElementById('properties-panel');
      panel.innerHTML = `
        <h3>Connection Properties</h3>
        <div class="form-group">
          <label>Name</label>
          <input type="text" value="${connection.name}" onchange="updateConnectionName('${connection.id}', this.value)">
        </div>
        <div class="form-group">
          <label>Transit Time (seconds)</label>
          <div class="transit-time-inputs">
            <input type="number" value="${connection.transitTime.min / 1000}" onchange="updateTransitTime('${connection.id}', 'min', this.value)">
            <input type="number" value="${connection.transitTime.typical / 1000}" onchange="updateTransitTime('${connection.id}', 'typical', this.value)">
            <input type="number" value="${connection.transitTime.max / 1000}" onchange="updateTransitTime('${connection.id}', 'max', this.value)">
          </div>
          <div class="transit-time-labels">
            <span>Min</span>
            <span>Typical</span>
            <span>Max</span>
          </div>
        </div>
        <div class="form-group">
          <label class="checkbox-group">
            <input type="checkbox" ${connection.bidirectional ? 'checked' : ''} onchange="updateConnectionBidi('${connection.id}', this.checked)">
            Bidirectional
          </label>
        </div>
        <div class="form-group">
          <button class="btn" style="width: 100%; background: #f44336;" onclick="deleteConnection('${connection.id}')">Delete Connection</button>
        </div>
      `;
    }

    // Update functions
    function updateCameraName(id, value) {
      const camera = topology.cameras.find(c => c.deviceId === id);
      if (camera) camera.name = value;
      updateUI();
    }

    function updateCameraEntry(id, value) {
      const camera = topology.cameras.find(c => c.deviceId === id);
      if (camera) camera.isEntryPoint = value;
    }

    function updateCameraExit(id, value) {
      const camera = topology.cameras.find(c => c.deviceId === id);
      if (camera) camera.isExitPoint = value;
    }

    function updateConnectionName(id, value) {
      const conn = topology.connections.find(c => c.id === id);
      if (conn) conn.name = value;
      updateUI();
    }

    function updateTransitTime(id, field, value) {
      const conn = topology.connections.find(c => c.id === id);
      if (conn) conn.transitTime[field] = parseInt(value) * 1000;
    }

    function updateConnectionBidi(id, value) {
      const conn = topology.connections.find(c => c.id === id);
      if (conn) conn.bidirectional = value;
      render();
    }

    function deleteCamera(id) {
      if (!confirm('Delete this camera?')) return;
      topology.cameras = topology.cameras.filter(c => c.deviceId !== id);
      topology.connections = topology.connections.filter(c => c.fromCameraId !== id && c.toCameraId !== id);
      selectedItem = null;
      document.getElementById('properties-panel').innerHTML = '<h3>Properties</h3><p style="color: #666;">Select a camera or connection.</p>';
      updateUI();
      render();
    }

    function deleteConnection(id) {
      if (!confirm('Delete this connection?')) return;
      topology.connections = topology.connections.filter(c => c.id !== id);
      selectedItem = null;
      document.getElementById('properties-panel').innerHTML = '<h3>Properties</h3><p style="color: #666;">Select a camera or connection.</p>';
      updateUI();
      render();
    }

    // Tools
    function setTool(tool) {
      currentTool = tool;
      setStatus(`Tool: ${tool}`, 'success');
    }

    // Utility
    function closeModal(id) {
      document.getElementById(id).classList.remove('active');
    }

    function setStatus(text, type = 'success') {
      document.getElementById('status-text').textContent = text;
      const dot = document.getElementById('status-dot');
      dot.className = 'status-dot';
      if (type === 'warning') dot.classList.add('warning');
      if (type === 'error') dot.classList.add('error');
    }

    // Canvas interactions
    canvas.addEventListener('mousedown', (e) => {
      const rect = canvas.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;

      if (currentTool === 'select') {
        // Check if clicked on a camera
        for (const camera of topology.cameras) {
          if (camera.floorPlanPosition) {
            const dist = Math.hypot(x - camera.floorPlanPosition.x, y - camera.floorPlanPosition.y);
            if (dist < 25) {
              selectCamera(camera.deviceId);
              return;
            }
          }
        }
      }
    });

    // Drag handling
    let dragging = null;
    canvas.addEventListener('mousedown', (e) => {
      if (currentTool !== 'select') return;
      const rect = canvas.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;

      for (const camera of topology.cameras) {
        if (camera.floorPlanPosition) {
          const dist = Math.hypot(x - camera.floorPlanPosition.x, y - camera.floorPlanPosition.y);
          if (dist < 25) {
            dragging = camera;
            return;
          }
        }
      }
    });

    canvas.addEventListener('mousemove', (e) => {
      if (!dragging) return;
      const rect = canvas.getBoundingClientRect();
      dragging.floorPlanPosition.x = e.clientX - rect.left;
      dragging.floorPlanPosition.y = e.clientY - rect.top;
      render();
    });

    canvas.addEventListener('mouseup', () => {
      dragging = null;
    });

    // Window resize
    window.addEventListener('resize', () => {
      resizeCanvas();
      render();
    });

    // Initialize
    init();
  </script>
</body>
</html>
