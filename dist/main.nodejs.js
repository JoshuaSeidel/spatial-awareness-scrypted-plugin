/*! For license information please see main.nodejs.js.LICENSE.txt */
(()=>{var e={128(e,t){"use strict";function n(e){const t=e.split("/");for(let e=0;e<t.length;e++)if("+"!==t[e]){if("#"===t[e])return e===t.length-1;if(-1!==t[e].indexOf("+")||-1!==t[e].indexOf("#"))return!1}return!0}Object.defineProperty(t,"__esModule",{value:!0}),t.validateTopic=n,t.validateTopics=function(e){if(0===e.length)return"empty_topic_list";for(let t=0;t<e.length;t++)if(!n(e[t]))return e[t];return null}},181(e){"use strict";e.exports=require("buffer")},277(e,t,n){"use strict";const{ArrayIsArray:r,ArrayPrototypeIncludes:i,ArrayPrototypeJoin:s,ArrayPrototypeMap:o,NumberIsInteger:a,NumberIsNaN:c,NumberMAX_SAFE_INTEGER:l,NumberMIN_SAFE_INTEGER:d,NumberParseInt:u,ObjectPrototypeHasOwnProperty:h,RegExpPrototypeExec:p,String:f,StringPrototypeToUpperCase:g,StringPrototypeTrim:m}=n(4134),{hideStackFrames:y,codes:{ERR_SOCKET_BAD_PORT:b,ERR_INVALID_ARG_TYPE:v,ERR_INVALID_ARG_VALUE:S,ERR_OUT_OF_RANGE:_,ERR_UNKNOWN_SIGNAL:w}}=n(6371),{normalizeEncoding:k}=n(7760),{isAsyncFunction:I,isArrayBufferView:E}=n(7760).types,x={};const T=/^[0-7]+$/;const C=y((e,t,n=d,r=l)=>{if("number"!=typeof e)throw new v(t,"number",e);if(!a(e))throw new _(t,"an integer",e);if(e<n||e>r)throw new _(t,`>= ${n} && <= ${r}`,e)}),O=y((e,t,n=-2147483648,r=2147483647)=>{if("number"!=typeof e)throw new v(t,"number",e);if(!a(e))throw new _(t,"an integer",e);if(e<n||e>r)throw new _(t,`>= ${n} && <= ${r}`,e)}),A=y((e,t,n=!1)=>{if("number"!=typeof e)throw new v(t,"number",e);if(!a(e))throw new _(t,"an integer",e);const r=n?1:0,i=4294967295;if(e<r||e>i)throw new _(t,`>= ${r} && <= ${i}`,e)});function P(e,t){if("string"!=typeof e)throw new v(t,"string",e)}const R=y((e,t,n)=>{if(!i(n,e)){const r=s(o(n,e=>"string"==typeof e?`'${e}'`:f(e)),", ");throw new S(t,e,"must be one of: "+r)}});function M(e,t){if("boolean"!=typeof e)throw new v(t,"boolean",e)}function N(e,t,n){return null!=e&&h(e,t)?e[t]:n}const B=y((e,t,n=null)=>{const i=N(n,"allowArray",!1),s=N(n,"allowFunction",!1);if(!N(n,"nullable",!1)&&null===e||!i&&r(e)||"object"!=typeof e&&(!s||"function"!=typeof e))throw new v(t,"Object",e)}),L=y((e,t)=>{if(null!=e&&"object"!=typeof e&&"function"!=typeof e)throw new v(t,"a dictionary",e)}),j=y((e,t,n=0)=>{if(!r(e))throw new v(t,"Array",e);if(e.length<n){throw new S(t,e,`must be longer than ${n}`)}});const D=y((e,t="buffer")=>{if(!E(e))throw new v(t,["Buffer","TypedArray","DataView"],e)});const U=y((e,t)=>{if(void 0!==e&&(null===e||"object"!=typeof e||!("aborted"in e)))throw new v(t,"AbortSignal",e)}),F=y((e,t)=>{if("function"!=typeof e)throw new v(t,"Function",e)}),$=y((e,t)=>{if("function"!=typeof e||I(e))throw new v(t,"Function",e)}),W=y((e,t)=>{if(void 0!==e)throw new v(t,"undefined",e)});const V=/^(?:<[^>]*>)(?:\s*;\s*[^;"\s]+(?:=(")?[^;"\s]*\1)?)*$/;function z(e,t){if("undefined"==typeof e||!p(V,e))throw new S(t,e,'must be an array or string of format "</styles.css>; rel=preload; as=style"')}e.exports={isInt32:function(e){return e===(0|e)},isUint32:function(e){return e===e>>>0},parseFileMode:function(e,t,n){if("undefined"==typeof e&&(e=n),"string"==typeof e){if(null===p(T,e))throw new S(t,e,"must be a 32-bit unsigned integer or an octal string");e=u(e,8)}return A(e,t),e},validateArray:j,validateStringArray:function(e,t){j(e,t);for(let n=0;n<e.length;n++)P(e[n],`${t}[${n}]`)},validateBooleanArray:function(e,t){j(e,t);for(let n=0;n<e.length;n++)M(e[n],`${t}[${n}]`)},validateAbortSignalArray:function(e,t){j(e,t);for(let n=0;n<e.length;n++){const r=e[n],i=`${t}[${n}]`;if(null==r)throw new v(i,"AbortSignal",r);U(r,i)}},validateBoolean:M,validateBuffer:D,validateDictionary:L,validateEncoding:function(e,t){const n=k(t),r=e.length;if("hex"===n&&r%2!=0)throw new S("encoding",t,`is invalid for data of length ${r}`)},validateFunction:F,validateInt32:O,validateInteger:C,validateNumber:function(e,t,n=void 0,r){if("number"!=typeof e)throw new v(t,"number",e);if(null!=n&&e<n||null!=r&&e>r||(null!=n||null!=r)&&c(e))throw new _(t,`${null!=n?`>= ${n}`:""}${null!=n&&null!=r?" && ":""}${null!=r?`<= ${r}`:""}`,e)},validateObject:B,validateOneOf:R,validatePlainFunction:$,validatePort:function(e,t="Port",n=!0){if("number"!=typeof e&&"string"!=typeof e||"string"==typeof e&&0===m(e).length||+e!==+e>>>0||e>65535||0===e&&!n)throw new b(t,e,n);return 0|e},validateSignalName:function(e,t="signal"){if(P(e,t),void 0===x[e]){if(void 0!==x[g(e)])throw new w(e+" (signals must use all capital letters)");throw new w(e)}},validateString:P,validateUint32:A,validateUndefined:W,validateUnion:function(e,t,n){if(!i(n,e))throw new v(t,`('${s(n,"|")}')`,e)},validateAbortSignal:U,validateLinkHeaderValue:function(e){if("string"==typeof e)return z(e,"hints"),e;if(r(e)){const t=e.length;let n="";if(0===t)return n;for(let r=0;r<t;r++){const i=e[r];z(i,"hints"),n+=i,r!==t-1&&(n+=", ")}return n}throw new S("hints",e,'must be an array or string of format "</styles.css>; rel=preload; as=style"')}}},321(e,t,n){"use strict";var r=this&&this.__createBinding||(Object.create?function(e,t,n,r){void 0===r&&(r=n);var i=Object.getOwnPropertyDescriptor(t,n);i&&!("get"in i?!t.__esModule:i.writable||i.configurable)||(i={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,r,i)}:function(e,t,n,r){void 0===r&&(r=n),e[r]=t[n]}),i=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),s=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&r(t,e,n);return i(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.ADDRESS_BOUNDARY=void 0,t.groupPossibilities=a,t.padGroup=c,t.simpleRegularExpression=function(e){const t=[];e.forEach((e,n)=>{0===parseInt(e,16)&&t.push(n)});const n=t.map(t=>e.map((e,n)=>{if(n===t){const t=0===n||n===o.GROUPS-1?":":"";return a([c(e),t])}return c(e)}).join(":"));return n.push(e.map(c).join(":")),a(n)},t.possibleElisions=function(e,t,n){const r=t?"":":",i=n?"":":",s=[];t||n||s.push("::");t&&n&&s.push("");(n&&!t||!n&&t)&&s.push(":");s.push(`${r}(:0{1,4}){1,${e-1}}`),s.push(`(0{1,4}:){1,${e-1}}${i}`),s.push(`(0{1,4}:){${e-1}}0{1,4}`);for(let t=1;t<e-1;t++)for(let n=1;n<e-t;n++)s.push(`(0{1,4}:){${n}}:(0{1,4}:){${e-n-t-1}}0{1,4}`);return a(s)};const o=s(n(8914));function a(e){return`(${e.join("|")})`}function c(e){return e.length<4?`0{0,${4-e.length}}${e}`:e}t.ADDRESS_BOUNDARY="[^A-Fa-f0-9:]"},345(e,t,n){"use strict";const{StringPrototypeSlice:r,SymbolIterator:i,TypedArrayPrototypeSet:s,Uint8Array:o}=n(4134),{Buffer:a}=n(181),{inspect:c}=n(7760);e.exports=class{constructor(){this.head=null,this.tail=null,this.length=0}push(e){const t={data:e,next:null};this.length>0?this.tail.next=t:this.head=t,this.tail=t,++this.length}unshift(e){const t={data:e,next:this.head};0===this.length&&(this.tail=t),this.head=t,++this.length}shift(){if(0===this.length)return;const e=this.head.data;return 1===this.length?this.head=this.tail=null:this.head=this.head.next,--this.length,e}clear(){this.head=this.tail=null,this.length=0}join(e){if(0===this.length)return"";let t=this.head,n=""+t.data;for(;null!==(t=t.next);)n+=e+t.data;return n}concat(e){if(0===this.length)return a.alloc(0);const t=a.allocUnsafe(e>>>0);let n=this.head,r=0;for(;n;)s(t,n.data,r),r+=n.data.length,n=n.next;return t}consume(e,t){const n=this.head.data;if(e<n.length){const t=n.slice(0,e);return this.head.data=n.slice(e),t}return e===n.length?this.shift():t?this._getString(e):this._getBuffer(e)}first(){return this.head.data}*[i](){for(let e=this.head;e;e=e.next)yield e.data}_getString(e){let t="",n=this.head,i=0;do{const s=n.data;if(!(e>s.length)){e===s.length?(t+=s,++i,n.next?this.head=n.next:this.head=this.tail=null):(t+=r(s,0,e),this.head=n,n.data=r(s,e));break}t+=s,e-=s.length,++i}while(null!==(n=n.next));return this.length-=i,t}_getBuffer(e){const t=a.allocUnsafe(e),n=e;let r=this.head,i=0;do{const a=r.data;if(!(e>a.length)){e===a.length?(s(t,a,n-e),++i,r.next?this.head=r.next:this.head=this.tail=null):(s(t,new o(a.buffer,a.byteOffset,e),n-e),this.head=r,r.data=a.slice(e));break}s(t,a,n-e),e-=a.length,++i}while(null!==(r=r.next));return this.length-=i,t}[Symbol.for("nodejs.util.inspect.custom")](e,t){return c(this,{...t,depth:0,customInspect:!1})}}},397(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DEFAULT_TRAINING_CONFIG=void 0,t.createTrainingSession=function(e){const t=Date.now();return{id:`training-${t}-${Math.random().toString(36).substr(2,9)}`,state:"idle",startedAt:t,updatedAt:t,trainerName:e,visits:[],transits:[],landmarks:[],overlaps:[],structures:[],stats:{totalDuration:0,camerasVisited:0,transitsRecorded:0,landmarksMarked:0,overlapsDetected:0,structuresMarked:0,averageTransitTime:0,coveragePercentage:0}}},t.calculateTrainingStats=function(e,t){const n=new Set(e.visits.map(e=>e.cameraId)),r=e.transits.map(e=>e.transitSeconds),i=r.length>0?r.reduce((e,t)=>e+t,0)/r.length:0;return{totalDuration:(e.completedAt||Date.now())-e.startedAt,camerasVisited:n.size,transitsRecorded:e.transits.length,landmarksMarked:e.landmarks.length,overlapsDetected:e.overlaps.length,structuresMarked:e.structures.length,averageTransitTime:Math.round(i),coveragePercentage:t>0?Math.round(n.size/t*100):0}},t.DEFAULT_TRAINING_CONFIG={minDetectionConfidence:.7,maxTransitWait:120,autoDetectOverlaps:!0,autoSuggestLandmarks:!0,minOverlapDuration:2}},441(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.createTrackedObject=function(e,t,n){return{globalId:e,className:t.detection.className,label:t.detection.label,sightings:[t],journey:[],firstSeen:t.timestamp,lastSeen:t.timestamp,activeOnCameras:[t.cameraId],entryCamera:n?t.cameraId:void 0,entryCameraName:n?t.cameraName:void 0,hasExited:!1,totalDwellTime:0,state:"active",visualDescriptor:t.embedding,bestThumbnailId:t.detectionId}},t.addSighting=function(e,t){e.sightings.push(t),e.lastSeen=t.timestamp,e.activeOnCameras.includes(t.cameraId)||e.activeOnCameras.push(t.cameraId);t.embedding&&!e.visualDescriptor&&(e.visualDescriptor=t.embedding);t.detectionId&&t.confidence>.8&&(e.bestThumbnailId=t.detectionId);t.detection.label&&!e.label&&(e.label=t.detection.label)},t.addJourneySegment=function(e,t){e.journey.push(t),e.activeOnCameras=e.activeOnCameras.filter(e=>e!==t.fromCameraId),e.activeOnCameras.includes(t.toCameraId)||e.activeOnCameras.push(t.toCameraId)},t.calculateDwellTime=function(e){return 0===e.sightings.length?0:e.lastSeen-e.firstSeen},t.getLastCamera=function(e){return 0===e.sightings.length?void 0:e.sightings[e.sightings.length-1].cameraId},t.getLastSighting=function(e){return 0===e.sightings.length?void 0:e.sightings[e.sightings.length-1]},t.getJourneySummary=function(e){const t=[];e.entryCamera&&t.push(e.entryCameraName||e.entryCamera);for(const n of e.journey)t.includes(n.toCameraName||n.toCameraId)||t.push(n.toCameraName||n.toCameraId);e.exitCamera&&!t.includes(e.exitCameraName||e.exitCamera)&&t.push(e.exitCameraName||e.exitCamera);return t.join(" → ")}},465(e,t){"use strict";function n(e){return e.replace(/(0+)/g,'<span class="zero">$1</span>')}function r(e){return e.replace(/^(0+)/,'<span class="zero">$1</span>')}Object.defineProperty(t,"__esModule",{value:!0}),t.spanAllZeroes=n,t.spanAll=function(e,t=0){return e.split("").map((e,r)=>`<span class="digit value-${e} position-${r+t}">${n(e)}</span>`).join("")},t.spanLeadingZeroes=function(e){return e.split(":").map(e=>r(e)).join(":")},t.simpleGroup=function(e,t=0){return e.split(":").map((e,n)=>/group-v4/.test(e)?e:`<span class="hover-group group-${n+t}">${r(e)}</span>`)}},495(e,t,n){"use strict";var r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const i=n(1021),s=r(n(3497)),o=n(4723);t.default=(e,t)=>{e.log("_handleConnack");const{options:n}=e,r=5===n.protocolVersion?t.reasonCode:t.returnCode;if(clearTimeout(e.connackTimer),delete e.topicAliasSend,t.properties){if(t.properties.topicAliasMaximum){if(t.properties.topicAliasMaximum>65535)return void e.emit("error",new Error("topicAliasMaximum from broker is out of range"));t.properties.topicAliasMaximum>0&&(e.topicAliasSend=new s.default(t.properties.topicAliasMaximum))}t.properties.serverKeepAlive&&n.keepalive&&(n.keepalive=t.properties.serverKeepAlive),t.properties.maximumPacketSize&&(n.properties||(n.properties={}),n.properties.maximumPacketSize=t.properties.maximumPacketSize)}if(0===r)e.reconnecting=!1,e._onConnect(t);else if(r>0){const t=new o.ErrorWithReasonCode(`Connection refused: ${i.ReasonCodes[r]}`,r);e.emit("error",t),e.options.reconnectOnConnackError&&e._cleanUp(!0)}}},576(e){e.exports=class{constructor(){this.cmd=null,this.retain=!1,this.qos=0,this.dup=!1,this.length=-1,this.topic=null,this.payload=null}}},579(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.default=class{nextId;constructor(){this.nextId=Math.max(1,Math.floor(65535*Math.random()))}allocate(){const e=this.nextId++;return 65536===this.nextId&&(this.nextId=1),e}getLastAllocated(){return 1===this.nextId?65535:this.nextId-1}register(e){return!0}deallocate(e){}clear(){}}},597(e,t,n){"use strict";const{kForOnEventAttribute:r,kListener:i}=n(2614),s=Symbol("kCode"),o=Symbol("kData"),a=Symbol("kError"),c=Symbol("kMessage"),l=Symbol("kReason"),d=Symbol("kTarget"),u=Symbol("kType"),h=Symbol("kWasClean");class p{constructor(e){this[d]=null,this[u]=e}get target(){return this[d]}get type(){return this[u]}}Object.defineProperty(p.prototype,"target",{enumerable:!0}),Object.defineProperty(p.prototype,"type",{enumerable:!0});class f extends p{constructor(e,t={}){super(e),this[s]=void 0===t.code?0:t.code,this[l]=void 0===t.reason?"":t.reason,this[h]=void 0!==t.wasClean&&t.wasClean}get code(){return this[s]}get reason(){return this[l]}get wasClean(){return this[h]}}Object.defineProperty(f.prototype,"code",{enumerable:!0}),Object.defineProperty(f.prototype,"reason",{enumerable:!0}),Object.defineProperty(f.prototype,"wasClean",{enumerable:!0});class g extends p{constructor(e,t={}){super(e),this[a]=void 0===t.error?null:t.error,this[c]=void 0===t.message?"":t.message}get error(){return this[a]}get message(){return this[c]}}Object.defineProperty(g.prototype,"error",{enumerable:!0}),Object.defineProperty(g.prototype,"message",{enumerable:!0});class m extends p{constructor(e,t={}){super(e),this[o]=void 0===t.data?null:t.data}get data(){return this[o]}}Object.defineProperty(m.prototype,"data",{enumerable:!0});const y={addEventListener(e,t,n={}){for(const s of this.listeners(e))if(!n[r]&&s[i]===t&&!s[r])return;let s;if("message"===e)s=function(e,n){const r=new m("message",{data:n?e:e.toString()});r[d]=this,b(t,this,r)};else if("close"===e)s=function(e,n){const r=new f("close",{code:e,reason:n.toString(),wasClean:this._closeFrameReceived&&this._closeFrameSent});r[d]=this,b(t,this,r)};else if("error"===e)s=function(e){const n=new g("error",{error:e,message:e.message});n[d]=this,b(t,this,n)};else{if("open"!==e)return;s=function(){const e=new p("open");e[d]=this,b(t,this,e)}}s[r]=!!n[r],s[i]=t,n.once?this.once(e,s):this.on(e,s)},removeEventListener(e,t){for(const n of this.listeners(e))if(n[i]===t&&!n[r]){this.removeListener(e,n);break}}};function b(e,t,n){"object"==typeof e&&e.handleEvent?e.handleEvent.call(e,n):e.call(t,n)}e.exports={CloseEvent:f,ErrorEvent:g,Event:p,EventTarget:y,MessageEvent:m}},720(e,t,n){const r=n(9291);e.exports.NumberAllocator=r},736(e,t,n){e.exports=function(e){function t(e){let n,i,s,o=null;function a(...e){if(!a.enabled)return;const r=a,i=Number(new Date),s=i-(n||i);r.diff=s,r.prev=n,r.curr=i,n=i,e[0]=t.coerce(e[0]),"string"!=typeof e[0]&&e.unshift("%O");let o=0;e[0]=e[0].replace(/%([a-zA-Z%])/g,(n,i)=>{if("%%"===n)return"%";o++;const s=t.formatters[i];if("function"==typeof s){const t=e[o];n=s.call(r,t),e.splice(o,1),o--}return n}),t.formatArgs.call(r,e);(r.log||t.log).apply(r,e)}return a.namespace=e,a.useColors=t.useColors(),a.color=t.selectColor(e),a.extend=r,a.destroy=t.destroy,Object.defineProperty(a,"enabled",{enumerable:!0,configurable:!1,get:()=>null!==o?o:(i!==t.namespaces&&(i=t.namespaces,s=t.enabled(e)),s),set:e=>{o=e}}),"function"==typeof t.init&&t.init(a),a}function r(e,n){const r=t(this.namespace+("undefined"==typeof n?":":n)+e);return r.log=this.log,r}function i(e,t){let n=0,r=0,i=-1,s=0;for(;n<e.length;)if(r<t.length&&(t[r]===e[n]||"*"===t[r]))"*"===t[r]?(i=r,s=n,r++):(n++,r++);else{if(-1===i)return!1;r=i+1,s++,n=s}for(;r<t.length&&"*"===t[r];)r++;return r===t.length}return t.debug=t,t.default=t,t.coerce=function(e){if(e instanceof Error)return e.stack||e.message;return e},t.disable=function(){const e=[...t.names,...t.skips.map(e=>"-"+e)].join(",");return t.enable(""),e},t.enable=function(e){t.save(e),t.namespaces=e,t.names=[],t.skips=[];const n=("string"==typeof e?e:"").trim().replace(/\s+/g,",").split(",").filter(Boolean);for(const e of n)"-"===e[0]?t.skips.push(e.slice(1)):t.names.push(e)},t.enabled=function(e){for(const n of t.skips)if(i(e,n))return!1;for(const n of t.names)if(i(e,n))return!0;return!1},t.humanize=n(6585),t.destroy=function(){console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`.")},Object.keys(e).forEach(n=>{t[n]=e[n]}),t.names=[],t.skips=[],t.formatters={},t.selectColor=function(e){let n=0;for(let t=0;t<e.length;t++)n=(n<<5)-n+e.charCodeAt(t),n|=0;return t.colors[Math.abs(n)%t.colors.length]},t.enable(t.load()),t}},778(e,t,n){"use strict";var r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const i=r(n(9278)),s=r(n(5753)),o=r(n(6968)),a=(0,s.default)("mqttjs:tcp");t.default=(e,t)=>{if(t.port=t.port||1883,t.hostname=t.hostname||t.host||"localhost",t.socksProxy)return(0,o.default)(t.hostname,t.port,t.socksProxy,{timeout:t.socksTimeout});const{port:n,path:r}=t,s=t.hostname;return a("port %d and host %s",n,s),i.default.createConnection({port:n,host:s,path:r})}},823(e,t,n){"use strict";const r=globalThis.AbortController||n(6584).AbortController,{codes:{ERR_INVALID_ARG_VALUE:i,ERR_INVALID_ARG_TYPE:s,ERR_MISSING_ARGS:o,ERR_OUT_OF_RANGE:a},AbortError:c}=n(6371),{validateAbortSignal:l,validateInteger:d,validateObject:u}=n(277),h=n(4134).Symbol("kWeak"),p=n(4134).Symbol("kResistStopPropagation"),{finished:f}=n(6238),g=n(7830),{addAbortSignalNoValidate:m}=n(4147),{isWritable:y,isNodeStream:b}=n(6115),{deprecate:v}=n(7760),{ArrayPrototypePush:S,Boolean:_,MathFloor:w,Number:k,NumberIsNaN:I,Promise:E,PromiseReject:x,PromiseResolve:T,PromisePrototypeThen:C,Symbol:O}=n(4134),A=O("kEmpty"),P=O("kEof");function R(e,t){if("function"!=typeof e)throw new s("fn",["Function","AsyncFunction"],e);null!=t&&u(t,"options"),null!=(null==t?void 0:t.signal)&&l(t.signal,"options.signal");let r=1;null!=(null==t?void 0:t.concurrency)&&(r=w(t.concurrency));let i=r-1;return null!=(null==t?void 0:t.highWaterMark)&&(i=w(t.highWaterMark)),d(r,"options.concurrency",1),d(i,"options.highWaterMark",0),i+=r,async function*(){const s=n(7760).AbortSignalAny([null==t?void 0:t.signal].filter(_)),o=this,a=[],l={signal:s};let d,u,h=!1,p=0;function f(){h=!0,g()}function g(){p-=1,m()}function m(){u&&!h&&p<r&&a.length<i&&(u(),u=null)}!async function(){try{for await(let t of o){if(h)return;if(s.aborted)throw new c;try{if(t=e(t,l),t===A)continue;t=T(t)}catch(e){t=x(e)}p+=1,C(t,g,f),a.push(t),d&&(d(),d=null),!h&&(a.length>=i||p>=r)&&await new E(e=>{u=e})}a.push(P)}catch(e){const t=x(e);C(t,g,f),a.push(t)}finally{h=!0,d&&(d(),d=null)}}();try{for(;;){for(;a.length>0;){const e=await a[0];if(e===P)return;if(s.aborted)throw new c;e!==A&&(yield e),a.shift(),m()}await new E(e=>{d=e})}}finally{h=!0,u&&(u(),u=null)}}.call(this)}async function M(e,t=void 0){for await(const n of N.call(this,e,t))return!0;return!1}function N(e,t){if("function"!=typeof e)throw new s("fn",["Function","AsyncFunction"],e);return R.call(this,async function(t,n){return await e(t,n)?t:A},t)}class B extends o{constructor(){super("reduce"),this.message="Reduce of an empty stream requires an initial value"}}function L(e){if(e=k(e),I(e))return 0;if(e<0)throw new a("number",">= 0",e);return e}e.exports.streamReturningOperators={asIndexedPairs:v(function(e=void 0){return null!=e&&u(e,"options"),null!=(null==e?void 0:e.signal)&&l(e.signal,"options.signal"),async function*(){let t=0;for await(const r of this){var n;if(null!=e&&null!==(n=e.signal)&&void 0!==n&&n.aborted)throw new c({cause:e.signal.reason});yield[t++,r]}}.call(this)},"readable.asIndexedPairs will be removed in a future version."),drop:function(e,t=void 0){return null!=t&&u(t,"options"),null!=(null==t?void 0:t.signal)&&l(t.signal,"options.signal"),e=L(e),async function*(){var n;if(null!=t&&null!==(n=t.signal)&&void 0!==n&&n.aborted)throw new c;for await(const n of this){var r;if(null!=t&&null!==(r=t.signal)&&void 0!==r&&r.aborted)throw new c;e--<=0&&(yield n)}}.call(this)},filter:N,flatMap:function(e,t){const n=R.call(this,e,t);return async function*(){for await(const e of n)yield*e}.call(this)},map:R,take:function(e,t=void 0){return null!=t&&u(t,"options"),null!=(null==t?void 0:t.signal)&&l(t.signal,"options.signal"),e=L(e),async function*(){var n;if(null!=t&&null!==(n=t.signal)&&void 0!==n&&n.aborted)throw new c;for await(const n of this){var r;if(null!=t&&null!==(r=t.signal)&&void 0!==r&&r.aborted)throw new c;if(e-- >0&&(yield n),e<=0)return}}.call(this)},compose:function(e,t){if(null!=t&&u(t,"options"),null!=(null==t?void 0:t.signal)&&l(t.signal,"options.signal"),b(e)&&!y(e))throw new i("stream",e,"must be writable");const n=g(this,e);return null!=t&&t.signal&&m(t.signal,n),n}},e.exports.promiseReturningOperators={every:async function(e,t=void 0){if("function"!=typeof e)throw new s("fn",["Function","AsyncFunction"],e);return!await M.call(this,async(...t)=>!await e(...t),t)},forEach:async function(e,t){if("function"!=typeof e)throw new s("fn",["Function","AsyncFunction"],e);for await(const n of R.call(this,async function(t,n){return await e(t,n),A},t));},reduce:async function(e,t,n){var i;if("function"!=typeof e)throw new s("reducer",["Function","AsyncFunction"],e);null!=n&&u(n,"options"),null!=(null==n?void 0:n.signal)&&l(n.signal,"options.signal");let o=arguments.length>1;if(null!=n&&null!==(i=n.signal)&&void 0!==i&&i.aborted){const e=new c(void 0,{cause:n.signal.reason});throw this.once("error",()=>{}),await f(this.destroy(e)),e}const a=new r,d=a.signal;if(null!=n&&n.signal){const e={once:!0,[h]:this,[p]:!0};n.signal.addEventListener("abort",()=>a.abort(),e)}let g=!1;try{for await(const r of this){var m;if(g=!0,null!=n&&null!==(m=n.signal)&&void 0!==m&&m.aborted)throw new c;o?t=await e(t,r,{signal:d}):(t=r,o=!0)}if(!g&&!o)throw new B}finally{a.abort()}return t},toArray:async function(e){null!=e&&u(e,"options"),null!=(null==e?void 0:e.signal)&&l(e.signal,"options.signal");const t=[];for await(const r of this){var n;if(null!=e&&null!==(n=e.signal)&&void 0!==n&&n.aborted)throw new c(void 0,{cause:e.signal.reason});S(t,r)}return t},some:M,find:async function(e,t){for await(const n of N.call(this,e,t))return n}}},837(e,t){"use strict";function n(e){return e.toString(16).padStart(2,"0")}Object.defineProperty(t,"__esModule",{value:!0}),t.isInSubnet=function(e){if(this.subnetMask<e.subnetMask)return!1;if(this.mask(e.subnetMask)===e.mask())return!0;return!1},t.isCorrect=function(e){return function(){return this.addressMinusSuffix===this.correctForm()&&(this.subnetMask===e&&!this.parsedSubnet||this.parsedSubnet===String(this.subnetMask))}},t.numberToPaddedHex=n,t.stringToPaddedHex=function(e){return n(parseInt(e,10))},t.testBit=function(e,t){const{length:n}=e;if(t>n)return!1;const r=n-t;return"1"===e.substring(r,r+1)}},857(e){"use strict";e.exports=require("os")},914(e,t,n){"use strict";const{Duplex:r}=n(2203),{randomFillSync:i}=n(6982),s=n(2971),{EMPTY_BUFFER:o,kWebSocket:a,NOOP:c}=n(2614),{isBlob:l,isValidStatusCode:d}=n(5880),{mask:u,toBuffer:h}=n(3338),p=Symbol("kByteLength"),f=Buffer.alloc(4),g=8192;let m,y=g;class b{constructor(e,t,n){this._extensions=t||{},n&&(this._generateMask=n,this._maskBuffer=Buffer.alloc(4)),this._socket=e,this._firstFragment=!0,this._compress=!1,this._bufferedBytes=0,this._queue=[],this._state=0,this.onerror=c,this[a]=void 0}static frame(e,t){let n,r,s=!1,o=2,a=!1;t.mask&&(n=t.maskBuffer||f,t.generateMask?t.generateMask(n):(y===g&&(void 0===m&&(m=Buffer.alloc(g)),i(m,0,g),y=0),n[0]=m[y++],n[1]=m[y++],n[2]=m[y++],n[3]=m[y++]),a=0===(n[0]|n[1]|n[2]|n[3]),o=6),"string"==typeof e?r=t.mask&&!a||void 0===t[p]?(e=Buffer.from(e)).length:t[p]:(r=e.length,s=t.mask&&t.readOnly&&!a);let c=r;r>=65536?(o+=8,c=127):r>125&&(o+=2,c=126);const l=Buffer.allocUnsafe(s?r+o:o);return l[0]=t.fin?128|t.opcode:t.opcode,t.rsv1&&(l[0]|=64),l[1]=c,126===c?l.writeUInt16BE(r,2):127===c&&(l[2]=l[3]=0,l.writeUIntBE(r,4,6)),t.mask?(l[1]|=128,l[o-4]=n[0],l[o-3]=n[1],l[o-2]=n[2],l[o-1]=n[3],a?[l,e]:s?(u(e,n,l,o,r),[l]):(u(e,n,e,0,r),[l,e])):[l,e]}close(e,t,n,r){let i;if(void 0===e)i=o;else{if("number"!=typeof e||!d(e))throw new TypeError("First argument must be a valid error code number");if(void 0!==t&&t.length){const n=Buffer.byteLength(t);if(n>123)throw new RangeError("The message must not be greater than 123 bytes");i=Buffer.allocUnsafe(2+n),i.writeUInt16BE(e,0),"string"==typeof t?i.write(t,2):i.set(t,2)}else i=Buffer.allocUnsafe(2),i.writeUInt16BE(e,0)}const s={[p]:i.length,fin:!0,generateMask:this._generateMask,mask:n,maskBuffer:this._maskBuffer,opcode:8,readOnly:!1,rsv1:!1};0!==this._state?this.enqueue([this.dispatch,i,!1,s,r]):this.sendFrame(b.frame(i,s),r)}ping(e,t,n){let r,i;if("string"==typeof e?(r=Buffer.byteLength(e),i=!1):l(e)?(r=e.size,i=!1):(r=(e=h(e)).length,i=h.readOnly),r>125)throw new RangeError("The data size must not be greater than 125 bytes");const s={[p]:r,fin:!0,generateMask:this._generateMask,mask:t,maskBuffer:this._maskBuffer,opcode:9,readOnly:i,rsv1:!1};l(e)?0!==this._state?this.enqueue([this.getBlobData,e,!1,s,n]):this.getBlobData(e,!1,s,n):0!==this._state?this.enqueue([this.dispatch,e,!1,s,n]):this.sendFrame(b.frame(e,s),n)}pong(e,t,n){let r,i;if("string"==typeof e?(r=Buffer.byteLength(e),i=!1):l(e)?(r=e.size,i=!1):(r=(e=h(e)).length,i=h.readOnly),r>125)throw new RangeError("The data size must not be greater than 125 bytes");const s={[p]:r,fin:!0,generateMask:this._generateMask,mask:t,maskBuffer:this._maskBuffer,opcode:10,readOnly:i,rsv1:!1};l(e)?0!==this._state?this.enqueue([this.getBlobData,e,!1,s,n]):this.getBlobData(e,!1,s,n):0!==this._state?this.enqueue([this.dispatch,e,!1,s,n]):this.sendFrame(b.frame(e,s),n)}send(e,t,n){const r=this._extensions[s.extensionName];let i,o,a=t.binary?2:1,c=t.compress;"string"==typeof e?(i=Buffer.byteLength(e),o=!1):l(e)?(i=e.size,o=!1):(i=(e=h(e)).length,o=h.readOnly),this._firstFragment?(this._firstFragment=!1,c&&r&&r.params[r._isServer?"server_no_context_takeover":"client_no_context_takeover"]&&(c=i>=r._threshold),this._compress=c):(c=!1,a=0),t.fin&&(this._firstFragment=!0);const d={[p]:i,fin:t.fin,generateMask:this._generateMask,mask:t.mask,maskBuffer:this._maskBuffer,opcode:a,readOnly:o,rsv1:c};l(e)?0!==this._state?this.enqueue([this.getBlobData,e,this._compress,d,n]):this.getBlobData(e,this._compress,d,n):0!==this._state?this.enqueue([this.dispatch,e,this._compress,d,n]):this.dispatch(e,this._compress,d,n)}getBlobData(e,t,n,r){this._bufferedBytes+=n[p],this._state=2,e.arrayBuffer().then(e=>{if(this._socket.destroyed){const e=new Error("The socket was closed while the blob was being read");return void process.nextTick(v,this,e,r)}this._bufferedBytes-=n[p];const i=h(e);t?this.dispatch(i,t,n,r):(this._state=0,this.sendFrame(b.frame(i,n),r),this.dequeue())}).catch(e=>{process.nextTick(S,this,e,r)})}dispatch(e,t,n,r){if(!t)return void this.sendFrame(b.frame(e,n),r);const i=this._extensions[s.extensionName];this._bufferedBytes+=n[p],this._state=1,i.compress(e,n.fin,(e,t)=>{if(this._socket.destroyed){return void v(this,new Error("The socket was closed while data was being compressed"),r)}this._bufferedBytes-=n[p],this._state=0,n.readOnly=!1,this.sendFrame(b.frame(t,n),r),this.dequeue()})}dequeue(){for(;0===this._state&&this._queue.length;){const e=this._queue.shift();this._bufferedBytes-=e[3][p],Reflect.apply(e[0],this,e.slice(1))}}enqueue(e){this._bufferedBytes+=e[3][p],this._queue.push(e)}sendFrame(e,t){2===e.length?(this._socket.cork(),this._socket.write(e[0]),this._socket.write(e[1],t),this._socket.uncork()):this._socket.write(e[0],t)}}function v(e,t,n){"function"==typeof n&&n(t);for(let n=0;n<e._queue.length;n++){const r=e._queue[n],i=r[r.length-1];"function"==typeof i&&i(t)}}function S(e,t,n){v(e,t,n),e.onerror(t)}e.exports=b},1021(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ReasonCodes=void 0;const r=n(4723);t.ReasonCodes={0:"",1:"Unacceptable protocol version",2:"Identifier rejected",3:"Server unavailable",4:"Bad username or password",5:"Not authorized",16:"No matching subscribers",17:"No subscription existed",128:"Unspecified error",129:"Malformed Packet",130:"Protocol Error",131:"Implementation specific error",132:"Unsupported Protocol Version",133:"Client Identifier not valid",134:"Bad User Name or Password",135:"Not authorized",136:"Server unavailable",137:"Server busy",138:"Banned",139:"Server shutting down",140:"Bad authentication method",141:"Keep Alive timeout",142:"Session taken over",143:"Topic Filter invalid",144:"Topic Name invalid",145:"Packet identifier in use",146:"Packet Identifier not found",147:"Receive Maximum exceeded",148:"Topic Alias invalid",149:"Packet too large",150:"Message rate too high",151:"Quota exceeded",152:"Administrative action",153:"Payload format invalid",154:"Retain not supported",155:"QoS not supported",156:"Use another server",157:"Server moved",158:"Shared Subscriptions not supported",159:"Connection rate exceeded",160:"Maximum connect time",161:"Subscription Identifiers not supported",162:"Wildcard Subscriptions not supported"};t.default=(e,n)=>{const{messageId:i}=n,s=n.cmd;let o=null;const a=e.outgoing[i]?e.outgoing[i].cb:null;let c=null;if(a){switch(e.log("_handleAck :: packet type",s),s){case"pubcomp":case"puback":{const s=n.reasonCode;s&&s>0&&16!==s?(c=new r.ErrorWithReasonCode(`Publish error: ${t.ReasonCodes[s]}`,s),e._removeOutgoingAndStoreMessage(i,()=>{a(c,n)})):e._removeOutgoingAndStoreMessage(i,a);break}case"pubrec":{o={cmd:"pubrel",qos:2,messageId:i};const s=n.reasonCode;s&&s>0&&16!==s?(c=new r.ErrorWithReasonCode(`Publish error: ${t.ReasonCodes[s]}`,s),e._removeOutgoingAndStoreMessage(i,()=>{a(c,n)})):e._sendPacket(o);break}case"suback":{delete e.outgoing[i],e.messageIdProvider.deallocate(i);const r=n.granted;for(let n=0;n<r.length;n++){const s=r[n];if(128&s){c=new Error(`Subscribe error: ${t.ReasonCodes[s]}`),c.code=s;const n=e.messageIdToTopic[i];n&&n.forEach(t=>{delete e._resubscribeTopics[t]})}}delete e.messageIdToTopic[i],e._invokeStoreProcessingQueue(),a(c,n);break}case"unsuback":delete e.outgoing[i],e.messageIdProvider.deallocate(i),e._invokeStoreProcessingQueue(),a(null,n);break;default:e.emit("error",new Error("unrecognized packet type"))}e.disconnecting&&0===Object.keys(e.outgoing).length&&e.emit("outgoingEmpty")}else e.log("_handleAck :: Server sent an ack in error. Ignoring.")}},1060(e,t,n){"use strict";const r=n(4434),i=n(5692),s=n(8611),o=n(9278),a=n(4756),{randomBytes:c,createHash:l}=n(6982),{Duplex:d,Readable:u}=n(2203),{URL:h}=n(7016),p=n(2971),f=n(6286),g=n(914),{isBlob:m}=n(5880),{BINARY_TYPES:y,EMPTY_BUFFER:b,GUID:v,kForOnEventAttribute:S,kListener:_,kStatusCode:w,kWebSocket:k,NOOP:I}=n(2614),{EventTarget:{addEventListener:E,removeEventListener:x}}=n(597),{format:T,parse:C}=n(5926),{toBuffer:O}=n(3338),A=Symbol("kAborted"),P=[8,13],R=["CONNECTING","OPEN","CLOSING","CLOSED"],M=/^[!#$%&'*+\-.0-9A-Z^_`|a-z~]+$/;class N extends r{constructor(e,t,n){super(),this._binaryType=y[0],this._closeCode=1006,this._closeFrameReceived=!1,this._closeFrameSent=!1,this._closeMessage=b,this._closeTimer=null,this._errorEmitted=!1,this._extensions={},this._paused=!1,this._protocol="",this._readyState=N.CONNECTING,this._receiver=null,this._sender=null,this._socket=null,null!==e?(this._bufferedAmount=0,this._isServer=!1,this._redirects=0,void 0===t?t=[]:Array.isArray(t)||("object"==typeof t&&null!==t?(n=t,t=[]):t=[t]),B(this,e,t,n)):(this._autoPong=n.autoPong,this._isServer=!0)}get binaryType(){return this._binaryType}set binaryType(e){y.includes(e)&&(this._binaryType=e,this._receiver&&(this._receiver._binaryType=e))}get bufferedAmount(){return this._socket?this._socket._writableState.length+this._sender._bufferedBytes:this._bufferedAmount}get extensions(){return Object.keys(this._extensions).join()}get isPaused(){return this._paused}get onclose(){return null}get onerror(){return null}get onopen(){return null}get onmessage(){return null}get protocol(){return this._protocol}get readyState(){return this._readyState}get url(){return this._url}setSocket(e,t,n){const r=new f({allowSynchronousEvents:n.allowSynchronousEvents,binaryType:this.binaryType,extensions:this._extensions,isServer:this._isServer,maxPayload:n.maxPayload,skipUTF8Validation:n.skipUTF8Validation}),i=new g(e,this._extensions,n.generateMask);this._receiver=r,this._sender=i,this._socket=e,r[k]=this,i[k]=this,e[k]=this,r.on("conclude",$),r.on("drain",W),r.on("error",V),r.on("message",H),r.on("ping",q),r.on("pong",G),i.onerror=J,e.setTimeout&&e.setTimeout(0),e.setNoDelay&&e.setNoDelay(),t.length>0&&e.unshift(t),e.on("close",Y),e.on("data",Z),e.on("end",X),e.on("error",ee),this._readyState=N.OPEN,this.emit("open")}emitClose(){if(!this._socket)return this._readyState=N.CLOSED,void this.emit("close",this._closeCode,this._closeMessage);this._extensions[p.extensionName]&&this._extensions[p.extensionName].cleanup(),this._receiver.removeAllListeners(),this._readyState=N.CLOSED,this.emit("close",this._closeCode,this._closeMessage)}close(e,t){if(this.readyState!==N.CLOSED){if(this.readyState===N.CONNECTING){const e="WebSocket was closed before the connection was established";return void U(this,this._req,e)}this.readyState!==N.CLOSING?(this._readyState=N.CLOSING,this._sender.close(e,t,!this._isServer,e=>{e||(this._closeFrameSent=!0,(this._closeFrameReceived||this._receiver._writableState.errorEmitted)&&this._socket.end())}),Q(this)):this._closeFrameSent&&(this._closeFrameReceived||this._receiver._writableState.errorEmitted)&&this._socket.end()}}pause(){this.readyState!==N.CONNECTING&&this.readyState!==N.CLOSED&&(this._paused=!0,this._socket.pause())}ping(e,t,n){if(this.readyState===N.CONNECTING)throw new Error("WebSocket is not open: readyState 0 (CONNECTING)");"function"==typeof e?(n=e,e=t=void 0):"function"==typeof t&&(n=t,t=void 0),"number"==typeof e&&(e=e.toString()),this.readyState===N.OPEN?(void 0===t&&(t=!this._isServer),this._sender.ping(e||b,t,n)):F(this,e,n)}pong(e,t,n){if(this.readyState===N.CONNECTING)throw new Error("WebSocket is not open: readyState 0 (CONNECTING)");"function"==typeof e?(n=e,e=t=void 0):"function"==typeof t&&(n=t,t=void 0),"number"==typeof e&&(e=e.toString()),this.readyState===N.OPEN?(void 0===t&&(t=!this._isServer),this._sender.pong(e||b,t,n)):F(this,e,n)}resume(){this.readyState!==N.CONNECTING&&this.readyState!==N.CLOSED&&(this._paused=!1,this._receiver._writableState.needDrain||this._socket.resume())}send(e,t,n){if(this.readyState===N.CONNECTING)throw new Error("WebSocket is not open: readyState 0 (CONNECTING)");if("function"==typeof t&&(n=t,t={}),"number"==typeof e&&(e=e.toString()),this.readyState!==N.OPEN)return void F(this,e,n);const r={binary:"string"!=typeof e,mask:!this._isServer,compress:!0,fin:!0,...t};this._extensions[p.extensionName]||(r.compress=!1),this._sender.send(e||b,r,n)}terminate(){if(this.readyState!==N.CLOSED){if(this.readyState===N.CONNECTING){const e="WebSocket was closed before the connection was established";return void U(this,this._req,e)}this._socket&&(this._readyState=N.CLOSING,this._socket.destroy())}}}function B(e,t,n,r){const o={allowSynchronousEvents:!0,autoPong:!0,protocolVersion:P[1],maxPayload:104857600,skipUTF8Validation:!1,perMessageDeflate:!0,followRedirects:!1,maxRedirects:10,...r,socketPath:void 0,hostname:void 0,protocol:void 0,timeout:void 0,method:"GET",host:void 0,path:void 0,port:void 0};if(e._autoPong=o.autoPong,!P.includes(o.protocolVersion))throw new RangeError(`Unsupported protocol version: ${o.protocolVersion} (supported versions: ${P.join(", ")})`);let a;if(t instanceof h)a=t;else try{a=new h(t)}catch(e){throw new SyntaxError(`Invalid URL: ${t}`)}"http:"===a.protocol?a.protocol="ws:":"https:"===a.protocol&&(a.protocol="wss:"),e._url=a.href;const d="wss:"===a.protocol,u="ws+unix:"===a.protocol;let f;if("ws:"===a.protocol||d||u?u&&!a.pathname?f="The URL's pathname is empty":a.hash&&(f="The URL contains a fragment identifier"):f='The URL\'s protocol must be one of "ws:", "wss:", "http:", "https:", or "ws+unix:"',f){const t=new SyntaxError(f);if(0===e._redirects)throw t;return void L(e,t)}const g=d?443:80,m=c(16).toString("base64"),y=d?i.request:s.request,b=new Set;let S,_;if(o.createConnection=o.createConnection||(d?D:j),o.defaultPort=o.defaultPort||g,o.port=a.port||g,o.host=a.hostname.startsWith("[")?a.hostname.slice(1,-1):a.hostname,o.headers={...o.headers,"Sec-WebSocket-Version":o.protocolVersion,"Sec-WebSocket-Key":m,Connection:"Upgrade",Upgrade:"websocket"},o.path=a.pathname+a.search,o.timeout=o.handshakeTimeout,o.perMessageDeflate&&(S=new p(!0!==o.perMessageDeflate?o.perMessageDeflate:{},!1,o.maxPayload),o.headers["Sec-WebSocket-Extensions"]=T({[p.extensionName]:S.offer()})),n.length){for(const e of n){if("string"!=typeof e||!M.test(e)||b.has(e))throw new SyntaxError("An invalid or duplicated subprotocol was specified");b.add(e)}o.headers["Sec-WebSocket-Protocol"]=n.join(",")}if(o.origin&&(o.protocolVersion<13?o.headers["Sec-WebSocket-Origin"]=o.origin:o.headers.Origin=o.origin),(a.username||a.password)&&(o.auth=`${a.username}:${a.password}`),u){const e=o.path.split(":");o.socketPath=e[0],o.path=e[1]}if(o.followRedirects){if(0===e._redirects){e._originalIpc=u,e._originalSecure=d,e._originalHostOrSocketPath=u?o.socketPath:a.host;const t=r&&r.headers;if(r={...r,headers:{}},t)for(const[e,n]of Object.entries(t))r.headers[e.toLowerCase()]=n}else if(0===e.listenerCount("redirect")){const t=u?!!e._originalIpc&&o.socketPath===e._originalHostOrSocketPath:!e._originalIpc&&a.host===e._originalHostOrSocketPath;(!t||e._originalSecure&&!d)&&(delete o.headers.authorization,delete o.headers.cookie,t||delete o.headers.host,o.auth=void 0)}o.auth&&!r.headers.authorization&&(r.headers.authorization="Basic "+Buffer.from(o.auth).toString("base64")),_=e._req=y(o),e._redirects&&e.emit("redirect",e.url,_)}else _=e._req=y(o);o.timeout&&_.on("timeout",()=>{U(e,_,"Opening handshake has timed out")}),_.on("error",t=>{null===_||_[A]||(_=e._req=null,L(e,t))}),_.on("response",i=>{const s=i.headers.location,a=i.statusCode;if(s&&o.followRedirects&&a>=300&&a<400){if(++e._redirects>o.maxRedirects)return void U(e,_,"Maximum redirects exceeded");let i;_.abort();try{i=new h(s,t)}catch(t){const n=new SyntaxError(`Invalid URL: ${s}`);return void L(e,n)}B(e,i,n,r)}else e.emit("unexpected-response",_,i)||U(e,_,`Unexpected server response: ${i.statusCode}`)}),_.on("upgrade",(t,n,r)=>{if(e.emit("upgrade",t),e.readyState!==N.CONNECTING)return;_=e._req=null;const i=t.headers.upgrade;if(void 0===i||"websocket"!==i.toLowerCase())return void U(e,n,"Invalid Upgrade header");const s=l("sha1").update(m+v).digest("base64");if(t.headers["sec-websocket-accept"]!==s)return void U(e,n,"Invalid Sec-WebSocket-Accept header");const a=t.headers["sec-websocket-protocol"];let c;if(void 0!==a?b.size?b.has(a)||(c="Server sent an invalid subprotocol"):c="Server sent a subprotocol but none was requested":b.size&&(c="Server sent no subprotocol"),c)return void U(e,n,c);a&&(e._protocol=a);const d=t.headers["sec-websocket-extensions"];if(void 0!==d){if(!S){return void U(e,n,"Server sent a Sec-WebSocket-Extensions header but no extension was requested")}let t;try{t=C(d)}catch(t){return void U(e,n,"Invalid Sec-WebSocket-Extensions header")}const r=Object.keys(t);if(1!==r.length||r[0]!==p.extensionName){return void U(e,n,"Server indicated an extension that was not requested")}try{S.accept(t[p.extensionName])}catch(t){return void U(e,n,"Invalid Sec-WebSocket-Extensions header")}e._extensions[p.extensionName]=S}e.setSocket(n,r,{allowSynchronousEvents:o.allowSynchronousEvents,generateMask:o.generateMask,maxPayload:o.maxPayload,skipUTF8Validation:o.skipUTF8Validation})}),o.finishRequest?o.finishRequest(_,e):_.end()}function L(e,t){e._readyState=N.CLOSING,e._errorEmitted=!0,e.emit("error",t),e.emitClose()}function j(e){return e.path=e.socketPath,o.connect(e)}function D(e){return e.path=void 0,e.servername||""===e.servername||(e.servername=o.isIP(e.host)?"":e.host),a.connect(e)}function U(e,t,n){e._readyState=N.CLOSING;const r=new Error(n);Error.captureStackTrace(r,U),t.setHeader?(t[A]=!0,t.abort(),t.socket&&!t.socket.destroyed&&t.socket.destroy(),process.nextTick(L,e,r)):(t.destroy(r),t.once("error",e.emit.bind(e,"error")),t.once("close",e.emitClose.bind(e)))}function F(e,t,n){if(t){const n=m(t)?t.size:O(t).length;e._socket?e._sender._bufferedBytes+=n:e._bufferedAmount+=n}if(n){const t=new Error(`WebSocket is not open: readyState ${e.readyState} (${R[e.readyState]})`);process.nextTick(n,t)}}function $(e,t){const n=this[k];n._closeFrameReceived=!0,n._closeMessage=t,n._closeCode=e,void 0!==n._socket[k]&&(n._socket.removeListener("data",Z),process.nextTick(K,n._socket),1005===e?n.close():n.close(e,t))}function W(){const e=this[k];e.isPaused||e._socket.resume()}function V(e){const t=this[k];void 0!==t._socket[k]&&(t._socket.removeListener("data",Z),process.nextTick(K,t._socket),t.close(e[w])),t._errorEmitted||(t._errorEmitted=!0,t.emit("error",e))}function z(){this[k].emitClose()}function H(e,t){this[k].emit("message",e,t)}function q(e){const t=this[k];t._autoPong&&t.pong(e,!this._isServer,I),t.emit("ping",e)}function G(e){this[k].emit("pong",e)}function K(e){e.resume()}function J(e){const t=this[k];t.readyState!==N.CLOSED&&(t.readyState===N.OPEN&&(t._readyState=N.CLOSING,Q(t)),this._socket.end(),t._errorEmitted||(t._errorEmitted=!0,t.emit("error",e)))}function Q(e){e._closeTimer=setTimeout(e._socket.destroy.bind(e._socket),3e4)}function Y(){const e=this[k];let t;this.removeListener("close",Y),this.removeListener("data",Z),this.removeListener("end",X),e._readyState=N.CLOSING,this._readableState.endEmitted||e._closeFrameReceived||e._receiver._writableState.errorEmitted||null===(t=e._socket.read())||e._receiver.write(t),e._receiver.end(),this[k]=void 0,clearTimeout(e._closeTimer),e._receiver._writableState.finished||e._receiver._writableState.errorEmitted?e.emitClose():(e._receiver.on("error",z),e._receiver.on("finish",z))}function Z(e){this[k]._receiver.write(e)||this.pause()}function X(){const e=this[k];e._readyState=N.CLOSING,e._receiver.end(),this.end()}function ee(){const e=this[k];this.removeListener("error",ee),this.on("error",I),e&&(e._readyState=N.CLOSING,this.destroy())}Object.defineProperty(N,"CONNECTING",{enumerable:!0,value:R.indexOf("CONNECTING")}),Object.defineProperty(N.prototype,"CONNECTING",{enumerable:!0,value:R.indexOf("CONNECTING")}),Object.defineProperty(N,"OPEN",{enumerable:!0,value:R.indexOf("OPEN")}),Object.defineProperty(N.prototype,"OPEN",{enumerable:!0,value:R.indexOf("OPEN")}),Object.defineProperty(N,"CLOSING",{enumerable:!0,value:R.indexOf("CLOSING")}),Object.defineProperty(N.prototype,"CLOSING",{enumerable:!0,value:R.indexOf("CLOSING")}),Object.defineProperty(N,"CLOSED",{enumerable:!0,value:R.indexOf("CLOSED")}),Object.defineProperty(N.prototype,"CLOSED",{enumerable:!0,value:R.indexOf("CLOSED")}),["binaryType","bufferedAmount","extensions","isPaused","protocol","readyState","url"].forEach(e=>{Object.defineProperty(N.prototype,e,{enumerable:!0})}),["open","error","close","message"].forEach(e=>{Object.defineProperty(N.prototype,`on${e}`,{enumerable:!0,get(){for(const t of this.listeners(e))if(t[S])return t[_];return null},set(t){for(const t of this.listeners(e))if(t[S]){this.removeListener(e,t);break}"function"==typeof t&&this.addEventListener(e,t,{[S]:!0})}})}),N.prototype.addEventListener=E,N.prototype.removeEventListener=x,e.exports=N},1278(e,t,n){t.parser=n(3079).parser,t.generate=n(2535),t.writeToStream=n(3132)},1554(e,t){"use strict";function n(e,t){return e.cameras.find(e=>e.deviceId===t)}function r(e,t){return e.landmarks?.find(e=>e.id===t)}function i(e,t,n){return e.connections.filter(e=>e.fromCameraId===t&&e.toCameraId===n||e.bidirectional&&e.fromCameraId===n&&e.toCameraId===t)[0]}function s(e,t){const i=n(e,t);return i?.context?.visibleLandmarks?i.context.visibleLandmarks.map(t=>r(e,t)).filter(e=>void 0!==e):[]}function o(e,t){const n=t.x-e.x,r=t.y-e.y;return Math.sqrt(n*n+r*r)}Object.defineProperty(t,"__esModule",{value:!0}),t.LANDMARK_TEMPLATES=void 0,t.createEmptyTopology=function(){return{version:"2.0",cameras:[],connections:[],landmarks:[],relationships:[],globalZones:[]}},t.findCamera=n,t.findLandmark=r,t.findConnectionsFrom=function(e,t){return e.connections.filter(e=>e.fromCameraId===t||e.bidirectional&&e.toCameraId===t)},t.findConnection=i,t.getEntryPoints=function(e){return e.cameras.filter(e=>e.isEntryPoint)},t.getExitPoints=function(e){return e.cameras.filter(e=>e.isExitPoint)},t.getLandmarksVisibleFromCamera=s,t.getCamerasWithLandmarkVisibility=function(e,t){return e.cameras.filter(e=>e.context?.visibleLandmarks?.includes(t))},t.getAdjacentLandmarks=function(e,t){const n=r(e,t);return n?.adjacentTo?n.adjacentTo.map(t=>r(e,t)).filter(e=>void 0!==e):[]},t.calculateDistance=o,t.inferRelationships=function(e,t=50){const n=[],r=[];for(const t of e.cameras)t.floorPlanPosition&&r.push({id:t.deviceId,position:t.floorPlanPosition,type:"camera"});for(const t of e.landmarks||[])r.push({id:t.id,position:t.position,type:"landmark"});for(let e=0;e<r.length;e++)for(let i=e+1;i<r.length;i++){const s=o(r[e].position,r[i].position);s<=t&&n.push({id:`auto_${r[e].id}_${r[i].id}`,type:s<=t/2?"adjacent":"near",entityA:r[e].id,entityB:r[i].id,autoInferred:!0})}return n},t.generateTopologyDescription=function(e){const t=[];e.property?.description&&t.push(`Property: ${e.property.description}`);e.property?.frontFacing&&t.push(`Front of property faces ${e.property.frontFacing}.`);if(e.landmarks?.length>0){t.push("\nLandmarks on property:");for(const n of e.landmarks||[]){let e=`- ${n.name} (${n.type})`;n.description&&(e+=`: ${n.description}`),n.isEntryPoint&&(e+=" [Entry point]"),n.isExitPoint&&(e+=" [Exit point]"),t.push(e)}}if(e.cameras.length>0){t.push("\nCamera coverage:");for(const n of e.cameras){let i=`- ${n.name}`;if(n.context?.mountLocation&&(i+=` (mounted at ${n.context.mountLocation})`),n.context?.coverageDescription&&(i+=`: ${n.context.coverageDescription}`),n.isEntryPoint&&(i+=" [Watches entry point]"),n.isExitPoint&&(i+=" [Watches exit point]"),n.context?.visibleLandmarks&&n.context.visibleLandmarks.length>0){const t=n.context.visibleLandmarks.map(t=>r(e,t)?.name).filter(Boolean);t.length>0&&(i+=` Can see: ${t.join(", ")}`)}t.push(i)}}if(e.connections.length>0){t.push("\nMovement paths:");for(const r of e.connections){const i=n(e,r.fromCameraId),s=n(e,r.toCameraId);if(i&&s){let e=`- ${i.name} → ${s.name}`;r.name&&(e+=` (${r.name})`),e+=` [${r.transitTime.min/1e3}-${r.transitTime.max/1e3}s transit]`,r.bidirectional&&(e+=" [bidirectional]"),t.push(e)}}}return t.join("\n")},t.generateMovementContext=function(e,t,o,a){const c=n(e,t),l=n(e,o),d=i(e,t,o);if(!c||!l)return`${a} moving between cameras`;const u=[];u.push(`Origin: ${c.name}`),c.context?.coverageDescription&&u.push(`  Coverage: ${c.context.coverageDescription}`);u.push(`Destination: ${l.name}`),l.context?.coverageDescription&&u.push(`  Coverage: ${l.context.coverageDescription}`);if(d&&(d.name&&u.push(`Path: ${d.name}`),d.pathLandmarks&&d.pathLandmarks.length>0)){const t=d.pathLandmarks.map(t=>r(e,t)?.name).filter(Boolean);t.length>0&&u.push(`Passing: ${t.join(" → ")}`)}const h=s(e,o);h.length>0&&u.push(`Near: ${h.map(e=>e.name).join(", ")}`);return u.join("\n")},t.LANDMARK_TEMPLATES=[{type:"structure",suggestions:["House","Garage","Shed","Porch","Deck","Patio","Gazebo","Pool House"]},{type:"feature",suggestions:["Mailbox","Tree","Firepit","Pool","Hot Tub","Garden","Fountain","Flagpole"]},{type:"boundary",suggestions:["Front Fence","Back Fence","Side Fence","Hedge","Wall","Property Line"]},{type:"access",suggestions:["Driveway","Front Walkway","Back Walkway","Front Door","Back Door","Side Door","Gate","Stairs"]},{type:"vehicle",suggestions:["Car Parking","Boat","RV Pad","Motorcycle Spot"]},{type:"neighbor",suggestions:["Neighbor's House","Neighbor's Driveway","Neighbor's Yard"]},{type:"zone",suggestions:["Front Yard","Back Yard","Side Yard","Courtyard"]},{type:"street",suggestions:["Street","Sidewalk","Alley","Cul-de-sac"]}]},1676(e,t,n){"use strict";var r,i=this&&this.__createBinding||(Object.create?function(e,t,n,r){void 0===r&&(r=n);var i=Object.getOwnPropertyDescriptor(t,n);i&&!("get"in i?!t.__esModule:i.writable||i.configurable)||(i={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,r,i)}:function(e,t,n,r){void 0===r&&(r=n),e[r]=t[n]}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),o=this&&this.__importStar||(r=function(e){return r=Object.getOwnPropertyNames||function(e){var t=[];for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[t.length]=n);return t},r(e)},function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n=r(e),o=0;o<n.length;o++)"default"!==n[o]&&i(t,e,n[o]);return s(t,e),t}),a=this&&this.__exportStar||function(e,t){for(var n in e)"default"===n||Object.prototype.hasOwnProperty.call(t,n)||i(t,e,n)},c=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.ReasonCodes=t.KeepaliveManager=t.UniqueMessageIdProvider=t.DefaultMessageIdProvider=t.Store=t.MqttClient=t.connectAsync=t.connect=t.Client=void 0;const l=c(n(9777));t.MqttClient=l.default;const d=c(n(579));t.DefaultMessageIdProvider=d.default;const u=c(n(2099));t.UniqueMessageIdProvider=u.default;const h=c(n(7969));t.Store=h.default;const p=o(n(2793));t.connect=p.default,Object.defineProperty(t,"connectAsync",{enumerable:!0,get:function(){return p.connectAsync}});const f=c(n(3175));t.KeepaliveManager=f.default,t.Client=l.default,a(n(9777),t),a(n(4723),t);var g=n(1021);Object.defineProperty(t,"ReasonCodes",{enumerable:!0,get:function(){return g.ReasonCodes}})},1711(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TRAINING_HTML=void 0,t.TRAINING_HTML='<!DOCTYPE html>\n<html lang="en">\n<head>\n  <meta charset="UTF-8">\n  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">\n  <meta name="apple-mobile-web-app-capable" content="yes">\n  <meta name="mobile-web-app-capable" content="yes">\n  <title>Spatial Awareness - Training Mode</title>\n  <style>\n    * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }\n    html, body { height: 100%; overflow: hidden; }\n    body {\n      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;\n      background: #121212;\n      color: rgba(255,255,255,0.87);\n      min-height: 100vh;\n      display: flex;\n      flex-direction: column;\n    }\n\n    /* Header */\n    .header {\n      background: rgba(255,255,255,0.03);\n      padding: 12px 16px;\n      display: flex;\n      justify-content: space-between;\n      align-items: center;\n      border-bottom: 1px solid rgba(255,255,255,0.08);\n    }\n    .header h1 { font-size: 16px; font-weight: 500; }\n    .header-status {\n      display: flex;\n      align-items: center;\n      gap: 8px;\n      font-size: 13px;\n    }\n    .status-badge {\n      padding: 4px 10px;\n      border-radius: 4px;\n      font-size: 11px;\n      font-weight: 500;\n      text-transform: uppercase;\n    }\n    .status-badge.idle { background: rgba(255,255,255,0.1); color: rgba(255,255,255,0.6); }\n    .status-badge.active { background: #4fc3f7; color: #000; animation: pulse 2s infinite; }\n    .status-badge.paused { background: #ffb74d; color: #000; }\n    .status-badge.completed { background: #81c784; color: #000; }\n    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }\n\n    /* Main content area */\n    .main-content {\n      flex: 1;\n      display: flex;\n      flex-direction: column;\n      padding: 12px;\n      overflow-y: auto;\n      gap: 12px;\n    }\n\n    /* Camera detection card */\n    .detection-card {\n      background: rgba(255,255,255,0.03);\n      border-radius: 8px;\n      padding: 16px;\n      border: 1px solid rgba(255,255,255,0.08);\n      transition: all 0.3s;\n    }\n    .detection-card.detecting {\n      border-color: #4fc3f7;\n      background: rgba(79, 195, 247, 0.1);\n    }\n    .detection-card.in-transit {\n      border-color: #ffb74d;\n      background: rgba(255, 183, 77, 0.1);\n    }\n\n    .detection-icon {\n      width: 64px;\n      height: 64px;\n      border-radius: 8px;\n      background: rgba(255,255,255,0.05);\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      margin: 0 auto 12px;\n      font-size: 28px;\n    }\n    .detection-card.detecting .detection-icon {\n      background: #4fc3f7;\n      animation: detectPulse 1.5s infinite;\n    }\n    @keyframes detectPulse {\n      0%, 100% { transform: scale(1); }\n      50% { transform: scale(1.03); }\n    }\n\n    .detection-title {\n      font-size: 18px;\n      font-weight: 500;\n      text-align: center;\n      margin-bottom: 4px;\n    }\n    .detection-subtitle {\n      font-size: 13px;\n      color: rgba(255,255,255,0.5);\n      text-align: center;\n    }\n    .detection-confidence {\n      margin-top: 8px;\n      text-align: center;\n      font-size: 12px;\n      color: rgba(255,255,255,0.4);\n    }\n\n    /* Transit timer */\n    .transit-timer {\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      gap: 8px;\n      margin-top: 12px;\n      padding: 10px;\n      background: rgba(0,0,0,0.2);\n      border-radius: 6px;\n    }\n    .transit-timer-icon { font-size: 18px; }\n    .transit-timer-text { font-size: 16px; font-weight: 500; }\n    .transit-timer-from { font-size: 12px; color: rgba(255,255,255,0.5); }\n\n    /* Stats grid */\n    .stats-grid {\n      display: grid;\n      grid-template-columns: repeat(3, 1fr);\n      gap: 8px;\n    }\n    .stat-item {\n      background: rgba(255,255,255,0.03);\n      border-radius: 6px;\n      padding: 12px 8px;\n      text-align: center;\n      border: 1px solid rgba(255,255,255,0.05);\n    }\n    .stat-value {\n      font-size: 24px;\n      font-weight: 500;\n      color: #4fc3f7;\n    }\n    .stat-label {\n      font-size: 10px;\n      color: rgba(255,255,255,0.4);\n      text-transform: uppercase;\n      margin-top: 2px;\n    }\n\n    /* Progress bar */\n    .progress-section {\n      background: rgba(255,255,255,0.03);\n      border-radius: 6px;\n      padding: 12px;\n      border: 1px solid rgba(255,255,255,0.05);\n    }\n    .progress-header {\n      display: flex;\n      justify-content: space-between;\n      margin-bottom: 8px;\n      font-size: 13px;\n    }\n    .progress-bar {\n      height: 6px;\n      background: rgba(255,255,255,0.1);\n      border-radius: 3px;\n      overflow: hidden;\n    }\n    .progress-fill {\n      height: 100%;\n      background: #4fc3f7;\n      border-radius: 3px;\n      transition: width 0.5s;\n    }\n\n    /* Suggestions */\n    .suggestions-section {\n      background: rgba(79, 195, 247, 0.08);\n      border: 1px solid rgba(79, 195, 247, 0.2);\n      border-radius: 6px;\n      padding: 12px;\n    }\n    .suggestions-title {\n      font-size: 11px;\n      text-transform: uppercase;\n      color: #4fc3f7;\n      margin-bottom: 6px;\n      font-weight: 500;\n    }\n    .suggestion-item {\n      font-size: 13px;\n      padding: 6px 0;\n      border-bottom: 1px solid rgba(255,255,255,0.05);\n      color: rgba(255,255,255,0.7);\n    }\n    .suggestion-item:last-child { border-bottom: none; }\n    .suggestion-item::before {\n      content: "→ ";\n      color: #4fc3f7;\n    }\n\n    /* Action buttons */\n    .action-buttons {\n      display: flex;\n      gap: 8px;\n      padding: 8px 0;\n    }\n    .btn {\n      flex: 1;\n      padding: 14px 16px;\n      border: none;\n      border-radius: 6px;\n      font-size: 14px;\n      font-weight: 500;\n      cursor: pointer;\n      transition: all 0.2s;\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      gap: 6px;\n    }\n    .btn:active { transform: scale(0.98); }\n    .btn-primary { background: #4fc3f7; color: #000; }\n    .btn-secondary { background: rgba(255,255,255,0.08); color: rgba(255,255,255,0.87); }\n    .btn-danger { background: #ef5350; color: #fff; }\n    .btn-warning { background: #ffb74d; color: #000; }\n    .btn:disabled { opacity: 0.4; cursor: not-allowed; }\n\n    /* Full-width button */\n    .btn-full { flex: none; width: 100%; }\n\n    /* Mark landmark/structure panel */\n    .mark-panel {\n      background: rgba(255,255,255,0.03);\n      border-radius: 6px;\n      padding: 16px;\n      border: 1px solid rgba(255,255,255,0.05);\n    }\n    .mark-panel-title {\n      font-size: 14px;\n      font-weight: 500;\n      margin-bottom: 12px;\n    }\n    .mark-type-grid {\n      display: grid;\n      grid-template-columns: repeat(4, 1fr);\n      gap: 6px;\n      margin-bottom: 12px;\n    }\n    .mark-type-btn {\n      padding: 10px 6px;\n      border: 1px solid rgba(255,255,255,0.1);\n      border-radius: 6px;\n      background: transparent;\n      color: rgba(255,255,255,0.7);\n      font-size: 10px;\n      text-align: center;\n      cursor: pointer;\n      transition: all 0.2s;\n    }\n    .mark-type-btn.selected {\n      border-color: #4fc3f7;\n      background: rgba(79, 195, 247, 0.15);\n      color: #fff;\n    }\n    .mark-type-btn .icon { font-size: 18px; margin-bottom: 2px; display: block; }\n\n    /* Input field */\n    .input-group { margin-bottom: 12px; }\n    .input-group label {\n      display: block;\n      font-size: 12px;\n      color: rgba(255,255,255,0.5);\n      margin-bottom: 4px;\n    }\n    .input-group input {\n      width: 100%;\n      padding: 12px;\n      border: 1px solid rgba(255,255,255,0.1);\n      border-radius: 6px;\n      background: rgba(0,0,0,0.2);\n      color: #fff;\n      font-size: 14px;\n    }\n    .input-group input:focus {\n      outline: none;\n      border-color: #4fc3f7;\n    }\n\n    /* History list */\n    .history-section {\n      background: rgba(255,255,255,0.03);\n      border-radius: 6px;\n      padding: 12px;\n      max-height: 180px;\n      overflow-y: auto;\n      border: 1px solid rgba(255,255,255,0.05);\n    }\n    .history-title {\n      font-size: 13px;\n      font-weight: 500;\n      margin-bottom: 8px;\n      display: flex;\n      justify-content: space-between;\n    }\n    .history-item {\n      padding: 8px;\n      border-bottom: 1px solid rgba(255,255,255,0.05);\n      font-size: 13px;\n    }\n    .history-item:last-child { border-bottom: none; }\n    .history-item-time {\n      font-size: 10px;\n      color: rgba(255,255,255,0.4);\n    }\n    .history-item-camera { color: #4fc3f7; font-weight: 500; }\n    .history-item-transit { color: #ffb74d; }\n\n    /* Bottom action bar */\n    .bottom-bar {\n      background: rgba(255,255,255,0.03);\n      padding: 12px 16px;\n      padding-bottom: max(12px, env(safe-area-inset-bottom));\n      border-top: 1px solid rgba(255,255,255,0.08);\n    }\n\n    /* Tabs */\n    .tabs {\n      display: flex;\n      background: rgba(0,0,0,0.2);\n      border-radius: 6px;\n      padding: 3px;\n      margin-bottom: 12px;\n    }\n    .tab {\n      flex: 1;\n      padding: 10px;\n      border: none;\n      background: transparent;\n      color: rgba(255,255,255,0.5);\n      font-size: 13px;\n      font-weight: 500;\n      cursor: pointer;\n      border-radius: 4px;\n      transition: all 0.2s;\n    }\n    .tab.active {\n      background: rgba(255,255,255,0.08);\n      color: rgba(255,255,255,0.87);\n    }\n\n    /* Tab content */\n    .tab-content { display: none; }\n    .tab-content.active { display: block; }\n\n    /* Apply results modal */\n    .modal-overlay {\n      display: none;\n      position: fixed;\n      top: 0;\n      left: 0;\n      right: 0;\n      bottom: 0;\n      background: rgba(0,0,0,0.85);\n      z-index: 100;\n      align-items: center;\n      justify-content: center;\n      padding: 16px;\n    }\n    .modal-overlay.active { display: flex; }\n    .modal {\n      background: #1e1e1e;\n      border-radius: 8px;\n      padding: 20px;\n      max-width: 360px;\n      width: 100%;\n      border: 1px solid rgba(255,255,255,0.1);\n    }\n    .modal h2 { font-size: 18px; margin-bottom: 12px; font-weight: 500; }\n    .modal-result-item {\n      display: flex;\n      justify-content: space-between;\n      padding: 8px 0;\n      border-bottom: 1px solid rgba(255,255,255,0.08);\n      font-size: 13px;\n    }\n    .modal-result-value { color: #4fc3f7; font-weight: 500; }\n    .modal-buttons { display: flex; gap: 8px; margin-top: 16px; }\n\n    /* Idle state */\n    .idle-content {\n      flex: 1;\n      display: flex;\n      flex-direction: column;\n      align-items: center;\n      justify-content: center;\n      text-align: center;\n      padding: 32px 16px;\n    }\n    .idle-icon {\n      font-size: 56px;\n      margin-bottom: 16px;\n      opacity: 0.7;\n    }\n    .idle-title {\n      font-size: 20px;\n      font-weight: 500;\n      margin-bottom: 8px;\n    }\n    .idle-desc {\n      font-size: 14px;\n      color: rgba(255,255,255,0.5);\n      max-width: 280px;\n      line-height: 1.5;\n    }\n    .idle-instructions {\n      margin-top: 24px;\n      text-align: left;\n      background: rgba(255,255,255,0.03);\n      border-radius: 6px;\n      padding: 16px;\n      border: 1px solid rgba(255,255,255,0.05);\n    }\n    .idle-instructions h3 {\n      font-size: 12px;\n      margin-bottom: 10px;\n      color: #4fc3f7;\n      font-weight: 500;\n    }\n    .idle-instructions ol {\n      padding-left: 18px;\n      font-size: 13px;\n      line-height: 1.8;\n      color: rgba(255,255,255,0.6);\n    }\n  </style>\n</head>\n<body>\n  <div class="header">\n    <h1>Training Mode</h1>\n    <div class="header-status">\n      <span class="status-badge" id="status-badge">Idle</span>\n    </div>\n  </div>\n\n  \x3c!-- Idle State --\x3e\n  <div class="main-content" id="idle-content">\n    <div class="idle-content">\n      <div class="idle-icon">🚶</div>\n      <div class="idle-title">Train Your System</div>\n      <div class="idle-desc">Walk around your property to teach the system about camera positions, transit times, and landmarks.</div>\n\n      <div class="idle-instructions">\n        <h3>How it works:</h3>\n        <ol>\n          <li>Tap <strong>Start Training</strong> below</li>\n          <li>Walk to each camera on your property</li>\n          <li>The system detects you automatically</li>\n          <li>Mark landmarks as you encounter them</li>\n          <li>End training when you\'re done</li>\n        </ol>\n      </div>\n    </div>\n\n    <div class="bottom-bar">\n      <button class="btn btn-primary btn-full" onclick="startTraining()">\n        ▶ Start Training\n      </button>\n    </div>\n  </div>\n\n  \x3c!-- Active Training State --\x3e\n  <div class="main-content" id="active-content" style="display: none;">\n    \x3c!-- Detection Card --\x3e\n    <div class="detection-card" id="detection-card">\n      <div class="detection-icon" id="detection-icon">👤</div>\n      <div class="detection-title" id="detection-title">Waiting for detection...</div>\n      <div class="detection-subtitle" id="detection-subtitle">Walk to any camera to begin</div>\n      <div class="detection-confidence" id="detection-confidence"></div>\n\n      <div class="transit-timer" id="transit-timer" style="display: none;">\n        <span class="transit-timer-icon">⏱</span>\n        <span class="transit-timer-text" id="transit-time">0s</span>\n        <span class="transit-timer-from" id="transit-from"></span>\n      </div>\n    </div>\n\n    \x3c!-- Tabs --\x3e\n    <div class="tabs">\n      <button class="tab active" onclick="switchTab(\'status\')">Status</button>\n      <button class="tab" onclick="switchTab(\'mark\')">Mark</button>\n      <button class="tab" onclick="switchTab(\'history\')">History</button>\n    </div>\n\n    \x3c!-- Status Tab --\x3e\n    <div class="tab-content active" id="tab-status">\n      \x3c!-- Stats --\x3e\n      <div class="stats-grid">\n        <div class="stat-item">\n          <div class="stat-value" id="stat-cameras">0</div>\n          <div class="stat-label">Cameras</div>\n        </div>\n        <div class="stat-item">\n          <div class="stat-value" id="stat-transits">0</div>\n          <div class="stat-label">Transits</div>\n        </div>\n        <div class="stat-item">\n          <div class="stat-value" id="stat-landmarks">0</div>\n          <div class="stat-label">Landmarks</div>\n        </div>\n      </div>\n\n      \x3c!-- Progress --\x3e\n      <div class="progress-section" style="margin-top: 15px;">\n        <div class="progress-header">\n          <span>Coverage</span>\n          <span id="progress-percent">0%</span>\n        </div>\n        <div class="progress-bar">\n          <div class="progress-fill" id="progress-fill" style="width: 0%"></div>\n        </div>\n      </div>\n\n      \x3c!-- Suggestions --\x3e\n      <div class="suggestions-section" style="margin-top: 15px;" id="suggestions-section">\n        <div class="suggestions-title">Suggestions</div>\n        <div id="suggestions-list">\n          <div class="suggestion-item">Start walking to a camera</div>\n        </div>\n      </div>\n    </div>\n\n    \x3c!-- Mark Tab --\x3e\n    <div class="tab-content" id="tab-mark">\n      <div class="mark-panel">\n        <div class="mark-panel-title">Mark a Landmark</div>\n        <div class="mark-type-grid" id="landmark-type-grid">\n          <button class="mark-type-btn selected" data-type="mailbox" onclick="selectLandmarkType(\'mailbox\')">\n            <span class="icon">📬</span>\n            Mailbox\n          </button>\n          <button class="mark-type-btn" data-type="garage" onclick="selectLandmarkType(\'garage\')">\n            <span class="icon">🏠</span>\n            Garage\n          </button>\n          <button class="mark-type-btn" data-type="shed" onclick="selectLandmarkType(\'shed\')">\n            <span class="icon">🏚</span>\n            Shed\n          </button>\n          <button class="mark-type-btn" data-type="tree" onclick="selectLandmarkType(\'tree\')">\n            <span class="icon">🌳</span>\n            Tree\n          </button>\n          <button class="mark-type-btn" data-type="gate" onclick="selectLandmarkType(\'gate\')">\n            <span class="icon">🚪</span>\n            Gate\n          </button>\n          <button class="mark-type-btn" data-type="driveway" onclick="selectLandmarkType(\'driveway\')">\n            <span class="icon">🛣</span>\n            Driveway\n          </button>\n          <button class="mark-type-btn" data-type="pool" onclick="selectLandmarkType(\'pool\')">\n            <span class="icon">🏊</span>\n            Pool\n          </button>\n          <button class="mark-type-btn" data-type="other" onclick="selectLandmarkType(\'other\')">\n            <span class="icon">📍</span>\n            Other\n          </button>\n        </div>\n\n        <div class="input-group">\n          <label>Landmark Name</label>\n          <input type="text" id="landmark-name" placeholder="e.g., Front Mailbox">\n        </div>\n\n        <button class="btn btn-primary btn-full" onclick="markLandmark()">\n          📍 Mark Landmark Here\n        </button>\n      </div>\n    </div>\n\n    \x3c!-- History Tab --\x3e\n    <div class="tab-content" id="tab-history">\n      <div class="history-section">\n        <div class="history-title">\n          <span>Recent Activity</span>\n          <span id="history-count">0 events</span>\n        </div>\n        <div id="history-list">\n          <div class="history-item" style="color: rgba(255,255,255,0.4); text-align: center;">\n            No activity yet\n          </div>\n        </div>\n      </div>\n    </div>\n\n    \x3c!-- Bottom Actions --\x3e\n    <div class="bottom-bar">\n      <div class="action-buttons">\n        <button class="btn btn-warning" id="pause-btn" onclick="togglePause()">\n          ⏸ Pause\n        </button>\n        <button class="btn btn-danger" onclick="endTraining()">\n          ⏹ End\n        </button>\n      </div>\n    </div>\n  </div>\n\n  \x3c!-- Completed State --\x3e\n  <div class="main-content" id="completed-content" style="display: none;">\n    <div class="idle-content">\n      <div class="idle-icon">✅</div>\n      <div class="idle-title">Training Complete!</div>\n      <div class="idle-desc">Review the results and apply them to your topology.</div>\n    </div>\n\n    \x3c!-- Final Stats --\x3e\n    <div class="stats-grid">\n      <div class="stat-item">\n        <div class="stat-value" id="final-cameras">0</div>\n        <div class="stat-label">Cameras</div>\n      </div>\n      <div class="stat-item">\n        <div class="stat-value" id="final-transits">0</div>\n        <div class="stat-label">Transits</div>\n      </div>\n      <div class="stat-item">\n        <div class="stat-value" id="final-landmarks">0</div>\n        <div class="stat-label">Landmarks</div>\n      </div>\n    </div>\n\n    <div class="stats-grid" style="margin-top: 10px;">\n      <div class="stat-item">\n        <div class="stat-value" id="final-overlaps">0</div>\n        <div class="stat-label">Overlaps</div>\n      </div>\n      <div class="stat-item">\n        <div class="stat-value" id="final-avg-transit">0s</div>\n        <div class="stat-label">Avg Transit</div>\n      </div>\n      <div class="stat-item">\n        <div class="stat-value" id="final-coverage">0%</div>\n        <div class="stat-label">Coverage</div>\n      </div>\n    </div>\n\n    <div class="bottom-bar" style="margin-top: auto;">\n      <div class="action-buttons">\n        <button class="btn btn-secondary" onclick="resetTraining()">\n          ↻ Start Over\n        </button>\n        <button class="btn btn-primary" onclick="applyTraining()">\n          ✓ Apply Results\n        </button>\n      </div>\n    </div>\n  </div>\n\n  \x3c!-- Apply Results Modal --\x3e\n  <div class="modal-overlay" id="results-modal">\n    <div class="modal">\n      <h2>Training Applied!</h2>\n      <div id="results-content">\n        <div class="modal-result-item">\n          <span>Connections Created</span>\n          <span class="modal-result-value" id="result-connections">0</span>\n        </div>\n        <div class="modal-result-item">\n          <span>Connections Updated</span>\n          <span class="modal-result-value" id="result-updated">0</span>\n        </div>\n        <div class="modal-result-item">\n          <span>Landmarks Added</span>\n          <span class="modal-result-value" id="result-landmarks">0</span>\n        </div>\n        <div class="modal-result-item">\n          <span>Zones Created</span>\n          <span class="modal-result-value" id="result-zones">0</span>\n        </div>\n      </div>\n      <div class="modal-buttons">\n        <button class="btn btn-secondary" style="flex: 1;" onclick="closeResultsModal()">Close</button>\n        <button class="btn btn-primary" style="flex: 1;" onclick="openEditor()">Open Editor</button>\n      </div>\n    </div>\n  </div>\n\n  <script>\n    let trainingState = \'idle\'; // idle, active, paused, completed\n    let session = null;\n    let pollInterval = null;\n    let transitInterval = null;\n    let selectedLandmarkType = \'mailbox\';\n    let historyItems = [];\n\n    // Initialize\n    async function init() {\n      // Check if there\'s an existing session\n      const status = await fetchTrainingStatus();\n      if (status && (status.state === \'active\' || status.state === \'paused\')) {\n        session = status;\n        trainingState = status.state;\n        updateUI();\n        startPolling();\n      }\n    }\n\n    // API calls\n    async function fetchTrainingStatus() {\n      try {\n        const response = await fetch(\'../api/training/status\');\n        if (response.ok) {\n          return await response.json();\n        }\n      } catch (e) { console.error(\'Failed to fetch status:\', e); }\n      return null;\n    }\n\n    async function startTraining() {\n      try {\n        const response = await fetch(\'../api/training/start\', { method: \'POST\' });\n        if (response.ok) {\n          session = await response.json();\n          trainingState = \'active\';\n          updateUI();\n          startPolling();\n          addHistoryItem(\'Training started\', \'start\');\n        }\n      } catch (e) {\n        console.error(\'Failed to start training:\', e);\n        alert(\'Failed to start training. Please try again.\');\n      }\n    }\n\n    async function togglePause() {\n      const endpoint = trainingState === \'active\' ? \'pause\' : \'resume\';\n      try {\n        const response = await fetch(\'../api/training/\' + endpoint, { method: \'POST\' });\n        if (response.ok) {\n          trainingState = trainingState === \'active\' ? \'paused\' : \'active\';\n          updateUI();\n          addHistoryItem(\'Training \' + (trainingState === \'paused\' ? \'paused\' : \'resumed\'), \'control\');\n        }\n      } catch (e) { console.error(\'Failed to toggle pause:\', e); }\n    }\n\n    async function endTraining() {\n      if (!confirm(\'End training session?\')) return;\n      try {\n        const response = await fetch(\'../api/training/end\', { method: \'POST\' });\n        if (response.ok) {\n          session = await response.json();\n          trainingState = \'completed\';\n          stopPolling();\n          updateUI();\n        }\n      } catch (e) { console.error(\'Failed to end training:\', e); }\n    }\n\n    async function applyTraining() {\n      try {\n        const response = await fetch(\'../api/training/apply\', { method: \'POST\' });\n        if (response.ok) {\n          const result = await response.json();\n          document.getElementById(\'result-connections\').textContent = result.connectionsCreated;\n          document.getElementById(\'result-updated\').textContent = result.connectionsUpdated;\n          document.getElementById(\'result-landmarks\').textContent = result.landmarksAdded;\n          document.getElementById(\'result-zones\').textContent = result.zonesCreated;\n          document.getElementById(\'results-modal\').classList.add(\'active\');\n        }\n      } catch (e) {\n        console.error(\'Failed to apply training:\', e);\n        alert(\'Failed to apply training results.\');\n      }\n    }\n\n    function closeResultsModal() {\n      document.getElementById(\'results-modal\').classList.remove(\'active\');\n    }\n\n    function openEditor() {\n      window.location.href = \'../ui/editor\';\n    }\n\n    function resetTraining() {\n      trainingState = \'idle\';\n      session = null;\n      historyItems = [];\n      updateUI();\n    }\n\n    async function markLandmark() {\n      const name = document.getElementById(\'landmark-name\').value.trim();\n      if (!name) {\n        alert(\'Please enter a landmark name\');\n        return;\n      }\n\n      const currentCameraId = session?.currentCamera?.id;\n      const visibleFromCameras = currentCameraId ? [currentCameraId] : [];\n\n      try {\n        const response = await fetch(\'../api/training/landmark\', {\n          method: \'POST\',\n          headers: { \'Content-Type\': \'application/json\' },\n          body: JSON.stringify({\n            name,\n            type: selectedLandmarkType,\n            visibleFromCameras,\n            position: { x: 50, y: 50 }, // Will be refined when applied\n          })\n        });\n        if (response.ok) {\n          document.getElementById(\'landmark-name\').value = \'\';\n          addHistoryItem(\'Marked: \' + name + \' (\' + selectedLandmarkType + \')\', \'landmark\');\n          // Refresh status\n          const status = await fetchTrainingStatus();\n          if (status) {\n            session = status;\n            updateStatsUI();\n          }\n        }\n      } catch (e) { console.error(\'Failed to mark landmark:\', e); }\n    }\n\n    function selectLandmarkType(type) {\n      selectedLandmarkType = type;\n      document.querySelectorAll(\'.mark-type-btn\').forEach(btn => {\n        btn.classList.toggle(\'selected\', btn.dataset.type === type);\n      });\n    }\n\n    // Polling\n    function startPolling() {\n      if (pollInterval) clearInterval(pollInterval);\n      pollInterval = setInterval(async () => {\n        const status = await fetchTrainingStatus();\n        if (status) {\n          session = status;\n          updateDetectionUI();\n          updateStatsUI();\n          updateSuggestionsUI();\n        }\n      }, 1000);\n    }\n\n    function stopPolling() {\n      if (pollInterval) {\n        clearInterval(pollInterval);\n        pollInterval = null;\n      }\n      if (transitInterval) {\n        clearInterval(transitInterval);\n        transitInterval = null;\n      }\n    }\n\n    // UI Updates\n    function updateUI() {\n      // Show/hide content sections\n      document.getElementById(\'idle-content\').style.display = trainingState === \'idle\' ? \'flex\' : \'none\';\n      document.getElementById(\'active-content\').style.display = (trainingState === \'active\' || trainingState === \'paused\') ? \'flex\' : \'none\';\n      document.getElementById(\'completed-content\').style.display = trainingState === \'completed\' ? \'flex\' : \'none\';\n\n      // Update status badge\n      const badge = document.getElementById(\'status-badge\');\n      badge.textContent = trainingState.charAt(0).toUpperCase() + trainingState.slice(1);\n      badge.className = \'status-badge \' + trainingState;\n\n      // Update pause button\n      const pauseBtn = document.getElementById(\'pause-btn\');\n      if (pauseBtn) {\n        pauseBtn.innerHTML = trainingState === \'paused\' ? \'▶ Resume\' : \'⏸ Pause\';\n      }\n\n      // Update completed stats\n      if (trainingState === \'completed\' && session) {\n        document.getElementById(\'final-cameras\').textContent = session.stats?.camerasVisited || 0;\n        document.getElementById(\'final-transits\').textContent = session.stats?.transitsRecorded || 0;\n        document.getElementById(\'final-landmarks\').textContent = session.stats?.landmarksMarked || 0;\n        document.getElementById(\'final-overlaps\').textContent = session.stats?.overlapsDetected || 0;\n        document.getElementById(\'final-avg-transit\').textContent = (session.stats?.averageTransitTime || 0) + \'s\';\n        document.getElementById(\'final-coverage\').textContent = (session.stats?.coveragePercentage || 0) + \'%\';\n      }\n    }\n\n    function updateDetectionUI() {\n      if (!session) return;\n\n      const card = document.getElementById(\'detection-card\');\n      const icon = document.getElementById(\'detection-icon\');\n      const title = document.getElementById(\'detection-title\');\n      const subtitle = document.getElementById(\'detection-subtitle\');\n      const confidence = document.getElementById(\'detection-confidence\');\n      const transitTimer = document.getElementById(\'transit-timer\');\n\n      if (session.currentCamera) {\n        // Detected on a camera\n        card.className = \'detection-card detecting\';\n        icon.textContent = \'📷\';\n        title.textContent = session.currentCamera.name;\n        subtitle.textContent = \'You are visible on this camera\';\n        confidence.textContent = \'Confidence: \' + Math.round(session.currentCamera.confidence * 100) + \'%\';\n        transitTimer.style.display = \'none\';\n\n        // Check for new camera detection to add to history\n        const lastHistoryCamera = historyItems.find(h => h.type === \'camera\');\n        if (!lastHistoryCamera || lastHistoryCamera.cameraId !== session.currentCamera.id) {\n          addHistoryItem(\'Detected on: \' + session.currentCamera.name, \'camera\', session.currentCamera.id);\n        }\n      } else if (session.activeTransit) {\n        // In transit\n        card.className = \'detection-card in-transit\';\n        icon.textContent = \'🚶\';\n        title.textContent = \'In Transit\';\n        subtitle.textContent = \'Walking to next camera...\';\n        confidence.textContent = \'\';\n        transitTimer.style.display = \'flex\';\n        document.getElementById(\'transit-from\').textContent = \'from \' + session.activeTransit.fromCameraName;\n\n        // Start transit timer if not already running\n        if (!transitInterval) {\n          transitInterval = setInterval(() => {\n            if (session?.activeTransit) {\n              document.getElementById(\'transit-time\').textContent = session.activeTransit.elapsedSeconds + \'s\';\n            }\n          }, 1000);\n        }\n      } else {\n        // Waiting\n        card.className = \'detection-card\';\n        icon.textContent = \'👤\';\n        title.textContent = \'Waiting for detection...\';\n        subtitle.textContent = \'Walk to any camera to begin\';\n        confidence.textContent = \'\';\n        transitTimer.style.display = \'none\';\n\n        if (transitInterval) {\n          clearInterval(transitInterval);\n          transitInterval = null;\n        }\n      }\n    }\n\n    function updateStatsUI() {\n      if (!session?.stats) return;\n\n      document.getElementById(\'stat-cameras\').textContent = session.stats.camerasVisited;\n      document.getElementById(\'stat-transits\').textContent = session.stats.transitsRecorded;\n      document.getElementById(\'stat-landmarks\').textContent = session.stats.landmarksMarked;\n      document.getElementById(\'progress-percent\').textContent = session.stats.coveragePercentage + \'%\';\n      document.getElementById(\'progress-fill\').style.width = session.stats.coveragePercentage + \'%\';\n    }\n\n    function updateSuggestionsUI() {\n      if (!session?.suggestions || session.suggestions.length === 0) return;\n\n      const list = document.getElementById(\'suggestions-list\');\n      list.innerHTML = session.suggestions.map(s =>\n        \'<div class="suggestion-item">\' + s + \'</div>\'\n      ).join(\'\');\n    }\n\n    function addHistoryItem(text, type, cameraId) {\n      const time = new Date().toLocaleTimeString();\n      historyItems.unshift({ text, type, time, cameraId });\n      if (historyItems.length > 50) historyItems.pop();\n\n      const list = document.getElementById(\'history-list\');\n      document.getElementById(\'history-count\').textContent = historyItems.length + \' events\';\n\n      list.innerHTML = historyItems.map(item => {\n        let className = \'\';\n        if (item.type === \'camera\') className = \'history-item-camera\';\n        if (item.type === \'transit\') className = \'history-item-transit\';\n        return \'<div class="history-item"><span class="\' + className + \'">\' + item.text + \'</span>\' +\n               \'<div class="history-item-time">\' + item.time + \'</div></div>\';\n      }).join(\'\');\n    }\n\n    function switchTab(tabName) {\n      document.querySelectorAll(\'.tab\').forEach(tab => {\n        tab.classList.toggle(\'active\', tab.textContent.toLowerCase() === tabName);\n      });\n      document.querySelectorAll(\'.tab-content\').forEach(content => {\n        content.classList.toggle(\'active\', content.id === \'tab-\' + tabName);\n      });\n    }\n\n    // Initialize on load\n    init();\n  <\/script>\n</body>\n</html>'},1722(e,t,n){"use strict";const r=n(4434),i=n(8611),{Duplex:s}=n(2203),{createHash:o}=n(6982),a=n(5926),c=n(2971),l=n(8237),d=n(1060),{GUID:u,kWebSocket:h}=n(2614),p=/^[+/0-9A-Za-z]{22}==$/;function f(e){e._state=2,e.emit("close")}function g(){this.destroy()}function m(e,t,n,r){n=n||i.STATUS_CODES[t],r={Connection:"close","Content-Type":"text/html","Content-Length":Buffer.byteLength(n),...r},e.once("finish",e.destroy),e.end(`HTTP/1.1 ${t} ${i.STATUS_CODES[t]}\r\n`+Object.keys(r).map(e=>`${e}: ${r[e]}`).join("\r\n")+"\r\n\r\n"+n)}function y(e,t,n,r,i,s){if(e.listenerCount("wsClientError")){const r=new Error(i);Error.captureStackTrace(r,y),e.emit("wsClientError",r,n,t)}else m(n,r,i,s)}e.exports=class extends r{constructor(e,t){if(super(),null==(e={allowSynchronousEvents:!0,autoPong:!0,maxPayload:104857600,skipUTF8Validation:!1,perMessageDeflate:!1,handleProtocols:null,clientTracking:!0,verifyClient:null,noServer:!1,backlog:null,server:null,host:null,path:null,port:null,WebSocket:d,...e}).port&&!e.server&&!e.noServer||null!=e.port&&(e.server||e.noServer)||e.server&&e.noServer)throw new TypeError('One and only one of the "port", "server", or "noServer" options must be specified');if(null!=e.port?(this._server=i.createServer((e,t)=>{const n=i.STATUS_CODES[426];t.writeHead(426,{"Content-Length":n.length,"Content-Type":"text/plain"}),t.end(n)}),this._server.listen(e.port,e.host,e.backlog,t)):e.server&&(this._server=e.server),this._server){const e=this.emit.bind(this,"connection");this._removeListeners=function(e,t){for(const n of Object.keys(t))e.on(n,t[n]);return function(){for(const n of Object.keys(t))e.removeListener(n,t[n])}}(this._server,{listening:this.emit.bind(this,"listening"),error:this.emit.bind(this,"error"),upgrade:(t,n,r)=>{this.handleUpgrade(t,n,r,e)}})}!0===e.perMessageDeflate&&(e.perMessageDeflate={}),e.clientTracking&&(this.clients=new Set,this._shouldEmitClose=!1),this.options=e,this._state=0}address(){if(this.options.noServer)throw new Error('The server is operating in "noServer" mode');return this._server?this._server.address():null}close(e){if(2===this._state)return e&&this.once("close",()=>{e(new Error("The server is not running"))}),void process.nextTick(f,this);if(e&&this.once("close",e),1!==this._state)if(this._state=1,this.options.noServer||this.options.server)this._server&&(this._removeListeners(),this._removeListeners=this._server=null),this.clients&&this.clients.size?this._shouldEmitClose=!0:process.nextTick(f,this);else{const e=this._server;this._removeListeners(),this._removeListeners=this._server=null,e.close(()=>{f(this)})}}shouldHandle(e){if(this.options.path){const t=e.url.indexOf("?");if((-1!==t?e.url.slice(0,t):e.url)!==this.options.path)return!1}return!0}handleUpgrade(e,t,n,r){t.on("error",g);const i=e.headers["sec-websocket-key"],s=e.headers.upgrade,o=+e.headers["sec-websocket-version"];if("GET"!==e.method){return void y(this,e,t,405,"Invalid HTTP method")}if(void 0===s||"websocket"!==s.toLowerCase()){return void y(this,e,t,400,"Invalid Upgrade header")}if(void 0===i||!p.test(i)){return void y(this,e,t,400,"Missing or invalid Sec-WebSocket-Key header")}if(13!==o&&8!==o){return void y(this,e,t,400,"Missing or invalid Sec-WebSocket-Version header",{"Sec-WebSocket-Version":"13, 8"})}if(!this.shouldHandle(e))return void m(t,400);const d=e.headers["sec-websocket-protocol"];let u=new Set;if(void 0!==d)try{u=l.parse(d)}catch(n){return void y(this,e,t,400,"Invalid Sec-WebSocket-Protocol header")}const h=e.headers["sec-websocket-extensions"],f={};if(this.options.perMessageDeflate&&void 0!==h){const n=new c(this.options.perMessageDeflate,!0,this.options.maxPayload);try{const e=a.parse(h);e[c.extensionName]&&(n.accept(e[c.extensionName]),f[c.extensionName]=n)}catch(n){return void y(this,e,t,400,"Invalid or unacceptable Sec-WebSocket-Extensions header")}}if(this.options.verifyClient){const s={origin:e.headers[""+(8===o?"sec-websocket-origin":"origin")],secure:!(!e.socket.authorized&&!e.socket.encrypted),req:e};if(2===this.options.verifyClient.length)return void this.options.verifyClient(s,(s,o,a,c)=>{if(!s)return m(t,o||401,a,c);this.completeUpgrade(f,i,u,e,t,n,r)});if(!this.options.verifyClient(s))return m(t,401)}this.completeUpgrade(f,i,u,e,t,n,r)}completeUpgrade(e,t,n,r,i,s,l){if(!i.readable||!i.writable)return i.destroy();if(i[h])throw new Error("server.handleUpgrade() was called more than once with the same socket, possibly due to a misconfiguration");if(this._state>0)return m(i,503);const d=["HTTP/1.1 101 Switching Protocols","Upgrade: websocket","Connection: Upgrade",`Sec-WebSocket-Accept: ${o("sha1").update(t+u).digest("base64")}`],p=new this.options.WebSocket(null,void 0,this.options);if(n.size){const e=this.options.handleProtocols?this.options.handleProtocols(n,r):n.values().next().value;e&&(d.push(`Sec-WebSocket-Protocol: ${e}`),p._protocol=e)}if(e[c.extensionName]){const t=e[c.extensionName].params,n=a.format({[c.extensionName]:[t]});d.push(`Sec-WebSocket-Extensions: ${n}`),p._extensions=e}this.emit("headers",d,r),i.write(d.concat("\r\n").join("\r\n")),i.removeListener("error",g),p.setSocket(i,s,{allowSynchronousEvents:this.options.allowSynchronousEvents,maxPayload:this.options.maxPayload,skipUTF8Validation:this.options.skipUTF8Validation}),this.clients&&(this.clients.add(p),p.on("close",()=>{this.clients.delete(p),this._shouldEmitClose&&!this.clients.size&&process.nextTick(f,this)})),l(p,r)}}},1725(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const r=n(181),i={INVALID_ENCODING:"Invalid encoding provided. Please specify a valid encoding the internal Node.js Buffer supports.",INVALID_SMARTBUFFER_SIZE:"Invalid size provided. Size must be a valid integer greater than zero.",INVALID_SMARTBUFFER_BUFFER:"Invalid Buffer provided in SmartBufferOptions.",INVALID_SMARTBUFFER_OBJECT:"Invalid SmartBufferOptions object supplied to SmartBuffer constructor or factory methods.",INVALID_OFFSET:"An invalid offset value was provided.",INVALID_OFFSET_NON_NUMBER:"An invalid offset value was provided. A numeric value is required.",INVALID_LENGTH:"An invalid length value was provided.",INVALID_LENGTH_NON_NUMBER:"An invalid length value was provived. A numeric value is required.",INVALID_TARGET_OFFSET:"Target offset is beyond the bounds of the internal SmartBuffer data.",INVALID_TARGET_LENGTH:"Specified length value moves cursor beyong the bounds of the internal SmartBuffer data.",INVALID_READ_BEYOND_BOUNDS:"Attempted to read beyond the bounds of the managed data.",INVALID_WRITE_BEYOND_BOUNDS:"Attempted to write beyond the bounds of the managed data."};function s(e){return"number"==typeof e&&isFinite(e)&&function(e){return"number"==typeof e&&isFinite(e)&&Math.floor(e)===e}(e)}function o(e,t){if("number"!=typeof e)throw new Error(t?i.INVALID_OFFSET_NON_NUMBER:i.INVALID_LENGTH_NON_NUMBER);if(!s(e)||e<0)throw new Error(t?i.INVALID_OFFSET:i.INVALID_LENGTH)}t.ERRORS=i,t.checkEncoding=function(e){if(!r.Buffer.isEncoding(e))throw new Error(i.INVALID_ENCODING)},t.isFiniteInteger=s,t.checkLengthValue=function(e){o(e,!1)},t.checkOffsetValue=function(e){o(e,!0)},t.checkTargetOffset=function(e,t){if(e<0||e>t.length)throw new Error(i.INVALID_TARGET_OFFSET)},t.bigIntAndBufferInt64Check=function(e){if("undefined"==typeof BigInt)throw new Error("Platform does not support JS BigInt type.");if("undefined"==typeof r.Buffer.prototype[e])throw new Error(`Platform does not support Buffer.prototype.${e}.`)}},2017(e,t,n){try{var r=n(9023);if("function"!=typeof r.inherits)throw"";e.exports=r.inherits}catch(t){e.exports=n(6698)}},2018(e){"use strict";e.exports=require("tty")},2099(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const r=n(720);t.default=class{numberAllocator;lastId;constructor(){this.numberAllocator=new r.NumberAllocator(1,65535)}allocate(){return this.lastId=this.numberAllocator.alloc(),this.lastId}getLastAllocated(){return this.lastId}register(e){return this.numberAllocator.use(e)}deallocate(e){this.numberAllocator.free(e)}clear(){this.numberAllocator.clear()}}},2203(e){"use strict";e.exports=require("stream")},2250(e){"use strict";e.exports=require("dns")},2437(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AddressError=void 0;class n extends Error{constructor(e,t){super(e),this.name="AddressError",this.parseMessage=t}}t.AddressError=n},2535(e,t,n){const r=n(3132),{EventEmitter:i}=n(4434),{Buffer:s}=n(181);class o extends i{constructor(){super(),this._array=new Array(20),this._i=0}write(e){return this._array[this._i++]=e,!0}concat(){let e=0;const t=new Array(this._array.length),n=this._array;let r,i=0;for(r=0;r<n.length&&void 0!==n[r];r++)"string"!=typeof n[r]?t[r]=n[r].length:t[r]=s.byteLength(n[r]),e+=t[r];const o=s.allocUnsafe(e);for(r=0;r<n.length&&void 0!==n[r];r++)"string"!=typeof n[r]?(n[r].copy(o,i),i+=t[r]):(o.write(n[r],i),i+=t[r]);return o}destroy(e){e&&this.emit("error",e)}}e.exports=function(e,t){const n=new o;return r(e,n,t),n.concat()}},2613(e){"use strict";e.exports=require("assert")},2614(e){"use strict";const t=["nodebuffer","arraybuffer","fragments"],n="undefined"!=typeof Blob;n&&t.push("blob"),e.exports={BINARY_TYPES:t,EMPTY_BUFFER:Buffer.alloc(0),GUID:"258EAFA5-E914-47DA-95CA-C5AB0DC85B11",hasBlob:n,kForOnEventAttribute:Symbol("kIsForOnEventAttribute"),kListener:Symbol("kListener"),kStatusCode:Symbol("status-code"),kWebSocket:Symbol("websocket"),NOOP:()=>{}}},2635(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.BufferedDuplex=void 0,t.writev=s;const r=n(4478),i=n(181);function s(e,t){const n=new Array(e.length);for(let t=0;t<e.length;t++)"string"==typeof e[t].chunk?n[t]=i.Buffer.from(e[t].chunk,"utf8"):n[t]=e[t].chunk;this._write(i.Buffer.concat(n),"binary",t)}class o extends r.Duplex{socket;proxy;isSocketOpen;writeQueue;constructor(e,t,n){super({objectMode:!0}),this.proxy=t,this.socket=n,this.writeQueue=[],e.objectMode||(this._writev=s.bind(this)),this.isSocketOpen=!1,this.proxy.on("data",e=>{!this.destroyed&&this.readable&&this.push(e)})}_read(e){this.proxy.read(e)}_write(e,t,n){this.isSocketOpen?this.writeToProxy(e,t,n):this.writeQueue.push({chunk:e,encoding:t,cb:n})}_final(e){this.writeQueue=[],this.proxy.end(e)}_destroy(e,t){this.writeQueue=[],this.proxy.destroy(),t(e)}socketReady(){this.emit("connect"),this.isSocketOpen=!0,this.processWriteQueue()}writeToProxy(e,t,n){!1===this.proxy.write(e,t)?this.proxy.once("drain",n):n()}processWriteQueue(){for(;this.writeQueue.length>0;){const{chunk:e,encoding:t,cb:n}=this.writeQueue.shift();this.writeToProxy(e,t,n)}}}t.BufferedDuplex=o},2639(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.default=class{aliasToTopic;max;length;constructor(e){this.aliasToTopic={},this.max=e}put(e,t){return!(0===t||t>this.max)&&(this.aliasToTopic[t]=e,this.length=Object.keys(this.aliasToTopic).length,!0)}getTopicByAlias(e){return this.aliasToTopic[e]}clear(){this.aliasToTopic={}}}},2778(e,t,n){"use strict";const r=n(181),i=n(4478),s=n(2635);let o,a,c,l=!1;t.A=(e,t)=>{if(t.hostname=t.hostname||t.host,!t.hostname)throw new Error("Could not determine host. Specify host manually.");const n="MQIsdp"===t.protocolId&&3===t.protocolVersion?"mqttv3.1":"mqtt";!function(e){e.hostname||(e.hostname="localhost"),e.path||(e.path="/"),e.wsOptions||(e.wsOptions={})}(t);const d=function(e,t){const n="alis"===e.protocol?"wss":"ws";let r=`${n}://${e.hostname}${e.path}`;return e.port&&80!==e.port&&443!==e.port&&(r=`${n}://${e.hostname}:${e.port}${e.path}`),"function"==typeof e.transformWsUrl&&(r=e.transformWsUrl(r,e,t)),r}(t,e);return o=t.my,o.connectSocket({url:d,protocols:n}),a=function(){const e=new i.Transform;return e._write=(e,t,n)=>{o.sendSocketMessage({data:e.buffer,success(){n()},fail(){n(new Error)}})},e._flush=e=>{o.closeSocket({success(){e()}})},e}(),c=new s.BufferedDuplex(t,a,o),l||(l=!0,o.onSocketOpen(()=>{c.socketReady()}),o.onSocketMessage(e=>{if("string"==typeof e.data){const t=r.Buffer.from(e.data,"base64");a.push(t)}else{const t=new FileReader;t.addEventListener("load",()=>{t.result instanceof ArrayBuffer?a.push(r.Buffer.from(t.result)):a.push(r.Buffer.from(t.result,"utf-8"))}),t.readAsArrayBuffer(e.data)}}),o.onSocketClose(()=>{c.end(),c.destroy()}),o.onSocketError(e=>{c.destroy(e)})),c}},2793(e,t,n){"use strict";var r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.connectAsync=function(e,t,n=!0){return new Promise((r,i)=>{const s=d(e,t),o={connect:e=>{a(),r(s)},end:()=>{a(),r(s)},error:e=>{a(),s.end(),i(e)}};function a(){Object.keys(o).forEach(e=>{s.off(e,o[e])})}!1===n&&(o.close=()=>{o.error(new Error("Couldn't connect to server"))}),Object.keys(o).forEach(e=>{s.on(e,o[e])})})};const i=r(n(5753)),s=r(n(7016)),o=r(n(9777)),a=r(n(6887));"function"!=typeof process?.nextTick&&(process.nextTick=setImmediate);const c=(0,i.default)("mqttjs");let l=null;function d(e,t){if(c("connecting to an MQTT broker..."),"object"!=typeof e||t||(t=e,e=""),t=t||{},e&&"string"==typeof e){const n=s.default.parse(e,!0),r={};if(null!=n.port&&(r.port=Number(n.port)),r.host=n.hostname,r.query=n.query,r.auth=n.auth,r.protocol=n.protocol,r.path=n.path,!(t={...r,...t}).protocol)throw new Error("Missing protocol");t.protocol=t.protocol.replace(/:$/,"")}if(t.unixSocket=t.unixSocket||t.protocol?.includes("+unix"),t.unixSocket?t.protocol=t.protocol.replace("+unix",""):t.protocol?.startsWith("ws")||t.protocol?.startsWith("wx")||delete t.path,function(e){let t;if(e.auth)if(t=e.auth.match(/^(.+):(.+)$/),t){const[,n,r]=t;e.username=n,e.password=r}else e.username=e.auth}(t),t.query&&"string"==typeof t.query.clientId&&(t.clientId=t.query.clientId),a.default||t.unixSocket?t.socksProxy=void 0:void 0===t.socksProxy&&"undefined"!=typeof process&&(t.socksProxy=process.env.MQTTJS_SOCKS_PROXY),t.cert&&t.key){if(!t.protocol)throw new Error("Missing secure protocol key");if(-1===["mqtts","wss","wxs","alis"].indexOf(t.protocol))switch(t.protocol){case"mqtt":t.protocol="mqtts";break;case"ws":t.protocol="wss";break;case"wx":t.protocol="wxs";break;case"ali":t.protocol="alis";break;default:throw new Error(`Unknown protocol for secure connection: "${t.protocol}"!`)}}if(l||(l={},a.default||t.forceNativeWebSocket?(l.ws=n(8203).browserStreamBuilder,l.wss=n(8203).browserStreamBuilder,l.wx=n(5670).A,l.wxs=n(5670).A,l.ali=n(2778).A,l.alis=n(2778).A):(l.ws=n(8203).streamBuilder,l.wss=n(8203).streamBuilder,l.mqtt=n(778).default,l.tcp=n(778).default,l.ssl=n(3936).default,l.tls=l.ssl,l.mqtts=n(3936).default)),!l[t.protocol]){const e=-1!==["mqtts","wss"].indexOf(t.protocol);t.protocol=["mqtt","mqtts","ws","wss","wx","wxs","ali","alis"].filter((t,n)=>(!e||n%2!=0)&&"function"==typeof l[t])[0]}if(!1===t.clean&&!t.clientId)throw new Error("Missing clientId for unclean clients");t.protocol&&(t.defaultProtocol=t.protocol);const r=new o.default(function(e){return t.servers&&(e._reconnectCount&&e._reconnectCount!==t.servers.length||(e._reconnectCount=0),t.host=t.servers[e._reconnectCount].host,t.port=t.servers[e._reconnectCount].port,t.protocol=t.servers[e._reconnectCount].protocol?t.servers[e._reconnectCount].protocol:t.defaultProtocol,t.hostname=t.host,e._reconnectCount++),c("calling streambuilder for",t.protocol),l[t.protocol](e,t)},t);return r.on("error",()=>{}),r}t.default=d},2839(e,t,n){"use strict";var r=this&&this.__createBinding||(Object.create?function(e,t,n,r){void 0===r&&(r=n);var i=Object.getOwnPropertyDescriptor(t,n);i&&!("get"in i?!t.__esModule:i.writable||i.configurable)||(i={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,r,i)}:function(e,t,n,r){void 0===r&&(r=n),e[r]=t[n]}),i=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),s=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&r(t,e,n);return i(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.Address4=void 0;const o=s(n(837)),a=s(n(9576)),c=n(2437);class l{constructor(e){this.groups=a.GROUPS,this.parsedAddress=[],this.parsedSubnet="",this.subnet="/32",this.subnetMask=32,this.v4=!0,this.isCorrect=o.isCorrect(a.BITS),this.isInSubnet=o.isInSubnet,this.address=e;const t=a.RE_SUBNET_STRING.exec(e);if(t){if(this.parsedSubnet=t[0].replace("/",""),this.subnetMask=parseInt(this.parsedSubnet,10),this.subnet=`/${this.subnetMask}`,this.subnetMask<0||this.subnetMask>a.BITS)throw new c.AddressError("Invalid subnet mask.");e=e.replace(a.RE_SUBNET_STRING,"")}this.addressMinusSuffix=e,this.parsedAddress=this.parse(e)}static isValid(e){try{return new l(e),!0}catch(e){return!1}}parse(e){const t=e.split(".");if(!e.match(a.RE_ADDRESS))throw new c.AddressError("Invalid IPv4 address.");return t}correctForm(){return this.parsedAddress.map(e=>parseInt(e,10)).join(".")}static fromHex(e){const t=e.replace(/:/g,"").padStart(8,"0"),n=[];let r;for(r=0;r<8;r+=2){const e=t.slice(r,r+2);n.push(parseInt(e,16))}return new l(n.join("."))}static fromInteger(e){return l.fromHex(e.toString(16))}static fromArpa(e){const t=e.replace(/(\.in-addr\.arpa)?\.$/,"").split(".").reverse().join(".");return new l(t)}toHex(){return this.parsedAddress.map(e=>o.stringToPaddedHex(e)).join(":")}toArray(){return this.parsedAddress.map(e=>parseInt(e,10))}toGroup6(){const e=[];let t;for(t=0;t<a.GROUPS;t+=2)e.push(`${o.stringToPaddedHex(this.parsedAddress[t])}${o.stringToPaddedHex(this.parsedAddress[t+1])}`);return e.join(":")}bigInt(){return BigInt(`0x${this.parsedAddress.map(e=>o.stringToPaddedHex(e)).join("")}`)}_startAddress(){return BigInt(`0b${this.mask()+"0".repeat(a.BITS-this.subnetMask)}`)}startAddress(){return l.fromBigInt(this._startAddress())}startAddressExclusive(){const e=BigInt("1");return l.fromBigInt(this._startAddress()+e)}_endAddress(){return BigInt(`0b${this.mask()+"1".repeat(a.BITS-this.subnetMask)}`)}endAddress(){return l.fromBigInt(this._endAddress())}endAddressExclusive(){const e=BigInt("1");return l.fromBigInt(this._endAddress()-e)}static fromBigInt(e){return l.fromHex(e.toString(16))}static fromByteArray(e){if(4!==e.length)throw new c.AddressError("IPv4 addresses require exactly 4 bytes");for(let t=0;t<e.length;t++)if(!Number.isInteger(e[t])||e[t]<0||e[t]>255)throw new c.AddressError("All bytes must be integers between 0 and 255");return this.fromUnsignedByteArray(e)}static fromUnsignedByteArray(e){if(4!==e.length)throw new c.AddressError("IPv4 addresses require exactly 4 bytes");const t=e.join(".");return new l(t)}mask(e){return void 0===e&&(e=this.subnetMask),this.getBitsBase2(0,e)}getBitsBase2(e,t){return this.binaryZeroPad().slice(e,t)}reverseForm(e){e||(e={});const t=this.correctForm().split(".").reverse().join(".");return e.omitSuffix?t:`${t}.in-addr.arpa.`}isMulticast(){return this.isInSubnet(new l("224.0.0.0/4"))}binaryZeroPad(){return this.bigInt().toString(2).padStart(a.BITS,"0")}groupForV6(){const e=this.parsedAddress;return this.address.replace(a.RE_ADDRESS,`<span class="hover-group group-v4 group-6">${e.slice(0,2).join(".")}</span>.<span class="hover-group group-v4 group-7">${e.slice(2,4).join(".")}</span>`)}}t.Address4=l},2846(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TrackingZone=void 0;const r=n(7562),i=n(6117);class s extends r.ScryptedDeviceBase{trackingState;plugin;config={type:"entry",cameras:[]};storageSettings=new i.StorageSettings(this,{zoneType:{title:"Zone Type",type:"string",choices:["entry","exit","dwell","restricted"],defaultValue:"entry",description:"Type of zone for alerting purposes"},cameras:{title:"Cameras",type:"device",multiple:!0,deviceFilter:`interfaces.includes('${r.ScryptedInterface.ObjectDetector}')`,description:"Cameras that make up this zone"},dwellThreshold:{title:"Dwell Time Threshold (seconds)",type:"number",defaultValue:60,description:"For dwell zones: alert if object stays longer than this"},trackClasses:{title:"Track Object Types",type:"string",multiple:!0,choices:["person","car","vehicle","animal","package"],description:"Object types to monitor in this zone (empty = all)"}});constructor(e,t,n){super(t),this.plugin=e,this.trackingState=n,this.loadConfig(),n.onStateChange(()=>this.evaluateZone()),this.evaluateZone()}loadConfig(){try{const e=this.storage.getItem("zoneConfig");e&&(this.config=JSON.parse(e))}catch(e){this.console.error("Failed to load zone config:",e)}}saveConfig(){try{this.storage.setItem("zoneConfig",JSON.stringify(this.config))}catch(e){this.console.error("Failed to save zone config:",e)}}configure(e){this.config={...this.config,...e},this.saveConfig(),this.evaluateZone()}evaluateZone(){const e=this.getCameraIds();if(0===e.length)return this.occupied=!1,void(this.motionDetected=!1);const t=this.storageSettings.values.trackClasses||[];let n=!1,r=!1;const i=Date.now();for(const s of e){const e=this.trackingState.getObjectsOnCamera(s);for(const o of e){if(t.length>0&&!t.includes(o.className))continue;n=!0;o.sightings.filter(e=>e.cameraId===s&&i-e.timestamp<5e3).some(e=>e.detection.movement?.moving)&&(r=!0)}}this.occupied=n,this.motionDetected=r}getCameraIds(){const e=this.storageSettings.values.cameras;return Array.isArray(e)?e:e?[e]:this.config.cameras||[]}getObjectsInZone(){const e=this.getCameraIds(),t=this.storageSettings.values.trackClasses||[],n=[],r=new Set;for(const i of e)for(const e of this.trackingState.getObjectsOnCamera(i))r.has(e.globalId)||(r.add(e.globalId),(0===t.length||t.includes(e.className))&&n.push(e));return n}async getSettings(){const e=await this.storageSettings.getSettings(),t=this.getObjectsInZone();return e.push({key:"currentStatus",title:"Current Status",type:"string",readonly:!0,value:this.occupied?`Occupied: ${t.length} object${1!==t.length?"s":""}`:"Empty",group:"Status"}),t.length>0&&e.push({key:"objectsList",title:"Objects in Zone",type:"string",readonly:!0,value:t.map(e=>`${e.className}${e.label?` (${e.label})`:""}`).join(", "),group:"Status"}),e}async putSetting(e,t){await this.storageSettings.putSetting(e,t),this.config.type=this.storageSettings.values.zoneType||"entry",this.config.cameras=this.getCameraIds(),this.config.dwellThreshold=1e3*(this.storageSettings.values.dwellThreshold||60),this.saveConfig(),this.evaluateZone()}}t.TrackingZone=s},2860(e){"use strict";e.exports={version:"5.14.1"}},2861(e,t,n){var r=n(181),i=r.Buffer;function s(e,t){for(var n in e)t[n]=e[n]}function o(e,t,n){return i(e,t,n)}i.from&&i.alloc&&i.allocUnsafe&&i.allocUnsafeSlow?e.exports=r:(s(r,t),t.Buffer=o),o.prototype=Object.create(i.prototype),s(i,o),o.from=function(e,t,n){if("number"==typeof e)throw new TypeError("Argument must not be a number");return i(e,t,n)},o.alloc=function(e,t,n){if("number"!=typeof e)throw new TypeError("Argument must be a number");var r=i(e);return void 0!==t?"string"==typeof n?r.fill(t,n):r.fill(t):r.fill(0),r},o.allocUnsafe=function(e){if("number"!=typeof e)throw new TypeError("Argument must be a number");return i(e)},o.allocUnsafeSlow=function(e){if("number"!=typeof e)throw new TypeError("Argument must be a number");return r.SlowBuffer(e)}},2971(e,t,n){"use strict";const r=n(3106),i=n(3338),s=n(4759),{kStatusCode:o}=n(2614),a=Buffer[Symbol.species],c=Buffer.from([0,0,255,255]),l=Symbol("permessage-deflate"),d=Symbol("total-length"),u=Symbol("callback"),h=Symbol("buffers"),p=Symbol("error");let f;function g(e){this[h].push(e),this[d]+=e.length}function m(e){this[d]+=e.length,this[l]._maxPayload<1||this[d]<=this[l]._maxPayload?this[h].push(e):(this[p]=new RangeError("Max payload size exceeded"),this[p].code="WS_ERR_UNSUPPORTED_MESSAGE_LENGTH",this[p][o]=1009,this.removeListener("data",m),this.reset())}function y(e){this[l]._inflate=null,this[p]?this[u](this[p]):(e[o]=1007,this[u](e))}e.exports=class{constructor(e,t,n){if(this._maxPayload=0|n,this._options=e||{},this._threshold=void 0!==this._options.threshold?this._options.threshold:1024,this._isServer=!!t,this._deflate=null,this._inflate=null,this.params=null,!f){const e=void 0!==this._options.concurrencyLimit?this._options.concurrencyLimit:10;f=new s(e)}}static get extensionName(){return"permessage-deflate"}offer(){const e={};return this._options.serverNoContextTakeover&&(e.server_no_context_takeover=!0),this._options.clientNoContextTakeover&&(e.client_no_context_takeover=!0),this._options.serverMaxWindowBits&&(e.server_max_window_bits=this._options.serverMaxWindowBits),this._options.clientMaxWindowBits?e.client_max_window_bits=this._options.clientMaxWindowBits:null==this._options.clientMaxWindowBits&&(e.client_max_window_bits=!0),e}accept(e){return e=this.normalizeParams(e),this.params=this._isServer?this.acceptAsServer(e):this.acceptAsClient(e),this.params}cleanup(){if(this._inflate&&(this._inflate.close(),this._inflate=null),this._deflate){const e=this._deflate[u];this._deflate.close(),this._deflate=null,e&&e(new Error("The deflate stream was closed while data was being processed"))}}acceptAsServer(e){const t=this._options,n=e.find(e=>!(!1===t.serverNoContextTakeover&&e.server_no_context_takeover||e.server_max_window_bits&&(!1===t.serverMaxWindowBits||"number"==typeof t.serverMaxWindowBits&&t.serverMaxWindowBits>e.server_max_window_bits)||"number"==typeof t.clientMaxWindowBits&&!e.client_max_window_bits));if(!n)throw new Error("None of the extension offers can be accepted");return t.serverNoContextTakeover&&(n.server_no_context_takeover=!0),t.clientNoContextTakeover&&(n.client_no_context_takeover=!0),"number"==typeof t.serverMaxWindowBits&&(n.server_max_window_bits=t.serverMaxWindowBits),"number"==typeof t.clientMaxWindowBits?n.client_max_window_bits=t.clientMaxWindowBits:!0!==n.client_max_window_bits&&!1!==t.clientMaxWindowBits||delete n.client_max_window_bits,n}acceptAsClient(e){const t=e[0];if(!1===this._options.clientNoContextTakeover&&t.client_no_context_takeover)throw new Error('Unexpected parameter "client_no_context_takeover"');if(t.client_max_window_bits){if(!1===this._options.clientMaxWindowBits||"number"==typeof this._options.clientMaxWindowBits&&t.client_max_window_bits>this._options.clientMaxWindowBits)throw new Error('Unexpected or invalid parameter "client_max_window_bits"')}else"number"==typeof this._options.clientMaxWindowBits&&(t.client_max_window_bits=this._options.clientMaxWindowBits);return t}normalizeParams(e){return e.forEach(e=>{Object.keys(e).forEach(t=>{let n=e[t];if(n.length>1)throw new Error(`Parameter "${t}" must have only a single value`);if(n=n[0],"client_max_window_bits"===t){if(!0!==n){const e=+n;if(!Number.isInteger(e)||e<8||e>15)throw new TypeError(`Invalid value for parameter "${t}": ${n}`);n=e}else if(!this._isServer)throw new TypeError(`Invalid value for parameter "${t}": ${n}`)}else if("server_max_window_bits"===t){const e=+n;if(!Number.isInteger(e)||e<8||e>15)throw new TypeError(`Invalid value for parameter "${t}": ${n}`);n=e}else{if("client_no_context_takeover"!==t&&"server_no_context_takeover"!==t)throw new Error(`Unknown parameter "${t}"`);if(!0!==n)throw new TypeError(`Invalid value for parameter "${t}": ${n}`)}e[t]=n})}),e}decompress(e,t,n){f.add(r=>{this._decompress(e,t,(e,t)=>{r(),n(e,t)})})}compress(e,t,n){f.add(r=>{this._compress(e,t,(e,t)=>{r(),n(e,t)})})}_decompress(e,t,n){const s=this._isServer?"client":"server";if(!this._inflate){const e=`${s}_max_window_bits`,t="number"!=typeof this.params[e]?r.Z_DEFAULT_WINDOWBITS:this.params[e];this._inflate=r.createInflateRaw({...this._options.zlibInflateOptions,windowBits:t}),this._inflate[l]=this,this._inflate[d]=0,this._inflate[h]=[],this._inflate.on("error",y),this._inflate.on("data",m)}this._inflate[u]=n,this._inflate.write(e),t&&this._inflate.write(c),this._inflate.flush(()=>{const e=this._inflate[p];if(e)return this._inflate.close(),this._inflate=null,void n(e);const r=i.concat(this._inflate[h],this._inflate[d]);this._inflate._readableState.endEmitted?(this._inflate.close(),this._inflate=null):(this._inflate[d]=0,this._inflate[h]=[],t&&this.params[`${s}_no_context_takeover`]&&this._inflate.reset()),n(null,r)})}_compress(e,t,n){const s=this._isServer?"server":"client";if(!this._deflate){const e=`${s}_max_window_bits`,t="number"!=typeof this.params[e]?r.Z_DEFAULT_WINDOWBITS:this.params[e];this._deflate=r.createDeflateRaw({...this._options.zlibDeflateOptions,windowBits:t}),this._deflate[d]=0,this._deflate[h]=[],this._deflate.on("data",g)}this._deflate[u]=n,this._deflate.write(e),this._deflate.flush(r.Z_SYNC_FLUSH,()=>{if(!this._deflate)return;let e=i.concat(this._deflate[h],this._deflate[d]);t&&(e=new a(e.buffer,e.byteOffset,e.length-4)),this._deflate[u]=null,this._deflate[d]=0,this._deflate[h]=[],t&&this.params[`${s}_no_context_takeover`]&&this._deflate.reset(),n(null,e)})}}},3079(e,t,n){const r=n(4829),{EventEmitter:i}=n(4434),s=n(576),o=n(5399),a=n(5753)("mqtt-packet:parser");class c extends i{constructor(){super(),this.parser=this.constructor.parser}static parser(e){return this instanceof c?(this.settings=e||{},this._states=["_parseHeader","_parseLength","_parsePayload","_newPacket"],this._resetState(),this):(new c).parser(e)}_resetState(){a("_resetState: resetting packet, error, _list, and _stateCounter"),this.packet=new s,this.error=null,this._list=r(),this._stateCounter=0}parse(e){for(this.error&&this._resetState(),this._list.append(e),a("parse: current state: %s",this._states[this._stateCounter]);(-1!==this.packet.length||this._list.length>0)&&this[this._states[this._stateCounter]]()&&!this.error;)this._stateCounter++,a("parse: state complete. _stateCounter is now: %d",this._stateCounter),a("parse: packet.length: %d, buffer list length: %d",this.packet.length,this._list.length),this._stateCounter>=this._states.length&&(this._stateCounter=0);return a("parse: exited while loop. packet: %d, buffer list length: %d",this.packet.length,this._list.length),this._list.length}_parseHeader(){const e=this._list.readUInt8(0),t=e>>o.CMD_SHIFT;this.packet.cmd=o.types[t];const n=15&e,r=o.requiredHeaderFlags[t];return null!=r&&n!==r?this._emitError(new Error(o.requiredHeaderFlagsErrors[t])):(this.packet.retain=0!==(e&o.RETAIN_MASK),this.packet.qos=e>>o.QOS_SHIFT&o.QOS_MASK,this.packet.qos>2?this._emitError(new Error("Packet must not have both QoS bits set to 1")):(this.packet.dup=0!==(e&o.DUP_MASK),a("_parseHeader: packet: %o",this.packet),this._list.consume(1),!0))}_parseLength(){const e=this._parseVarByteNum(!0);return e&&(this.packet.length=e.value,this._list.consume(e.bytes)),a("_parseLength %d",e.value),!!e}_parsePayload(){a("_parsePayload: payload %O",this._list);let e=!1;if(0===this.packet.length||this._list.length>=this.packet.length){switch(this._pos=0,this.packet.cmd){case"connect":this._parseConnect();break;case"connack":this._parseConnack();break;case"publish":this._parsePublish();break;case"puback":case"pubrec":case"pubrel":case"pubcomp":this._parseConfirmation();break;case"subscribe":this._parseSubscribe();break;case"suback":this._parseSuback();break;case"unsubscribe":this._parseUnsubscribe();break;case"unsuback":this._parseUnsuback();break;case"pingreq":case"pingresp":break;case"disconnect":this._parseDisconnect();break;case"auth":this._parseAuth();break;default:this._emitError(new Error("Not supported"))}e=!0}return a("_parsePayload complete result: %s",e),e}_parseConnect(){let e,t,n,r;a("_parseConnect");const i={},s=this.packet,c=this._parseString();if(null===c)return this._emitError(new Error("Cannot parse protocolId"));if("MQTT"!==c&&"MQIsdp"!==c)return this._emitError(new Error("Invalid protocolId"));if(s.protocolId=c,this._pos>=this._list.length)return this._emitError(new Error("Packet too short"));if(s.protocolVersion=this._list.readUInt8(this._pos),s.protocolVersion>=128&&(s.bridgeMode=!0,s.protocolVersion=s.protocolVersion-128),3!==s.protocolVersion&&4!==s.protocolVersion&&5!==s.protocolVersion)return this._emitError(new Error("Invalid protocol version"));if(this._pos++,this._pos>=this._list.length)return this._emitError(new Error("Packet too short"));if(1&this._list.readUInt8(this._pos))return this._emitError(new Error("Connect flag bit 0 must be 0, but got 1"));i.username=this._list.readUInt8(this._pos)&o.USERNAME_MASK,i.password=this._list.readUInt8(this._pos)&o.PASSWORD_MASK,i.will=this._list.readUInt8(this._pos)&o.WILL_FLAG_MASK;const l=!!(this._list.readUInt8(this._pos)&o.WILL_RETAIN_MASK),d=(this._list.readUInt8(this._pos)&o.WILL_QOS_MASK)>>o.WILL_QOS_SHIFT;if(i.will)s.will={},s.will.retain=l,s.will.qos=d;else{if(l)return this._emitError(new Error("Will Retain Flag must be set to zero when Will Flag is set to 0"));if(d)return this._emitError(new Error("Will QoS must be set to zero when Will Flag is set to 0"))}if(s.clean=0!==(this._list.readUInt8(this._pos)&o.CLEAN_SESSION_MASK),this._pos++,s.keepalive=this._parseNum(),-1===s.keepalive)return this._emitError(new Error("Packet too short"));if(5===s.protocolVersion){const e=this._parseProperties();Object.getOwnPropertyNames(e).length&&(s.properties=e)}const u=this._parseString();if(null===u)return this._emitError(new Error("Packet too short"));if(s.clientId=u,a("_parseConnect: packet.clientId: %s",s.clientId),i.will){if(5===s.protocolVersion){const e=this._parseProperties();Object.getOwnPropertyNames(e).length&&(s.will.properties=e)}if(e=this._parseString(),null===e)return this._emitError(new Error("Cannot parse will topic"));if(s.will.topic=e,a("_parseConnect: packet.will.topic: %s",s.will.topic),t=this._parseBuffer(),null===t)return this._emitError(new Error("Cannot parse will payload"));s.will.payload=t,a("_parseConnect: packet.will.paylaod: %s",s.will.payload)}if(i.username){if(r=this._parseString(),null===r)return this._emitError(new Error("Cannot parse username"));s.username=r,a("_parseConnect: packet.username: %s",s.username)}if(i.password){if(n=this._parseBuffer(),null===n)return this._emitError(new Error("Cannot parse password"));s.password=n}return this.settings=s,a("_parseConnect: complete"),s}_parseConnack(){a("_parseConnack");const e=this.packet;if(this._list.length<1)return null;const t=this._list.readUInt8(this._pos++);if(t>1)return this._emitError(new Error("Invalid connack flags, bits 7-1 must be set to 0"));if(e.sessionPresent=!!(t&o.SESSIONPRESENT_MASK),5===this.settings.protocolVersion)this._list.length>=2?e.reasonCode=this._list.readUInt8(this._pos++):e.reasonCode=0;else{if(this._list.length<2)return null;e.returnCode=this._list.readUInt8(this._pos++)}if(-1===e.returnCode||-1===e.reasonCode)return this._emitError(new Error("Cannot parse return code"));if(5===this.settings.protocolVersion){const t=this._parseProperties();Object.getOwnPropertyNames(t).length&&(e.properties=t)}a("_parseConnack: complete")}_parsePublish(){a("_parsePublish");const e=this.packet;if(e.topic=this._parseString(),null===e.topic)return this._emitError(new Error("Cannot parse topic"));if(!(e.qos>0)||this._parseMessageId()){if(5===this.settings.protocolVersion){const t=this._parseProperties();Object.getOwnPropertyNames(t).length&&(e.properties=t)}e.payload=this._list.slice(this._pos,e.length),a("_parsePublish: payload from buffer list: %o",e.payload)}}_parseSubscribe(){a("_parseSubscribe");const e=this.packet;let t,n,r,i,s,c,l;if(e.subscriptions=[],this._parseMessageId()){if(5===this.settings.protocolVersion){const t=this._parseProperties();Object.getOwnPropertyNames(t).length&&(e.properties=t)}if(e.length<=0)return this._emitError(new Error("Malformed subscribe, no payload specified"));for(;this._pos<e.length;){if(t=this._parseString(),null===t)return this._emitError(new Error("Cannot parse topic"));if(this._pos>=e.length)return this._emitError(new Error("Malformed Subscribe Payload"));if(n=this._parseByte(),5===this.settings.protocolVersion){if(192&n)return this._emitError(new Error("Invalid subscribe topic flag bits, bits 7-6 must be 0"))}else if(252&n)return this._emitError(new Error("Invalid subscribe topic flag bits, bits 7-2 must be 0"));if(r=n&o.SUBSCRIBE_OPTIONS_QOS_MASK,r>2)return this._emitError(new Error("Invalid subscribe QoS, must be <= 2"));if(c=0!==(n>>o.SUBSCRIBE_OPTIONS_NL_SHIFT&o.SUBSCRIBE_OPTIONS_NL_MASK),s=0!==(n>>o.SUBSCRIBE_OPTIONS_RAP_SHIFT&o.SUBSCRIBE_OPTIONS_RAP_MASK),i=n>>o.SUBSCRIBE_OPTIONS_RH_SHIFT&o.SUBSCRIBE_OPTIONS_RH_MASK,i>2)return this._emitError(new Error("Invalid retain handling, must be <= 2"));l={topic:t,qos:r},5===this.settings.protocolVersion?(l.nl=c,l.rap=s,l.rh=i):this.settings.bridgeMode&&(l.rh=0,l.rap=!0,l.nl=!0),a("_parseSubscribe: push subscription `%s` to subscription",l),e.subscriptions.push(l)}}}_parseSuback(){a("_parseSuback");const e=this.packet;if(this.packet.granted=[],this._parseMessageId()){if(5===this.settings.protocolVersion){const t=this._parseProperties();Object.getOwnPropertyNames(t).length&&(e.properties=t)}if(e.length<=0)return this._emitError(new Error("Malformed suback, no payload specified"));for(;this._pos<this.packet.length;){const e=this._list.readUInt8(this._pos++);if(5===this.settings.protocolVersion){if(!o.MQTT5_SUBACK_CODES[e])return this._emitError(new Error("Invalid suback code"))}else if(e>2&&128!==e)return this._emitError(new Error("Invalid suback QoS, must be 0, 1, 2 or 128"));this.packet.granted.push(e)}}}_parseUnsubscribe(){a("_parseUnsubscribe");const e=this.packet;if(e.unsubscriptions=[],this._parseMessageId()){if(5===this.settings.protocolVersion){const t=this._parseProperties();Object.getOwnPropertyNames(t).length&&(e.properties=t)}if(e.length<=0)return this._emitError(new Error("Malformed unsubscribe, no payload specified"));for(;this._pos<e.length;){const t=this._parseString();if(null===t)return this._emitError(new Error("Cannot parse topic"));a("_parseUnsubscribe: push topic `%s` to unsubscriptions",t),e.unsubscriptions.push(t)}}}_parseUnsuback(){a("_parseUnsuback");const e=this.packet;if(!this._parseMessageId())return this._emitError(new Error("Cannot parse messageId"));if((3===this.settings.protocolVersion||4===this.settings.protocolVersion)&&2!==e.length)return this._emitError(new Error("Malformed unsuback, payload length must be 2"));if(e.length<=0)return this._emitError(new Error("Malformed unsuback, no payload specified"));if(5===this.settings.protocolVersion){const t=this._parseProperties();for(Object.getOwnPropertyNames(t).length&&(e.properties=t),e.granted=[];this._pos<this.packet.length;){const e=this._list.readUInt8(this._pos++);if(!o.MQTT5_UNSUBACK_CODES[e])return this._emitError(new Error("Invalid unsuback code"));this.packet.granted.push(e)}}}_parseConfirmation(){a("_parseConfirmation: packet.cmd: `%s`",this.packet.cmd);const e=this.packet;if(this._parseMessageId(),5===this.settings.protocolVersion){if(e.length>2){switch(e.reasonCode=this._parseByte(),this.packet.cmd){case"puback":case"pubrec":if(!o.MQTT5_PUBACK_PUBREC_CODES[e.reasonCode])return this._emitError(new Error("Invalid "+this.packet.cmd+" reason code"));break;case"pubrel":case"pubcomp":if(!o.MQTT5_PUBREL_PUBCOMP_CODES[e.reasonCode])return this._emitError(new Error("Invalid "+this.packet.cmd+" reason code"))}a("_parseConfirmation: packet.reasonCode `%d`",e.reasonCode)}else e.reasonCode=0;if(e.length>3){const t=this._parseProperties();Object.getOwnPropertyNames(t).length&&(e.properties=t)}}return!0}_parseDisconnect(){const e=this.packet;if(a("_parseDisconnect"),5===this.settings.protocolVersion){this._list.length>0?(e.reasonCode=this._parseByte(),o.MQTT5_DISCONNECT_CODES[e.reasonCode]||this._emitError(new Error("Invalid disconnect reason code"))):e.reasonCode=0;const t=this._parseProperties();Object.getOwnPropertyNames(t).length&&(e.properties=t)}return a("_parseDisconnect result: true"),!0}_parseAuth(){a("_parseAuth");const e=this.packet;if(5!==this.settings.protocolVersion)return this._emitError(new Error("Not supported auth packet for this version MQTT"));if(e.reasonCode=this._parseByte(),!o.MQTT5_AUTH_CODES[e.reasonCode])return this._emitError(new Error("Invalid auth reason code"));const t=this._parseProperties();return Object.getOwnPropertyNames(t).length&&(e.properties=t),a("_parseAuth: result: true"),!0}_parseMessageId(){const e=this.packet;return e.messageId=this._parseNum(),null===e.messageId?(this._emitError(new Error("Cannot parse messageId")),!1):(a("_parseMessageId: packet.messageId %d",e.messageId),!0)}_parseString(e){const t=this._parseNum(),n=t+this._pos;if(-1===t||n>this._list.length||n>this.packet.length)return null;const r=this._list.toString("utf8",this._pos,n);return this._pos+=t,a("_parseString: result: %s",r),r}_parseStringPair(){return a("_parseStringPair"),{name:this._parseString(),value:this._parseString()}}_parseBuffer(){const e=this._parseNum(),t=e+this._pos;if(-1===e||t>this._list.length||t>this.packet.length)return null;const n=this._list.slice(this._pos,t);return this._pos+=e,a("_parseBuffer: result: %o",n),n}_parseNum(){if(this._list.length-this._pos<2)return-1;const e=this._list.readUInt16BE(this._pos);return this._pos+=2,a("_parseNum: result: %s",e),e}_parse4ByteNum(){if(this._list.length-this._pos<4)return-1;const e=this._list.readUInt32BE(this._pos);return this._pos+=4,a("_parse4ByteNum: result: %s",e),e}_parseVarByteNum(e){a("_parseVarByteNum");let t,n=0,r=1,i=0,s=!1;const c=this._pos?this._pos:0;for(;n<4&&c+n<this._list.length;){if(t=this._list.readUInt8(c+n++),i+=r*(t&o.VARBYTEINT_MASK),r*=128,0===(t&o.VARBYTEINT_FIN_MASK)){s=!0;break}if(this._list.length<=n)break}return!s&&4===n&&this._list.length>=n&&this._emitError(new Error("Invalid variable byte integer")),c&&(this._pos+=n),s=!!s&&(e?{bytes:n,value:i}:i),a("_parseVarByteNum: result: %o",s),s}_parseByte(){let e;return this._pos<this._list.length&&(e=this._list.readUInt8(this._pos),this._pos++),a("_parseByte: result: %o",e),e}_parseByType(e){switch(a("_parseByType: type: %s",e),e){case"byte":return 0!==this._parseByte();case"int8":return this._parseByte();case"int16":return this._parseNum();case"int32":return this._parse4ByteNum();case"var":return this._parseVarByteNum();case"string":return this._parseString();case"pair":return this._parseStringPair();case"binary":return this._parseBuffer()}}_parseProperties(){a("_parseProperties");const e=this._parseVarByteNum(),t=this._pos+e,n={};for(;this._pos<t;){const e=this._parseByte();if(!e)return this._emitError(new Error("Cannot parse property code type")),!1;const t=o.propertiesCodes[e];if(!t)return this._emitError(new Error("Unknown property")),!1;if("userProperties"===t){n[t]||(n[t]=Object.create(null));const e=this._parseByType(o.propertiesTypes[t]);if(n[t][e.name])if(Array.isArray(n[t][e.name]))n[t][e.name].push(e.value);else{const r=n[t][e.name];n[t][e.name]=[r],n[t][e.name].push(e.value)}else n[t][e.name]=e.value;continue}n[t]?(Array.isArray(n[t])||(n[t]=[n[t]]),n[t].push(this._parseByType(o.propertiesTypes[t]))):n[t]=this._parseByType(o.propertiesTypes[t])}return n}_newPacket(){return a("_newPacket"),this.packet&&(this._list.consume(this.packet.length),a("_newPacket: parser emit packet: packet.cmd: %s, packet.payload: %s, packet.length: %d",this.packet.cmd,this.packet.payload,this.packet.length),this.emit("packet",this.packet)),a("_newPacket: new packet"),this.packet=new s,this._pos=0,!0}_emitError(e){a("_emitError",e),this.error=e,this.emit("error",e)}}e.exports=c},3095(e,t,n){"use strict";const{ArrayPrototypePop:r,Promise:i}=n(4134),{isIterable:s,isNodeStream:o,isWebStream:a}=n(6115),{pipelineImpl:c}=n(7758),{finished:l}=n(6238);n(5506),e.exports={finished:l,pipeline:function(...e){return new i((t,n)=>{let i,l;const d=e[e.length-1];if(d&&"object"==typeof d&&!o(d)&&!s(d)&&!a(d)){const t=r(e);i=t.signal,l=t.end}c(e,(e,r)=>{e?n(e):t(r)},{signal:i,end:l})})}}},3106(e){"use strict";e.exports=require("zlib")},3132(e,t,n){const r=n(5399),{Buffer:i}=n(181),s=i.allocUnsafe(0),o=i.from([0]),a=n(6172),c=n(3225).nextTick,l=n(5753)("mqtt-packet:writeToStream"),d=a.cache,u=a.generateNumber,h=a.generateCache,p=a.genBufVariableByteInt,f=a.generate4ByteBuffer;let g=k,m=!0;function y(e,t,n){switch(l("generate called"),t.cork&&(t.cork(),c(b,t)),m&&(m=!1,h()),l("generate: packet.cmd: %s",e.cmd),e.cmd){case"connect":return function(e,t){const n=e||{},s=n.protocolId||"MQTT";let o=n.protocolVersion||4;const a=n.will;let c=n.clean;const l=n.keepalive||0,d=n.clientId||"",u=n.username,h=n.password,p=n.properties;void 0===c&&(c=!0);let f,m,y=0;if(!s||"string"!=typeof s&&!i.isBuffer(s))return t.destroy(new Error("Invalid protocolId")),!1;y+=s.length+2;if(3!==o&&4!==o&&5!==o)return t.destroy(new Error("Invalid protocol version")),!1;y+=1;if(("string"==typeof d||i.isBuffer(d))&&(d||o>=4)&&(d||c))y+=i.byteLength(d)+2;else{if(o<4)return t.destroy(new Error("clientId must be supplied before 3.1.1")),!1;if(1*c==0)return t.destroy(new Error("clientId must be given if cleanSession set to 0")),!1}if("number"!=typeof l||l<0||l>65535||l%1!=0)return t.destroy(new Error("Invalid keepalive")),!1;y+=2;if(y+=1,5===o){if(f=x(t,p),!f)return!1;y+=f.length}if(a){if("object"!=typeof a)return t.destroy(new Error("Invalid will")),!1;if(!a.topic||"string"!=typeof a.topic)return t.destroy(new Error("Invalid will topic")),!1;if(y+=i.byteLength(a.topic)+2,y+=2,a.payload){if(!(a.payload.length>=0))return t.destroy(new Error("Invalid will payload")),!1;"string"==typeof a.payload?y+=i.byteLength(a.payload):y+=a.payload.length}if(m={},5===o){if(m=x(t,a.properties),!m)return!1;y+=m.length}}let b=!1;if(null!=u){if(!P(u))return t.destroy(new Error("Invalid username")),!1;b=!0,y+=i.byteLength(u)+2}if(null!=h){if(!b)return t.destroy(new Error("Username is required to use password")),!1;if(!P(h))return t.destroy(new Error("Invalid password")),!1;y+=A(h)+2}t.write(r.CONNECT_HEADER),S(t,y),E(t,s),n.bridgeMode&&(o+=128);t.write(131===o?r.VERSION131:132===o?r.VERSION132:4===o?r.VERSION4:5===o?r.VERSION5:r.VERSION3);let v=0;v|=null!=u?r.USERNAME_MASK:0,v|=null!=h?r.PASSWORD_MASK:0,v|=a&&a.retain?r.WILL_RETAIN_MASK:0,v|=a&&a.qos?a.qos<<r.WILL_QOS_SHIFT:0,v|=a?r.WILL_FLAG_MASK:0,v|=c?r.CLEAN_SESSION_MASK:0,t.write(i.from([v])),g(t,l),5===o&&f.write();E(t,d),a&&(5===o&&m.write(),_(t,a.topic),E(t,a.payload));null!=u&&E(t,u);null!=h&&E(t,h);return!0}(e,t);case"connack":return function(e,t,n){const s=n?n.protocolVersion:4,a=e||{},c=5===s?a.reasonCode:a.returnCode,l=a.properties;let d=2;if("number"!=typeof c)return t.destroy(new Error("Invalid return code")),!1;let u=null;if(5===s){if(u=x(t,l),!u)return!1;d+=u.length}t.write(r.CONNACK_HEADER),S(t,d),t.write(a.sessionPresent?r.SESSIONPRESENT_HEADER:o),t.write(i.from([c])),null!=u&&u.write();return!0}(e,t,n);case"publish":return function(e,t,n){l("publish: packet: %o",e);const o=n?n.protocolVersion:4,a=e||{},c=a.qos||0,d=a.retain?r.RETAIN_MASK:0,u=a.topic,h=a.payload||s,p=a.messageId,f=a.properties;let m=0;if("string"==typeof u)m+=i.byteLength(u)+2;else{if(!i.isBuffer(u))return t.destroy(new Error("Invalid topic")),!1;m+=u.length+2}i.isBuffer(h)?m+=h.length:m+=i.byteLength(h);if(c&&"number"!=typeof p)return t.destroy(new Error("Invalid messageId")),!1;c&&(m+=2);let y=null;if(5===o){if(y=x(t,f),!y)return!1;m+=y.length}t.write(r.PUBLISH_HEADER[c][a.dup?1:0][d?1:0]),S(t,m),g(t,A(u)),t.write(u),c>0&&g(t,p);null!=y&&y.write();return l("publish: payload: %o",h),t.write(h)}(e,t,n);case"puback":case"pubrec":case"pubrel":case"pubcomp":return function(e,t,n){const s=n?n.protocolVersion:4,o=e||{},a=o.cmd||"puback",c=o.messageId,l=o.dup&&"pubrel"===a?r.DUP_MASK:0;let d=0;const u=o.reasonCode,h=o.properties;let p=5===s?3:2;"pubrel"===a&&(d=1);if("number"!=typeof c)return t.destroy(new Error("Invalid messageId")),!1;let f=null;if(5===s&&"object"==typeof h){if(f=T(t,h,n,p),!f)return!1;p+=f.length}t.write(r.ACKS[a][d][l][0]),3===p&&(p+=0!==u?1:-1);S(t,p),g(t,c),5===s&&2!==p&&t.write(i.from([u]));null!==f?f.write():4===p&&t.write(i.from([0]));return!0}(e,t,n);case"subscribe":return function(e,t,n){l("subscribe: packet: ");const s=n?n.protocolVersion:4,o=e||{},a=o.dup?r.DUP_MASK:0,c=o.messageId,d=o.subscriptions,u=o.properties;let h=0;if("number"!=typeof c)return t.destroy(new Error("Invalid messageId")),!1;h+=2;let p=null;if(5===s){if(p=x(t,u),!p)return!1;h+=p.length}if("object"!=typeof d||!d.length)return t.destroy(new Error("Invalid subscriptions")),!1;for(let e=0;e<d.length;e+=1){const n=d[e].topic,r=d[e].qos;if("string"!=typeof n)return t.destroy(new Error("Invalid subscriptions - invalid topic")),!1;if("number"!=typeof r)return t.destroy(new Error("Invalid subscriptions - invalid qos")),!1;if(5===s){if("boolean"!=typeof(d[e].nl||!1))return t.destroy(new Error("Invalid subscriptions - invalid No Local")),!1;if("boolean"!=typeof(d[e].rap||!1))return t.destroy(new Error("Invalid subscriptions - invalid Retain as Published")),!1;const n=d[e].rh||0;if("number"!=typeof n||n>2)return t.destroy(new Error("Invalid subscriptions - invalid Retain Handling")),!1}h+=i.byteLength(n)+2+1}l("subscribe: writing to stream: %o",r.SUBSCRIBE_HEADER),t.write(r.SUBSCRIBE_HEADER[1][a?1:0][0]),S(t,h),g(t,c),null!==p&&p.write();let f=!0;for(const e of d){const n=e.topic,o=e.qos,a=+e.nl,c=+e.rap,l=e.rh;let d;_(t,n),d=r.SUBSCRIBE_OPTIONS_QOS[o],5===s&&(d|=a?r.SUBSCRIBE_OPTIONS_NL:0,d|=c?r.SUBSCRIBE_OPTIONS_RAP:0,d|=l?r.SUBSCRIBE_OPTIONS_RH[l]:0),f=t.write(i.from([d]))}return f}(e,t,n);case"suback":return function(e,t,n){const s=n?n.protocolVersion:4,o=e||{},a=o.messageId,c=o.granted,l=o.properties;let d=0;if("number"!=typeof a)return t.destroy(new Error("Invalid messageId")),!1;d+=2;if("object"!=typeof c||!c.length)return t.destroy(new Error("Invalid qos vector")),!1;for(let e=0;e<c.length;e+=1){if("number"!=typeof c[e])return t.destroy(new Error("Invalid qos vector")),!1;d+=1}let u=null;if(5===s){if(u=T(t,l,n,d),!u)return!1;d+=u.length}t.write(r.SUBACK_HEADER),S(t,d),g(t,a),null!==u&&u.write();return t.write(i.from(c))}(e,t,n);case"unsubscribe":return function(e,t,n){const s=n?n.protocolVersion:4,o=e||{},a=o.messageId,c=o.dup?r.DUP_MASK:0,l=o.unsubscriptions,d=o.properties;let u=0;if("number"!=typeof a)return t.destroy(new Error("Invalid messageId")),!1;u+=2;if("object"!=typeof l||!l.length)return t.destroy(new Error("Invalid unsubscriptions")),!1;for(let e=0;e<l.length;e+=1){if("string"!=typeof l[e])return t.destroy(new Error("Invalid unsubscriptions")),!1;u+=i.byteLength(l[e])+2}let h=null;if(5===s){if(h=x(t,d),!h)return!1;u+=h.length}t.write(r.UNSUBSCRIBE_HEADER[1][c?1:0][0]),S(t,u),g(t,a),null!==h&&h.write();let p=!0;for(let e=0;e<l.length;e++)p=_(t,l[e]);return p}(e,t,n);case"unsuback":return function(e,t,n){const s=n?n.protocolVersion:4,o=e||{},a=o.messageId,c=o.dup?r.DUP_MASK:0,l=o.granted,d=o.properties,u=o.cmd,h=0;let p=2;if("number"!=typeof a)return t.destroy(new Error("Invalid messageId")),!1;if(5===s){if("object"!=typeof l||!l.length)return t.destroy(new Error("Invalid qos vector")),!1;for(let e=0;e<l.length;e+=1){if("number"!=typeof l[e])return t.destroy(new Error("Invalid qos vector")),!1;p+=1}}let f=null;if(5===s){if(f=T(t,d,n,p),!f)return!1;p+=f.length}t.write(r.ACKS[u][h][c][0]),S(t,p),g(t,a),null!==f&&f.write();5===s&&t.write(i.from(l));return!0}(e,t,n);case"pingreq":case"pingresp":return function(e,t){return t.write(r.EMPTY[e.cmd])}(e,t);case"disconnect":return function(e,t,n){const s=n?n.protocolVersion:4,o=e||{},a=o.reasonCode,c=o.properties;let l=5===s?1:0,d=null;if(5===s){if(d=T(t,c,n,l),!d)return!1;l+=d.length}t.write(i.from([r.codes.disconnect<<4])),S(t,l),5===s&&t.write(i.from([a]));null!==d&&d.write();return!0}(e,t,n);case"auth":return function(e,t,n){const s=n?n.protocolVersion:4,o=e||{},a=o.reasonCode,c=o.properties;let l=5===s?1:0;5!==s&&t.destroy(new Error("Invalid mqtt version for auth packet"));const d=T(t,c,n,l);if(!d)return!1;l+=d.length,t.write(i.from([r.codes.auth<<4])),S(t,l),t.write(i.from([a])),null!==d&&d.write();return!0}(e,t,n);default:return t.destroy(new Error("Unknown command")),!1}}function b(e){e.uncork()}Object.defineProperty(y,"cacheNumbers",{get:()=>g===k,set(e){e?(d&&0!==Object.keys(d).length||(m=!0),g=k):(m=!1,g=I)}});const v={};function S(e,t){if(t>r.VARBYTEINT_MAX)return e.destroy(new Error(`Invalid variable byte integer: ${t}`)),!1;let n=v[t];return n||(n=p(t),t<16384&&(v[t]=n)),l("writeVarByteInt: writing to stream: %o",n),e.write(n)}function _(e,t){const n=i.byteLength(t);return g(e,n),l("writeString: %s",t),e.write(t,"utf8")}function w(e,t,n){_(e,t),_(e,n)}function k(e,t){return l("writeNumberCached: number: %d",t),l("writeNumberCached: %o",d[t]),e.write(d[t])}function I(e,t){const n=u(t);return l("writeNumberGenerated: %o",n),e.write(n)}function E(e,t){"string"==typeof t?_(e,t):t?(g(e,t.length),e.write(t)):g(e,0)}function x(e,t){if("object"!=typeof t||null!=t.length)return{length:1,write(){O(e,{},0)}};let n=0;function s(t,n){let s=0;switch(r.propertiesTypes[t]){case"byte":if("boolean"!=typeof n)return e.destroy(new Error(`Invalid ${t}: ${n}`)),!1;s+=2;break;case"int8":if("number"!=typeof n||n<0||n>255)return e.destroy(new Error(`Invalid ${t}: ${n}`)),!1;s+=2;break;case"binary":if(n&&null===n)return e.destroy(new Error(`Invalid ${t}: ${n}`)),!1;s+=1+i.byteLength(n)+2;break;case"int16":if("number"!=typeof n||n<0||n>65535)return e.destroy(new Error(`Invalid ${t}: ${n}`)),!1;s+=3;break;case"int32":if("number"!=typeof n||n<0||n>4294967295)return e.destroy(new Error(`Invalid ${t}: ${n}`)),!1;s+=5;break;case"var":if("number"!=typeof n||n<0||n>268435455)return e.destroy(new Error(`Invalid ${t}: ${n}`)),!1;s+=1+i.byteLength(p(n));break;case"string":if("string"!=typeof n)return e.destroy(new Error(`Invalid ${t}: ${n}`)),!1;s+=3+i.byteLength(n.toString());break;case"pair":if("object"!=typeof n)return e.destroy(new Error(`Invalid ${t}: ${n}`)),!1;s+=Object.getOwnPropertyNames(n).reduce((e,t)=>{const r=n[t];return Array.isArray(r)?e+=r.reduce((e,n)=>e+=3+i.byteLength(t.toString())+2+i.byteLength(n.toString()),0):e+=3+i.byteLength(t.toString())+2+i.byteLength(n[t].toString()),e},0);break;default:return e.destroy(new Error(`Invalid property ${t}: ${n}`)),!1}return s}if(t)for(const e in t){let r=0,i=0;const o=t[e];if(void 0!==o){if(Array.isArray(o))for(let t=0;t<o.length;t++){if(i=s(e,o[t]),!i)return!1;r+=i}else{if(i=s(e,o),!i)return!1;r=i}if(!r)return!1;n+=r}}return{length:i.byteLength(p(n))+n,write(){O(e,t,n)}}}function T(e,t,n,r){const i=["reasonString","userProperties"],s=n&&n.properties&&n.properties.maximumPacketSize?n.properties.maximumPacketSize:0;let o=x(e,t);if(s)for(;r+o.length>s;){const n=i.shift();if(!n||!t[n])return!1;delete t[n],o=x(e,t)}return o}function C(e,t,n){switch(r.propertiesTypes[t]){case"byte":e.write(i.from([r.properties[t]])),e.write(i.from([+n]));break;case"int8":e.write(i.from([r.properties[t]])),e.write(i.from([n]));break;case"binary":e.write(i.from([r.properties[t]])),E(e,n);break;case"int16":e.write(i.from([r.properties[t]])),g(e,n);break;case"int32":e.write(i.from([r.properties[t]])),function(e,t){const n=f(t);l("write4ByteNumber: %o",n),e.write(n)}(e,n);break;case"var":e.write(i.from([r.properties[t]])),S(e,n);break;case"string":e.write(i.from([r.properties[t]])),_(e,n);break;case"pair":Object.getOwnPropertyNames(n).forEach(s=>{const o=n[s];Array.isArray(o)?o.forEach(n=>{e.write(i.from([r.properties[t]])),w(e,s.toString(),n.toString())}):(e.write(i.from([r.properties[t]])),w(e,s.toString(),o.toString()))});break;default:return e.destroy(new Error(`Invalid property ${t} value: ${n}`)),!1}}function O(e,t,n){S(e,n);for(const n in t)if(Object.prototype.hasOwnProperty.call(t,n)&&null!=t[n]){const r=t[n];if(Array.isArray(r))for(let t=0;t<r.length;t++)C(e,n,r[t]);else C(e,n,r)}}function A(e){return e?e instanceof i?e.length:i.byteLength(e):0}function P(e){return"string"==typeof e||e instanceof i}e.exports=y},3141(e,t,n){"use strict";var r=n(2861).Buffer,i=r.isEncoding||function(e){switch((e=""+e)&&e.toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":case"raw":return!0;default:return!1}};function s(e){var t;switch(this.encoding=function(e){var t=function(e){if(!e)return"utf8";for(var t;;)switch(e){case"utf8":case"utf-8":return"utf8";case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return"utf16le";case"latin1":case"binary":return"latin1";case"base64":case"ascii":case"hex":return e;default:if(t)return;e=(""+e).toLowerCase(),t=!0}}(e);if("string"!=typeof t&&(r.isEncoding===i||!i(e)))throw new Error("Unknown encoding: "+e);return t||e}(e),this.encoding){case"utf16le":this.text=c,this.end=l,t=4;break;case"utf8":this.fillLast=a,t=4;break;case"base64":this.text=d,this.end=u,t=3;break;default:return this.write=h,void(this.end=p)}this.lastNeed=0,this.lastTotal=0,this.lastChar=r.allocUnsafe(t)}function o(e){return e<=127?0:e>>5==6?2:e>>4==14?3:e>>3==30?4:e>>6==2?-1:-2}function a(e){var t=this.lastTotal-this.lastNeed,n=function(e,t){if(128!=(192&t[0]))return e.lastNeed=0,"�";if(e.lastNeed>1&&t.length>1){if(128!=(192&t[1]))return e.lastNeed=1,"�";if(e.lastNeed>2&&t.length>2&&128!=(192&t[2]))return e.lastNeed=2,"�"}}(this,e);return void 0!==n?n:this.lastNeed<=e.length?(e.copy(this.lastChar,t,0,this.lastNeed),this.lastChar.toString(this.encoding,0,this.lastTotal)):(e.copy(this.lastChar,t,0,e.length),void(this.lastNeed-=e.length))}function c(e,t){if((e.length-t)%2==0){var n=e.toString("utf16le",t);if(n){var r=n.charCodeAt(n.length-1);if(r>=55296&&r<=56319)return this.lastNeed=2,this.lastTotal=4,this.lastChar[0]=e[e.length-2],this.lastChar[1]=e[e.length-1],n.slice(0,-1)}return n}return this.lastNeed=1,this.lastTotal=2,this.lastChar[0]=e[e.length-1],e.toString("utf16le",t,e.length-1)}function l(e){var t=e&&e.length?this.write(e):"";if(this.lastNeed){var n=this.lastTotal-this.lastNeed;return t+this.lastChar.toString("utf16le",0,n)}return t}function d(e,t){var n=(e.length-t)%3;return 0===n?e.toString("base64",t):(this.lastNeed=3-n,this.lastTotal=3,1===n?this.lastChar[0]=e[e.length-1]:(this.lastChar[0]=e[e.length-2],this.lastChar[1]=e[e.length-1]),e.toString("base64",t,e.length-n))}function u(e){var t=e&&e.length?this.write(e):"";return this.lastNeed?t+this.lastChar.toString("base64",0,3-this.lastNeed):t}function h(e){return e.toString(this.encoding)}function p(e){return e&&e.length?this.write(e):""}t.StringDecoder=s,s.prototype.write=function(e){if(0===e.length)return"";var t,n;if(this.lastNeed){if(void 0===(t=this.fillLast(e)))return"";n=this.lastNeed,this.lastNeed=0}else n=0;return n<e.length?t?t+this.text(e,n):this.text(e,n):t||""},s.prototype.end=function(e){var t=e&&e.length?this.write(e):"";return this.lastNeed?t+"�":t},s.prototype.text=function(e,t){var n=function(e,t,n){var r=t.length-1;if(r<n)return 0;var i=o(t[r]);if(i>=0)return i>0&&(e.lastNeed=i-1),i;if(--r<n||-2===i)return 0;if(i=o(t[r]),i>=0)return i>0&&(e.lastNeed=i-2),i;if(--r<n||-2===i)return 0;if(i=o(t[r]),i>=0)return i>0&&(2===i?i=0:e.lastNeed=i-3),i;return 0}(this,e,t);if(!this.lastNeed)return e.toString("utf8",t);this.lastTotal=n;var r=e.length-(n-this.lastNeed);return e.copy(this.lastChar,0,r),e.toString("utf8",t,r)},s.prototype.fillLast=function(e){if(this.lastNeed<=e.length)return e.copy(this.lastChar,this.lastTotal-this.lastNeed,0,this.lastNeed),this.lastChar.toString(this.encoding,0,this.lastTotal);e.copy(this.lastChar,this.lastTotal-this.lastNeed,0,e.length),this.lastNeed-=e.length}},3175(e,t,n){"use strict";var r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const i=r(n(7732));t.default=class{_keepalive;timerId;timer;destroyed=!1;counter;client;_keepaliveTimeoutTimestamp;_intervalEvery;get keepaliveTimeoutTimestamp(){return this._keepaliveTimeoutTimestamp}get intervalEvery(){return this._intervalEvery}get keepalive(){return this._keepalive}constructor(e,t){this.client=e,this.timer="object"==typeof t&&"set"in t&&"clear"in t?t:(0,i.default)(t),this.setKeepalive(e.options.keepalive)}clear(){this.timerId&&(this.timer.clear(this.timerId),this.timerId=null)}setKeepalive(e){if(e*=1e3,isNaN(e)||e<=0||e>2147483647)throw new Error(`Keepalive value must be an integer between 0 and 2147483647. Provided value is ${e}`);this._keepalive=e,this.reschedule(),this.client.log(`KeepaliveManager: set keepalive to ${e}ms`)}destroy(){this.clear(),this.destroyed=!0}reschedule(){if(this.destroyed)return;this.clear(),this.counter=0;const e=Math.ceil(1.5*this._keepalive);this._keepaliveTimeoutTimestamp=Date.now()+e,this._intervalEvery=Math.ceil(this._keepalive/2),this.timerId=this.timer.set(()=>{this.destroyed||(this.counter+=1,2===this.counter?this.client.sendPing():this.counter>2&&this.client.onKeepaliveTimeout())},this._intervalEvery)}}},3225(e){"use strict";"undefined"==typeof process||!process.version||0===process.version.indexOf("v0.")||0===process.version.indexOf("v1.")&&0!==process.version.indexOf("v1.8.")?e.exports={nextTick:function(e,t,n,r){if("function"!=typeof e)throw new TypeError('"callback" argument must be a function');var i,s,o=arguments.length;switch(o){case 0:case 1:return process.nextTick(e);case 2:return process.nextTick(function(){e.call(null,t)});case 3:return process.nextTick(function(){e.call(null,t,n)});case 4:return process.nextTick(function(){e.call(null,t,n,r)});default:for(i=new Array(o-1),s=0;s<i.length;)i[s++]=arguments[s];return process.nextTick(function(){e.apply(null,i)})}}}:e.exports=process},3338(e,t,n){"use strict";const{EMPTY_BUFFER:r}=n(2614),i=Buffer[Symbol.species];function s(e,t,n,r,i){for(let s=0;s<i;s++)n[r+s]=e[s]^t[3&s]}function o(e,t){for(let n=0;n<e.length;n++)e[n]^=t[3&n]}if(e.exports={concat:function(e,t){if(0===e.length)return r;if(1===e.length)return e[0];const n=Buffer.allocUnsafe(t);let s=0;for(let t=0;t<e.length;t++){const r=e[t];n.set(r,s),s+=r.length}return s<t?new i(n.buffer,n.byteOffset,s):n},mask:s,toArrayBuffer:function(e){return e.length===e.buffer.byteLength?e.buffer:e.buffer.slice(e.byteOffset,e.byteOffset+e.length)},toBuffer:function e(t){if(e.readOnly=!0,Buffer.isBuffer(t))return t;let n;return t instanceof ArrayBuffer?n=new i(t):ArrayBuffer.isView(t)?n=new i(t.buffer,t.byteOffset,t.byteLength):(n=Buffer.from(t),e.readOnly=!1),n},unmask:o},!process.env.WS_NO_BUFFER_UTIL)try{const t=n(Object(function(){var e=new Error("Cannot find module 'bufferutil'");throw e.code="MODULE_NOT_FOUND",e}()));e.exports.mask=function(e,n,r,i,o){o<48?s(e,n,r,i,o):t.mask(e,n,r,i,o)},e.exports.unmask=function(e,n){e.length<32?o(e,n):t.unmask(e,n)}}catch(e){}},3339(e){"use strict";e.exports=require("module")},3370(e,t,n){"use strict";const{ObjectDefineProperties:r,ObjectGetOwnPropertyDescriptor:i,ObjectKeys:s,ObjectSetPrototypeOf:o}=n(4134);e.exports=l;const a=n(7576),c=n(8584);o(l.prototype,a.prototype),o(l,a);{const e=s(c.prototype);for(let t=0;t<e.length;t++){const n=e[t];l.prototype[n]||(l.prototype[n]=c.prototype[n])}}function l(e){if(!(this instanceof l))return new l(e);a.call(this,e),c.call(this,e),e?(this.allowHalfOpen=!1!==e.allowHalfOpen,!1===e.readable&&(this._readableState.readable=!1,this._readableState.ended=!0,this._readableState.endEmitted=!0),!1===e.writable&&(this._writableState.writable=!1,this._writableState.ending=!0,this._writableState.ended=!0,this._writableState.finished=!0)):this.allowHalfOpen=!0}let d,u;function h(){return void 0===d&&(d={}),d}r(l.prototype,{writable:{__proto__:null,...i(c.prototype,"writable")},writableHighWaterMark:{__proto__:null,...i(c.prototype,"writableHighWaterMark")},writableObjectMode:{__proto__:null,...i(c.prototype,"writableObjectMode")},writableBuffer:{__proto__:null,...i(c.prototype,"writableBuffer")},writableLength:{__proto__:null,...i(c.prototype,"writableLength")},writableFinished:{__proto__:null,...i(c.prototype,"writableFinished")},writableCorked:{__proto__:null,...i(c.prototype,"writableCorked")},writableEnded:{__proto__:null,...i(c.prototype,"writableEnded")},writableNeedDrain:{__proto__:null,...i(c.prototype,"writableNeedDrain")},destroyed:{__proto__:null,get(){return void 0!==this._readableState&&void 0!==this._writableState&&(this._readableState.destroyed&&this._writableState.destroyed)},set(e){this._readableState&&this._writableState&&(this._readableState.destroyed=e,this._writableState.destroyed=e)}}}),l.fromWeb=function(e,t){return h().newStreamDuplexFromReadableWritablePair(e,t)},l.toWeb=function(e){return h().newReadableWritablePairFromDuplex(e)},l.from=function(e){return u||(u=n(6706)),u(e,"body")}},3497(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const r=n(4966),i=n(720);t.default=class{aliasToTopic;topicToAlias;max;numberAllocator;length;constructor(e){e>0&&(this.aliasToTopic=new r.LRUCache({max:e}),this.topicToAlias={},this.numberAllocator=new i.NumberAllocator(1,e),this.max=e,this.length=0)}put(e,t){if(0===t||t>this.max)return!1;const n=this.aliasToTopic.get(t);return n&&delete this.topicToAlias[n],this.aliasToTopic.set(t,e),this.topicToAlias[e]=t,this.numberAllocator.use(t),this.length=this.aliasToTopic.size,!0}getTopicByAlias(e){return this.aliasToTopic.get(e)}getAliasByTopic(e){const t=this.topicToAlias[e];return"undefined"!=typeof t&&this.aliasToTopic.get(t),t}clear(){this.aliasToTopic.clear(),this.topicToAlias={},this.numberAllocator.clear(),this.length=0}getLruAlias(){const e=this.numberAllocator.firstVacant();return e||[...this.aliasToTopic.keys()][this.aliasToTopic.size-1]}}},3719(e,t,n){"use strict";n(1060);const{Duplex:r}=n(2203);function i(e){e.emit("close")}function s(){!this.destroyed&&this._writableState.finished&&this.destroy()}function o(e){this.removeListener("error",o),this.destroy(),0===this.listenerCount("error")&&this.emit("error",e)}e.exports=function(e,t){let n=!0;const a=new r({...t,autoDestroy:!1,emitClose:!1,objectMode:!1,writableObjectMode:!1});return e.on("message",function(t,n){const r=!n&&a._readableState.objectMode?t.toString():t;a.push(r)||e.pause()}),e.once("error",function(e){a.destroyed||(n=!1,a.destroy(e))}),e.once("close",function(){a.destroyed||a.push(null)}),a._destroy=function(t,r){if(e.readyState===e.CLOSED)return r(t),void process.nextTick(i,a);let s=!1;e.once("error",function(e){s=!0,r(e)}),e.once("close",function(){s||r(t),process.nextTick(i,a)}),n&&e.terminate()},a._final=function(t){e.readyState!==e.CONNECTING?null!==e._socket&&(e._socket._writableState.finished?(t(),a._readableState.endEmitted&&a.destroy()):(e._socket.once("finish",function(){t()}),e.close())):e.once("open",function(){a._final(t)})},a._read=function(){e.isPaused&&e.resume()},a._write=function(t,n,r){e.readyState!==e.CONNECTING?e.send(t,r):e.once("open",function(){a._write(t,n,r)})},a.on("end",s),a.on("error",o),a}},3763(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.shuffleArray=t.SocksClientError=void 0;class n extends Error{constructor(e,t){super(e),this.options=t}}t.SocksClientError=n,t.shuffleArray=function(e){for(let t=e.length-1;t>0;t--){const n=Math.floor(Math.random()*(t+1));[e[t],e[n]]=[e[n],e[t]]}}},3874(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.EDITOR_HTML=void 0,t.EDITOR_HTML="<!DOCTYPE html>\n<html lang=\"en\">\n<head>\n  <meta charset=\"UTF-8\">\n  <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n  <title>Spatial Awareness - Topology Editor</title>\n  <style>\n    * { box-sizing: border-box; margin: 0; padding: 0; }\n    body { font-family: -apple-system, BlinkMacSystemFont, \"Segoe UI\", Roboto, Oxygen, Ubuntu, sans-serif; background: #1a1a2e; color: #eee; min-height: 100vh; }\n    .container { display: flex; height: 100vh; }\n    .sidebar { width: 300px; background: #16213e; border-right: 1px solid #0f3460; display: flex; flex-direction: column; overflow: hidden; }\n    .sidebar-header { padding: 20px; border-bottom: 1px solid #0f3460; }\n    .sidebar-header h1 { font-size: 18px; font-weight: 600; margin-bottom: 5px; }\n    .sidebar-header p { font-size: 12px; color: #888; }\n    .sidebar-content { flex: 1; overflow-y: auto; padding: 15px; }\n    .section { margin-bottom: 20px; }\n    .section-title { font-size: 12px; font-weight: 600; text-transform: uppercase; color: #888; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }\n    .btn { background: #0f3460; color: #fff; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 13px; transition: background 0.2s; }\n    .btn:hover { background: #1a4a7a; }\n    .btn-primary { background: #e94560; }\n    .btn-primary:hover { background: #ff6b6b; }\n    .btn-small { padding: 4px 8px; font-size: 11px; }\n    .camera-item, .connection-item { background: #0f3460; border-radius: 6px; padding: 12px; margin-bottom: 8px; cursor: pointer; transition: background 0.2s; }\n    .camera-item:hover, .connection-item:hover { background: #1a4a7a; }\n    .camera-item.selected, .connection-item.selected { outline: 2px solid #e94560; }\n    .camera-name { font-weight: 500; margin-bottom: 4px; }\n    .camera-info { font-size: 11px; color: #888; }\n    .editor { flex: 1; display: flex; flex-direction: column; overflow: hidden; }\n    .toolbar { background: #16213e; border-bottom: 1px solid #0f3460; padding: 10px 20px; display: flex; gap: 10px; align-items: center; }\n    .toolbar-group { display: flex; gap: 5px; padding-right: 15px; border-right: 1px solid #0f3460; margin-right: 5px; }\n    .toolbar-group:last-child { border-right: none; }\n    .canvas-container { flex: 1; position: relative; overflow: hidden; background: #0f0f1a; }\n    #floor-plan-canvas { position: absolute; top: 0; left: 0; }\n    .canvas-placeholder { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; color: #666; }\n    .canvas-placeholder h2 { margin-bottom: 15px; }\n    .properties-panel { width: 280px; background: #16213e; border-left: 1px solid #0f3460; overflow-y: auto; padding: 15px; }\n    .properties-panel h3 { font-size: 14px; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid #0f3460; }\n    .form-group { margin-bottom: 15px; }\n    .form-group label { display: block; font-size: 12px; color: #888; margin-bottom: 5px; }\n    .form-group input, .form-group select { width: 100%; padding: 8px 10px; background: #0f3460; border: 1px solid #1a4a7a; border-radius: 4px; color: #fff; font-size: 13px; }\n    .form-group input:focus, .form-group select:focus { outline: none; border-color: #e94560; }\n    .checkbox-group { display: flex; align-items: center; gap: 8px; }\n    .checkbox-group input[type=\"checkbox\"] { width: auto; }\n    .transit-time-inputs { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; }\n    .transit-time-inputs input { text-align: center; }\n    .transit-time-labels { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; font-size: 10px; color: #666; text-align: center; }\n    .modal-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.7); z-index: 1000; align-items: center; justify-content: center; }\n    .modal-overlay.active { display: flex; }\n    .modal { background: #16213e; border-radius: 8px; padding: 25px; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto; }\n    .modal h2 { margin-bottom: 20px; }\n    .modal-actions { display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px; }\n    .upload-zone { border: 2px dashed #0f3460; border-radius: 8px; padding: 40px; text-align: center; cursor: pointer; transition: border-color 0.2s, background 0.2s; }\n    .upload-zone:hover { border-color: #e94560; background: rgba(233, 69, 96, 0.1); }\n    .upload-zone input { display: none; }\n    .status-bar { background: #0f3460; padding: 8px 20px; font-size: 12px; color: #888; display: flex; justify-content: space-between; }\n    .status-indicator { display: flex; align-items: center; gap: 6px; }\n    .status-dot { width: 8px; height: 8px; border-radius: 50%; background: #4caf50; }\n    .status-dot.warning { background: #ff9800; }\n    .status-dot.error { background: #f44336; }\n  </style>\n</head>\n<body>\n  <div class=\"container\">\n    <div class=\"sidebar\">\n      <div class=\"sidebar-header\">\n        <h1>Spatial Awareness</h1>\n        <p>Topology Editor</p>\n      </div>\n      <div class=\"sidebar-content\">\n        <div class=\"section\">\n          <div class=\"section-title\">\n            <span>Cameras</span>\n            <button class=\"btn btn-small\" onclick=\"openAddCameraModal()\">+ Add</button>\n          </div>\n          <div id=\"camera-list\">\n            <div class=\"camera-item\" style=\"color: #666; text-align: center; cursor: default;\">No cameras configured</div>\n          </div>\n        </div>\n        <div class=\"section\">\n          <div class=\"section-title\">\n            <span>Connections</span>\n            <button class=\"btn btn-small\" onclick=\"openAddConnectionModal()\">+ Add</button>\n          </div>\n          <div id=\"connection-list\">\n            <div class=\"connection-item\" style=\"color: #666; text-align: center; cursor: default;\">No connections configured</div>\n          </div>\n        </div>\n        <div class=\"section\">\n          <div class=\"section-title\">\n            <span>Landmarks</span>\n            <button class=\"btn btn-small\" onclick=\"openAddLandmarkModal()\">+ Add</button>\n          </div>\n          <div id=\"landmark-list\">\n            <div class=\"landmark-item\" style=\"color: #666; text-align: center; cursor: default; padding: 8px;\">No landmarks configured</div>\n          </div>\n        </div>\n        <div class=\"section\" id=\"suggestions-section\" style=\"display: none;\">\n          <div class=\"section-title\">\n            <span>AI Suggestions</span>\n            <button class=\"btn btn-small\" onclick=\"loadSuggestions()\">Refresh</button>\n          </div>\n          <div id=\"suggestions-list\"></div>\n        </div>\n        <div class=\"section\" id=\"connection-suggestions-section\" style=\"display: none;\">\n          <div class=\"section-title\">\n            <span>Connection Suggestions</span>\n            <button class=\"btn btn-small\" onclick=\"loadConnectionSuggestions()\">Refresh</button>\n          </div>\n          <div id=\"connection-suggestions-list\"></div>\n        </div>\n        <div class=\"section\" id=\"live-tracking-section\">\n          <div class=\"section-title\">\n            <span>Live Tracking</span>\n            <label class=\"checkbox-group\" style=\"font-size: 11px; font-weight: normal; text-transform: none;\">\n              <input type=\"checkbox\" id=\"live-tracking-toggle\" onchange=\"toggleLiveTracking(this.checked)\">\n              Enable\n            </label>\n          </div>\n          <div id=\"live-tracking-list\" style=\"max-height: 150px; overflow-y: auto;\"></div>\n        </div>\n      </div>\n    </div>\n    <div class=\"editor\">\n      <div class=\"toolbar\">\n        <div class=\"toolbar-group\">\n          <button class=\"btn\" onclick=\"uploadFloorPlan()\">Upload Image</button>\n          <button class=\"btn\" onclick=\"useBlankCanvas()\">Blank Canvas</button>\n        </div>\n        <div class=\"toolbar-group\">\n          <button class=\"btn\" id=\"tool-select\" onclick=\"setTool('select')\">Select</button>\n          <button class=\"btn\" id=\"tool-wall\" onclick=\"setTool('wall')\">Draw Wall</button>\n          <button class=\"btn\" id=\"tool-room\" onclick=\"setTool('room')\">Draw Room</button>\n          <button class=\"btn\" id=\"tool-camera\" onclick=\"setTool('camera')\">Place Camera</button>\n          <button class=\"btn\" id=\"tool-landmark\" onclick=\"setTool('landmark')\">Place Landmark</button>\n          <button class=\"btn\" id=\"tool-connect\" onclick=\"setTool('connect')\">Connect</button>\n        </div>\n        <div class=\"toolbar-group\">\n          <button class=\"btn\" onclick=\"clearDrawings()\">Clear Drawings</button>\n        </div>\n        <div class=\"toolbar-group\">\n          <button class=\"btn btn-primary\" onclick=\"saveTopology()\">Save</button>\n        </div>\n      </div>\n      <div class=\"canvas-container\">\n        <canvas id=\"floor-plan-canvas\"></canvas>\n        <div class=\"canvas-placeholder\" id=\"canvas-placeholder\">\n          <h2>Floor Plan Editor</h2>\n          <p>Upload an image or use a blank canvas to draw your floor plan</p>\n          <br>\n          <div style=\"display: flex; gap: 15px; justify-content: center;\">\n            <button class=\"btn btn-primary\" onclick=\"uploadFloorPlan()\">Upload Image</button>\n            <button class=\"btn\" onclick=\"useBlankCanvas()\">Use Blank Canvas</button>\n          </div>\n        </div>\n      </div>\n      <div class=\"status-bar\">\n        <div class=\"status-indicator\">\n          <div class=\"status-dot\" id=\"status-dot\"></div>\n          <span id=\"status-text\">Ready</span>\n        </div>\n        <div>\n          <span id=\"camera-count\">0</span> cameras | <span id=\"connection-count\">0</span> connections | <span id=\"landmark-count\">0</span> landmarks\n        </div>\n      </div>\n    </div>\n    <div class=\"properties-panel\" id=\"properties-panel\">\n      <h3>Properties</h3>\n      <p style=\"color: #666; font-size: 13px;\">Select a camera or connection to edit its properties.</p>\n    </div>\n  </div>\n\n  <div class=\"modal-overlay\" id=\"add-camera-modal\">\n    <div class=\"modal\">\n      <h2>Add Camera</h2>\n      <div class=\"form-group\">\n        <label>Camera Device</label>\n        <select id=\"camera-device-select\"><option value=\"\">Loading cameras...</option></select>\n      </div>\n      <div class=\"form-group\">\n        <label>Display Name</label>\n        <input type=\"text\" id=\"camera-name-input\" placeholder=\"e.g., Front Door Camera\">\n      </div>\n      <div class=\"form-group\">\n        <label class=\"checkbox-group\">\n          <input type=\"checkbox\" id=\"camera-entry-checkbox\">\n          Entry Point (objects can enter property here)\n        </label>\n      </div>\n      <div class=\"form-group\">\n        <label class=\"checkbox-group\">\n          <input type=\"checkbox\" id=\"camera-exit-checkbox\">\n          Exit Point (objects can exit property here)\n        </label>\n      </div>\n      <div class=\"modal-actions\">\n        <button class=\"btn\" onclick=\"closeModal('add-camera-modal')\">Cancel</button>\n        <button class=\"btn btn-primary\" onclick=\"addCamera()\">Add Camera</button>\n      </div>\n    </div>\n  </div>\n\n  <div class=\"modal-overlay\" id=\"add-connection-modal\">\n    <div class=\"modal\">\n      <h2>Add Connection</h2>\n      <div class=\"form-group\">\n        <label>Connection Name</label>\n        <input type=\"text\" id=\"connection-name-input\" placeholder=\"e.g., Driveway to Front Door\">\n      </div>\n      <div class=\"form-group\">\n        <label>From Camera</label>\n        <select id=\"connection-from-select\"></select>\n      </div>\n      <div class=\"form-group\">\n        <label>To Camera</label>\n        <select id=\"connection-to-select\"></select>\n      </div>\n      <div class=\"form-group\">\n        <label>Transit Time (seconds)</label>\n        <div class=\"transit-time-inputs\">\n          <input type=\"number\" id=\"transit-min\" placeholder=\"Min\" value=\"3\">\n          <input type=\"number\" id=\"transit-typical\" placeholder=\"Typical\" value=\"10\">\n          <input type=\"number\" id=\"transit-max\" placeholder=\"Max\" value=\"30\">\n        </div>\n        <div class=\"transit-time-labels\">\n          <span>Minimum</span>\n          <span>Typical</span>\n          <span>Maximum</span>\n        </div>\n      </div>\n      <div class=\"form-group\">\n        <label class=\"checkbox-group\">\n          <input type=\"checkbox\" id=\"connection-bidirectional\" checked>\n          Bidirectional (works both ways)\n        </label>\n      </div>\n      <div class=\"modal-actions\">\n        <button class=\"btn\" onclick=\"closeModal('add-connection-modal')\">Cancel</button>\n        <button class=\"btn btn-primary\" onclick=\"addConnection()\">Add Connection</button>\n      </div>\n    </div>\n  </div>\n\n  <div class=\"modal-overlay\" id=\"upload-modal\">\n    <div class=\"modal\">\n      <h2>Upload Floor Plan</h2>\n      <div class=\"upload-zone\" onclick=\"document.getElementById('floor-plan-input').click()\">\n        <p>Click to select an image<br><small>PNG, JPG, or SVG</small></p>\n        <input type=\"file\" id=\"floor-plan-input\" accept=\"image/*\" onchange=\"handleFloorPlanUpload(event)\">\n      </div>\n      <div class=\"modal-actions\">\n        <button class=\"btn\" onclick=\"closeModal('upload-modal')\">Cancel</button>\n      </div>\n    </div>\n  </div>\n\n  <div class=\"modal-overlay\" id=\"add-landmark-modal\">\n    <div class=\"modal\">\n      <h2>Add Landmark</h2>\n      <div class=\"form-group\">\n        <label>Landmark Type</label>\n        <select id=\"landmark-type-select\" onchange=\"updateLandmarkSuggestions()\">\n          <option value=\"structure\">Structure (House, Garage, Shed)</option>\n          <option value=\"feature\">Feature (Mailbox, Tree, Pool)</option>\n          <option value=\"boundary\">Boundary (Fence, Wall, Hedge)</option>\n          <option value=\"access\">Access (Driveway, Walkway, Gate)</option>\n          <option value=\"vehicle\">Vehicle (Parking, Boat, RV)</option>\n          <option value=\"neighbor\">Neighbor (House, Driveway)</option>\n          <option value=\"zone\">Zone (Front Yard, Back Yard)</option>\n          <option value=\"street\">Street (Street, Sidewalk, Alley)</option>\n        </select>\n      </div>\n      <div class=\"form-group\">\n        <label>Quick Templates</label>\n        <div id=\"landmark-templates\" style=\"display: flex; flex-wrap: wrap; gap: 5px;\"></div>\n      </div>\n      <div class=\"form-group\">\n        <label>Name</label>\n        <input type=\"text\" id=\"landmark-name-input\" placeholder=\"e.g., Front Porch, Red Shed\">\n      </div>\n      <div class=\"form-group\">\n        <label>Description (optional)</label>\n        <input type=\"text\" id=\"landmark-desc-input\" placeholder=\"Brief description for AI context\">\n      </div>\n      <div class=\"form-group\">\n        <label class=\"checkbox-group\">\n          <input type=\"checkbox\" id=\"landmark-entry-checkbox\">\n          Entry Point (people can enter property here)\n        </label>\n      </div>\n      <div class=\"form-group\">\n        <label class=\"checkbox-group\">\n          <input type=\"checkbox\" id=\"landmark-exit-checkbox\">\n          Exit Point (people can exit property here)\n        </label>\n      </div>\n      <div class=\"modal-actions\">\n        <button class=\"btn\" onclick=\"closeModal('add-landmark-modal')\">Cancel</button>\n        <button class=\"btn btn-primary\" onclick=\"addLandmark()\">Add Landmark</button>\n      </div>\n    </div>\n  </div>\n\n  <script>\n    let topology = { version: '2.0', cameras: [], connections: [], globalZones: [], landmarks: [], relationships: [], floorPlan: null, drawings: [] };\n    let selectedItem = null;\n    let currentTool = 'select';\n    let floorPlanImage = null;\n    let availableCameras = [];\n    let landmarkTemplates = [];\n    let pendingSuggestions = [];\n    let connectionSuggestions = [];\n    let liveTrackingData = { objects: [], timestamp: 0 };\n    let liveTrackingEnabled = false;\n    let liveTrackingInterval = null;\n    let selectedJourneyId = null;\n    let journeyPath = null;\n    let isDrawing = false;\n    let drawStart = null;\n    let currentDrawing = null;\n    let blankCanvasMode = false;\n    const canvas = document.getElementById('floor-plan-canvas');\n    const ctx = canvas.getContext('2d');\n\n    async function init() {\n      await loadTopology();\n      await loadAvailableCameras();\n      await loadLandmarkTemplates();\n      await loadSuggestions();\n      await loadConnectionSuggestions();\n      resizeCanvas();\n      render();\n      updateUI();\n    }\n\n    async function loadTopology() {\n      try {\n        const response = await fetch('../api/topology');\n        if (response.ok) {\n          topology = await response.json();\n          if (!topology.drawings) topology.drawings = [];\n          // Load floor plan from separate storage (handles legacy imageData in topology too)\n          if (topology.floorPlan?.imageData) {\n            // Legacy: imageData was stored in topology\n            await loadFloorPlanImage(topology.floorPlan.imageData);\n          } else if (topology.floorPlan?.type === 'blank') {\n            blankCanvasMode = true;\n          } else {\n            // Always try to load from floor-plan endpoint (handles uploaded and missing cases)\n            try {\n              const fpResponse = await fetch('../api/floor-plan');\n              if (fpResponse.ok) {\n                const fpData = await fpResponse.json();\n                if (fpData.imageData) {\n                  await loadFloorPlanImage(fpData.imageData);\n                  // Update topology reference if not set\n                  if (!topology.floorPlan || topology.floorPlan.type !== 'uploaded') {\n                    topology.floorPlan = { type: 'uploaded', width: floorPlanImage.width, height: floorPlanImage.height };\n                  }\n                }\n              }\n            } catch (err) { console.error('Failed to load floor plan:', err); }\n          }\n        }\n      } catch (e) { console.error('Failed to load topology:', e); }\n    }\n\n    async function loadAvailableCameras() {\n      try {\n        const response = await fetch('../api/cameras');\n        if (response.ok) {\n          availableCameras = await response.json();\n        } else {\n          availableCameras = [];\n        }\n      } catch (e) {\n        console.error('Failed to load cameras:', e);\n        availableCameras = [];\n      }\n      updateCameraSelects();\n    }\n\n    async function loadLandmarkTemplates() {\n      try {\n        const response = await fetch('../api/landmark-templates');\n        if (response.ok) {\n          const data = await response.json();\n          landmarkTemplates = data.templates || [];\n        }\n      } catch (e) { console.error('Failed to load landmark templates:', e); }\n    }\n\n    async function loadSuggestions() {\n      try {\n        const response = await fetch('../api/landmark-suggestions');\n        if (response.ok) {\n          const data = await response.json();\n          pendingSuggestions = data.suggestions || [];\n          updateSuggestionsUI();\n        }\n      } catch (e) { console.error('Failed to load suggestions:', e); }\n    }\n\n    function updateSuggestionsUI() {\n      const section = document.getElementById('suggestions-section');\n      const list = document.getElementById('suggestions-list');\n      if (pendingSuggestions.length === 0) {\n        section.style.display = 'none';\n        return;\n      }\n      section.style.display = 'block';\n      list.innerHTML = pendingSuggestions.map(s =>\n        '<div class=\"camera-item\" style=\"display: flex; justify-content: space-between; align-items: center;\">' +\n        '<div><div class=\"camera-name\">' + s.landmark.name + '</div>' +\n        '<div class=\"camera-info\">' + s.landmark.type + ' - ' + Math.round((s.landmark.aiConfidence || 0) * 100) + '% confidence</div></div>' +\n        '<div style=\"display: flex; gap: 5px;\">' +\n        '<button class=\"btn btn-small btn-primary\" onclick=\"acceptSuggestion(\\'' + s.id + '\\')\">Accept</button>' +\n        '<button class=\"btn btn-small\" onclick=\"rejectSuggestion(\\'' + s.id + '\\')\">Reject</button>' +\n        '</div></div>'\n      ).join('');\n    }\n\n    async function acceptSuggestion(id) {\n      try {\n        const response = await fetch('../api/landmark-suggestions/' + id + '/accept', { method: 'POST' });\n        if (response.ok) {\n          const data = await response.json();\n          if (data.landmark) {\n            topology.landmarks.push(data.landmark);\n            updateUI();\n            render();\n          }\n          await loadSuggestions();\n          setStatus('Landmark accepted', 'success');\n        }\n      } catch (e) { console.error('Failed to accept suggestion:', e); }\n    }\n\n    async function rejectSuggestion(id) {\n      try {\n        await fetch('../api/landmark-suggestions/' + id + '/reject', { method: 'POST' });\n        await loadSuggestions();\n        setStatus('Suggestion rejected', 'success');\n      } catch (e) { console.error('Failed to reject suggestion:', e); }\n    }\n\n    // ==================== Connection Suggestions ====================\n    async function loadConnectionSuggestions() {\n      try {\n        const response = await fetch('../api/connection-suggestions');\n        if (response.ok) {\n          const data = await response.json();\n          connectionSuggestions = data.suggestions || [];\n          updateConnectionSuggestionsUI();\n        }\n      } catch (e) { console.error('Failed to load connection suggestions:', e); }\n    }\n\n    function updateConnectionSuggestionsUI() {\n      const section = document.getElementById('connection-suggestions-section');\n      const list = document.getElementById('connection-suggestions-list');\n      if (connectionSuggestions.length === 0) {\n        section.style.display = 'none';\n        return;\n      }\n      section.style.display = 'block';\n      list.innerHTML = connectionSuggestions.map(s =>\n        '<div class=\"camera-item\" style=\"display: flex; justify-content: space-between; align-items: center;\">' +\n        '<div><div class=\"camera-name\">' + s.fromCameraName + ' → ' + s.toCameraName + '</div>' +\n        '<div class=\"camera-info\">' + Math.round(s.suggestedTransitTime.typical / 1000) + 's typical, ' +\n        Math.round(s.confidence * 100) + '% confidence</div></div>' +\n        '<div style=\"display: flex; gap: 5px;\">' +\n        '<button class=\"btn btn-small btn-primary\" onclick=\"acceptConnectionSuggestion(\\'' + s.id + '\\')\">Accept</button>' +\n        '<button class=\"btn btn-small\" onclick=\"rejectConnectionSuggestion(\\'' + s.id + '\\')\">Reject</button>' +\n        '</div></div>'\n      ).join('');\n    }\n\n    async function acceptConnectionSuggestion(id) {\n      try {\n        const response = await fetch('../api/connection-suggestions/' + encodeURIComponent(id) + '/accept', { method: 'POST' });\n        if (response.ok) {\n          const data = await response.json();\n          if (data.connection) {\n            topology.connections.push(data.connection);\n            updateUI();\n            render();\n          }\n          await loadConnectionSuggestions();\n          setStatus('Connection accepted', 'success');\n        }\n      } catch (e) { console.error('Failed to accept connection suggestion:', e); }\n    }\n\n    async function rejectConnectionSuggestion(id) {\n      try {\n        await fetch('../api/connection-suggestions/' + encodeURIComponent(id) + '/reject', { method: 'POST' });\n        await loadConnectionSuggestions();\n        setStatus('Connection suggestion rejected', 'success');\n      } catch (e) { console.error('Failed to reject connection suggestion:', e); }\n    }\n\n    // ==================== Live Tracking ====================\n    function toggleLiveTracking(enabled) {\n      liveTrackingEnabled = enabled;\n      if (enabled) {\n        loadLiveTracking();\n        liveTrackingInterval = setInterval(loadLiveTracking, 2000); // Poll every 2 seconds\n      } else {\n        if (liveTrackingInterval) {\n          clearInterval(liveTrackingInterval);\n          liveTrackingInterval = null;\n        }\n        liveTrackingData = { objects: [], timestamp: 0 };\n        selectedJourneyId = null;\n        journeyPath = null;\n        updateLiveTrackingUI();\n        render();\n      }\n    }\n\n    async function loadLiveTracking() {\n      try {\n        const response = await fetch('../api/live-tracking');\n        if (response.ok) {\n          liveTrackingData = await response.json();\n          updateLiveTrackingUI();\n          render();\n        }\n      } catch (e) { console.error('Failed to load live tracking:', e); }\n    }\n\n    function updateLiveTrackingUI() {\n      const list = document.getElementById('live-tracking-list');\n      if (liveTrackingData.objects.length === 0) {\n        list.innerHTML = '<div style=\"color: #666; font-size: 12px; text-align: center; padding: 10px;\">No active objects</div>';\n        return;\n      }\n      list.innerHTML = liveTrackingData.objects.map(obj => {\n        const isSelected = selectedJourneyId === obj.globalId;\n        const ageSeconds = Math.round((Date.now() - obj.lastSeen) / 1000);\n        const ageStr = ageSeconds < 60 ? ageSeconds + 's ago' : Math.round(ageSeconds / 60) + 'm ago';\n        return '<div class=\"camera-item' + (isSelected ? ' selected' : '') + '\" ' +\n          'onclick=\"selectTrackedObject(\\'' + obj.globalId + '\\')\" ' +\n          'style=\"padding: 8px; cursor: pointer;\">' +\n          '<div class=\"camera-name\" style=\"font-size: 12px;\">' +\n          (obj.className.charAt(0).toUpperCase() + obj.className.slice(1)) +\n          (obj.label ? ' (' + obj.label + ')' : '') + '</div>' +\n          '<div class=\"camera-info\">' + obj.lastCameraName + ' • ' + ageStr + '</div>' +\n          '</div>';\n      }).join('');\n    }\n\n    async function selectTrackedObject(globalId) {\n      if (selectedJourneyId === globalId) {\n        // Deselect\n        selectedJourneyId = null;\n        journeyPath = null;\n      } else {\n        selectedJourneyId = globalId;\n        // Load journey path\n        try {\n          const response = await fetch('../api/journey-path/' + globalId);\n          if (response.ok) {\n            journeyPath = await response.json();\n          }\n        } catch (e) { console.error('Failed to load journey path:', e); }\n      }\n      updateLiveTrackingUI();\n      render();\n    }\n\n    function openAddLandmarkModal() {\n      updateLandmarkSuggestions();\n      document.getElementById('add-landmark-modal').classList.add('active');\n    }\n\n    function updateLandmarkSuggestions() {\n      const type = document.getElementById('landmark-type-select').value;\n      const template = landmarkTemplates.find(t => t.type === type);\n      const container = document.getElementById('landmark-templates');\n      if (template) {\n        container.innerHTML = template.suggestions.map(s =>\n          '<button class=\"btn btn-small\" onclick=\"setLandmarkName(\\'' + s + '\\')\" style=\"margin: 2px;\">' + s + '</button>'\n        ).join('');\n      } else {\n        container.innerHTML = '<span style=\"color: #666; font-size: 12px;\">No templates for this type</span>';\n      }\n    }\n\n    function setLandmarkName(name) {\n      document.getElementById('landmark-name-input').value = name;\n    }\n\n    function addLandmark() {\n      const name = document.getElementById('landmark-name-input').value;\n      if (!name) { alert('Please enter a landmark name'); return; }\n      const type = document.getElementById('landmark-type-select').value;\n      const description = document.getElementById('landmark-desc-input').value;\n      const isEntry = document.getElementById('landmark-entry-checkbox').checked;\n      const isExit = document.getElementById('landmark-exit-checkbox').checked;\n      const pos = topology._pendingLandmarkPos || { x: canvas.width / 2 + Math.random() * 100 - 50, y: canvas.height / 2 + Math.random() * 100 - 50 };\n      delete topology._pendingLandmarkPos;\n      const landmark = {\n        id: 'landmark_' + Date.now(),\n        name,\n        type,\n        position: pos,\n        description: description || undefined,\n        isEntryPoint: isEntry,\n        isExitPoint: isExit,\n        visibleFromCameras: [],\n      };\n      if (!topology.landmarks) topology.landmarks = [];\n      topology.landmarks.push(landmark);\n      closeModal('add-landmark-modal');\n      document.getElementById('landmark-name-input').value = '';\n      document.getElementById('landmark-desc-input').value = '';\n      document.getElementById('landmark-entry-checkbox').checked = false;\n      document.getElementById('landmark-exit-checkbox').checked = false;\n      updateUI();\n      render();\n    }\n\n    function selectLandmark(id) {\n      selectedItem = { type: 'landmark', id };\n      const landmark = topology.landmarks.find(l => l.id === id);\n      showLandmarkProperties(landmark);\n      updateUI();\n      render();\n    }\n\n    function showLandmarkProperties(landmark) {\n      const panel = document.getElementById('properties-panel');\n      const cameraOptions = topology.cameras.map(c =>\n        '<label class=\"checkbox-group\" style=\"margin-bottom: 5px;\"><input type=\"checkbox\" ' +\n        ((landmark.visibleFromCameras || []).includes(c.deviceId) ? 'checked' : '') +\n        ' onchange=\"toggleLandmarkCamera(\\'' + landmark.id + '\\', \\'' + c.deviceId + '\\', this.checked)\">' +\n        c.name + '</label>'\n      ).join('');\n      panel.innerHTML = '<h3>Landmark Properties</h3>' +\n        '<div class=\"form-group\"><label>Name</label><input type=\"text\" value=\"' + landmark.name + '\" onchange=\"updateLandmarkName(\\'' + landmark.id + '\\', this.value)\"></div>' +\n        '<div class=\"form-group\"><label>Type</label><select onchange=\"updateLandmarkType(\\'' + landmark.id + '\\', this.value)\">' +\n        '<option value=\"structure\"' + (landmark.type === 'structure' ? ' selected' : '') + '>Structure</option>' +\n        '<option value=\"feature\"' + (landmark.type === 'feature' ? ' selected' : '') + '>Feature</option>' +\n        '<option value=\"boundary\"' + (landmark.type === 'boundary' ? ' selected' : '') + '>Boundary</option>' +\n        '<option value=\"access\"' + (landmark.type === 'access' ? ' selected' : '') + '>Access</option>' +\n        '<option value=\"vehicle\"' + (landmark.type === 'vehicle' ? ' selected' : '') + '>Vehicle</option>' +\n        '<option value=\"neighbor\"' + (landmark.type === 'neighbor' ? ' selected' : '') + '>Neighbor</option>' +\n        '<option value=\"zone\"' + (landmark.type === 'zone' ? ' selected' : '') + '>Zone</option>' +\n        '<option value=\"street\"' + (landmark.type === 'street' ? ' selected' : '') + '>Street</option>' +\n        '</select></div>' +\n        '<div class=\"form-group\"><label>Description</label><input type=\"text\" value=\"' + (landmark.description || '') + '\" onchange=\"updateLandmarkDesc(\\'' + landmark.id + '\\', this.value)\"></div>' +\n        '<div class=\"form-group\"><label class=\"checkbox-group\"><input type=\"checkbox\" ' + (landmark.isEntryPoint ? 'checked' : '') + ' onchange=\"updateLandmarkEntry(\\'' + landmark.id + '\\', this.checked)\">Entry Point</label></div>' +\n        '<div class=\"form-group\"><label class=\"checkbox-group\"><input type=\"checkbox\" ' + (landmark.isExitPoint ? 'checked' : '') + ' onchange=\"updateLandmarkExit(\\'' + landmark.id + '\\', this.checked)\">Exit Point</label></div>' +\n        '<div class=\"form-group\"><label>Visible from Cameras</label>' + (cameraOptions || '<span style=\"color:#666;font-size:12px;\">Add cameras first</span>') + '</div>' +\n        '<div class=\"form-group\"><button class=\"btn\" style=\"width: 100%; background: #f44336;\" onclick=\"deleteLandmark(\\'' + landmark.id + '\\')\">Delete Landmark</button></div>';\n    }\n\n    function updateLandmarkName(id, value) { const l = topology.landmarks.find(x => x.id === id); if (l) l.name = value; updateUI(); }\n    function updateLandmarkType(id, value) { const l = topology.landmarks.find(x => x.id === id); if (l) l.type = value; render(); }\n    function updateLandmarkDesc(id, value) { const l = topology.landmarks.find(x => x.id === id); if (l) l.description = value || undefined; }\n    function updateLandmarkEntry(id, value) { const l = topology.landmarks.find(x => x.id === id); if (l) l.isEntryPoint = value; }\n    function updateLandmarkExit(id, value) { const l = topology.landmarks.find(x => x.id === id); if (l) l.isExitPoint = value; }\n    function toggleLandmarkCamera(landmarkId, cameraId, visible) {\n      const l = topology.landmarks.find(x => x.id === landmarkId);\n      if (!l) return;\n      if (!l.visibleFromCameras) l.visibleFromCameras = [];\n      if (visible && !l.visibleFromCameras.includes(cameraId)) {\n        l.visibleFromCameras.push(cameraId);\n      } else if (!visible) {\n        l.visibleFromCameras = l.visibleFromCameras.filter(id => id !== cameraId);\n      }\n      // Also update camera's visibleLandmarks\n      const camera = topology.cameras.find(c => c.deviceId === cameraId);\n      if (camera) {\n        if (!camera.context) camera.context = {};\n        if (!camera.context.visibleLandmarks) camera.context.visibleLandmarks = [];\n        if (visible && !camera.context.visibleLandmarks.includes(landmarkId)) {\n          camera.context.visibleLandmarks.push(landmarkId);\n        } else if (!visible) {\n          camera.context.visibleLandmarks = camera.context.visibleLandmarks.filter(id => id !== landmarkId);\n        }\n      }\n    }\n    function deleteLandmark(id) {\n      if (!confirm('Delete this landmark?')) return;\n      topology.landmarks = topology.landmarks.filter(l => l.id !== id);\n      selectedItem = null;\n      document.getElementById('properties-panel').innerHTML = '<h3>Properties</h3><p style=\"color: #666;\">Select an item to edit.</p>';\n      updateUI();\n      render();\n    }\n\n    async function saveTopology() {\n      try {\n        setStatus('Saving...', 'warning');\n        const response = await fetch('../api/topology', {\n          method: 'PUT',\n          headers: { 'Content-Type': 'application/json' },\n          body: JSON.stringify(topology)\n        });\n        if (response.ok) { setStatus('Saved successfully', 'success'); }\n        else { setStatus('Failed to save', 'error'); }\n      } catch (e) { console.error('Failed to save topology:', e); setStatus('Failed to save', 'error'); }\n    }\n\n    function resizeCanvas() {\n      const container = canvas.parentElement;\n      canvas.width = container.clientWidth;\n      canvas.height = container.clientHeight;\n    }\n\n    function render() {\n      ctx.clearRect(0, 0, canvas.width, canvas.height);\n\n      // Draw grid for blank canvas\n      if (blankCanvasMode && !floorPlanImage) {\n        document.getElementById('canvas-placeholder').style.display = 'none';\n        ctx.fillStyle = '#1a1a2e';\n        ctx.fillRect(0, 0, canvas.width, canvas.height);\n        ctx.strokeStyle = '#2a2a4e';\n        ctx.lineWidth = 1;\n        const gridSize = 40;\n        for (let x = 0; x < canvas.width; x += gridSize) {\n          ctx.beginPath(); ctx.moveTo(x, 0); ctx.lineTo(x, canvas.height); ctx.stroke();\n        }\n        for (let y = 0; y < canvas.height; y += gridSize) {\n          ctx.beginPath(); ctx.moveTo(0, y); ctx.lineTo(canvas.width, y); ctx.stroke();\n        }\n      } else if (floorPlanImage) {\n        document.getElementById('canvas-placeholder').style.display = 'none';\n        const scale = Math.min(canvas.width / floorPlanImage.width, canvas.height / floorPlanImage.height) * 0.9;\n        const x = (canvas.width - floorPlanImage.width * scale) / 2;\n        const y = (canvas.height - floorPlanImage.height * scale) / 2;\n        ctx.drawImage(floorPlanImage, x, y, floorPlanImage.width * scale, floorPlanImage.height * scale);\n      } else {\n        document.getElementById('canvas-placeholder').style.display = 'block';\n      }\n\n      // Draw saved drawings (walls and rooms)\n      if (topology.drawings) {\n        for (const drawing of topology.drawings) {\n          if (drawing.type === 'wall') {\n            ctx.beginPath();\n            ctx.moveTo(drawing.x1, drawing.y1);\n            ctx.lineTo(drawing.x2, drawing.y2);\n            ctx.strokeStyle = '#888';\n            ctx.lineWidth = 4;\n            ctx.stroke();\n          } else if (drawing.type === 'room') {\n            ctx.strokeStyle = '#666';\n            ctx.lineWidth = 2;\n            ctx.strokeRect(drawing.x, drawing.y, drawing.width, drawing.height);\n            ctx.fillStyle = 'rgba(100, 100, 150, 0.1)';\n            ctx.fillRect(drawing.x, drawing.y, drawing.width, drawing.height);\n            if (drawing.label) {\n              ctx.fillStyle = '#888';\n              ctx.font = '12px sans-serif';\n              ctx.textAlign = 'center';\n              ctx.fillText(drawing.label, drawing.x + drawing.width/2, drawing.y + drawing.height/2);\n            }\n          }\n        }\n      }\n\n      // Draw current drawing in progress\n      if (currentDrawing) {\n        if (currentDrawing.type === 'wall') {\n          ctx.beginPath();\n          ctx.moveTo(currentDrawing.x1, currentDrawing.y1);\n          ctx.lineTo(currentDrawing.x2, currentDrawing.y2);\n          ctx.strokeStyle = '#e94560';\n          ctx.lineWidth = 4;\n          ctx.stroke();\n        } else if (currentDrawing.type === 'room') {\n          ctx.strokeStyle = '#e94560';\n          ctx.lineWidth = 2;\n          ctx.strokeRect(currentDrawing.x, currentDrawing.y, currentDrawing.width, currentDrawing.height);\n        }\n      }\n      // Draw landmarks first (below cameras and connections)\n      for (const landmark of (topology.landmarks || [])) {\n        if (landmark.position) { drawLandmark(landmark); }\n      }\n      for (const conn of topology.connections) {\n        const fromCam = topology.cameras.find(c => c.deviceId === conn.fromCameraId);\n        const toCam = topology.cameras.find(c => c.deviceId === conn.toCameraId);\n        if (fromCam?.floorPlanPosition && toCam?.floorPlanPosition) {\n          drawConnection(fromCam.floorPlanPosition, toCam.floorPlanPosition, conn);\n        }\n      }\n      for (const camera of topology.cameras) {\n        if (camera.floorPlanPosition) { drawCamera(camera); }\n      }\n\n      // Draw journey path if selected\n      if (journeyPath && journeyPath.segments.length > 0) {\n        drawJourneyPath();\n      }\n\n      // Draw live tracking objects\n      if (liveTrackingEnabled && liveTrackingData.objects.length > 0) {\n        drawLiveTrackingObjects();\n      }\n    }\n\n    function drawJourneyPath() {\n      if (!journeyPath) return;\n\n      ctx.strokeStyle = '#ff6b6b';\n      ctx.lineWidth = 3;\n      ctx.setLineDash([8, 4]);\n\n      // Draw path segments\n      for (const segment of journeyPath.segments) {\n        if (segment.fromCamera.position && segment.toCamera.position) {\n          ctx.beginPath();\n          ctx.moveTo(segment.fromCamera.position.x, segment.fromCamera.position.y);\n          ctx.lineTo(segment.toCamera.position.x, segment.toCamera.position.y);\n          ctx.stroke();\n\n          // Draw timestamp indicator\n          const midX = (segment.fromCamera.position.x + segment.toCamera.position.x) / 2;\n          const midY = (segment.fromCamera.position.y + segment.toCamera.position.y) / 2;\n          ctx.fillStyle = 'rgba(255, 107, 107, 0.9)';\n          ctx.beginPath();\n          ctx.arc(midX, midY, 4, 0, Math.PI * 2);\n          ctx.fill();\n        }\n      }\n\n      ctx.setLineDash([]);\n\n      // Draw current location indicator\n      if (journeyPath.currentLocation?.position) {\n        const pos = journeyPath.currentLocation.position;\n        // Pulsing dot effect\n        const pulse = (Date.now() % 1000) / 1000;\n        const radius = 10 + pulse * 5;\n        const alpha = 1 - pulse * 0.5;\n\n        ctx.beginPath();\n        ctx.arc(pos.x, pos.y, radius, 0, Math.PI * 2);\n        ctx.fillStyle = 'rgba(255, 107, 107, ' + alpha + ')';\n        ctx.fill();\n\n        ctx.beginPath();\n        ctx.arc(pos.x, pos.y, 6, 0, Math.PI * 2);\n        ctx.fillStyle = '#ff6b6b';\n        ctx.fill();\n        ctx.strokeStyle = '#fff';\n        ctx.lineWidth = 2;\n        ctx.stroke();\n      }\n    }\n\n    function drawLiveTrackingObjects() {\n      const objectColors = {\n        person: '#4caf50',\n        car: '#2196f3',\n        animal: '#ff9800',\n        default: '#9c27b0'\n      };\n\n      for (const obj of liveTrackingData.objects) {\n        if (!obj.cameraPosition) continue;\n\n        // Skip if this is the selected journey object (drawn separately with path)\n        if (obj.globalId === selectedJourneyId) continue;\n\n        const pos = obj.cameraPosition;\n        const color = objectColors[obj.className] || objectColors.default;\n        const ageSeconds = (Date.now() - obj.lastSeen) / 1000;\n\n        // Fade old objects\n        const alpha = Math.max(0.3, 1 - ageSeconds / 60);\n\n        // Draw object indicator\n        ctx.beginPath();\n        ctx.arc(pos.x, pos.y, 12, 0, Math.PI * 2);\n        ctx.fillStyle = color.replace(')', ', ' + alpha + ')').replace('rgb', 'rgba');\n        ctx.fill();\n        ctx.strokeStyle = 'rgba(255, 255, 255, ' + alpha + ')';\n        ctx.lineWidth = 2;\n        ctx.stroke();\n\n        // Draw class icon\n        ctx.fillStyle = 'rgba(255, 255, 255, ' + alpha + ')';\n        ctx.font = 'bold 10px sans-serif';\n        ctx.textAlign = 'center';\n        ctx.textBaseline = 'middle';\n        const icon = obj.className === 'person' ? 'P' : obj.className === 'car' ? 'C' : obj.className === 'animal' ? 'A' : '?';\n        ctx.fillText(icon, pos.x, pos.y);\n\n        // Draw label below\n        if (obj.label) {\n          ctx.font = '9px sans-serif';\n          ctx.fillText(obj.label.slice(0, 10), pos.x, pos.y + 20);\n        }\n      }\n    }\n\n    function drawLandmark(landmark) {\n      const pos = landmark.position;\n      const isSelected = selectedItem?.type === 'landmark' && selectedItem?.id === landmark.id;\n      // Color by type\n      const colors = {\n        structure: '#8b5cf6', // purple\n        feature: '#10b981', // green\n        boundary: '#f59e0b', // amber\n        access: '#3b82f6', // blue\n        vehicle: '#6366f1', // indigo\n        neighbor: '#ec4899', // pink\n        zone: '#14b8a6', // teal\n        street: '#6b7280', // gray\n      };\n      const color = colors[landmark.type] || '#888';\n      // Draw landmark marker\n      ctx.beginPath();\n      ctx.moveTo(pos.x, pos.y - 15);\n      ctx.lineTo(pos.x + 12, pos.y + 8);\n      ctx.lineTo(pos.x - 12, pos.y + 8);\n      ctx.closePath();\n      ctx.fillStyle = isSelected ? '#e94560' : color;\n      ctx.fill();\n      ctx.strokeStyle = '#fff';\n      ctx.lineWidth = 2;\n      ctx.stroke();\n      // Entry/exit indicators\n      if (landmark.isEntryPoint || landmark.isExitPoint) {\n        ctx.beginPath();\n        ctx.arc(pos.x, pos.y - 20, 5, 0, Math.PI * 2);\n        ctx.fillStyle = landmark.isEntryPoint ? '#4caf50' : '#ff9800';\n        ctx.fill();\n      }\n      // Label\n      ctx.fillStyle = '#fff';\n      ctx.font = '11px sans-serif';\n      ctx.textAlign = 'center';\n      ctx.fillText(landmark.name, pos.x, pos.y + 25);\n    }\n\n    function drawCamera(camera) {\n      const pos = camera.floorPlanPosition;\n      const isSelected = selectedItem?.type === 'camera' && selectedItem?.id === camera.deviceId;\n      ctx.beginPath();\n      ctx.arc(pos.x, pos.y, 20, 0, Math.PI * 2);\n      ctx.fillStyle = isSelected ? '#e94560' : '#0f3460';\n      ctx.fill();\n      ctx.strokeStyle = '#fff';\n      ctx.lineWidth = 2;\n      ctx.stroke();\n      ctx.fillStyle = '#fff';\n      ctx.font = '12px sans-serif';\n      ctx.textAlign = 'center';\n      ctx.textBaseline = 'middle';\n      ctx.fillText('CAM', pos.x, pos.y);\n      ctx.fillText(camera.name, pos.x, pos.y + 35);\n    }\n\n    function drawConnection(from, to, conn) {\n      const isSelected = selectedItem?.type === 'connection' && selectedItem?.id === conn.id;\n      ctx.beginPath();\n      ctx.moveTo(from.x, from.y);\n      ctx.lineTo(to.x, to.y);\n      ctx.strokeStyle = isSelected ? '#e94560' : '#4caf50';\n      ctx.lineWidth = isSelected ? 4 : 2;\n      ctx.stroke();\n      if (!conn.bidirectional) {\n        const angle = Math.atan2(to.y - from.y, to.x - from.x);\n        const midX = (from.x + to.x) / 2;\n        const midY = (from.y + to.y) / 2;\n        ctx.beginPath();\n        ctx.moveTo(midX, midY);\n        ctx.lineTo(midX - 10 * Math.cos(angle - 0.5), midY - 10 * Math.sin(angle - 0.5));\n        ctx.lineTo(midX - 10 * Math.cos(angle + 0.5), midY - 10 * Math.sin(angle + 0.5));\n        ctx.closePath();\n        ctx.fillStyle = isSelected ? '#e94560' : '#4caf50';\n        ctx.fill();\n      }\n    }\n\n    function uploadFloorPlan() { document.getElementById('upload-modal').classList.add('active'); }\n\n    // Compress and resize image to avoid 413 errors (Scrypted has ~50KB limit)\n    function compressImage(img, maxSize = 800, quality = 0.5) {\n      return new Promise((resolve) => {\n        const canvas = document.createElement('canvas');\n        let width = img.width;\n        let height = img.height;\n\n        // Always resize to fit within maxSize\n        if (width > maxSize || height > maxSize) {\n          if (width > height) {\n            height = Math.round(height * maxSize / width);\n            width = maxSize;\n          } else {\n            width = Math.round(width * maxSize / height);\n            height = maxSize;\n          }\n        }\n\n        canvas.width = width;\n        canvas.height = height;\n        const ctx = canvas.getContext('2d');\n        ctx.drawImage(img, 0, 0, width, height);\n\n        // Convert to JPEG with aggressive compression\n        let compressed = canvas.toDataURL('image/jpeg', quality);\n        console.log('Compressed image from', img.width, 'x', img.height, 'to', width, 'x', height, 'size:', Math.round(compressed.length / 1024), 'KB');\n\n        // If still too large, compress more\n        let q = quality;\n        while (compressed.length > 50000 && q > 0.1) {\n          q -= 0.1;\n          compressed = canvas.toDataURL('image/jpeg', q);\n          console.log('Re-compressed at quality', q.toFixed(1), 'size:', Math.round(compressed.length / 1024), 'KB');\n        }\n\n        resolve(compressed);\n      });\n    }\n\n    async function handleFloorPlanUpload(event) {\n      const file = event.target.files[0];\n      if (!file) return;\n      const reader = new FileReader();\n      reader.onload = async (e) => {\n        const originalData = e.target.result;\n\n        // Load image to get dimensions\n        const img = new Image();\n        img.onload = async () => {\n          // Compress image to reduce size\n          const imageData = await compressImage(img);\n          await loadFloorPlanImage(imageData);\n\n          // Store floor plan separately via API\n          try {\n            setStatus('Uploading floor plan...', 'warning');\n            const response = await fetch('../api/floor-plan', {\n              method: 'POST',\n              headers: { 'Content-Type': 'application/json' },\n              body: JSON.stringify({ imageData })\n            });\n            if (response.ok) {\n              setStatus('Floor plan saved', 'success');\n            } else {\n              setStatus('Failed to save floor plan: ' + response.status, 'error');\n              console.error('Floor plan upload failed:', response.status, response.statusText);\n            }\n          } catch (err) {\n            console.error('Failed to save floor plan:', err);\n            setStatus('Failed to save floor plan', 'error');\n          }\n\n          // Store reference in topology (without the large imageData)\n          topology.floorPlan = { type: 'uploaded', width: floorPlanImage.width, height: floorPlanImage.height };\n          closeModal('upload-modal');\n          render();\n        };\n        img.src = originalData;\n      };\n      reader.readAsDataURL(file);\n    }\n\n    function loadFloorPlanImage(imageData) {\n      return new Promise((resolve) => {\n        floorPlanImage = new Image();\n        floorPlanImage.onload = resolve;\n        floorPlanImage.src = imageData;\n      });\n    }\n\n    function openAddCameraModal() { document.getElementById('add-camera-modal').classList.add('active'); }\n\n    function addCamera() {\n      const deviceId = document.getElementById('camera-device-select').value;\n      if (!deviceId) {\n        alert('Please select a camera');\n        return;\n      }\n      const selectedCam = availableCameras.find(c => c.id === deviceId);\n      const customName = document.getElementById('camera-name-input').value;\n      const name = customName || (selectedCam ? selectedCam.name : 'New Camera');\n      const isEntry = document.getElementById('camera-entry-checkbox').checked;\n      const isExit = document.getElementById('camera-exit-checkbox').checked;\n      // Use pending position from click, or default to center\n      const pos = topology._pendingCameraPos || { x: canvas.width / 2 + Math.random() * 100 - 50, y: canvas.height / 2 + Math.random() * 100 - 50 };\n      delete topology._pendingCameraPos;\n      const camera = {\n        deviceId: deviceId,\n        nativeId: 'cam-' + Date.now(),\n        name,\n        isEntryPoint: isEntry,\n        isExitPoint: isExit,\n        trackClasses: ['person', 'car', 'animal'],\n        floorPlanPosition: pos\n      };\n      topology.cameras.push(camera);\n      closeModal('add-camera-modal');\n      // Clear form\n      document.getElementById('camera-name-input').value = '';\n      document.getElementById('camera-entry-checkbox').checked = false;\n      document.getElementById('camera-exit-checkbox').checked = false;\n      updateCameraSelects();\n      updateUI();\n      render();\n    }\n\n    function openAddConnectionModal() {\n      if (topology.cameras.length < 2) { alert('Add at least 2 cameras before creating connections'); return; }\n      updateCameraSelects();\n      document.getElementById('add-connection-modal').classList.add('active');\n    }\n\n    function updateCameraSelects() {\n      // Update camera device select (for adding new cameras)\n      const cameraDeviceSelect = document.getElementById('camera-device-select');\n      if (availableCameras.length > 0) {\n        const existingIds = topology.cameras.map(c => c.deviceId);\n        const available = availableCameras.filter(c => !existingIds.includes(c.id));\n        if (available.length > 0) {\n          cameraDeviceSelect.innerHTML = '<option value=\"\">Select a camera...</option>' +\n            available.map(c => '<option value=\"' + c.id + '\">' + c.name + '</option>').join('');\n        } else {\n          cameraDeviceSelect.innerHTML = '<option value=\"\">All cameras already added</option>';\n        }\n      } else {\n        cameraDeviceSelect.innerHTML = '<option value=\"\">No cameras with object detection found</option>';\n      }\n\n      // Update connection selects (for existing topology cameras)\n      const options = topology.cameras.map(c => '<option value=\"' + c.deviceId + '\">' + c.name + '</option>').join('');\n      document.getElementById('connection-from-select').innerHTML = options;\n      document.getElementById('connection-to-select').innerHTML = options;\n    }\n\n    function addConnection() {\n      const name = document.getElementById('connection-name-input').value;\n      const fromId = document.getElementById('connection-from-select').value;\n      const toId = document.getElementById('connection-to-select').value;\n      const minTransit = parseInt(document.getElementById('transit-min').value) * 1000;\n      const typicalTransit = parseInt(document.getElementById('transit-typical').value) * 1000;\n      const maxTransit = parseInt(document.getElementById('transit-max').value) * 1000;\n      const bidirectional = document.getElementById('connection-bidirectional').checked;\n      if (fromId === toId) { alert('Please select different cameras'); return; }\n      const connection = {\n        id: 'conn-' + Date.now(),\n        fromCameraId: fromId,\n        toCameraId: toId,\n        name: name || fromId + ' to ' + toId,\n        exitZone: [],\n        entryZone: [],\n        transitTime: { min: minTransit, typical: typicalTransit, max: maxTransit },\n        bidirectional\n      };\n      topology.connections.push(connection);\n      closeModal('add-connection-modal');\n      updateUI();\n      render();\n    }\n\n    function updateUI() {\n      const cameraList = document.getElementById('camera-list');\n      if (topology.cameras.length === 0) {\n        cameraList.innerHTML = '<div class=\"camera-item\" style=\"color: #666; text-align: center; cursor: default;\">No cameras configured</div>';\n      } else {\n        cameraList.innerHTML = topology.cameras.map(c => '<div class=\"camera-item ' + (selectedItem?.type === 'camera' && selectedItem?.id === c.deviceId ? 'selected' : '') + '\" onclick=\"selectCamera(\\'' + c.deviceId + '\\')\"><div class=\"camera-name\">CAM ' + c.name + '</div><div class=\"camera-info\">' + (c.isEntryPoint ? 'Entry ' : '') + (c.isExitPoint ? 'Exit' : '') + '</div></div>').join('');\n      }\n      const connectionList = document.getElementById('connection-list');\n      if (topology.connections.length === 0) {\n        connectionList.innerHTML = '<div class=\"connection-item\" style=\"color: #666; text-align: center; cursor: default;\">No connections configured</div>';\n      } else {\n        connectionList.innerHTML = topology.connections.map(c => '<div class=\"connection-item ' + (selectedItem?.type === 'connection' && selectedItem?.id === c.id ? 'selected' : '') + '\" onclick=\"selectConnection(\\'' + c.id + '\\')\"><div class=\"camera-name\">' + c.name + '</div><div class=\"camera-info\">' + (c.transitTime.typical / 1000) + 's typical ' + (c.bidirectional ? '<->' : '->') + '</div></div>').join('');\n      }\n      // Landmark list\n      const landmarkList = document.getElementById('landmark-list');\n      const landmarks = topology.landmarks || [];\n      if (landmarks.length === 0) {\n        landmarkList.innerHTML = '<div class=\"landmark-item\" style=\"color: #666; text-align: center; cursor: default; padding: 8px;\">No landmarks configured</div>';\n      } else {\n        landmarkList.innerHTML = landmarks.map(l => '<div class=\"camera-item ' + (selectedItem?.type === 'landmark' && selectedItem?.id === l.id ? 'selected' : '') + '\" onclick=\"selectLandmark(\\'' + l.id + '\\')\"><div class=\"camera-name\">' + l.name + '</div><div class=\"camera-info\">' + l.type + (l.isEntryPoint ? ' | Entry' : '') + (l.isExitPoint ? ' | Exit' : '') + '</div></div>').join('');\n      }\n      document.getElementById('camera-count').textContent = topology.cameras.length;\n      document.getElementById('connection-count').textContent = topology.connections.length;\n      document.getElementById('landmark-count').textContent = landmarks.length;\n    }\n\n    function selectCamera(deviceId) {\n      selectedItem = { type: 'camera', id: deviceId };\n      const camera = topology.cameras.find(c => c.deviceId === deviceId);\n      showCameraProperties(camera);\n      updateUI();\n      render();\n    }\n\n    function selectConnection(connId) {\n      selectedItem = { type: 'connection', id: connId };\n      const connection = topology.connections.find(c => c.id === connId);\n      showConnectionProperties(connection);\n      updateUI();\n      render();\n    }\n\n    function showCameraProperties(camera) {\n      const panel = document.getElementById('properties-panel');\n      panel.innerHTML = '<h3>Camera Properties</h3><div class=\"form-group\"><label>Name</label><input type=\"text\" value=\"' + camera.name + '\" onchange=\"updateCameraName(\\'' + camera.deviceId + '\\', this.value)\"></div><div class=\"form-group\"><label class=\"checkbox-group\"><input type=\"checkbox\" ' + (camera.isEntryPoint ? 'checked' : '') + ' onchange=\"updateCameraEntry(\\'' + camera.deviceId + '\\', this.checked)\">Entry Point</label></div><div class=\"form-group\"><label class=\"checkbox-group\"><input type=\"checkbox\" ' + (camera.isExitPoint ? 'checked' : '') + ' onchange=\"updateCameraExit(\\'' + camera.deviceId + '\\', this.checked)\">Exit Point</label></div><div class=\"form-group\"><button class=\"btn\" style=\"width: 100%; background: #f44336;\" onclick=\"deleteCamera(\\'' + camera.deviceId + '\\')\">Delete Camera</button></div>';\n    }\n\n    function showConnectionProperties(connection) {\n      const panel = document.getElementById('properties-panel');\n      panel.innerHTML = '<h3>Connection Properties</h3><div class=\"form-group\"><label>Name</label><input type=\"text\" value=\"' + connection.name + '\" onchange=\"updateConnectionName(\\'' + connection.id + '\\', this.value)\"></div><div class=\"form-group\"><label>Transit Time (seconds)</label><div class=\"transit-time-inputs\"><input type=\"number\" value=\"' + (connection.transitTime.min / 1000) + '\" onchange=\"updateTransitTime(\\'' + connection.id + '\\', \\'min\\', this.value)\"><input type=\"number\" value=\"' + (connection.transitTime.typical / 1000) + '\" onchange=\"updateTransitTime(\\'' + connection.id + '\\', \\'typical\\', this.value)\"><input type=\"number\" value=\"' + (connection.transitTime.max / 1000) + '\" onchange=\"updateTransitTime(\\'' + connection.id + '\\', \\'max\\', this.value)\"></div><div class=\"transit-time-labels\"><span>Min</span><span>Typical</span><span>Max</span></div></div><div class=\"form-group\"><label class=\"checkbox-group\"><input type=\"checkbox\" ' + (connection.bidirectional ? 'checked' : '') + ' onchange=\"updateConnectionBidi(\\'' + connection.id + '\\', this.checked)\">Bidirectional</label></div><div class=\"form-group\"><button class=\"btn\" style=\"width: 100%; background: #f44336;\" onclick=\"deleteConnection(\\'' + connection.id + '\\')\">Delete Connection</button></div>';\n    }\n\n    function updateCameraName(id, value) { const camera = topology.cameras.find(c => c.deviceId === id); if (camera) camera.name = value; updateUI(); }\n    function updateCameraEntry(id, value) { const camera = topology.cameras.find(c => c.deviceId === id); if (camera) camera.isEntryPoint = value; }\n    function updateCameraExit(id, value) { const camera = topology.cameras.find(c => c.deviceId === id); if (camera) camera.isExitPoint = value; }\n    function updateConnectionName(id, value) { const conn = topology.connections.find(c => c.id === id); if (conn) conn.name = value; updateUI(); }\n    function updateTransitTime(id, field, value) { const conn = topology.connections.find(c => c.id === id); if (conn) conn.transitTime[field] = parseInt(value) * 1000; }\n    function updateConnectionBidi(id, value) { const conn = topology.connections.find(c => c.id === id); if (conn) conn.bidirectional = value; render(); }\n    function deleteCamera(id) { if (!confirm('Delete this camera?')) return; topology.cameras = topology.cameras.filter(c => c.deviceId !== id); topology.connections = topology.connections.filter(c => c.fromCameraId !== id && c.toCameraId !== id); selectedItem = null; document.getElementById('properties-panel').innerHTML = '<h3>Properties</h3><p style=\"color: #666;\">Select a camera or connection.</p>'; updateCameraSelects(); updateUI(); render(); }\n    function deleteConnection(id) { if (!confirm('Delete this connection?')) return; topology.connections = topology.connections.filter(c => c.id !== id); selectedItem = null; document.getElementById('properties-panel').innerHTML = '<h3>Properties</h3><p style=\"color: #666;\">Select a camera or connection.</p>'; updateUI(); render(); }\n    function setTool(tool) {\n      currentTool = tool;\n      setStatus('Tool: ' + tool, 'success');\n      document.querySelectorAll('.toolbar .btn').forEach(b => b.style.background = '');\n      const btn = document.getElementById('tool-' + tool);\n      if (btn) btn.style.background = '#e94560';\n    }\n\n    function useBlankCanvas() {\n      blankCanvasMode = true;\n      floorPlanImage = null;\n      topology.floorPlan = { type: 'blank', width: canvas.width, height: canvas.height };\n      render();\n      setStatus('Blank canvas ready - use Draw Wall or Draw Room tools', 'success');\n    }\n\n    function clearDrawings() {\n      if (!confirm('Clear all drawings (walls and rooms)?')) return;\n      topology.drawings = [];\n      render();\n      setStatus('Drawings cleared', 'success');\n    }\n\n    function closeModal(id) { document.getElementById(id).classList.remove('active'); }\n    function setStatus(text, type) { document.getElementById('status-text').textContent = text; const dot = document.getElementById('status-dot'); dot.className = 'status-dot'; if (type === 'warning') dot.classList.add('warning'); if (type === 'error') dot.classList.add('error'); }\n\n    let dragging = null;\n\n    canvas.addEventListener('mousedown', (e) => {\n      const rect = canvas.getBoundingClientRect();\n      const x = e.clientX - rect.left;\n      const y = e.clientY - rect.top;\n\n      if (currentTool === 'select') {\n        // Check cameras first\n        for (const camera of topology.cameras) {\n          if (camera.floorPlanPosition) {\n            const dist = Math.hypot(x - camera.floorPlanPosition.x, y - camera.floorPlanPosition.y);\n            if (dist < 25) { selectCamera(camera.deviceId); dragging = { type: 'camera', item: camera }; return; }\n          }\n        }\n        // Check landmarks\n        for (const landmark of (topology.landmarks || [])) {\n          if (landmark.position) {\n            const dist = Math.hypot(x - landmark.position.x, y - landmark.position.y);\n            if (dist < 20) { selectLandmark(landmark.id); dragging = { type: 'landmark', item: landmark }; return; }\n          }\n        }\n      } else if (currentTool === 'wall') {\n        isDrawing = true;\n        drawStart = { x, y };\n        currentDrawing = { type: 'wall', x1: x, y1: y, x2: x, y2: y };\n      } else if (currentTool === 'room') {\n        isDrawing = true;\n        drawStart = { x, y };\n        currentDrawing = { type: 'room', x: x, y: y, width: 0, height: 0 };\n      } else if (currentTool === 'camera') {\n        openAddCameraModal();\n        topology._pendingCameraPos = { x, y };\n      } else if (currentTool === 'landmark') {\n        openAddLandmarkModal();\n        topology._pendingLandmarkPos = { x, y };\n      }\n    });\n\n    canvas.addEventListener('mousemove', (e) => {\n      const rect = canvas.getBoundingClientRect();\n      const x = e.clientX - rect.left;\n      const y = e.clientY - rect.top;\n\n      if (dragging) {\n        if (dragging.type === 'camera') {\n          dragging.item.floorPlanPosition.x = x;\n          dragging.item.floorPlanPosition.y = y;\n        } else if (dragging.type === 'landmark') {\n          dragging.item.position.x = x;\n          dragging.item.position.y = y;\n        }\n        render();\n      } else if (isDrawing && currentDrawing) {\n        if (currentDrawing.type === 'wall') {\n          currentDrawing.x2 = x;\n          currentDrawing.y2 = y;\n        } else if (currentDrawing.type === 'room') {\n          currentDrawing.width = x - drawStart.x;\n          currentDrawing.height = y - drawStart.y;\n        }\n        render();\n      }\n    });\n\n    canvas.addEventListener('mouseup', (e) => {\n      if (isDrawing && currentDrawing) {\n        if (!topology.drawings) topology.drawings = [];\n        // Normalize room coordinates if drawn backwards\n        if (currentDrawing.type === 'room') {\n          if (currentDrawing.width < 0) {\n            currentDrawing.x += currentDrawing.width;\n            currentDrawing.width = Math.abs(currentDrawing.width);\n          }\n          if (currentDrawing.height < 0) {\n            currentDrawing.y += currentDrawing.height;\n            currentDrawing.height = Math.abs(currentDrawing.height);\n          }\n          // Only add if room is big enough\n          if (currentDrawing.width > 20 && currentDrawing.height > 20) {\n            const label = prompt('Room name (optional):');\n            if (label) currentDrawing.label = label;\n            topology.drawings.push(currentDrawing);\n          }\n        } else if (currentDrawing.type === 'wall') {\n          // Only add if wall is long enough\n          const len = Math.hypot(currentDrawing.x2 - currentDrawing.x1, currentDrawing.y2 - currentDrawing.y1);\n          if (len > 20) {\n            topology.drawings.push(currentDrawing);\n          }\n        }\n        isDrawing = false;\n        currentDrawing = null;\n        render();\n      }\n      dragging = null;\n    });\n\n    window.addEventListener('resize', () => { resizeCanvas(); render(); });\n    init();\n  <\/script>\n</body>\n</html>"},3885(e,t,n){"use strict";e.exports=n(9844)()},3891(e){function t(e){var t=new Error("Cannot find module '"+e+"'");throw t.code="MODULE_NOT_FOUND",t}t.keys=()=>[],t.resolve=t,t.id=3891,e.exports=t},3936(e,t,n){"use strict";var r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const i=n(4756),s=r(n(9278)),o=r(n(5753)),a=r(n(6968)),c=(0,o.default)("mqttjs:tls");t.default=(e,t)=>{t.port=t.port||8883,t.host=t.hostname||t.host||"localhost",0===s.default.isIP(t.host)&&(t.servername=t.host),t.rejectUnauthorized=!1!==t.rejectUnauthorized,delete t.path,c("port %d host %s rejectUnauthorized %b",t.port,t.host,t.rejectUnauthorized);const n=function(e){const{host:t,port:n,socksProxy:r,...s}=e;if(void 0!==r){const o=(0,a.default)(t,n,r,{timeout:e.socksTimeout});return(0,i.connect)({...s,socket:o})}return(0,i.connect)(e)}(t);function r(r){t.rejectUnauthorized&&e.emit("error",r),n.end()}return n.on("secureConnect",()=>{t.rejectUnauthorized&&!n.authorized?n.emit("error",new Error("TLS not authorized")):n.removeListener("error",r)}),n.on("error",r),n}},4134(e){"use strict";class t extends Error{constructor(e){if(!Array.isArray(e))throw new TypeError("Expected input to be an Array, got "+typeof e);let t="";for(let n=0;n<e.length;n++)t+=`    ${e[n].stack}\n`;super(t),this.name="AggregateError",this.errors=e}}e.exports={AggregateError:t,ArrayIsArray:e=>Array.isArray(e),ArrayPrototypeIncludes:(e,t)=>e.includes(t),ArrayPrototypeIndexOf:(e,t)=>e.indexOf(t),ArrayPrototypeJoin:(e,t)=>e.join(t),ArrayPrototypeMap:(e,t)=>e.map(t),ArrayPrototypePop:(e,t)=>e.pop(t),ArrayPrototypePush:(e,t)=>e.push(t),ArrayPrototypeSlice:(e,t,n)=>e.slice(t,n),Error,FunctionPrototypeCall:(e,t,...n)=>e.call(t,...n),FunctionPrototypeSymbolHasInstance:(e,t)=>Function.prototype[Symbol.hasInstance].call(e,t),MathFloor:Math.floor,Number,NumberIsInteger:Number.isInteger,NumberIsNaN:Number.isNaN,NumberMAX_SAFE_INTEGER:Number.MAX_SAFE_INTEGER,NumberMIN_SAFE_INTEGER:Number.MIN_SAFE_INTEGER,NumberParseInt:Number.parseInt,ObjectDefineProperties:(e,t)=>Object.defineProperties(e,t),ObjectDefineProperty:(e,t,n)=>Object.defineProperty(e,t,n),ObjectGetOwnPropertyDescriptor:(e,t)=>Object.getOwnPropertyDescriptor(e,t),ObjectKeys:e=>Object.keys(e),ObjectSetPrototypeOf:(e,t)=>Object.setPrototypeOf(e,t),Promise,PromisePrototypeCatch:(e,t)=>e.catch(t),PromisePrototypeThen:(e,t,n)=>e.then(t,n),PromiseReject:e=>Promise.reject(e),PromiseResolve:e=>Promise.resolve(e),ReflectApply:Reflect.apply,RegExpPrototypeTest:(e,t)=>e.test(t),SafeSet:Set,String,StringPrototypeSlice:(e,t,n)=>e.slice(t,n),StringPrototypeToLowerCase:e=>e.toLowerCase(),StringPrototypeToUpperCase:e=>e.toUpperCase(),StringPrototypeTrim:e=>e.trim(),Symbol,SymbolFor:Symbol.for,SymbolAsyncIterator:Symbol.asyncIterator,SymbolHasInstance:Symbol.hasInstance,SymbolIterator:Symbol.iterator,SymbolDispose:Symbol.dispose||Symbol("Symbol.dispose"),SymbolAsyncDispose:Symbol.asyncDispose||Symbol("Symbol.asyncDispose"),TypedArrayPrototypeSet:(e,t,n)=>e.set(t,n),Boolean,Uint8Array}},4147(e,t,n){"use strict";const{SymbolDispose:r}=n(4134),{AbortError:i,codes:s}=n(6371),{isNodeStream:o,isWebStream:a,kControllerErrorFunction:c}=n(6115),l=n(6238),{ERR_INVALID_ARG_TYPE:d}=s;let u;e.exports.addAbortSignal=function(t,n){if(((e,t)=>{if("object"!=typeof e||!("aborted"in e))throw new d(t,"AbortSignal",e)})(t,"signal"),!o(n)&&!a(n))throw new d("stream",["ReadableStream","WritableStream","Stream"],n);return e.exports.addAbortSignalNoValidate(t,n)},e.exports.addAbortSignalNoValidate=function(e,t){if("object"!=typeof e||!("aborted"in e))return t;const s=o(t)?()=>{t.destroy(new i(void 0,{cause:e.reason}))}:()=>{t[c](new i(void 0,{cause:e.reason}))};if(e.aborted)s();else{u=u||n(7760).addAbortListener;const i=u(e,s);l(t,i[r])}return t}},4152(e,t,n){"use strict";var r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.TypedEventEmitter=void 0;const i=r(n(4434)),s=n(4723);class o{}t.TypedEventEmitter=o,(0,s.applyMixin)(o,i.default)},4192(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ScryptedMimeTypes=t.ScryptedInterface=t.MediaPlayerState=t.SecuritySystemObstruction=t.SecuritySystemMode=t.AirQuality=t.AirPurifierMode=t.AirPurifierStatus=t.ChargeState=t.LockState=t.PanTiltZoomMovement=t.ThermostatMode=t.TemperatureUnit=t.FanMode=t.HumidityMode=t.ScryptedDeviceType=t.ScryptedInterfaceDescriptors=t.ScryptedInterfaceMethod=t.ScryptedInterfaceProperty=t.DeviceBase=t.TYPES_VERSION=void 0,t.TYPES_VERSION="0.5.51";var n,r,i,s,o,a,c,l,d,u,h,p,f,g,m,y,b,v;t.DeviceBase=class{},function(e){e.id="id",e.info="info",e.interfaces="interfaces",e.mixins="mixins",e.name="name",e.nativeId="nativeId",e.pluginId="pluginId",e.providedInterfaces="providedInterfaces",e.providedName="providedName",e.providedRoom="providedRoom",e.providedType="providedType",e.providerId="providerId",e.room="room",e.type="type",e.scryptedRuntimeArguments="scryptedRuntimeArguments",e.on="on",e.brightness="brightness",e.colorTemperature="colorTemperature",e.rgb="rgb",e.hsv="hsv",e.buttons="buttons",e.sensors="sensors",e.running="running",e.paused="paused",e.docked="docked",e.temperatureSetting="temperatureSetting",e.temperature="temperature",e.temperatureUnit="temperatureUnit",e.humidity="humidity",e.resolution="resolution",e.audioVolumes="audioVolumes",e.recordingActive="recordingActive",e.ptzCapabilities="ptzCapabilities",e.lockState="lockState",e.entryOpen="entryOpen",e.batteryLevel="batteryLevel",e.chargeState="chargeState",e.online="online",e.fromMimeType="fromMimeType",e.toMimeType="toMimeType",e.converters="converters",e.binaryState="binaryState",e.tampered="tampered",e.sleeping="sleeping",e.powerDetected="powerDetected",e.audioDetected="audioDetected",e.motionDetected="motionDetected",e.ambientLight="ambientLight",e.occupied="occupied",e.flooded="flooded",e.ultraviolet="ultraviolet",e.luminance="luminance",e.position="position",e.securitySystemState="securitySystemState",e.pm10Density="pm10Density",e.pm25Density="pm25Density",e.vocDensity="vocDensity",e.noxDensity="noxDensity",e.co2ppm="co2ppm",e.airQuality="airQuality",e.airPurifierState="airPurifierState",e.filterChangeIndication="filterChangeIndication",e.filterLifeLevel="filterLifeLevel",e.humiditySetting="humiditySetting",e.fan="fan",e.applicationInfo="applicationInfo",e.chatCompletionCapabilities="chatCompletionCapabilities",e.systemDevice="systemDevice"}(n||(t.ScryptedInterfaceProperty=n={})),function(e){e.listen="listen",e.probe="probe",e.setMixins="setMixins",e.setName="setName",e.setRoom="setRoom",e.setType="setType",e.getPluginJson="getPluginJson",e.turnOff="turnOff",e.turnOn="turnOn",e.setBrightness="setBrightness",e.getTemperatureMaxK="getTemperatureMaxK",e.getTemperatureMinK="getTemperatureMinK",e.setColorTemperature="setColorTemperature",e.setRgb="setRgb",e.setHsv="setHsv",e.pressButton="pressButton",e.sendNotification="sendNotification",e.start="start",e.stop="stop",e.pause="pause",e.resume="resume",e.dock="dock",e.setTemperature="setTemperature",e.setTemperatureUnit="setTemperatureUnit",e.getPictureOptions="getPictureOptions",e.takePicture="takePicture",e.getAudioStream="getAudioStream",e.setAudioVolumes="setAudioVolumes",e.startDisplay="startDisplay",e.stopDisplay="stopDisplay",e.getVideoStream="getVideoStream",e.getVideoStreamOptions="getVideoStreamOptions",e.getPrivacyMasks="getPrivacyMasks",e.setPrivacyMasks="setPrivacyMasks",e.getVideoTextOverlays="getVideoTextOverlays",e.setVideoTextOverlay="setVideoTextOverlay",e.getRecordingStream="getRecordingStream",e.getRecordingStreamCurrentTime="getRecordingStreamCurrentTime",e.getRecordingStreamOptions="getRecordingStreamOptions",e.getRecordingStreamThumbnail="getRecordingStreamThumbnail",e.deleteRecordingStream="deleteRecordingStream",e.setRecordingActive="setRecordingActive",e.ptzCommand="ptzCommand",e.getRecordedEvents="getRecordedEvents",e.getVideoClip="getVideoClip",e.getVideoClips="getVideoClips",e.getVideoClipThumbnail="getVideoClipThumbnail",e.removeVideoClips="removeVideoClips",e.setVideoStreamOptions="setVideoStreamOptions",e.startIntercom="startIntercom",e.stopIntercom="stopIntercom",e.lock="lock",e.unlock="unlock",e.addPassword="addPassword",e.getPasswords="getPasswords",e.removePassword="removePassword",e.activate="activate",e.deactivate="deactivate",e.isReversible="isReversible",e.closeEntry="closeEntry",e.openEntry="openEntry",e.getDevice="getDevice",e.releaseDevice="releaseDevice",e.adoptDevice="adoptDevice",e.discoverDevices="discoverDevices",e.createDevice="createDevice",e.getCreateDeviceSettings="getCreateDeviceSettings",e.reboot="reboot",e.getRefreshFrequency="getRefreshFrequency",e.refresh="refresh",e.getMediaStatus="getMediaStatus",e.load="load",e.seek="seek",e.skipNext="skipNext",e.skipPrevious="skipPrevious",e.convert="convert",e.convertMedia="convertMedia",e.getSettings="getSettings",e.putSetting="putSetting",e.armSecuritySystem="armSecuritySystem",e.disarmSecuritySystem="disarmSecuritySystem",e.setAirPurifierState="setAirPurifierState",e.getReadmeMarkdown="getReadmeMarkdown",e.getOauthUrl="getOauthUrl",e.onOauthCallback="onOauthCallback",e.canMixin="canMixin",e.getMixin="getMixin",e.releaseMixin="releaseMixin",e.onRequest="onRequest",e.onConnection="onConnection",e.onPush="onPush",e.run="run",e.eval="eval",e.loadScripts="loadScripts",e.saveScript="saveScript",e.forkInterface="forkInterface",e.getDetectionInput="getDetectionInput",e.getObjectTypes="getObjectTypes",e.detectObjects="detectObjects",e.generateObjectDetections="generateObjectDetections",e.getDetectionModel="getDetectionModel",e.setHumidity="setHumidity",e.setFan="setFan",e.startRTCSignalingSession="startRTCSignalingSession",e.createRTCSignalingSession="createRTCSignalingSession",e.getScryptedUserAccessControl="getScryptedUserAccessControl",e.generateVideoFrames="generateVideoFrames",e.connectStream="connectStream",e.getTTYSettings="getTTYSettings",e.getChatCompletion="getChatCompletion",e.streamChatCompletion="streamChatCompletion",e.getTextEmbedding="getTextEmbedding",e.getImageEmbedding="getImageEmbedding",e.callLLMTool="callLLMTool",e.getLLMTools="getLLMTools"}(r||(t.ScryptedInterfaceMethod=r={})),t.ScryptedInterfaceDescriptors={ScryptedDevice:{name:"ScryptedDevice",methods:["listen","probe","setMixins","setName","setRoom","setType"],properties:["id","info","interfaces","mixins","name","nativeId","pluginId","providedInterfaces","providedName","providedRoom","providedType","providerId","room","type"]},ScryptedPlugin:{name:"ScryptedPlugin",methods:["getPluginJson"],properties:[]},ScryptedPluginRuntime:{name:"ScryptedPluginRuntime",methods:[],properties:["scryptedRuntimeArguments"]},OnOff:{name:"OnOff",methods:["turnOff","turnOn"],properties:["on"]},Brightness:{name:"Brightness",methods:["setBrightness"],properties:["brightness"]},ColorSettingTemperature:{name:"ColorSettingTemperature",methods:["getTemperatureMaxK","getTemperatureMinK","setColorTemperature"],properties:["colorTemperature"]},ColorSettingRgb:{name:"ColorSettingRgb",methods:["setRgb"],properties:["rgb"]},ColorSettingHsv:{name:"ColorSettingHsv",methods:["setHsv"],properties:["hsv"]},Buttons:{name:"Buttons",methods:[],properties:["buttons"]},PressButtons:{name:"PressButtons",methods:["pressButton"],properties:[]},Sensors:{name:"Sensors",methods:[],properties:["sensors"]},Notifier:{name:"Notifier",methods:["sendNotification"],properties:[]},StartStop:{name:"StartStop",methods:["start","stop"],properties:["running"]},Pause:{name:"Pause",methods:["pause","resume"],properties:["paused"]},Dock:{name:"Dock",methods:["dock"],properties:["docked"]},TemperatureSetting:{name:"TemperatureSetting",methods:["setTemperature"],properties:["temperatureSetting"]},Thermometer:{name:"Thermometer",methods:["setTemperatureUnit"],properties:["temperature","temperatureUnit"]},HumiditySensor:{name:"HumiditySensor",methods:[],properties:["humidity"]},Camera:{name:"Camera",methods:["getPictureOptions","takePicture"],properties:[]},Resolution:{name:"Resolution",methods:[],properties:["resolution"]},Microphone:{name:"Microphone",methods:["getAudioStream"],properties:[]},AudioVolumeControl:{name:"AudioVolumeControl",methods:["setAudioVolumes"],properties:["audioVolumes"]},Display:{name:"Display",methods:["startDisplay","stopDisplay"],properties:[]},VideoCamera:{name:"VideoCamera",methods:["getVideoStream","getVideoStreamOptions"],properties:[]},VideoCameraMask:{name:"VideoCameraMask",methods:["getPrivacyMasks","setPrivacyMasks"],properties:[]},VideoTextOverlays:{name:"VideoTextOverlays",methods:["getVideoTextOverlays","setVideoTextOverlay"],properties:[]},VideoRecorder:{name:"VideoRecorder",methods:["getRecordingStream","getRecordingStreamCurrentTime","getRecordingStreamOptions","getRecordingStreamThumbnail"],properties:["recordingActive"]},VideoRecorderManagement:{name:"VideoRecorderManagement",methods:["deleteRecordingStream","setRecordingActive"],properties:[]},PanTiltZoom:{name:"PanTiltZoom",methods:["ptzCommand"],properties:["ptzCapabilities"]},EventRecorder:{name:"EventRecorder",methods:["getRecordedEvents"],properties:[]},VideoClips:{name:"VideoClips",methods:["getVideoClip","getVideoClips","getVideoClipThumbnail","removeVideoClips"],properties:[]},VideoCameraConfiguration:{name:"VideoCameraConfiguration",methods:["setVideoStreamOptions"],properties:[]},Intercom:{name:"Intercom",methods:["startIntercom","stopIntercom"],properties:[]},Lock:{name:"Lock",methods:["lock","unlock"],properties:["lockState"]},PasswordStore:{name:"PasswordStore",methods:["addPassword","getPasswords","removePassword"],properties:[]},Scene:{name:"Scene",methods:["activate","deactivate","isReversible"],properties:[]},Entry:{name:"Entry",methods:["closeEntry","openEntry"],properties:[]},EntrySensor:{name:"EntrySensor",methods:[],properties:["entryOpen"]},DeviceProvider:{name:"DeviceProvider",methods:["getDevice","releaseDevice"],properties:[]},DeviceDiscovery:{name:"DeviceDiscovery",methods:["adoptDevice","discoverDevices"],properties:[]},DeviceCreator:{name:"DeviceCreator",methods:["createDevice","getCreateDeviceSettings"],properties:[]},Battery:{name:"Battery",methods:[],properties:["batteryLevel"]},Charger:{name:"Charger",methods:[],properties:["chargeState"]},Reboot:{name:"Reboot",methods:["reboot"],properties:[]},Refresh:{name:"Refresh",methods:["getRefreshFrequency","refresh"],properties:[]},MediaPlayer:{name:"MediaPlayer",methods:["getMediaStatus","load","seek","skipNext","skipPrevious"],properties:[]},Online:{name:"Online",methods:[],properties:["online"]},BufferConverter:{name:"BufferConverter",methods:["convert"],properties:["fromMimeType","toMimeType"]},MediaConverter:{name:"MediaConverter",methods:["convertMedia"],properties:["converters"]},Settings:{name:"Settings",methods:["getSettings","putSetting"],properties:[]},BinarySensor:{name:"BinarySensor",methods:[],properties:["binaryState"]},TamperSensor:{name:"TamperSensor",methods:[],properties:["tampered"]},Sleep:{name:"Sleep",methods:[],properties:["sleeping"]},PowerSensor:{name:"PowerSensor",methods:[],properties:["powerDetected"]},AudioSensor:{name:"AudioSensor",methods:[],properties:["audioDetected"]},MotionSensor:{name:"MotionSensor",methods:[],properties:["motionDetected"]},AmbientLightSensor:{name:"AmbientLightSensor",methods:[],properties:["ambientLight"]},OccupancySensor:{name:"OccupancySensor",methods:[],properties:["occupied"]},FloodSensor:{name:"FloodSensor",methods:[],properties:["flooded"]},UltravioletSensor:{name:"UltravioletSensor",methods:[],properties:["ultraviolet"]},LuminanceSensor:{name:"LuminanceSensor",methods:[],properties:["luminance"]},PositionSensor:{name:"PositionSensor",methods:[],properties:["position"]},SecuritySystem:{name:"SecuritySystem",methods:["armSecuritySystem","disarmSecuritySystem"],properties:["securitySystemState"]},PM10Sensor:{name:"PM10Sensor",methods:[],properties:["pm10Density"]},PM25Sensor:{name:"PM25Sensor",methods:[],properties:["pm25Density"]},VOCSensor:{name:"VOCSensor",methods:[],properties:["vocDensity"]},NOXSensor:{name:"NOXSensor",methods:[],properties:["noxDensity"]},CO2Sensor:{name:"CO2Sensor",methods:[],properties:["co2ppm"]},AirQualitySensor:{name:"AirQualitySensor",methods:[],properties:["airQuality"]},AirPurifier:{name:"AirPurifier",methods:["setAirPurifierState"],properties:["airPurifierState"]},FilterMaintenance:{name:"FilterMaintenance",methods:[],properties:["filterChangeIndication","filterLifeLevel"]},Readme:{name:"Readme",methods:["getReadmeMarkdown"],properties:[]},OauthClient:{name:"OauthClient",methods:["getOauthUrl","onOauthCallback"],properties:[]},MixinProvider:{name:"MixinProvider",methods:["canMixin","getMixin","releaseMixin"],properties:[]},HttpRequestHandler:{name:"HttpRequestHandler",methods:["onRequest"],properties:[]},EngineIOHandler:{name:"EngineIOHandler",methods:["onConnection"],properties:[]},PushHandler:{name:"PushHandler",methods:["onPush"],properties:[]},Program:{name:"Program",methods:["run"],properties:[]},Scriptable:{name:"Scriptable",methods:["eval","loadScripts","saveScript"],properties:[]},ClusterForkInterface:{name:"ClusterForkInterface",methods:["forkInterface"],properties:[]},ObjectDetector:{name:"ObjectDetector",methods:["getDetectionInput","getObjectTypes"],properties:[]},ObjectDetection:{name:"ObjectDetection",methods:["detectObjects","generateObjectDetections","getDetectionModel"],properties:[]},ObjectDetectionPreview:{name:"ObjectDetectionPreview",methods:[],properties:[]},ObjectDetectionGenerator:{name:"ObjectDetectionGenerator",methods:[],properties:[]},HumiditySetting:{name:"HumiditySetting",methods:["setHumidity"],properties:["humiditySetting"]},Fan:{name:"Fan",methods:["setFan"],properties:["fan"]},RTCSignalingChannel:{name:"RTCSignalingChannel",methods:["startRTCSignalingSession"],properties:[]},RTCSignalingClient:{name:"RTCSignalingClient",methods:["createRTCSignalingSession"],properties:[]},LauncherApplication:{name:"LauncherApplication",methods:[],properties:["applicationInfo"]},ScryptedUser:{name:"ScryptedUser",methods:["getScryptedUserAccessControl"],properties:[]},VideoFrameGenerator:{name:"VideoFrameGenerator",methods:["generateVideoFrames"],properties:[]},StreamService:{name:"StreamService",methods:["connectStream"],properties:[]},TTY:{name:"TTY",methods:[],properties:[]},TTYSettings:{name:"TTYSettings",methods:["getTTYSettings"],properties:[]},ChatCompletion:{name:"ChatCompletion",methods:["getChatCompletion","streamChatCompletion"],properties:["chatCompletionCapabilities"]},TextEmbedding:{name:"TextEmbedding",methods:["getTextEmbedding"],properties:[]},ImageEmbedding:{name:"ImageEmbedding",methods:["getImageEmbedding"],properties:[]},LLMTools:{name:"LLMTools",methods:["callLLMTool","getLLMTools"],properties:[]},ScryptedSystemDevice:{name:"ScryptedSystemDevice",methods:[],properties:["systemDevice"]},ScryptedDeviceCreator:{name:"ScryptedDeviceCreator",methods:[],properties:[]},ScryptedSettings:{name:"ScryptedSettings",methods:[],properties:[]}},function(e){e.Builtin="Builtin",e.Internal="Internal",e.Camera="Camera",e.Fan="Fan",e.Light="Light",e.Switch="Switch",e.Outlet="Outlet",e.Sensor="Sensor",e.Scene="Scene",e.Program="Program",e.Automation="Automation",e.Vacuum="Vacuum",e.Notifier="Notifier",e.Thermostat="Thermostat",e.Lock="Lock",e.PasswordControl="PasswordControl",e.Display="Display",e.SmartDisplay="SmartDisplay",e.Speaker="Speaker",e.SmartSpeaker="SmartSpeaker",e.RemoteDesktop="RemoteDesktop",e.Event="Event",e.Entry="Entry",e.Garage="Garage",e.DeviceProvider="DeviceProvider",e.DataSource="DataSource",e.API="API",e.Buttons="Buttons",e.Doorbell="Doorbell",e.Irrigation="Irrigation",e.Valve="Valve",e.Person="Person",e.SecuritySystem="SecuritySystem",e.WindowCovering="WindowCovering",e.Siren="Siren",e.AirPurifier="AirPurifier",e.Internet="Internet",e.Network="Network",e.Bridge="Bridge",e.LLM="LLM",e.Unknown="Unknown"}(i||(t.ScryptedDeviceType=i={})),function(e){e.Humidify="Humidify",e.Dehumidify="Dehumidify",e.Auto="Auto",e.Off="Off"}(s||(t.HumidityMode=s={})),function(e){e.Auto="Auto",e.Manual="Manual"}(o||(t.FanMode=o={})),function(e){e.C="C",e.F="F"}(a||(t.TemperatureUnit=a={})),function(e){e.Off="Off",e.Cool="Cool",e.Heat="Heat",e.HeatCool="HeatCool",e.Auto="Auto",e.FanOnly="FanOnly",e.Purifier="Purifier",e.Eco="Eco",e.Dry="Dry",e.On="On"}(c||(t.ThermostatMode=c={})),function(e){e.Absolute="Absolute",e.Relative="Relative",e.Continuous="Continuous",e.Preset="Preset",e.Home="Home"}(l||(t.PanTiltZoomMovement=l={})),function(e){e.Locked="Locked",e.Unlocked="Unlocked",e.Jammed="Jammed"}(d||(t.LockState=d={})),function(e){e.Trickle="trickle",e.Charging="charging",e.NotCharging="not-charging"}(u||(t.ChargeState=u={})),function(e){e.Inactive="Inactive",e.Idle="Idle",e.Active="Active",e.ActiveNightMode="ActiveNightMode"}(h||(t.AirPurifierStatus=h={})),function(e){e.Manual="Manual",e.Automatic="Automatic"}(p||(t.AirPurifierMode=p={})),function(e){e.Unknown="Unknown",e.Excellent="Excellent",e.Good="Good",e.Fair="Fair",e.Inferior="Inferior",e.Poor="Poor"}(f||(t.AirQuality=f={})),function(e){e.Disarmed="Disarmed",e.HomeArmed="HomeArmed",e.AwayArmed="AwayArmed",e.NightArmed="NightArmed"}(g||(t.SecuritySystemMode=g={})),function(e){e.Sensor="Sensor",e.Occupied="Occupied",e.Time="Time",e.Error="Error"}(m||(t.SecuritySystemObstruction=m={})),function(e){e.Idle="Idle",e.Playing="Playing",e.Paused="Paused",e.Buffering="Buffering"}(y||(t.MediaPlayerState=y={})),function(e){e.ScryptedDevice="ScryptedDevice",e.ScryptedPlugin="ScryptedPlugin",e.ScryptedPluginRuntime="ScryptedPluginRuntime",e.OnOff="OnOff",e.Brightness="Brightness",e.ColorSettingTemperature="ColorSettingTemperature",e.ColorSettingRgb="ColorSettingRgb",e.ColorSettingHsv="ColorSettingHsv",e.Buttons="Buttons",e.PressButtons="PressButtons",e.Sensors="Sensors",e.Notifier="Notifier",e.StartStop="StartStop",e.Pause="Pause",e.Dock="Dock",e.TemperatureSetting="TemperatureSetting",e.Thermometer="Thermometer",e.HumiditySensor="HumiditySensor",e.Camera="Camera",e.Resolution="Resolution",e.Microphone="Microphone",e.AudioVolumeControl="AudioVolumeControl",e.Display="Display",e.VideoCamera="VideoCamera",e.VideoCameraMask="VideoCameraMask",e.VideoTextOverlays="VideoTextOverlays",e.VideoRecorder="VideoRecorder",e.VideoRecorderManagement="VideoRecorderManagement",e.PanTiltZoom="PanTiltZoom",e.EventRecorder="EventRecorder",e.VideoClips="VideoClips",e.VideoCameraConfiguration="VideoCameraConfiguration",e.Intercom="Intercom",e.Lock="Lock",e.PasswordStore="PasswordStore",e.Scene="Scene",e.Entry="Entry",e.EntrySensor="EntrySensor",e.DeviceProvider="DeviceProvider",e.DeviceDiscovery="DeviceDiscovery",e.DeviceCreator="DeviceCreator",e.Battery="Battery",e.Charger="Charger",e.Reboot="Reboot",e.Refresh="Refresh",e.MediaPlayer="MediaPlayer",e.Online="Online",e.BufferConverter="BufferConverter",e.MediaConverter="MediaConverter",e.Settings="Settings",e.BinarySensor="BinarySensor",e.TamperSensor="TamperSensor",e.Sleep="Sleep",e.PowerSensor="PowerSensor",e.AudioSensor="AudioSensor",e.MotionSensor="MotionSensor",e.AmbientLightSensor="AmbientLightSensor",e.OccupancySensor="OccupancySensor",e.FloodSensor="FloodSensor",e.UltravioletSensor="UltravioletSensor",e.LuminanceSensor="LuminanceSensor",e.PositionSensor="PositionSensor",e.SecuritySystem="SecuritySystem",e.PM10Sensor="PM10Sensor",e.PM25Sensor="PM25Sensor",e.VOCSensor="VOCSensor",e.NOXSensor="NOXSensor",e.CO2Sensor="CO2Sensor",e.AirQualitySensor="AirQualitySensor",e.AirPurifier="AirPurifier",e.FilterMaintenance="FilterMaintenance",e.Readme="Readme",e.OauthClient="OauthClient",e.MixinProvider="MixinProvider",e.HttpRequestHandler="HttpRequestHandler",e.EngineIOHandler="EngineIOHandler",e.PushHandler="PushHandler",e.Program="Program",e.Scriptable="Scriptable",e.ClusterForkInterface="ClusterForkInterface",e.ObjectDetector="ObjectDetector",e.ObjectDetection="ObjectDetection",e.ObjectDetectionPreview="ObjectDetectionPreview",e.ObjectDetectionGenerator="ObjectDetectionGenerator",e.HumiditySetting="HumiditySetting",e.Fan="Fan",e.RTCSignalingChannel="RTCSignalingChannel",e.RTCSignalingClient="RTCSignalingClient",e.LauncherApplication="LauncherApplication",e.ScryptedUser="ScryptedUser",e.VideoFrameGenerator="VideoFrameGenerator",e.StreamService="StreamService",e.TTY="TTY",e.TTYSettings="TTYSettings",e.ChatCompletion="ChatCompletion",e.TextEmbedding="TextEmbedding",e.ImageEmbedding="ImageEmbedding",e.LLMTools="LLMTools",e.ScryptedSystemDevice="ScryptedSystemDevice",e.ScryptedDeviceCreator="ScryptedDeviceCreator",e.ScryptedSettings="ScryptedSettings"}(b||(t.ScryptedInterface=b={})),function(e){e.Url="text/x-uri",e.InsecureLocalUrl="text/x-insecure-local-uri",e.LocalUrl="text/x-local-uri",e.ServerId="text/x-server-id",e.PushEndpoint="text/x-push-endpoint",e.SchemePrefix="x-scrypted/x-scrypted-scheme-",e.MediaStreamUrl="text/x-media-url",e.MediaObject="x-scrypted/x-scrypted-media-object",e.RequestMediaObject="x-scrypted/x-scrypted-request-media-object",e.RequestMediaStream="x-scrypted/x-scrypted-request-stream",e.MediaStreamFeedback="x-scrypted/x-media-stream-feedback",e.FFmpegInput="x-scrypted/x-ffmpeg-input",e.FFmpegTranscodeStream="x-scrypted/x-ffmpeg-transcode-stream",e.RTCSignalingChannel="x-scrypted/x-scrypted-rtc-signaling-channel",e.RTCSignalingSession="x-scrypted/x-scrypted-rtc-signaling-session",e.RTCConnectionManagement="x-scrypted/x-scrypted-rtc-connection-management",e.Image="x-scrypted/x-scrypted-image"}(v||(t.ScryptedMimeTypes=v={}))},4259(e,t,n){"use strict";const{ArrayIsArray:r,ObjectSetPrototypeOf:i}=n(4134),{EventEmitter:s}=n(4434);function o(e){s.call(this,e)}function a(e,t,n){if("function"==typeof e.prependListener)return e.prependListener(t,n);e._events&&e._events[t]?r(e._events[t])?e._events[t].unshift(n):e._events[t]=[n,e._events[t]]:e.on(t,n)}i(o.prototype,s.prototype),i(o,s),o.prototype.pipe=function(e,t){const n=this;function r(t){e.writable&&!1===e.write(t)&&n.pause&&n.pause()}function i(){n.readable&&n.resume&&n.resume()}n.on("data",r),e.on("drain",i),e._isStdio||t&&!1===t.end||(n.on("end",c),n.on("close",l));let o=!1;function c(){o||(o=!0,e.end())}function l(){o||(o=!0,"function"==typeof e.destroy&&e.destroy())}function d(e){u(),0===s.listenerCount(this,"error")&&this.emit("error",e)}function u(){n.removeListener("data",r),e.removeListener("drain",i),n.removeListener("end",c),n.removeListener("close",l),n.removeListener("error",d),e.removeListener("error",d),n.removeListener("end",u),n.removeListener("close",u),e.removeListener("close",u)}return a(n,"error",d),a(e,"error",d),n.on("end",u),n.on("close",u),e.on("close",u),e.emit("pipe",n),e},e.exports={Stream:o,prependListener:a}},4264(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.default=(e,t,n)=>{e.log("handling pubrel packet");const r="undefined"!=typeof n?n:e.noop,{messageId:i}=t,s={cmd:"pubcomp",messageId:i};e.incomingStore.get(t,(t,n)=>{t?e._sendPacket(s,r):(e.emit("message",n.topic,n.payload,n),e.handleMessage(n,t=>{if(t)return r(t);e.incomingStore.del(n,e.noop),e._sendPacket(s,r)}))})}},4386(e,t,n){"use strict";var r,i=this&&this.__createBinding||(Object.create?function(e,t,n,r){void 0===r&&(r=n);var i=Object.getOwnPropertyDescriptor(t,n);i&&!("get"in i?!t.__esModule:i.writable||i.configurable)||(i={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,r,i)}:function(e,t,n,r){void 0===r&&(r=n),e[r]=t[n]}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),o=this&&this.__importStar||(r=function(e){return r=Object.getOwnPropertyNames||function(e){var t=[];for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[t.length]=n);return t},r(e)},function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n=r(e),o=0;o<n.length;o++)"default"!==n[o]&&i(t,e,n[o]);return s(t,e),t});Object.defineProperty(t,"__esModule",{value:!0}),t.AlertManager=void 0;const a=o(n(7562)),c=n(4997),{systemManager:l,mediaManager:d}=a.default;t.AlertManager=class{rules=[];recentAlerts=[];cooldowns=new Map;console;storage;maxAlerts=100;constructor(e,t){this.console=e,this.storage=t,this.loadRules()}async checkAndAlert(e,t,n){const r=this.rules.find(t=>t.type===e&&t.enabled);if(!r)return null;if(r.objectClasses&&r.objectClasses.length>0&&!r.objectClasses.includes(t.className))return null;if(r.cameraIds&&r.cameraIds.length>0&&n.cameraId&&!r.cameraIds.includes(n.cameraId))return null;const i=`${r.id}:${t.globalId}`,s=this.cooldowns.get(i)||0;if(r.cooldown>0&&Date.now()-s<r.cooldown)return null;if(!this.evaluateConditions(r.conditions,t))return null;const o={...n,objectClass:t.className,objectLabel:t.label},a=(0,c.createAlert)(e,t.globalId,o,r.severity,r.id);return this.recentAlerts.unshift(a),this.recentAlerts.length>this.maxAlerts&&this.recentAlerts.pop(),this.cooldowns.set(i,Date.now()),await this.sendNotifications(a,r),this.console.log(`Alert generated: [${a.severity}] ${a.message}`),a}async sendNotifications(e,t){const n=t.notifiers.length>0?t.notifiers:this.getDefaultNotifiers();let r;const i=e.details.toCameraId||e.details.cameraId;if(i)try{const e=l.getDeviceById(i);e&&e.interfaces?.includes(a.ScryptedInterface.Camera)&&(r=await e.takePicture())}catch(e){this.console.warn(`Failed to get thumbnail from camera ${i}:`,e)}for(const t of n)try{const n=l.getDeviceById(t);if(!n){this.console.warn(`Notifier not found: ${t}`);continue}await n.sendNotification(this.getNotificationTitle(e),{body:e.message,data:{type:e.type,severity:e.severity,trackedObjectId:e.trackedObjectId,timestamp:e.timestamp}},r),this.console.log(`Notification sent to ${t}${r?" with thumbnail":""}`)}catch(e){this.console.error(`Failed to send notification to ${t}:`,e)}}getNotificationTitle(e){const t="critical"===e.severity?"🚨 ":"warning"===e.severity?"⚠️ ":"",n=e.details.objectClass?e.details.objectClass.charAt(0).toUpperCase()+e.details.objectClass.slice(1):"Object";switch(e.type){case"property_entry":return`${t}${n} Arrived`;case"property_exit":return`${t}${n} Left`;case"movement":return`${t}${n} → ${e.details.toCameraName||"area"}`;case"unusual_path":return`${t}Unusual Route`;case"dwell_time":return`${t}${n} Lingering`;case"restricted_zone":return`${t}Restricted Zone!`;case"lost_tracking":return`${t}${n} Lost`;case"reappearance":return`${t}${n} Reappeared`;default:return`${t}Spatial Alert`}}getDefaultNotifiers(){try{const e=this.storage.getItem("defaultNotifiers");if(e)try{const t=JSON.parse(e);if(Array.isArray(t))return t}catch{return e.includes(",")?e.split(",").map(e=>e.trim()).filter(Boolean):[e]}const t=this.storage.getItem("defaultNotifier");return t?[t]:[]}catch{return[]}}evaluateConditions(e,t){for(const n of e){const e=this.getFieldValue(n.field,t);switch(n.operator){case"equals":if(e!==n.value)return!1;break;case"not_equals":if(e===n.value)return!1;break;case"contains":if(!String(e).includes(String(n.value)))return!1;break;case"greater_than":if(Number(e)<=Number(n.value))return!1;break;case"less_than":if(Number(e)>=Number(n.value))return!1}}return!0}getFieldValue(e,t){const n=e.split(".");let r=t;for(const e of n){if(null==r)return;r=r[e]}return r}getRecentAlerts(e=50){return this.recentAlerts.slice(0,e)}acknowledgeAlert(e){const t=this.recentAlerts.find(t=>t.id===e);return!!t&&(t.acknowledged=!0,!0)}getAlertsForObject(e){return this.recentAlerts.filter(t=>t.trackedObjectId===e)}setRules(e){this.rules=e,this.saveRules()}getRules(){return this.rules}upsertRule(e){const t=this.rules.findIndex(t=>t.id===e.id);t>=0?this.rules[t]=e:this.rules.push(e),this.saveRules()}deleteRule(e){const t=this.rules.findIndex(t=>t.id===e);return t>=0&&(this.rules.splice(t,1),this.saveRules(),!0)}setRuleEnabled(e,t){const n=this.rules.find(t=>t.id===e);return!!n&&(n.enabled=t,this.saveRules(),!0)}loadRules(){try{const e=this.storage.getItem("alertRules");this.rules=e?JSON.parse(e):(0,c.createDefaultRules)()}catch(e){this.console.error("Failed to load alert rules:",e),this.rules=(0,c.createDefaultRules)()}}saveRules(){try{this.storage.setItem("alertRules",JSON.stringify(this.rules))}catch(e){this.console.error("Failed to save alert rules:",e)}}clearCooldowns(){this.cooldowns.clear()}clearHistory(){this.recentAlerts=[]}}},4422(e){e.exports=global.process},4434(e){"use strict";e.exports=require("events")},4478(e,t,n){"use strict";const r=n(2203);if(r&&"disable"===process.env.READABLE_STREAM){const t=r.promises;e.exports._uint8ArrayToBuffer=r._uint8ArrayToBuffer,e.exports._isUint8Array=r._isUint8Array,e.exports.isDisturbed=r.isDisturbed,e.exports.isErrored=r.isErrored,e.exports.isReadable=r.isReadable,e.exports.Readable=r.Readable,e.exports.Writable=r.Writable,e.exports.Duplex=r.Duplex,e.exports.Transform=r.Transform,e.exports.PassThrough=r.PassThrough,e.exports.addAbortSignal=r.addAbortSignal,e.exports.finished=r.finished,e.exports.destroy=r.destroy,e.exports.pipeline=r.pipeline,e.exports.compose=r.compose,Object.defineProperty(r,"promises",{configurable:!0,enumerable:!0,get:()=>t}),e.exports.Stream=r.Stream}else{const t=n(5506),r=n(3095),i=t.Readable.destroy;e.exports=t.Readable,e.exports._uint8ArrayToBuffer=t._uint8ArrayToBuffer,e.exports._isUint8Array=t._isUint8Array,e.exports.isDisturbed=t.isDisturbed,e.exports.isErrored=t.isErrored,e.exports.isReadable=t.isReadable,e.exports.Readable=t.Readable,e.exports.Writable=t.Writable,e.exports.Duplex=t.Duplex,e.exports.Transform=t.Transform,e.exports.PassThrough=t.PassThrough,e.exports.addAbortSignal=t.addAbortSignal,e.exports.finished=t.finished,e.exports.destroy=t.destroy,e.exports.destroy=i,e.exports.pipeline=t.pipeline,e.exports.compose=t.compose,Object.defineProperty(t,"promises",{configurable:!0,enumerable:!0,get:()=>r}),e.exports.Stream=t.Stream}e.exports.default=e.exports},4723(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.MQTTJS_VERSION=t.nextTick=t.ErrorWithSubackPacket=t.ErrorWithReasonCode=void 0,t.applyMixin=function(e,t,n=!1){const r=[t];for(;;){const e=r[0],t=Object.getPrototypeOf(e);if(!t?.prototype)break;r.unshift(t)}for(const t of r)for(const r of Object.getOwnPropertyNames(t.prototype))(n||"constructor"!==r)&&Object.defineProperty(e.prototype,r,Object.getOwnPropertyDescriptor(t.prototype,r)??Object.create(null))};class r extends Error{code;constructor(e,t){super(e),this.code=t,Object.setPrototypeOf(this,r.prototype),Object.getPrototypeOf(this).name="ErrorWithReasonCode"}}t.ErrorWithReasonCode=r;class i extends Error{packet;constructor(e,t){super(e),this.packet=t,Object.setPrototypeOf(this,i.prototype),Object.getPrototypeOf(this).name="ErrorWithSubackPacket"}}t.ErrorWithSubackPacket=i,t.nextTick="function"==typeof process?.nextTick?process.nextTick:e=>{setTimeout(e,0)},t.MQTTJS_VERSION=n(2860).version},4756(e){"use strict";e.exports=require("tls")},4759(e){"use strict";const t=Symbol("kDone"),n=Symbol("kRun");e.exports=class{constructor(e){this[t]=()=>{this.pending--,this[n]()},this.concurrency=e||1/0,this.jobs=[],this.pending=0}add(e){this.jobs.push(e),this[n]()}[n](){if(this.pending!==this.concurrency&&this.jobs.length){const e=this.jobs.shift();this.pending++,e(this[t])}}}},4829(e,t,n){"use strict";const r=n(4478).Duplex,i=n(2017),s=n(7813);function o(e){if(!(this instanceof o))return new o(e);if("function"==typeof e){this._callback=e;const t=function(e){this._callback&&(this._callback(e),this._callback=null)}.bind(this);this.on("pipe",function(e){e.on("error",t)}),this.on("unpipe",function(e){e.removeListener("error",t)}),e=null}s._init.call(this,e),r.call(this)}i(o,r),Object.assign(o.prototype,s.prototype),o.prototype._new=function(e){return new o(e)},o.prototype._write=function(e,t,n){this._appendBuffer(e),"function"==typeof n&&n()},o.prototype._read=function(e){if(!this.length)return this.push(null);e=Math.min(e,this.length),this.push(this.slice(0,e)),this.consume(e)},o.prototype.end=function(e){r.prototype.end.call(this,e),this._callback&&(this._callback(null,this.slice()),this._callback=null)},o.prototype._destroy=function(e,t){this._bufs.length=0,this.length=0,t(e)},o.prototype._isBufferList=function(e){return e instanceof o||e instanceof s||o.isBufferList(e)},o.isBufferList=s.isBufferList,e.exports=o,e.exports.BufferListStream=o,e.exports.BufferList=s},4959(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=[0,16,128,131,135,144,145,151,153];t.default=(e,t,r)=>{e.log("handlePublish: packet %o",t),r="undefined"!=typeof r?r:e.noop;let i=t.topic.toString();const s=t.payload,{qos:o}=t,{messageId:a}=t,{options:c}=e;if(5===e.options.protocolVersion){let n;if(t.properties&&(n=t.properties.topicAlias),"undefined"!=typeof n)if(0===i.length){if(!(n>0&&n<=65535))return e.log("handlePublish :: topic alias out of range. alias: %d",n),void e.emit("error",new Error("Received Topic Alias is out of range"));{const t=e.topicAliasRecv.getTopicByAlias(n);if(!t)return e.log("handlePublish :: unregistered topic alias. alias: %d",n),void e.emit("error",new Error("Received unregistered Topic Alias"));i=t,e.log("handlePublish :: topic complemented by alias. topic: %s - alias: %d",i,n)}}else{if(!e.topicAliasRecv.put(i,n))return e.log("handlePublish :: topic alias out of range. alias: %d",n),void e.emit("error",new Error("Received Topic Alias is out of range"));e.log("handlePublish :: registered topic: %s - alias: %d",i,n)}}switch(e.log("handlePublish: qos %d",o),o){case 2:c.customHandleAcks(i,s,t,(i,s)=>("number"==typeof i&&(s=i,i=null),i?e.emit("error",i):-1===n.indexOf(s)?e.emit("error",new Error("Wrong reason code for pubrec")):void(s?e._sendPacket({cmd:"pubrec",messageId:a,reasonCode:s},r):e.incomingStore.put(t,()=>{e._sendPacket({cmd:"pubrec",messageId:a},r)}))));break;case 1:c.customHandleAcks(i,s,t,(o,c)=>("number"==typeof o&&(c=o,o=null),o?e.emit("error",o):-1===n.indexOf(c)?e.emit("error",new Error("Wrong reason code for puback")):(c||e.emit("message",i,s,t),void e.handleMessage(t,t=>{if(t)return r&&r(t);e._sendPacket({cmd:"puback",messageId:a,reasonCode:c},r)}))));break;case 0:e.emit("message",i,s,t),e.handleMessage(t,r);break;default:e.log("handlePublish: unknown QoS. Doing nothing.")}}},4966(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.LRUCache=void 0;const n="object"==typeof performance&&performance&&"function"==typeof performance.now?performance:Date,r=new Set,i="object"==typeof process&&process?process:{},s=(e,t,n,r)=>{"function"==typeof i.emitWarning?i.emitWarning(e,t,n,r):console.error(`[${n}] ${t}: ${e}`)};let o=globalThis.AbortController,a=globalThis.AbortSignal;if("undefined"==typeof o){a=class{onabort;_onabort=[];reason;aborted=!1;addEventListener(e,t){this._onabort.push(t)}},o=class{constructor(){t()}signal=new a;abort(e){if(!this.signal.aborted){this.signal.reason=e,this.signal.aborted=!0;for(const t of this.signal._onabort)t(e);this.signal.onabort?.(e)}}};let e="1"!==i.env?.LRU_CACHE_IGNORE_AC_WARNING;const t=()=>{e&&(e=!1,s("AbortController is not defined. If using lru-cache in node 14, load an AbortController polyfill from the `node-abort-controller` package. A minimal polyfill is provided for use by LRUCache.fetch(), but it should not be relied upon in other contexts (eg, passing it to other APIs that use AbortController/AbortSignal might have undesirable effects). You may disable this with LRU_CACHE_IGNORE_AC_WARNING=1 in the env.","NO_ABORT_CONTROLLER","ENOTSUP",t))}}Symbol("type");const c=e=>e&&e===Math.floor(e)&&e>0&&isFinite(e),l=e=>c(e)?e<=Math.pow(2,8)?Uint8Array:e<=Math.pow(2,16)?Uint16Array:e<=Math.pow(2,32)?Uint32Array:e<=Number.MAX_SAFE_INTEGER?d:null:null;class d extends Array{constructor(e){super(e),this.fill(0)}}class u{heap;length;static#e=!1;static create(e){const t=l(e);if(!t)return[];u.#e=!0;const n=new u(e,t);return u.#e=!1,n}constructor(e,t){if(!u.#e)throw new TypeError("instantiate Stack using Stack.create(n)");this.heap=new t(e),this.length=0}push(e){this.heap[this.length++]=e}pop(){return this.heap[--this.length]}}class h{#t;#n;#r;#i;#s;#o;ttl;ttlResolution;ttlAutopurge;updateAgeOnGet;updateAgeOnHas;allowStale;noDisposeOnSet;noUpdateTTL;maxEntrySize;sizeCalculation;noDeleteOnFetchRejection;noDeleteOnStaleGet;allowStaleOnFetchAbort;allowStaleOnFetchRejection;ignoreFetchAbort;#a;#c;#l;#d;#u;#h;#p;#f;#g;#m;#y;#b;#v;#S;#_;#w;#k;static unsafeExposeInternals(e){return{starts:e.#v,ttls:e.#S,sizes:e.#b,keyMap:e.#l,keyList:e.#d,valList:e.#u,next:e.#h,prev:e.#p,get head(){return e.#f},get tail(){return e.#g},free:e.#m,isBackgroundFetch:t=>e.#I(t),backgroundFetch:(t,n,r,i)=>e.#E(t,n,r,i),moveToTail:t=>e.#x(t),indexes:t=>e.#T(t),rindexes:t=>e.#C(t),isStale:t=>e.#O(t)}}get max(){return this.#t}get maxSize(){return this.#n}get calculatedSize(){return this.#c}get size(){return this.#a}get fetchMethod(){return this.#s}get memoMethod(){return this.#o}get dispose(){return this.#r}get disposeAfter(){return this.#i}constructor(e){const{max:t=0,ttl:n,ttlResolution:i=1,ttlAutopurge:o,updateAgeOnGet:a,updateAgeOnHas:d,allowStale:p,dispose:f,disposeAfter:g,noDisposeOnSet:m,noUpdateTTL:y,maxSize:b=0,maxEntrySize:v=0,sizeCalculation:S,fetchMethod:_,memoMethod:w,noDeleteOnFetchRejection:k,noDeleteOnStaleGet:I,allowStaleOnFetchRejection:E,allowStaleOnFetchAbort:x,ignoreFetchAbort:T}=e;if(0!==t&&!c(t))throw new TypeError("max option must be a nonnegative integer");const C=t?l(t):Array;if(!C)throw new Error("invalid max value: "+t);if(this.#t=t,this.#n=b,this.maxEntrySize=v||this.#n,this.sizeCalculation=S,this.sizeCalculation){if(!this.#n&&!this.maxEntrySize)throw new TypeError("cannot set sizeCalculation without setting maxSize or maxEntrySize");if("function"!=typeof this.sizeCalculation)throw new TypeError("sizeCalculation set to non-function")}if(void 0!==w&&"function"!=typeof w)throw new TypeError("memoMethod must be a function if defined");if(this.#o=w,void 0!==_&&"function"!=typeof _)throw new TypeError("fetchMethod must be a function if specified");if(this.#s=_,this.#w=!!_,this.#l=new Map,this.#d=new Array(t).fill(void 0),this.#u=new Array(t).fill(void 0),this.#h=new C(t),this.#p=new C(t),this.#f=0,this.#g=0,this.#m=u.create(t),this.#a=0,this.#c=0,"function"==typeof f&&(this.#r=f),"function"==typeof g?(this.#i=g,this.#y=[]):(this.#i=void 0,this.#y=void 0),this.#_=!!this.#r,this.#k=!!this.#i,this.noDisposeOnSet=!!m,this.noUpdateTTL=!!y,this.noDeleteOnFetchRejection=!!k,this.allowStaleOnFetchRejection=!!E,this.allowStaleOnFetchAbort=!!x,this.ignoreFetchAbort=!!T,0!==this.maxEntrySize){if(0!==this.#n&&!c(this.#n))throw new TypeError("maxSize must be a positive integer if specified");if(!c(this.maxEntrySize))throw new TypeError("maxEntrySize must be a positive integer if specified");this.#A()}if(this.allowStale=!!p,this.noDeleteOnStaleGet=!!I,this.updateAgeOnGet=!!a,this.updateAgeOnHas=!!d,this.ttlResolution=c(i)||0===i?i:1,this.ttlAutopurge=!!o,this.ttl=n||0,this.ttl){if(!c(this.ttl))throw new TypeError("ttl must be a positive integer if specified");this.#P()}if(0===this.#t&&0===this.ttl&&0===this.#n)throw new TypeError("At least one of max, maxSize, or ttl is required");if(!this.ttlAutopurge&&!this.#t&&!this.#n){const e="LRU_CACHE_UNBOUNDED";if((e=>!r.has(e))(e)){r.add(e);s("TTL caching without ttlAutopurge, max, or maxSize can result in unbounded memory consumption.","UnboundedCacheWarning",e,h)}}}getRemainingTTL(e){return this.#l.has(e)?1/0:0}#P(){const e=new d(this.#t),t=new d(this.#t);this.#S=e,this.#v=t,this.#R=(r,i,s=n.now())=>{if(t[r]=0!==i?s:0,e[r]=i,0!==i&&this.ttlAutopurge){const e=setTimeout(()=>{this.#O(r)&&this.#M(this.#d[r],"expire")},i+1);e.unref&&e.unref()}},this.#N=r=>{t[r]=0!==e[r]?n.now():0},this.#B=(n,s)=>{if(e[s]){const o=e[s],a=t[s];if(!o||!a)return;n.ttl=o,n.start=a,n.now=r||i();const c=n.now-a;n.remainingTTL=o-c}};let r=0;const i=()=>{const e=n.now();if(this.ttlResolution>0){r=e;const t=setTimeout(()=>r=0,this.ttlResolution);t.unref&&t.unref()}return e};this.getRemainingTTL=n=>{const s=this.#l.get(n);if(void 0===s)return 0;const o=e[s],a=t[s];if(!o||!a)return 1/0;return o-((r||i())-a)},this.#O=n=>{const s=t[n],o=e[n];return!!o&&!!s&&(r||i())-s>o}}#N=()=>{};#B=()=>{};#R=()=>{};#O=()=>!1;#A(){const e=new d(this.#t);this.#c=0,this.#b=e,this.#L=t=>{this.#c-=e[t],e[t]=0},this.#j=(e,t,n,r)=>{if(this.#I(t))return 0;if(!c(n)){if(!r)throw new TypeError("invalid size value (must be positive integer). When maxSize or maxEntrySize is used, sizeCalculation or size must be set.");if("function"!=typeof r)throw new TypeError("sizeCalculation must be a function");if(n=r(t,e),!c(n))throw new TypeError("sizeCalculation return invalid (expect positive integer)")}return n},this.#D=(t,n,r)=>{if(e[t]=n,this.#n){const n=this.#n-e[t];for(;this.#c>n;)this.#U(!0)}this.#c+=e[t],r&&(r.entrySize=n,r.totalCalculatedSize=this.#c)}}#L=e=>{};#D=(e,t,n)=>{};#j=(e,t,n,r)=>{if(n||r)throw new TypeError("cannot set size without setting maxSize or maxEntrySize on cache");return 0};*#T({allowStale:e=this.allowStale}={}){if(this.#a)for(let t=this.#g;this.#F(t)&&(!e&&this.#O(t)||(yield t),t!==this.#f);)t=this.#p[t]}*#C({allowStale:e=this.allowStale}={}){if(this.#a)for(let t=this.#f;this.#F(t)&&(!e&&this.#O(t)||(yield t),t!==this.#g);)t=this.#h[t]}#F(e){return void 0!==e&&this.#l.get(this.#d[e])===e}*entries(){for(const e of this.#T())void 0===this.#u[e]||void 0===this.#d[e]||this.#I(this.#u[e])||(yield[this.#d[e],this.#u[e]])}*rentries(){for(const e of this.#C())void 0===this.#u[e]||void 0===this.#d[e]||this.#I(this.#u[e])||(yield[this.#d[e],this.#u[e]])}*keys(){for(const e of this.#T()){const t=this.#d[e];void 0===t||this.#I(this.#u[e])||(yield t)}}*rkeys(){for(const e of this.#C()){const t=this.#d[e];void 0===t||this.#I(this.#u[e])||(yield t)}}*values(){for(const e of this.#T()){void 0===this.#u[e]||this.#I(this.#u[e])||(yield this.#u[e])}}*rvalues(){for(const e of this.#C()){void 0===this.#u[e]||this.#I(this.#u[e])||(yield this.#u[e])}}[Symbol.iterator](){return this.entries()}[Symbol.toStringTag]="LRUCache";find(e,t={}){for(const n of this.#T()){const r=this.#u[n],i=this.#I(r)?r.__staleWhileFetching:r;if(void 0!==i&&e(i,this.#d[n],this))return this.get(this.#d[n],t)}}forEach(e,t=this){for(const n of this.#T()){const r=this.#u[n],i=this.#I(r)?r.__staleWhileFetching:r;void 0!==i&&e.call(t,i,this.#d[n],this)}}rforEach(e,t=this){for(const n of this.#C()){const r=this.#u[n],i=this.#I(r)?r.__staleWhileFetching:r;void 0!==i&&e.call(t,i,this.#d[n],this)}}purgeStale(){let e=!1;for(const t of this.#C({allowStale:!0}))this.#O(t)&&(this.#M(this.#d[t],"expire"),e=!0);return e}info(e){const t=this.#l.get(e);if(void 0===t)return;const r=this.#u[t],i=this.#I(r)?r.__staleWhileFetching:r;if(void 0===i)return;const s={value:i};if(this.#S&&this.#v){const e=this.#S[t],r=this.#v[t];if(e&&r){const t=e-(n.now()-r);s.ttl=t,s.start=Date.now()}}return this.#b&&(s.size=this.#b[t]),s}dump(){const e=[];for(const t of this.#T({allowStale:!0})){const r=this.#d[t],i=this.#u[t],s=this.#I(i)?i.__staleWhileFetching:i;if(void 0===s||void 0===r)continue;const o={value:s};if(this.#S&&this.#v){o.ttl=this.#S[t];const e=n.now()-this.#v[t];o.start=Math.floor(Date.now()-e)}this.#b&&(o.size=this.#b[t]),e.unshift([r,o])}return e}load(e){this.clear();for(const[t,r]of e){if(r.start){const e=Date.now()-r.start;r.start=n.now()-e}this.set(t,r.value,r)}}set(e,t,n={}){if(void 0===t)return this.delete(e),this;const{ttl:r=this.ttl,start:i,noDisposeOnSet:s=this.noDisposeOnSet,sizeCalculation:o=this.sizeCalculation,status:a}=n;let{noUpdateTTL:c=this.noUpdateTTL}=n;const l=this.#j(e,t,n.size||0,o);if(this.maxEntrySize&&l>this.maxEntrySize)return a&&(a.set="miss",a.maxEntrySizeExceeded=!0),this.#M(e,"set"),this;let d=0===this.#a?void 0:this.#l.get(e);if(void 0===d)d=0===this.#a?this.#g:0!==this.#m.length?this.#m.pop():this.#a===this.#t?this.#U(!1):this.#a,this.#d[d]=e,this.#u[d]=t,this.#l.set(e,d),this.#h[this.#g]=d,this.#p[d]=this.#g,this.#g=d,this.#a++,this.#D(d,l,a),a&&(a.set="add"),c=!1;else{this.#x(d);const n=this.#u[d];if(t!==n){if(this.#w&&this.#I(n)){n.__abortController.abort(new Error("replaced"));const{__staleWhileFetching:t}=n;void 0===t||s||(this.#_&&this.#r?.(t,e,"set"),this.#k&&this.#y?.push([t,e,"set"]))}else s||(this.#_&&this.#r?.(n,e,"set"),this.#k&&this.#y?.push([n,e,"set"]));if(this.#L(d),this.#D(d,l,a),this.#u[d]=t,a){a.set="replace";const e=n&&this.#I(n)?n.__staleWhileFetching:n;void 0!==e&&(a.oldValue=e)}}else a&&(a.set="update")}if(0===r||this.#S||this.#P(),this.#S&&(c||this.#R(d,r,i),a&&this.#B(a,d)),!s&&this.#k&&this.#y){const e=this.#y;let t;for(;t=e?.shift();)this.#i?.(...t)}return this}pop(){try{for(;this.#a;){const e=this.#u[this.#f];if(this.#U(!0),this.#I(e)){if(e.__staleWhileFetching)return e.__staleWhileFetching}else if(void 0!==e)return e}}finally{if(this.#k&&this.#y){const e=this.#y;let t;for(;t=e?.shift();)this.#i?.(...t)}}}#U(e){const t=this.#f,n=this.#d[t],r=this.#u[t];return this.#w&&this.#I(r)?r.__abortController.abort(new Error("evicted")):(this.#_||this.#k)&&(this.#_&&this.#r?.(r,n,"evict"),this.#k&&this.#y?.push([r,n,"evict"])),this.#L(t),e&&(this.#d[t]=void 0,this.#u[t]=void 0,this.#m.push(t)),1===this.#a?(this.#f=this.#g=0,this.#m.length=0):this.#f=this.#h[t],this.#l.delete(n),this.#a--,t}has(e,t={}){const{updateAgeOnHas:n=this.updateAgeOnHas,status:r}=t,i=this.#l.get(e);if(void 0!==i){const e=this.#u[i];if(this.#I(e)&&void 0===e.__staleWhileFetching)return!1;if(!this.#O(i))return n&&this.#N(i),r&&(r.has="hit",this.#B(r,i)),!0;r&&(r.has="stale",this.#B(r,i))}else r&&(r.has="miss");return!1}peek(e,t={}){const{allowStale:n=this.allowStale}=t,r=this.#l.get(e);if(void 0===r||!n&&this.#O(r))return;const i=this.#u[r];return this.#I(i)?i.__staleWhileFetching:i}#E(e,t,n,r){const i=void 0===t?void 0:this.#u[t];if(this.#I(i))return i;const s=new o,{signal:a}=n;a?.addEventListener("abort",()=>s.abort(a.reason),{signal:s.signal});const c={signal:s.signal,options:n,context:r},l=(r,i=!1)=>{const{aborted:o}=s.signal,a=n.ignoreFetchAbort&&void 0!==r;if(n.status&&(o&&!i?(n.status.fetchAborted=!0,n.status.fetchError=s.signal.reason,a&&(n.status.fetchAbortIgnored=!0)):n.status.fetchResolved=!0),o&&!a&&!i)return d(s.signal.reason);const l=u;return this.#u[t]===u&&(void 0===r?l.__staleWhileFetching?this.#u[t]=l.__staleWhileFetching:this.#M(e,"fetch"):(n.status&&(n.status.fetchUpdated=!0),this.set(e,r,c.options))),r},d=r=>{const{aborted:i}=s.signal,o=i&&n.allowStaleOnFetchAbort,a=o||n.allowStaleOnFetchRejection,c=a||n.noDeleteOnFetchRejection,l=u;if(this.#u[t]===u){!c||void 0===l.__staleWhileFetching?this.#M(e,"fetch"):o||(this.#u[t]=l.__staleWhileFetching)}if(a)return n.status&&void 0!==l.__staleWhileFetching&&(n.status.returnedStale=!0),l.__staleWhileFetching;if(l.__returned===l)throw r};n.status&&(n.status.fetchDispatched=!0);const u=new Promise((t,r)=>{const o=this.#s?.(e,i,c);o&&o instanceof Promise&&o.then(e=>t(void 0===e?void 0:e),r),s.signal.addEventListener("abort",()=>{n.ignoreFetchAbort&&!n.allowStaleOnFetchAbort||(t(void 0),n.allowStaleOnFetchAbort&&(t=e=>l(e,!0)))})}).then(l,e=>(n.status&&(n.status.fetchRejected=!0,n.status.fetchError=e),d(e))),h=Object.assign(u,{__abortController:s,__staleWhileFetching:i,__returned:void 0});return void 0===t?(this.set(e,h,{...c.options,status:void 0}),t=this.#l.get(e)):this.#u[t]=h,h}#I(e){if(!this.#w)return!1;const t=e;return!!t&&t instanceof Promise&&t.hasOwnProperty("__staleWhileFetching")&&t.__abortController instanceof o}async fetch(e,t={}){const{allowStale:n=this.allowStale,updateAgeOnGet:r=this.updateAgeOnGet,noDeleteOnStaleGet:i=this.noDeleteOnStaleGet,ttl:s=this.ttl,noDisposeOnSet:o=this.noDisposeOnSet,size:a=0,sizeCalculation:c=this.sizeCalculation,noUpdateTTL:l=this.noUpdateTTL,noDeleteOnFetchRejection:d=this.noDeleteOnFetchRejection,allowStaleOnFetchRejection:u=this.allowStaleOnFetchRejection,ignoreFetchAbort:h=this.ignoreFetchAbort,allowStaleOnFetchAbort:p=this.allowStaleOnFetchAbort,context:f,forceRefresh:g=!1,status:m,signal:y}=t;if(!this.#w)return m&&(m.fetch="get"),this.get(e,{allowStale:n,updateAgeOnGet:r,noDeleteOnStaleGet:i,status:m});const b={allowStale:n,updateAgeOnGet:r,noDeleteOnStaleGet:i,ttl:s,noDisposeOnSet:o,size:a,sizeCalculation:c,noUpdateTTL:l,noDeleteOnFetchRejection:d,allowStaleOnFetchRejection:u,allowStaleOnFetchAbort:p,ignoreFetchAbort:h,status:m,signal:y};let v=this.#l.get(e);if(void 0===v){m&&(m.fetch="miss");const t=this.#E(e,v,b,f);return t.__returned=t}{const t=this.#u[v];if(this.#I(t)){const e=n&&void 0!==t.__staleWhileFetching;return m&&(m.fetch="inflight",e&&(m.returnedStale=!0)),e?t.__staleWhileFetching:t.__returned=t}const i=this.#O(v);if(!g&&!i)return m&&(m.fetch="hit"),this.#x(v),r&&this.#N(v),m&&this.#B(m,v),t;const s=this.#E(e,v,b,f),o=void 0!==s.__staleWhileFetching&&n;return m&&(m.fetch=i?"stale":"refresh",o&&i&&(m.returnedStale=!0)),o?s.__staleWhileFetching:s.__returned=s}}async forceFetch(e,t={}){const n=await this.fetch(e,t);if(void 0===n)throw new Error("fetch() returned undefined");return n}memo(e,t={}){const n=this.#o;if(!n)throw new Error("no memoMethod provided to constructor");const{context:r,forceRefresh:i,...s}=t,o=this.get(e,s);if(!i&&void 0!==o)return o;const a=n(e,o,{options:s,context:r});return this.set(e,a,s),a}get(e,t={}){const{allowStale:n=this.allowStale,updateAgeOnGet:r=this.updateAgeOnGet,noDeleteOnStaleGet:i=this.noDeleteOnStaleGet,status:s}=t,o=this.#l.get(e);if(void 0!==o){const t=this.#u[o],a=this.#I(t);return s&&this.#B(s,o),this.#O(o)?(s&&(s.get="stale"),a?(s&&n&&void 0!==t.__staleWhileFetching&&(s.returnedStale=!0),n?t.__staleWhileFetching:void 0):(i||this.#M(e,"expire"),s&&n&&(s.returnedStale=!0),n?t:void 0)):(s&&(s.get="hit"),a?t.__staleWhileFetching:(this.#x(o),r&&this.#N(o),t))}s&&(s.get="miss")}#$(e,t){this.#p[t]=e,this.#h[e]=t}#x(e){e!==this.#g&&(e===this.#f?this.#f=this.#h[e]:this.#$(this.#p[e],this.#h[e]),this.#$(this.#g,e),this.#g=e)}delete(e){return this.#M(e,"delete")}#M(e,t){let n=!1;if(0!==this.#a){const r=this.#l.get(e);if(void 0!==r)if(n=!0,1===this.#a)this.#W(t);else{this.#L(r);const n=this.#u[r];if(this.#I(n)?n.__abortController.abort(new Error("deleted")):(this.#_||this.#k)&&(this.#_&&this.#r?.(n,e,t),this.#k&&this.#y?.push([n,e,t])),this.#l.delete(e),this.#d[r]=void 0,this.#u[r]=void 0,r===this.#g)this.#g=this.#p[r];else if(r===this.#f)this.#f=this.#h[r];else{const e=this.#p[r];this.#h[e]=this.#h[r];const t=this.#h[r];this.#p[t]=this.#p[r]}this.#a--,this.#m.push(r)}}if(this.#k&&this.#y?.length){const e=this.#y;let t;for(;t=e?.shift();)this.#i?.(...t)}return n}clear(){return this.#W("delete")}#W(e){for(const t of this.#C({allowStale:!0})){const n=this.#u[t];if(this.#I(n))n.__abortController.abort(new Error("deleted"));else{const r=this.#d[t];this.#_&&this.#r?.(n,r,e),this.#k&&this.#y?.push([n,r,e])}}if(this.#l.clear(),this.#u.fill(void 0),this.#d.fill(void 0),this.#S&&this.#v&&(this.#S.fill(0),this.#v.fill(0)),this.#b&&this.#b.fill(0),this.#f=0,this.#g=0,this.#m.length=0,this.#c=0,this.#a=0,this.#k&&this.#y){const e=this.#y;let t;for(;t=e?.shift();)this.#i?.(...t)}}}t.LRUCache=h},4988(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=new WeakMap,r=new WeakMap;function i(e){const t=n.get(e);return console.assert(null!=t,"'this' is expected an Event object, but got",e),t}function s(e){null==e.passiveListener?e.event.cancelable&&(e.canceled=!0,"function"==typeof e.event.preventDefault&&e.event.preventDefault()):"undefined"!=typeof console&&"function"==typeof console.error&&console.error("Unable to preventDefault inside passive event listener invocation.",e.passiveListener)}function o(e,t){n.set(this,{eventTarget:e,event:t,eventPhase:2,currentTarget:e,canceled:!1,stopped:!1,immediateStopped:!1,passiveListener:null,timeStamp:t.timeStamp||Date.now()}),Object.defineProperty(this,"isTrusted",{value:!1,enumerable:!0});const r=Object.keys(t);for(let e=0;e<r.length;++e){const t=r[e];t in this||Object.defineProperty(this,t,a(t))}}function a(e){return{get(){return i(this).event[e]},set(t){i(this).event[e]=t},configurable:!0,enumerable:!0}}function c(e){return{value(){const t=i(this).event;return t[e].apply(t,arguments)},configurable:!0,enumerable:!0}}function l(e){if(null==e||e===Object.prototype)return o;let t=r.get(e);return null==t&&(t=function(e,t){const n=Object.keys(t);if(0===n.length)return e;function r(t,n){e.call(this,t,n)}r.prototype=Object.create(e.prototype,{constructor:{value:r,configurable:!0,writable:!0}});for(let i=0;i<n.length;++i){const s=n[i];if(!(s in e.prototype)){const e="function"==typeof Object.getOwnPropertyDescriptor(t,s).value;Object.defineProperty(r.prototype,s,e?c(s):a(s))}}return r}(l(Object.getPrototypeOf(e)),e),r.set(e,t)),t}function d(e){return i(e).immediateStopped}function u(e,t){i(e).passiveListener=t}o.prototype={get type(){return i(this).event.type},get target(){return i(this).eventTarget},get currentTarget(){return i(this).currentTarget},composedPath(){const e=i(this).currentTarget;return null==e?[]:[e]},get NONE(){return 0},get CAPTURING_PHASE(){return 1},get AT_TARGET(){return 2},get BUBBLING_PHASE(){return 3},get eventPhase(){return i(this).eventPhase},stopPropagation(){const e=i(this);e.stopped=!0,"function"==typeof e.event.stopPropagation&&e.event.stopPropagation()},stopImmediatePropagation(){const e=i(this);e.stopped=!0,e.immediateStopped=!0,"function"==typeof e.event.stopImmediatePropagation&&e.event.stopImmediatePropagation()},get bubbles(){return Boolean(i(this).event.bubbles)},get cancelable(){return Boolean(i(this).event.cancelable)},preventDefault(){s(i(this))},get defaultPrevented(){return i(this).canceled},get composed(){return Boolean(i(this).event.composed)},get timeStamp(){return i(this).timeStamp},get srcElement(){return i(this).eventTarget},get cancelBubble(){return i(this).stopped},set cancelBubble(e){if(!e)return;const t=i(this);t.stopped=!0,"boolean"==typeof t.event.cancelBubble&&(t.event.cancelBubble=!0)},get returnValue(){return!i(this).canceled},set returnValue(e){e||s(i(this))},initEvent(){}},Object.defineProperty(o.prototype,"constructor",{value:o,configurable:!0,writable:!0}),"undefined"!=typeof window&&"undefined"!=typeof window.Event&&(Object.setPrototypeOf(o.prototype,window.Event.prototype),r.set(window.Event.prototype,o));const h=new WeakMap;function p(e){return null!==e&&"object"==typeof e}function f(e){const t=h.get(e);if(null==t)throw new TypeError("'this' is expected an EventTarget object, but got another value.");return t}function g(e,t){Object.defineProperty(e,`on${t}`,function(e){return{get(){let t=f(this).get(e);for(;null!=t;){if(3===t.listenerType)return t.listener;t=t.next}return null},set(t){"function"==typeof t||p(t)||(t=null);const n=f(this);let r=null,i=n.get(e);for(;null!=i;)3===i.listenerType?null!==r?r.next=i.next:null!==i.next?n.set(e,i.next):n.delete(e):r=i,i=i.next;if(null!==t){const i={listener:t,listenerType:3,passive:!1,once:!1,next:null};null===r?n.set(e,i):r.next=i}},configurable:!0,enumerable:!0}}(t))}function m(e){function t(){y.call(this)}t.prototype=Object.create(y.prototype,{constructor:{value:t,configurable:!0,writable:!0}});for(let n=0;n<e.length;++n)g(t.prototype,e[n]);return t}function y(){if(!(this instanceof y)){if(1===arguments.length&&Array.isArray(arguments[0]))return m(arguments[0]);if(arguments.length>0){const e=new Array(arguments.length);for(let t=0;t<arguments.length;++t)e[t]=arguments[t];return m(e)}throw new TypeError("Cannot call a class as a function")}h.set(this,new Map)}y.prototype={addEventListener(e,t,n){if(null==t)return;if("function"!=typeof t&&!p(t))throw new TypeError("'listener' should be a function or an object.");const r=f(this),i=p(n),s=(i?Boolean(n.capture):Boolean(n))?1:2,o={listener:t,listenerType:s,passive:i&&Boolean(n.passive),once:i&&Boolean(n.once),next:null};let a=r.get(e);if(void 0===a)return void r.set(e,o);let c=null;for(;null!=a;){if(a.listener===t&&a.listenerType===s)return;c=a,a=a.next}c.next=o},removeEventListener(e,t,n){if(null==t)return;const r=f(this),i=(p(n)?Boolean(n.capture):Boolean(n))?1:2;let s=null,o=r.get(e);for(;null!=o;){if(o.listener===t&&o.listenerType===i)return void(null!==s?s.next=o.next:null!==o.next?r.set(e,o.next):r.delete(e));s=o,o=o.next}},dispatchEvent(e){if(null==e||"string"!=typeof e.type)throw new TypeError('"event.type" should be a string.');const t=f(this),n=e.type;let r=t.get(n);if(null==r)return!0;const s=function(e,t){return new(l(Object.getPrototypeOf(t)))(e,t)}(this,e);let o=null;for(;null!=r;){if(r.once?null!==o?o.next=r.next:null!==r.next?t.set(n,r.next):t.delete(n):o=r,u(s,r.passive?r.listener:null),"function"==typeof r.listener)try{r.listener.call(this,s)}catch(e){"undefined"!=typeof console&&"function"==typeof console.error&&console.error(e)}else 3!==r.listenerType&&"function"==typeof r.listener.handleEvent&&r.listener.handleEvent(s);if(d(s))break;r=r.next}return u(s,null),function(e,t){i(e).eventPhase=t}(s,0),function(e,t){i(e).currentTarget=t}(s,null),!s.defaultPrevented}},Object.defineProperty(y.prototype,"constructor",{value:y,configurable:!0,writable:!0}),"undefined"!=typeof window&&"undefined"!=typeof window.EventTarget&&Object.setPrototypeOf(y.prototype,window.EventTarget.prototype),t.defineEventAttribute=g,t.EventTarget=y,t.default=y,e.exports=y,e.exports.EventTarget=e.exports.default=y,e.exports.defineEventAttribute=g},4997(e,t){"use strict";function n(e,t){const n=e=>e?e.charAt(0).toUpperCase()+e.slice(1):"Object",r=t.objectLabel?`${n(t.objectClass||"")} (${t.objectLabel})`:n(t.objectClass||"");switch(e){case"property_entry":return t.involvedLandmarks&&t.involvedLandmarks.length>0?`${r} entered property near ${t.involvedLandmarks[0]}`:`${r} entered property at ${t.cameraName||"entrance"}`;case"property_exit":return t.involvedLandmarks&&t.involvedLandmarks.length>0?`${r} left property via ${t.involvedLandmarks[0]}`:`${r} left property`;case"movement":if(t.objectLabel&&t.usedLlm){const e=t.transitTime?Math.round(t.transitTime/1e3):0,n=e>0?` (${e}s)`:"",r=t.pathDescription?` via ${t.pathDescription}`:"";return`${t.objectLabel}${r}${n}`}const n=t.transitTime?Math.round(t.transitTime/1e3):0,i=n>0?` (${n}s transit)`:"";let s=`${r} moving from ${t.fromCameraName||"unknown"} towards ${t.toCameraName||"unknown"}`;return t.involvedLandmarks&&t.involvedLandmarks.length>0&&(s+=` near ${t.involvedLandmarks.join(", ")}`),`${s}${i}`;case"unusual_path":return`${r} took unusual path: ${t.actualPath||"unknown"}`;case"dwell_time":return`${r} has been present for ${Math.round((t.dwellTime||0)/6e4)} minutes in ${t.zoneName||t.cameraName||"area"}`;case"restricted_zone":return`${r} entered restricted zone: ${t.zoneName}`;case"lost_tracking":return`Lost tracking of ${r} near ${t.cameraName||"unknown location"}`;case"reappearance":return`${r} reappeared on ${t.cameraName}`;case"zone_entry":return`${r} entered ${t.zoneName}`;case"zone_exit":return`${r} exited ${t.zoneName}`;default:return`Tracking event: ${e}`}}Object.defineProperty(t,"__esModule",{value:!0}),t.createDefaultRules=function(){return[{id:"property-entry",name:"Property Entry",enabled:!0,type:"property_entry",conditions:[],severity:"info",notifiers:[],cooldown:6e4},{id:"property-exit",name:"Property Exit",enabled:!0,type:"property_exit",conditions:[],severity:"info",notifiers:[],cooldown:6e4},{id:"movement",name:"Movement Between Cameras",enabled:!0,type:"movement",conditions:[],severity:"info",notifiers:[],cooldown:1e4},{id:"unusual-path",name:"Unusual Path Detected",enabled:!0,type:"unusual_path",conditions:[],severity:"warning",notifiers:[],cooldown:6e5},{id:"dwell-time",name:"Extended Dwell Time",enabled:!0,type:"dwell_time",conditions:[{field:"totalDwellTime",operator:"greater_than",value:3e5}],severity:"warning",notifiers:[],cooldown:6e5},{id:"restricted-zone",name:"Restricted Zone Entry",enabled:!0,type:"restricted_zone",conditions:[],severity:"critical",notifiers:[],cooldown:0},{id:"lost-tracking",name:"Lost Object Tracking",enabled:!1,type:"lost_tracking",conditions:[],severity:"info",notifiers:[],cooldown:3e5}]},t.generateAlertMessage=n,t.createAlert=function(e,t,r,i="info",s){return{id:`${Date.now()}-${Math.random().toString(36).slice(2,9)}`,type:e,severity:i,timestamp:Date.now(),trackedObjectId:t,message:n(e,r),details:r,acknowledged:!1,ruleId:s}}},5228(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const r=n(4723),i=n(1021);t.default=(e,t)=>{const{options:n}=e,s=n.protocolVersion,o=5===s?t.reasonCode:t.returnCode;if(5!==s){const t=new r.ErrorWithReasonCode(`Protocol error: Auth packets are only supported in MQTT 5. Your version:${s}`,o);return void e.emit("error",t)}e.handleAuth(t,(t,n)=>{if(t)e.emit("error",t);else if(24===o)e.reconnecting=!1,e._sendPacket(n);else{const t=new r.ErrorWithReasonCode(`Connection refused: ${i.ReasonCodes[o]}`,o);e.emit("error",t)}})}},5291(e,t,n){"use strict";const{MathFloor:r,NumberIsInteger:i}=n(4134),{validateInteger:s}=n(277),{ERR_INVALID_ARG_VALUE:o}=n(6371).codes;let a=16384,c=16;function l(e){return e?c:a}e.exports={getHighWaterMark:function(e,t,n,s){const a=function(e,t,n){return null!=e.highWaterMark?e.highWaterMark:t?e[n]:null}(t,s,n);if(null!=a){if(!i(a)||a<0){throw new o(s?`options.${n}`:"options.highWaterMark",a)}return r(a)}return l(e.objectMode)},getDefaultHighWaterMark:l,setDefaultHighWaterMark:function(e,t){s(t,"value",0),e?c=t:a=t}}},5389(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TrackingState=void 0;const r=n(441);t.TrackingState=class{objects=new Map;objectsByCamera=new Map;changeCallbacks=[];storage;console;constructor(e,t){this.storage=e,this.console=t,this.loadPersistedState()}createObject(e,t,n){const i=(0,r.createTrackedObject)(e,t,n);return this.upsertObject(i),i}upsertObject(e){const t=this.objects.get(e.globalId);if(t)for(const n of t.activeOnCameras)this.objectsByCamera.get(n)?.delete(e.globalId);for(const t of e.activeOnCameras)this.objectsByCamera.has(t)||this.objectsByCamera.set(t,new Set),this.objectsByCamera.get(t).add(e.globalId);this.objects.set(e.globalId,e),this.notifyChange(),this.persistState()}addSighting(e,t){const n=this.objects.get(e);return!!n&&((0,r.addSighting)(n,t),this.objectsByCamera.has(t.cameraId)||this.objectsByCamera.set(t.cameraId,new Set),this.objectsByCamera.get(t.cameraId).add(e),this.notifyChange(),this.persistState(),!0)}addJourney(e,t){const n=this.objects.get(e);return!!n&&((0,r.addJourneySegment)(n,t),this.objectsByCamera.get(t.fromCameraId)?.delete(e),this.objectsByCamera.has(t.toCameraId)||this.objectsByCamera.set(t.toCameraId,new Set),this.objectsByCamera.get(t.toCameraId).add(e),this.notifyChange(),this.persistState(),!0)}getObject(e){return this.objects.get(e)}getActiveObjects(){return Array.from(this.objects.values()).filter(e=>"active"===e.state||"pending"===e.state)}getObjectsOnCamera(e){const t=this.objectsByCamera.get(e)||new Set;return Array.from(t).map(e=>this.objects.get(e)).filter(e=>!!e&&"active"===e.state)}getAllObjects(){return Array.from(this.objects.values())}getActiveCount(){return this.getActiveObjects().length}getJourney(e){return this.objects.get(e)?.journey}markExited(e,t,n){const r=this.objects.get(e);if(r){r.state="exited",r.hasExited=!0,r.exitCamera=t,r.exitCameraName=n,r.activeOnCameras=[];for(const[t,n]of this.objectsByCamera.entries())n.delete(e);this.notifyChange(),this.persistState()}}markLost(e){const t=this.objects.get(e);if(t){t.state="lost",t.activeOnCameras=[];for(const[t,n]of this.objectsByCamera.entries())n.delete(e);this.notifyChange(),this.persistState()}}markPending(e){const t=this.objects.get(e);t&&"active"===t.state&&(t.state="pending",this.notifyChange())}reactivate(e){const t=this.objects.get(e);t&&"pending"===t.state&&(t.state="active",this.notifyChange())}onStateChange(e){this.changeCallbacks.push(e)}offStateChange(e){const t=this.changeCallbacks.indexOf(e);-1!==t&&this.changeCallbacks.splice(t,1)}notifyChange(){const e=this.getAllObjects();for(const t of this.changeCallbacks)try{t(e)}catch(e){this.console.error("State change callback error:",e)}}persistState(){try{const e=Date.now(),t=Array.from(this.objects.values()).filter(t=>"active"===t.state||"pending"===t.state||e-t.lastSeen<36e5);this.storage.setItem("tracked-objects",JSON.stringify(t))}catch(e){this.console.error("Failed to persist tracking state:",e)}}loadPersistedState(){try{const e=this.storage.getItem("tracked-objects");if(e){const t=JSON.parse(e),n=Date.now();for(const e of t){"active"===e.state&&n-e.lastSeen>3e5&&(e.state="lost",e.activeOnCameras=[]),this.objects.set(e.globalId,e);for(const t of e.activeOnCameras)this.objectsByCamera.has(t)||this.objectsByCamera.set(t,new Set),this.objectsByCamera.get(t).add(e.globalId)}this.console.log(`Loaded ${t.length} persisted tracked objects`)}}catch(e){this.console.error("Failed to load persisted tracking state:",e)}}cleanup(e=864e5){const t=Date.now();let n=0;for(const[r,i]of this.objects.entries())t-i.lastSeen>e&&"active"!==i.state&&(this.objects.delete(r),n++);n>0&&(this.console.log(`Cleaned up ${n} old tracked objects`),this.persistState())}generateId(){return`${Date.now()}-${Math.random().toString(36).slice(2,9)}`}}},5399(e,t,n){const r=e.exports,{Buffer:i}=n(181);r.types={0:"reserved",1:"connect",2:"connack",3:"publish",4:"puback",5:"pubrec",6:"pubrel",7:"pubcomp",8:"subscribe",9:"suback",10:"unsubscribe",11:"unsuback",12:"pingreq",13:"pingresp",14:"disconnect",15:"auth"},r.requiredHeaderFlags={1:0,2:0,4:0,5:0,6:2,7:0,8:2,9:0,10:2,11:0,12:0,13:0,14:0,15:0},r.requiredHeaderFlagsErrors={};for(const e in r.requiredHeaderFlags){const t=r.requiredHeaderFlags[e];r.requiredHeaderFlagsErrors[e]="Invalid header flag bits, must be 0x"+t.toString(16)+" for "+r.types[e]+" packet"}r.codes={};for(const e in r.types){const t=r.types[e];r.codes[t]=e}r.CMD_SHIFT=4,r.CMD_MASK=240,r.DUP_MASK=8,r.QOS_MASK=3,r.QOS_SHIFT=1,r.RETAIN_MASK=1,r.VARBYTEINT_MASK=127,r.VARBYTEINT_FIN_MASK=128,r.VARBYTEINT_MAX=268435455,r.SESSIONPRESENT_MASK=1,r.SESSIONPRESENT_HEADER=i.from([r.SESSIONPRESENT_MASK]),r.CONNACK_HEADER=i.from([r.codes.connack<<r.CMD_SHIFT]),r.USERNAME_MASK=128,r.PASSWORD_MASK=64,r.WILL_RETAIN_MASK=32,r.WILL_QOS_MASK=24,r.WILL_QOS_SHIFT=3,r.WILL_FLAG_MASK=4,r.CLEAN_SESSION_MASK=2,r.CONNECT_HEADER=i.from([r.codes.connect<<r.CMD_SHIFT]),r.properties={sessionExpiryInterval:17,willDelayInterval:24,receiveMaximum:33,maximumPacketSize:39,topicAliasMaximum:34,requestResponseInformation:25,requestProblemInformation:23,userProperties:38,authenticationMethod:21,authenticationData:22,payloadFormatIndicator:1,messageExpiryInterval:2,contentType:3,responseTopic:8,correlationData:9,maximumQoS:36,retainAvailable:37,assignedClientIdentifier:18,reasonString:31,wildcardSubscriptionAvailable:40,subscriptionIdentifiersAvailable:41,sharedSubscriptionAvailable:42,serverKeepAlive:19,responseInformation:26,serverReference:28,topicAlias:35,subscriptionIdentifier:11},r.propertiesCodes={};for(const e in r.properties){const t=r.properties[e];r.propertiesCodes[t]=e}function s(e){return[0,1,2].map(t=>[0,1].map(n=>[0,1].map(s=>{const o=i.alloc(1);return o.writeUInt8(r.codes[e]<<r.CMD_SHIFT|(n?r.DUP_MASK:0)|t<<r.QOS_SHIFT|s,0,!0),o})))}r.propertiesTypes={sessionExpiryInterval:"int32",willDelayInterval:"int32",receiveMaximum:"int16",maximumPacketSize:"int32",topicAliasMaximum:"int16",requestResponseInformation:"byte",requestProblemInformation:"byte",userProperties:"pair",authenticationMethod:"string",authenticationData:"binary",payloadFormatIndicator:"byte",messageExpiryInterval:"int32",contentType:"string",responseTopic:"string",correlationData:"binary",maximumQoS:"int8",retainAvailable:"byte",assignedClientIdentifier:"string",reasonString:"string",wildcardSubscriptionAvailable:"byte",subscriptionIdentifiersAvailable:"byte",sharedSubscriptionAvailable:"byte",serverKeepAlive:"int16",responseInformation:"string",serverReference:"string",topicAlias:"int16",subscriptionIdentifier:"var"},r.PUBLISH_HEADER=s("publish"),r.SUBSCRIBE_HEADER=s("subscribe"),r.SUBSCRIBE_OPTIONS_QOS_MASK=3,r.SUBSCRIBE_OPTIONS_NL_MASK=1,r.SUBSCRIBE_OPTIONS_NL_SHIFT=2,r.SUBSCRIBE_OPTIONS_RAP_MASK=1,r.SUBSCRIBE_OPTIONS_RAP_SHIFT=3,r.SUBSCRIBE_OPTIONS_RH_MASK=3,r.SUBSCRIBE_OPTIONS_RH_SHIFT=4,r.SUBSCRIBE_OPTIONS_RH=[0,16,32],r.SUBSCRIBE_OPTIONS_NL=4,r.SUBSCRIBE_OPTIONS_RAP=8,r.SUBSCRIBE_OPTIONS_QOS=[0,1,2],r.UNSUBSCRIBE_HEADER=s("unsubscribe"),r.ACKS={unsuback:s("unsuback"),puback:s("puback"),pubcomp:s("pubcomp"),pubrel:s("pubrel"),pubrec:s("pubrec")},r.SUBACK_HEADER=i.from([r.codes.suback<<r.CMD_SHIFT]),r.VERSION3=i.from([3]),r.VERSION4=i.from([4]),r.VERSION5=i.from([5]),r.VERSION131=i.from([131]),r.VERSION132=i.from([132]),r.QOS=[0,1,2].map(e=>i.from([e])),r.EMPTY={pingreq:i.from([r.codes.pingreq<<4,0]),pingresp:i.from([r.codes.pingresp<<4,0]),disconnect:i.from([r.codes.disconnect<<4,0])},r.MQTT5_PUBACK_PUBREC_CODES={0:"Success",16:"No matching subscribers",128:"Unspecified error",131:"Implementation specific error",135:"Not authorized",144:"Topic Name invalid",145:"Packet identifier in use",151:"Quota exceeded",153:"Payload format invalid"},r.MQTT5_PUBREL_PUBCOMP_CODES={0:"Success",146:"Packet Identifier not found"},r.MQTT5_SUBACK_CODES={0:"Granted QoS 0",1:"Granted QoS 1",2:"Granted QoS 2",128:"Unspecified error",131:"Implementation specific error",135:"Not authorized",143:"Topic Filter invalid",145:"Packet Identifier in use",151:"Quota exceeded",158:"Shared Subscriptions not supported",161:"Subscription Identifiers not supported",162:"Wildcard Subscriptions not supported"},r.MQTT5_UNSUBACK_CODES={0:"Success",17:"No subscription existed",128:"Unspecified error",131:"Implementation specific error",135:"Not authorized",143:"Topic Filter invalid",145:"Packet Identifier in use"},r.MQTT5_DISCONNECT_CODES={0:"Normal disconnection",4:"Disconnect with Will Message",128:"Unspecified error",129:"Malformed Packet",130:"Protocol Error",131:"Implementation specific error",135:"Not authorized",137:"Server busy",139:"Server shutting down",141:"Keep Alive timeout",142:"Session taken over",143:"Topic Filter invalid",144:"Topic Name invalid",147:"Receive Maximum exceeded",148:"Topic Alias invalid",149:"Packet too large",150:"Message rate too high",151:"Quota exceeded",152:"Administrative action",153:"Payload format invalid",154:"Retain not supported",155:"QoS not supported",156:"Use another server",157:"Server moved",158:"Shared Subscriptions not supported",159:"Connection rate exceeded",160:"Maximum connect time",161:"Subscription Identifiers not supported",162:"Wildcard Subscriptions not supported"},r.MQTT5_AUTH_CODES={0:"Success",24:"Continue authentication",25:"Re-authenticate"}},5438(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SOCKS5_NO_ACCEPTABLE_AUTH=t.SOCKS5_CUSTOM_AUTH_END=t.SOCKS5_CUSTOM_AUTH_START=t.SOCKS_INCOMING_PACKET_SIZES=t.SocksClientState=t.Socks5Response=t.Socks5HostType=t.Socks5Auth=t.Socks4Response=t.SocksCommand=t.ERRORS=t.DEFAULT_TIMEOUT=void 0;t.DEFAULT_TIMEOUT=3e4;t.ERRORS={InvalidSocksCommand:"An invalid SOCKS command was provided. Valid options are connect, bind, and associate.",InvalidSocksCommandForOperation:"An invalid SOCKS command was provided. Only a subset of commands are supported for this operation.",InvalidSocksCommandChain:"An invalid SOCKS command was provided. Chaining currently only supports the connect command.",InvalidSocksClientOptionsDestination:"An invalid destination host was provided.",InvalidSocksClientOptionsExistingSocket:"An invalid existing socket was provided. This should be an instance of stream.Duplex.",InvalidSocksClientOptionsProxy:"Invalid SOCKS proxy details were provided.",InvalidSocksClientOptionsTimeout:"An invalid timeout value was provided. Please enter a value above 0 (in ms).",InvalidSocksClientOptionsProxiesLength:"At least two socks proxies must be provided for chaining.",InvalidSocksClientOptionsCustomAuthRange:"Custom auth must be a value between 0x80 and 0xFE.",InvalidSocksClientOptionsCustomAuthOptions:"When a custom_auth_method is provided, custom_auth_request_handler, custom_auth_response_size, and custom_auth_response_handler must also be provided and valid.",NegotiationError:"Negotiation error",SocketClosed:"Socket closed",ProxyConnectionTimedOut:"Proxy connection timed out",InternalError:"SocksClient internal error (this should not happen)",InvalidSocks4HandshakeResponse:"Received invalid Socks4 handshake response",Socks4ProxyRejectedConnection:"Socks4 Proxy rejected connection",InvalidSocks4IncomingConnectionResponse:"Socks4 invalid incoming connection response",Socks4ProxyRejectedIncomingBoundConnection:"Socks4 Proxy rejected incoming bound connection",InvalidSocks5InitialHandshakeResponse:"Received invalid Socks5 initial handshake response",InvalidSocks5IntiailHandshakeSocksVersion:"Received invalid Socks5 initial handshake (invalid socks version)",InvalidSocks5InitialHandshakeNoAcceptedAuthType:"Received invalid Socks5 initial handshake (no accepted authentication type)",InvalidSocks5InitialHandshakeUnknownAuthType:"Received invalid Socks5 initial handshake (unknown authentication type)",Socks5AuthenticationFailed:"Socks5 Authentication failed",InvalidSocks5FinalHandshake:"Received invalid Socks5 final handshake response",InvalidSocks5FinalHandshakeRejected:"Socks5 proxy rejected connection",InvalidSocks5IncomingConnectionResponse:"Received invalid Socks5 incoming connection response",Socks5ProxyRejectedIncomingBoundConnection:"Socks5 Proxy rejected incoming bound connection"};var n,r,i;t.SOCKS_INCOMING_PACKET_SIZES={Socks5InitialHandshakeResponse:2,Socks5UserPassAuthenticationResponse:2,Socks5ResponseHeader:5,Socks5ResponseIPv4:10,Socks5ResponseIPv6:22,Socks5ResponseHostname:e=>e+7,Socks4Response:8},function(e){e[e.connect=1]="connect",e[e.bind=2]="bind",e[e.associate=3]="associate"}(n||(t.SocksCommand=n={})),function(e){e[e.Granted=90]="Granted",e[e.Failed=91]="Failed",e[e.Rejected=92]="Rejected",e[e.RejectedIdent=93]="RejectedIdent"}(r||(t.Socks4Response=r={})),function(e){e[e.NoAuth=0]="NoAuth",e[e.GSSApi=1]="GSSApi",e[e.UserPass=2]="UserPass"}(i||(t.Socks5Auth=i={}));t.SOCKS5_CUSTOM_AUTH_START=128;t.SOCKS5_CUSTOM_AUTH_END=254;var s,o,a;t.SOCKS5_NO_ACCEPTABLE_AUTH=255,function(e){e[e.Granted=0]="Granted",e[e.Failure=1]="Failure",e[e.NotAllowed=2]="NotAllowed",e[e.NetworkUnreachable=3]="NetworkUnreachable",e[e.HostUnreachable=4]="HostUnreachable",e[e.ConnectionRefused=5]="ConnectionRefused",e[e.TTLExpired=6]="TTLExpired",e[e.CommandNotSupported=7]="CommandNotSupported",e[e.AddressNotSupported=8]="AddressNotSupported"}(s||(t.Socks5Response=s={})),function(e){e[e.IPv4=1]="IPv4",e[e.Hostname=3]="Hostname",e[e.IPv6=4]="IPv6"}(o||(t.Socks5HostType=o={})),function(e){e[e.Created=0]="Created",e[e.Connecting=1]="Connecting",e[e.Connected=2]="Connected",e[e.SentInitialHandshake=3]="SentInitialHandshake",e[e.ReceivedInitialHandshakeResponse=4]="ReceivedInitialHandshakeResponse",e[e.SentAuthentication=5]="SentAuthentication",e[e.ReceivedAuthenticationResponse=6]="ReceivedAuthenticationResponse",e[e.SentFinalHandshake=7]="SentFinalHandshake",e[e.ReceivedFinalResponse=8]="ReceivedFinalResponse",e[e.BoundWaitingForConnection=9]="BoundWaitingForConnection",e[e.Established=10]="Established",e[e.Disconnected=11]="Disconnected",e[e.Error=99]="Error"}(a||(t.SocksClientState=a={}))},5471(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.GlobalTrackerSensor=void 0;const r=n(7562),i=n(441);class s extends r.ScryptedDeviceBase{trackingState;plugin;constructor(e,t,n){super(t),this.plugin=e,this.trackingState=n,n.onStateChange(()=>this.updateOccupancy()),this.updateOccupancy()}updateOccupancy(){const e=this.trackingState.getActiveCount();this.occupied=e>0}async getSettings(){const e=this.trackingState.getActiveObjects(),t=this.trackingState.getAllObjects(),n=[];if(n.push({key:"activeCount",title:"Currently Active",type:"string",readonly:!0,value:`${e.length} object${1!==e.length?"s":""}`,group:"Status"}),n.push({key:"totalTracked",title:"Total Tracked (24h)",type:"string",readonly:!0,value:`${t.length} object${1!==t.length?"s":""}`,group:"Status"}),e.length>0){n.push({key:"activeObjectsHeader",title:"Active Objects",type:"html",value:'<h4 style="margin: 0;">Currently Tracked</h4>',group:"Active Objects"});for(const t of e.slice(0,10)){const e=(0,i.calculateDwellTime)(t),r=Math.round(e/6e4);n.push({key:`active-${t.globalId}`,title:`${t.className}${t.label?` (${t.label})`:""}`,type:"string",readonly:!0,value:`Cameras: ${t.activeOnCameras.join(", ")} | Time: ${r}m`,group:"Active Objects"})}e.length>10&&n.push({key:"moreActive",title:"More",type:"string",readonly:!0,value:`...and ${e.length-10} more`,group:"Active Objects"})}const r=t.filter(e=>"exited"===e.state).sort((e,t)=>t.lastSeen-e.lastSeen).slice(0,5);if(r.length>0){n.push({key:"recentExitsHeader",title:"Recent Exits",type:"html",value:'<h4 style="margin: 0;">Recently Exited</h4>',group:"Recent Activity"});for(const e of r){const t=new Date(e.lastSeen).toLocaleTimeString(),r=(0,i.getJourneySummary)(e);n.push({key:`exit-${e.globalId}`,title:`${e.className} at ${t}`,type:"string",readonly:!0,value:r||"No journey recorded",group:"Recent Activity"})}}return n}async putSetting(e,t){}async getReadmeMarkdown(){const e=this.trackingState.getActiveObjects(),t=this.trackingState.getAllObjects(),n=e.filter(e=>"person"===e.className).length,r=e.filter(e=>["car","vehicle","truck"].includes(e.className)).length,i=e.filter(e=>"animal"===e.className).length;let s="";return n>0&&(s+=`- People: ${n}\n`),r>0&&(s+=`- Vehicles: ${r}\n`),i>0&&(s+=`- Animals: ${i}\n`),`\n# Global Object Tracker\n\nThis sensor tracks the presence of objects across all connected cameras in your property.\n\n## Current Status\n\n**Occupied**: ${this.occupied?"Yes":"No"}\n\n**Active Objects**: ${e.length}\n${s||"- None currently"}\n\n**Total Tracked (24h)**: ${t.length}\n\n## How It Works\n\nThe Global Tracker combines detection events from all configured cameras to maintain a unified view of objects on your property. When an object moves from one camera's view to another, the system correlates these sightings to track the object's journey.\n\n## States\n\n- **Active**: Object is currently visible on camera\n- **Pending**: Object left camera view, waiting for correlation\n- **Exited**: Object left the property\n- **Lost**: Object disappeared without exiting (timeout)\n\n## Integration\n\nThis sensor can be used in automations:\n- Trigger actions when property becomes occupied/unoccupied\n- Create presence-based automations\n- Monitor overall property activity\n`}}t.GlobalTrackerSensor=s},5506(e,t,n){"use strict";const{Buffer:r}=n(181),{ObjectDefineProperty:i,ObjectKeys:s,ReflectApply:o}=n(4134),{promisify:{custom:a}}=n(7760),{streamReturningOperators:c,promiseReturningOperators:l}=n(823),{codes:{ERR_ILLEGAL_CONSTRUCTOR:d}}=n(6371),u=n(7830),{setDefaultHighWaterMark:h,getDefaultHighWaterMark:p}=n(5291),{pipeline:f}=n(7758),{destroyer:g}=n(5896),m=n(6238),y=n(3095),b=n(6115),v=e.exports=n(4259).Stream;v.isDestroyed=b.isDestroyed,v.isDisturbed=b.isDisturbed,v.isErrored=b.isErrored,v.isReadable=b.isReadable,v.isWritable=b.isWritable,v.Readable=n(7576);for(const _ of s(c)){const w=c[_];function k(...e){if(new.target)throw d();return v.Readable.from(o(w,this,e))}i(k,"name",{__proto__:null,value:w.name}),i(k,"length",{__proto__:null,value:w.length}),i(v.Readable.prototype,_,{__proto__:null,value:k,enumerable:!1,configurable:!0,writable:!0})}for(const I of s(l)){const E=l[I];function x(...e){if(new.target)throw d();return o(E,this,e)}i(x,"name",{__proto__:null,value:E.name}),i(x,"length",{__proto__:null,value:E.length}),i(v.Readable.prototype,I,{__proto__:null,value:x,enumerable:!1,configurable:!0,writable:!0})}v.Writable=n(8584),v.Duplex=n(3370),v.Transform=n(7382),v.PassThrough=n(6524),v.pipeline=f;const{addAbortSignal:S}=n(4147);v.addAbortSignal=S,v.finished=m,v.destroy=g,v.compose=u,v.setDefaultHighWaterMark=h,v.getDefaultHighWaterMark=p,i(v,"promises",{__proto__:null,configurable:!0,enumerable:!0,get:()=>y}),i(f,a,{__proto__:null,enumerable:!0,get:()=>y.pipeline}),i(m,a,{__proto__:null,enumerable:!0,get:()=>y.finished}),v.Stream=v,v._isUint8Array=function(e){return e instanceof Uint8Array},v._uint8ArrayToBuffer=function(e){return r.from(e.buffer,e.byteOffset,e.byteLength)}},5670(e,t,n){"use strict";const r=n(181),i=n(4478),s=n(2635);let o,a,c;t.A=(e,t)=>{if(t.hostname=t.hostname||t.host,!t.hostname)throw new Error("Could not determine host. Specify host manually.");const n="MQIsdp"===t.protocolId&&3===t.protocolVersion?"mqttv3.1":"mqtt";!function(e){e.hostname||(e.hostname="localhost"),e.path||(e.path="/"),e.wsOptions||(e.wsOptions={})}(t);const l=function(e,t){const n="wxs"===e.protocol?"wss":"ws";let r=`${n}://${e.hostname}${e.path}`;return e.port&&80!==e.port&&443!==e.port&&(r=`${n}://${e.hostname}:${e.port}${e.path}`),"function"==typeof e.transformWsUrl&&(r=e.transformWsUrl(r,e,t)),r}(t,e);o=wx.connectSocket({url:l,protocols:[n]}),a=function(){const e=new i.Transform;return e._write=(e,t,n)=>{o.send({data:e.buffer,success(){n()},fail(e){n(new Error(e))}})},e._flush=e=>{o.close({success(){e()}})},e}(),c=new s.BufferedDuplex(t,a,o),c._destroy=(e,t)=>{o.close({success(){t&&t(e)}})};const d=c.destroy;return c.destroy=(e,t)=>(c.destroy=d,setTimeout(()=>{o.close({fail(){c._destroy(e,t)}})},0),c),o.onOpen(()=>{c.socketReady()}),o.onMessage(e=>{let{data:t}=e;t=t instanceof ArrayBuffer?r.Buffer.from(t):r.Buffer.from(t,"utf8"),a.push(t)}),o.onClose(()=>{c.emit("close"),c.end(),c.destroy()}),o.onError(e=>{const t=new Error(e.errMsg);c.destroy(t)}),c}},5692(e){"use strict";e.exports=require("https")},5753(e,t,n){"undefined"==typeof process||"renderer"===process.type||!0===process.browser||process.__nwjs?e.exports=n(7833):e.exports=n(6033)},5861(e,t,n){"use strict";var r=this&&this.__createBinding||(Object.create?function(e,t,n,r){void 0===r&&(r=n);var i=Object.getOwnPropertyDescriptor(t,n);i&&!("get"in i?!t.__esModule:i.writable||i.configurable)||(i={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,r,i)}:function(e,t,n,r){void 0===r&&(r=n),e[r]=t[n]}),i=this&&this.__exportStar||function(e,t){for(var n in e)"default"===n||Object.prototype.hasOwnProperty.call(t,n)||r(t,e,n)};Object.defineProperty(t,"__esModule",{value:!0}),i(n(7631),t)},5880(e,t,n){"use strict";const{isUtf8:r}=n(181),{hasBlob:i}=n(2614);function s(e){const t=e.length;let n=0;for(;n<t;)if(128&e[n])if(192==(224&e[n])){if(n+1===t||128!=(192&e[n+1])||192==(254&e[n]))return!1;n+=2}else if(224==(240&e[n])){if(n+2>=t||128!=(192&e[n+1])||128!=(192&e[n+2])||224===e[n]&&128==(224&e[n+1])||237===e[n]&&160==(224&e[n+1]))return!1;n+=3}else{if(240!=(248&e[n]))return!1;if(n+3>=t||128!=(192&e[n+1])||128!=(192&e[n+2])||128!=(192&e[n+3])||240===e[n]&&128==(240&e[n+1])||244===e[n]&&e[n+1]>143||e[n]>244)return!1;n+=4}else n++;return!0}if(e.exports={isBlob:function(e){return i&&"object"==typeof e&&"function"==typeof e.arrayBuffer&&"string"==typeof e.type&&"function"==typeof e.stream&&("Blob"===e[Symbol.toStringTag]||"File"===e[Symbol.toStringTag])},isValidStatusCode:function(e){return e>=1e3&&e<=1014&&1004!==e&&1005!==e&&1006!==e||e>=3e3&&e<=4999},isValidUTF8:s,tokenChars:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,1,1,1,1,1,0,0,1,1,0,1,1,0,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,1,0,1,0]},r)e.exports.isValidUTF8=function(e){return e.length<24?s(e):r(e)};else if(!process.env.WS_NO_UTF_8_VALIDATE)try{const t=n(Object(function(){var e=new Error("Cannot find module 'utf-8-validate'");throw e.code="MODULE_NOT_FOUND",e}()));e.exports.isValidUTF8=function(e){return e.length<32?s(e):t(e)}}catch(e){}},5884(e){"use strict";e.exports=(e,t=process.argv)=>{const n=e.startsWith("-")?"":1===e.length?"-":"--",r=t.indexOf(n+e),i=t.indexOf("--");return-1!==r&&(-1===i||r<i)}},5896(e,t,n){"use strict";const r=n(4422),{aggregateTwoErrors:i,codes:{ERR_MULTIPLE_CALLBACK:s},AbortError:o}=n(6371),{Symbol:a}=n(4134),{kIsDestroyed:c,isDestroyed:l,isFinished:d,isServerRequest:u}=n(6115),h=a("kDestroy"),p=a("kConstruct");function f(e,t,n){e&&(e.stack,t&&!t.errored&&(t.errored=e),n&&!n.errored&&(n.errored=e))}function g(e,t,n){let i=!1;function s(t){if(i)return;i=!0;const s=e._readableState,o=e._writableState;f(t,o,s),o&&(o.closed=!0),s&&(s.closed=!0),"function"==typeof n&&n(t),t?r.nextTick(m,e,t):r.nextTick(y,e)}try{e._destroy(t||null,s)}catch(t){s(t)}}function m(e,t){b(e,t),y(e)}function y(e){const t=e._readableState,n=e._writableState;n&&(n.closeEmitted=!0),t&&(t.closeEmitted=!0),(null!=n&&n.emitClose||null!=t&&t.emitClose)&&e.emit("close")}function b(e,t){const n=e._readableState,r=e._writableState;null!=r&&r.errorEmitted||null!=n&&n.errorEmitted||(r&&(r.errorEmitted=!0),n&&(n.errorEmitted=!0),e.emit("error",t))}function v(e,t,n){const i=e._readableState,s=e._writableState;if(null!=s&&s.destroyed||null!=i&&i.destroyed)return this;null!=i&&i.autoDestroy||null!=s&&s.autoDestroy?e.destroy(t):t&&(t.stack,s&&!s.errored&&(s.errored=t),i&&!i.errored&&(i.errored=t),n?r.nextTick(b,e,t):b(e,t))}function S(e){let t=!1;function n(n){if(t)return void v(e,null!=n?n:new s);t=!0;const i=e._readableState,o=e._writableState,a=o||i;i&&(i.constructed=!0),o&&(o.constructed=!0),a.destroyed?e.emit(h,n):n?v(e,n,!0):r.nextTick(_,e)}try{e._construct(e=>{r.nextTick(n,e)})}catch(e){r.nextTick(n,e)}}function _(e){e.emit(p)}function w(e){return(null==e?void 0:e.setHeader)&&"function"==typeof e.abort}function k(e){e.emit("close")}function I(e,t){e.emit("error",t),r.nextTick(k,e)}e.exports={construct:function(e,t){if("function"!=typeof e._construct)return;const n=e._readableState,i=e._writableState;n&&(n.constructed=!1),i&&(i.constructed=!1),e.once(p,t),e.listenerCount(p)>1||r.nextTick(S,e)},destroyer:function(e,t){e&&!l(e)&&(t||d(e)||(t=new o),u(e)?(e.socket=null,e.destroy(t)):w(e)?e.abort():w(e.req)?e.req.abort():"function"==typeof e.destroy?e.destroy(t):"function"==typeof e.close?e.close():t?r.nextTick(I,e,t):r.nextTick(k,e),e.destroyed||(e[c]=!0))},destroy:function(e,t){const n=this._readableState,r=this._writableState,s=r||n;return null!=r&&r.destroyed||null!=n&&n.destroyed?("function"==typeof t&&t(),this):(f(e,r,n),r&&(r.destroyed=!0),n&&(n.destroyed=!0),s.constructed?g(this,e,t):this.once(h,function(n){g(this,i(n,e),t)}),this)},undestroy:function(){const e=this._readableState,t=this._writableState;e&&(e.constructed=!0,e.closed=!1,e.closeEmitted=!1,e.destroyed=!1,e.errored=null,e.errorEmitted=!1,e.reading=!1,e.ended=!1===e.readable,e.endEmitted=!1===e.readable),t&&(t.constructed=!0,t.destroyed=!1,t.closed=!1,t.closeEmitted=!1,t.errored=null,t.errorEmitted=!1,t.finalCalled=!1,t.prefinished=!1,t.ended=!1===t.writable,t.ending=!1===t.writable,t.finished=!1===t.writable)},errorOrDestroy:v}},5926(e,t,n){"use strict";const{tokenChars:r}=n(5880);function i(e,t,n){void 0===e[t]?e[t]=[n]:e[t].push(n)}e.exports={format:function(e){return Object.keys(e).map(t=>{let n=e[t];return Array.isArray(n)||(n=[n]),n.map(e=>[t].concat(Object.keys(e).map(t=>{let n=e[t];return Array.isArray(n)||(n=[n]),n.map(e=>!0===e?t:`${t}=${e}`).join("; ")})).join("; ")).join(", ")}).join(", ")},parse:function(e){const t=Object.create(null);let n,s,o=Object.create(null),a=!1,c=!1,l=!1,d=-1,u=-1,h=-1,p=0;for(;p<e.length;p++)if(u=e.charCodeAt(p),void 0===n)if(-1===h&&1===r[u])-1===d&&(d=p);else if(0===p||32!==u&&9!==u){if(59!==u&&44!==u)throw new SyntaxError(`Unexpected character at index ${p}`);{if(-1===d)throw new SyntaxError(`Unexpected character at index ${p}`);-1===h&&(h=p);const r=e.slice(d,h);44===u?(i(t,r,o),o=Object.create(null)):n=r,d=h=-1}}else-1===h&&-1!==d&&(h=p);else if(void 0===s)if(-1===h&&1===r[u])-1===d&&(d=p);else if(32===u||9===u)-1===h&&-1!==d&&(h=p);else if(59===u||44===u){if(-1===d)throw new SyntaxError(`Unexpected character at index ${p}`);-1===h&&(h=p),i(o,e.slice(d,h),!0),44===u&&(i(t,n,o),o=Object.create(null),n=void 0),d=h=-1}else{if(61!==u||-1===d||-1!==h)throw new SyntaxError(`Unexpected character at index ${p}`);s=e.slice(d,p),d=h=-1}else if(c){if(1!==r[u])throw new SyntaxError(`Unexpected character at index ${p}`);-1===d?d=p:a||(a=!0),c=!1}else if(l)if(1===r[u])-1===d&&(d=p);else if(34===u&&-1!==d)l=!1,h=p;else{if(92!==u)throw new SyntaxError(`Unexpected character at index ${p}`);c=!0}else if(34===u&&61===e.charCodeAt(p-1))l=!0;else if(-1===h&&1===r[u])-1===d&&(d=p);else if(-1===d||32!==u&&9!==u){if(59!==u&&44!==u)throw new SyntaxError(`Unexpected character at index ${p}`);{if(-1===d)throw new SyntaxError(`Unexpected character at index ${p}`);-1===h&&(h=p);let r=e.slice(d,h);a&&(r=r.replace(/\\/g,""),a=!1),i(o,s,r),44===u&&(i(t,n,o),o=Object.create(null),n=void 0),s=void 0,d=h=-1}}else-1===h&&(h=p);if(-1===d||l||32===u||9===u)throw new SyntaxError("Unexpected end of input");-1===h&&(h=p);const f=e.slice(d,h);return void 0===n?i(t,f,o):(void 0===s?i(o,f,!0):i(o,s,a?f.replace(/\\/g,""):f),i(t,n,o)),t}}},6033(e,t,n){const r=n(2018),i=n(9023);t.init=function(e){e.inspectOpts={};const n=Object.keys(t.inspectOpts);for(let r=0;r<n.length;r++)e.inspectOpts[n[r]]=t.inspectOpts[n[r]]},t.log=function(...e){return process.stderr.write(i.formatWithOptions(t.inspectOpts,...e)+"\n")},t.formatArgs=function(n){const{namespace:r,useColors:i}=this;if(i){const t=this.color,i="[3"+(t<8?t:"8;5;"+t),s=`  ${i};1m${r} [0m`;n[0]=s+n[0].split("\n").join("\n"+s),n.push(i+"m+"+e.exports.humanize(this.diff)+"[0m")}else n[0]=function(){if(t.inspectOpts.hideDate)return"";return(new Date).toISOString()+" "}()+r+" "+n[0]},t.save=function(e){e?process.env.DEBUG=e:delete process.env.DEBUG},t.load=function(){return process.env.DEBUG},t.useColors=function(){return"colors"in t.inspectOpts?Boolean(t.inspectOpts.colors):r.isatty(process.stderr.fd)},t.destroy=i.deprecate(()=>{},"Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`."),t.colors=[6,2,3,4,5,1];try{const e=n(7687);e&&(e.stderr||e).level>=2&&(t.colors=[20,21,26,27,32,33,38,39,40,41,42,43,44,45,56,57,62,63,68,69,74,75,76,77,78,79,80,81,92,93,98,99,112,113,128,129,134,135,148,149,160,161,162,163,164,165,166,167,168,169,170,171,172,173,178,179,184,185,196,197,198,199,200,201,202,203,204,205,206,207,208,209,214,215,220,221])}catch(e){}t.inspectOpts=Object.keys(process.env).filter(e=>/^debug_/i.test(e)).reduce((e,t)=>{const n=t.substring(6).toLowerCase().replace(/_([a-z])/g,(e,t)=>t.toUpperCase());let r=process.env[t];return r=!!/^(yes|on|true|enabled)$/i.test(r)||!/^(no|off|false|disabled)$/i.test(r)&&("null"===r?null:Number(r)),e[n]=r,e},{}),e.exports=n(736)(t);const{formatters:s}=e.exports;s.o=function(e){return this.inspectOpts.colors=this.useColors,i.inspect(e,this.inspectOpts).split("\n").map(e=>e.trim()).join(" ")},s.O=function(e){return this.inspectOpts.colors=this.useColors,i.inspect(e,this.inspectOpts)}},6115(e,t,n){"use strict";const{SymbolAsyncIterator:r,SymbolIterator:i,SymbolFor:s}=n(4134),o=s("nodejs.stream.destroyed"),a=s("nodejs.stream.errored"),c=s("nodejs.stream.readable"),l=s("nodejs.stream.writable"),d=s("nodejs.stream.disturbed"),u=s("nodejs.webstream.isClosedPromise"),h=s("nodejs.webstream.controllerErrorFunction");function p(e,t=!1){var n;return!(!e||"function"!=typeof e.pipe||"function"!=typeof e.on||t&&("function"!=typeof e.pause||"function"!=typeof e.resume)||e._writableState&&!1===(null===(n=e._readableState)||void 0===n?void 0:n.readable)||e._writableState&&!e._readableState)}function f(e){var t;return!(!e||"function"!=typeof e.write||"function"!=typeof e.on||e._readableState&&!1===(null===(t=e._writableState)||void 0===t?void 0:t.writable))}function g(e){return e&&(e._readableState||e._writableState||"function"==typeof e.write&&"function"==typeof e.on||"function"==typeof e.pipe&&"function"==typeof e.on)}function m(e){return!(!e||g(e)||"function"!=typeof e.pipeThrough||"function"!=typeof e.getReader||"function"!=typeof e.cancel)}function y(e){return!(!e||g(e)||"function"!=typeof e.getWriter||"function"!=typeof e.abort)}function b(e){return!(!e||g(e)||"object"!=typeof e.readable||"object"!=typeof e.writable)}function v(e){if(!g(e))return null;const t=e._writableState,n=e._readableState,r=t||n;return!!(e.destroyed||e[o]||null!=r&&r.destroyed)}function S(e){if(!f(e))return null;if(!0===e.writableEnded)return!0;const t=e._writableState;return(null==t||!t.errored)&&("boolean"!=typeof(null==t?void 0:t.ended)?null:t.ended)}function _(e,t){if(!p(e))return null;const n=e._readableState;return(null==n||!n.errored)&&("boolean"!=typeof(null==n?void 0:n.endEmitted)?null:!!(n.endEmitted||!1===t&&!0===n.ended&&0===n.length))}function w(e){return e&&null!=e[c]?e[c]:"boolean"!=typeof(null==e?void 0:e.readable)?null:!v(e)&&(p(e)&&e.readable&&!_(e))}function k(e){return e&&null!=e[l]?e[l]:"boolean"!=typeof(null==e?void 0:e.writable)?null:!v(e)&&(f(e)&&e.writable&&!S(e))}function I(e){return"boolean"==typeof e._closed&&"boolean"==typeof e._defaultKeepAlive&&"boolean"==typeof e._removedConnection&&"boolean"==typeof e._removedContLen}function E(e){return"boolean"==typeof e._sent100&&I(e)}e.exports={isDestroyed:v,kIsDestroyed:o,isDisturbed:function(e){var t;return!(!e||!(null!==(t=e[d])&&void 0!==t?t:e.readableDidRead||e.readableAborted))},kIsDisturbed:d,isErrored:function(e){var t,n,r,i,s,o,c,l,d,u;return!(!e||!(null!==(t=null!==(n=null!==(r=null!==(i=null!==(s=null!==(o=e[a])&&void 0!==o?o:e.readableErrored)&&void 0!==s?s:e.writableErrored)&&void 0!==i?i:null===(c=e._readableState)||void 0===c?void 0:c.errorEmitted)&&void 0!==r?r:null===(l=e._writableState)||void 0===l?void 0:l.errorEmitted)&&void 0!==n?n:null===(d=e._readableState)||void 0===d?void 0:d.errored)&&void 0!==t?t:null===(u=e._writableState)||void 0===u?void 0:u.errored))},kIsErrored:a,isReadable:w,kIsReadable:c,kIsClosedPromise:u,kControllerErrorFunction:h,kIsWritable:l,isClosed:function(e){if(!g(e))return null;if("boolean"==typeof e.closed)return e.closed;const t=e._writableState,n=e._readableState;return"boolean"==typeof(null==t?void 0:t.closed)||"boolean"==typeof(null==n?void 0:n.closed)?(null==t?void 0:t.closed)||(null==n?void 0:n.closed):"boolean"==typeof e._closed&&I(e)?e._closed:null},isDuplexNodeStream:function(e){return!(!e||"function"!=typeof e.pipe||!e._readableState||"function"!=typeof e.on||"function"!=typeof e.write)},isFinished:function(e,t){return g(e)?!!v(e)||(!1===(null==t?void 0:t.readable)||!w(e))&&(!1===(null==t?void 0:t.writable)||!k(e)):null},isIterable:function(e,t){return null!=e&&(!0===t?"function"==typeof e[r]:!1===t?"function"==typeof e[i]:"function"==typeof e[r]||"function"==typeof e[i])},isReadableNodeStream:p,isReadableStream:m,isReadableEnded:function(e){if(!p(e))return null;if(!0===e.readableEnded)return!0;const t=e._readableState;return!(!t||t.errored)&&("boolean"!=typeof(null==t?void 0:t.ended)?null:t.ended)},isReadableFinished:_,isReadableErrored:function(e){var t,n;return g(e)?e.readableErrored?e.readableErrored:null!==(t=null===(n=e._readableState)||void 0===n?void 0:n.errored)&&void 0!==t?t:null:null},isNodeStream:g,isWebStream:function(e){return m(e)||y(e)||b(e)},isWritable:k,isWritableNodeStream:f,isWritableStream:y,isWritableEnded:S,isWritableFinished:function(e,t){if(!f(e))return null;if(!0===e.writableFinished)return!0;const n=e._writableState;return(null==n||!n.errored)&&("boolean"!=typeof(null==n?void 0:n.finished)?null:!!(n.finished||!1===t&&!0===n.ended&&0===n.length))},isWritableErrored:function(e){var t,n;return g(e)?e.writableErrored?e.writableErrored:null!==(t=null===(n=e._writableState)||void 0===n?void 0:n.errored)&&void 0!==t?t:null:null},isServerRequest:function(e){var t;return"boolean"==typeof e._consuming&&"boolean"==typeof e._dumped&&void 0===(null===(t=e.req)||void 0===t?void 0:t.upgradeOrConnect)},isServerResponse:E,willEmitClose:function(e){if(!g(e))return null;const t=e._writableState,n=e._readableState,r=t||n;return!r&&E(e)||!!(r&&r.autoDestroy&&r.emitClose&&!1===r.closed)},isTransformStream:b}},6117(e,t,n){"use strict";var r,i=this&&this.__createBinding||(Object.create?function(e,t,n,r){void 0===r&&(r=n);var i=Object.getOwnPropertyDescriptor(t,n);i&&!("get"in i?!t.__esModule:i.writable||i.configurable)||(i={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,r,i)}:function(e,t,n,r){void 0===r&&(r=n),e[r]=t[n]}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),o=this&&this.__importStar||(r=function(e){return r=Object.getOwnPropertyNames||function(e){var t=[];for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[t.length]=n);return t},r(e)},function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n=r(e),o=0;o<n.length;o++)"default"!==n[o]&&i(t,e,n[o]);return s(t,e),t});Object.defineProperty(t,"__esModule",{value:!0}),t.StorageSettings=void 0;const a=o(n(7562)),{systemManager:c}=a.default;t.StorageSettings=class{constructor(e,t){this.device=e,this.settings=t,this.values={},this.hasValue={};for(const e of Object.keys(t)){const n=t[e],r=()=>this.getItem(e);let i;i="clippath"!==n.type?r:()=>{try{return JSON.parse(r())}catch(e){}},Object.defineProperty(this.values,e,{get:i,set:t=>this.putSetting(e,t),enumerable:!0}),Object.defineProperty(this.hasValue,e,{get:()=>null!=this.device.storage.getItem(e),enumerable:!0})}}get keys(){const e={};for(const t of Object.keys(this.settings))e[t]=t;return e}async getSettings(){const e=await(this.options?.onGet?.()),t=[];for(const[n,r]of Object.entries(this.settings)){let i=Object.assign({},r);e?.[n]&&(i=Object.assign(i,e[n])),i.onGet&&(i=Object.assign(i,await i.onGet())),i.hide||await(this.options?.hide?.[n]?.())||(i.key=n,i.value=this.getItemInternal(n,i,!0),"function"==typeof i.deviceFilter&&(i.deviceFilter=i.deviceFilter.toString()),t.push(i),delete i.onPut,delete i.onGet,delete i.mapPut,delete i.mapGet)}return t}async putSetting(e,t){const n=this.settings[e];let r;return n&&(r=this.getItemInternal(e,n)),this.putSettingInternal(n,r,e,t)}putSettingInternal(e,t,n,r){e?.noStore||(e?.mapPut&&(r=e.mapPut(t,r)),null==r?this.device.storage.removeItem(n):"object"==typeof r?this.device.storage.setItem(n,JSON.stringify(r)):this.device.storage.setItem(n,r?.toString())),e?.onPut?.(t,r),e?.hide||this.device.onDeviceEvent(a.ScryptedInterface.Settings,void 0)}getItemInternal(e,t,n){if(!t)return this.device.storage.getItem(e);const r=function(e,t,n,r){if(null==e)return n();const i=t.multiple?"array":t.type;if("boolean"===i)return"true"===e||"false"!==e&&(n()||!1);if("number"===i){const t=parseFloat(e);return isNaN(t)?n()||0:t}if("integer"===i){const t=parseInt(e);return isNaN(t)?n()||0:t}if("array"===i){if(!e)return n()||[];try{return JSON.parse(e)}catch(e){return n()||[]}}if("device"===i)return r?e:c.getDeviceById(e)||c.getDeviceById(n());if(e&&t.json)try{return JSON.parse(e)}catch(e){return n()}return e||n()}(this.device.storage.getItem(e),t,()=>null!=t.persistedDefaultValue?(this.putSettingInternal(t,void 0,e,t.persistedDefaultValue),t.persistedDefaultValue):t.defaultValue,n);return t.mapGet?t.mapGet(r):r}getItem(e){return this.getItemInternal(e,this.settings[e])}}},6172(e,t,n){const{Buffer:r}=n(181),i={},s=r.isBuffer(r.from([1,2]).subarray(0,1));function o(e){const t=r.allocUnsafe(2);return t.writeUInt8(e>>8,0),t.writeUInt8(255&e,1),t}e.exports={cache:i,generateCache:function(){for(let e=0;e<65536;e++)i[e]=o(e)},generateNumber:o,genBufVariableByteInt:function(e){let t=0,n=0;const i=r.allocUnsafe(4);do{t=e%128|0,(e=e/128|0)>0&&(t|=128),i.writeUInt8(t,n++)}while(e>0&&n<4);return e>0&&(n=0),s?i.subarray(0,n):i.slice(0,n)},generate4ByteBuffer:function(e){const t=r.allocUnsafe(4);return t.writeUInt32BE(e,0),t}}},6238(e,t,n){"use strict";const r=n(4422),{AbortError:i,codes:s}=n(6371),{ERR_INVALID_ARG_TYPE:o,ERR_STREAM_PREMATURE_CLOSE:a}=s,{kEmptyObject:c,once:l}=n(7760),{validateAbortSignal:d,validateFunction:u,validateObject:h,validateBoolean:p}=n(277),{Promise:f,PromisePrototypeThen:g,SymbolDispose:m}=n(4134),{isClosed:y,isReadable:b,isReadableNodeStream:v,isReadableStream:S,isReadableFinished:_,isReadableErrored:w,isWritable:k,isWritableNodeStream:I,isWritableStream:E,isWritableFinished:x,isWritableErrored:T,isNodeStream:C,willEmitClose:O,kIsClosedPromise:A}=n(6115);let P;const R=()=>{};function M(e,t,s){var p,f;if(2===arguments.length?(s=t,t=c):null==t?t=c:h(t,"options"),u(s,"callback"),d(t.signal,"options.signal"),s=l(s),S(e)||E(e))return function(e,t,s){let o=!1,a=R;if(t.signal)if(a=()=>{o=!0,s.call(e,new i(void 0,{cause:t.signal.reason}))},t.signal.aborted)r.nextTick(a);else{P=P||n(7760).addAbortListener;const r=P(t.signal,a),i=s;s=l((...t)=>{r[m](),i.apply(e,t)})}const c=(...t)=>{o||r.nextTick(()=>s.apply(e,t))};return g(e[A].promise,c,c),R}(e,t,s);if(!C(e))throw new o("stream",["ReadableStream","WritableStream","Stream"],e);const M=null!==(p=t.readable)&&void 0!==p?p:v(e),N=null!==(f=t.writable)&&void 0!==f?f:I(e),B=e._writableState,L=e._readableState,j=()=>{e.writable||F()};let D=O(e)&&v(e)===M&&I(e)===N,U=x(e,!1);const F=()=>{U=!0,e.destroyed&&(D=!1),(!D||e.readable&&!M)&&(M&&!$||s.call(e))};let $=_(e,!1);const W=()=>{$=!0,e.destroyed&&(D=!1),(!D||e.writable&&!N)&&(N&&!U||s.call(e))},V=t=>{s.call(e,t)};let z=y(e);const H=()=>{z=!0;const t=T(e)||w(e);return t&&"boolean"!=typeof t?s.call(e,t):M&&!$&&v(e,!0)&&!_(e,!1)?s.call(e,new a):!N||U||x(e,!1)?void s.call(e):s.call(e,new a)},q=()=>{z=!0;const t=T(e)||w(e);if(t&&"boolean"!=typeof t)return s.call(e,t);s.call(e)},G=()=>{e.req.on("finish",F)};!function(e){return e.setHeader&&"function"==typeof e.abort}(e)?N&&!B&&(e.on("end",j),e.on("close",j)):(e.on("complete",F),D||e.on("abort",H),e.req?G():e.on("request",G)),D||"boolean"!=typeof e.aborted||e.on("aborted",H),e.on("end",W),e.on("finish",F),!1!==t.error&&e.on("error",V),e.on("close",H),z?r.nextTick(H):null!=B&&B.errorEmitted||null!=L&&L.errorEmitted?D||r.nextTick(q):(M||D&&!b(e)||!U&&!1!==k(e))&&(N||D&&!k(e)||!$&&!1!==b(e))?L&&e.req&&e.aborted&&r.nextTick(q):r.nextTick(q);const K=()=>{s=R,e.removeListener("aborted",H),e.removeListener("complete",F),e.removeListener("abort",H),e.removeListener("request",G),e.req&&e.req.removeListener("finish",F),e.removeListener("end",j),e.removeListener("close",j),e.removeListener("finish",F),e.removeListener("end",W),e.removeListener("error",V),e.removeListener("close",H)};if(t.signal&&!z){const o=()=>{const n=s;K(),n.call(e,new i(void 0,{cause:t.signal.reason}))};if(t.signal.aborted)r.nextTick(o);else{P=P||n(7760).addAbortListener;const r=P(t.signal,o),i=s;s=l((...t)=>{r[m](),i.apply(e,t)})}}return K}e.exports=M,e.exports.finished=function(e,t){var n;let r=!1;return null===t&&(t=c),null!==(n=t)&&void 0!==n&&n.cleanup&&(p(t.cleanup,"cleanup"),r=t.cleanup),new f((n,i)=>{const s=M(e,t,e=>{r&&s(),e?i(e):n()})})}},6286(e,t,n){"use strict";const{Writable:r}=n(2203),i=n(2971),{BINARY_TYPES:s,EMPTY_BUFFER:o,kStatusCode:a,kWebSocket:c}=n(2614),{concat:l,toArrayBuffer:d,unmask:u}=n(3338),{isValidStatusCode:h,isValidUTF8:p}=n(5880),f=Buffer[Symbol.species];e.exports=class extends r{constructor(e={}){super(),this._allowSynchronousEvents=void 0===e.allowSynchronousEvents||e.allowSynchronousEvents,this._binaryType=e.binaryType||s[0],this._extensions=e.extensions||{},this._isServer=!!e.isServer,this._maxPayload=0|e.maxPayload,this._skipUTF8Validation=!!e.skipUTF8Validation,this[c]=void 0,this._bufferedBytes=0,this._buffers=[],this._compressed=!1,this._payloadLength=0,this._mask=void 0,this._fragmented=0,this._masked=!1,this._fin=!1,this._opcode=0,this._totalPayloadLength=0,this._messageLength=0,this._fragments=[],this._errored=!1,this._loop=!1,this._state=0}_write(e,t,n){if(8===this._opcode&&0==this._state)return n();this._bufferedBytes+=e.length,this._buffers.push(e),this.startLoop(n)}consume(e){if(this._bufferedBytes-=e,e===this._buffers[0].length)return this._buffers.shift();if(e<this._buffers[0].length){const t=this._buffers[0];return this._buffers[0]=new f(t.buffer,t.byteOffset+e,t.length-e),new f(t.buffer,t.byteOffset,e)}const t=Buffer.allocUnsafe(e);do{const n=this._buffers[0],r=t.length-e;e>=n.length?t.set(this._buffers.shift(),r):(t.set(new Uint8Array(n.buffer,n.byteOffset,e),r),this._buffers[0]=new f(n.buffer,n.byteOffset+e,n.length-e)),e-=n.length}while(e>0);return t}startLoop(e){this._loop=!0;do{switch(this._state){case 0:this.getInfo(e);break;case 1:this.getPayloadLength16(e);break;case 2:this.getPayloadLength64(e);break;case 3:this.getMask();break;case 4:this.getData(e);break;case 5:case 6:return void(this._loop=!1)}}while(this._loop);this._errored||e()}getInfo(e){if(this._bufferedBytes<2)return void(this._loop=!1);const t=this.consume(2);if(48&t[0]){return void e(this.createError(RangeError,"RSV2 and RSV3 must be clear",!0,1002,"WS_ERR_UNEXPECTED_RSV_2_3"))}const n=!(64&~t[0]);if(n&&!this._extensions[i.extensionName]){return void e(this.createError(RangeError,"RSV1 must be clear",!0,1002,"WS_ERR_UNEXPECTED_RSV_1"))}if(this._fin=!(128&~t[0]),this._opcode=15&t[0],this._payloadLength=127&t[1],0===this._opcode){if(n){return void e(this.createError(RangeError,"RSV1 must be clear",!0,1002,"WS_ERR_UNEXPECTED_RSV_1"))}if(!this._fragmented){return void e(this.createError(RangeError,"invalid opcode 0",!0,1002,"WS_ERR_INVALID_OPCODE"))}this._opcode=this._fragmented}else if(1===this._opcode||2===this._opcode){if(this._fragmented){return void e(this.createError(RangeError,`invalid opcode ${this._opcode}`,!0,1002,"WS_ERR_INVALID_OPCODE"))}this._compressed=n}else{if(!(this._opcode>7&&this._opcode<11)){return void e(this.createError(RangeError,`invalid opcode ${this._opcode}`,!0,1002,"WS_ERR_INVALID_OPCODE"))}if(!this._fin){return void e(this.createError(RangeError,"FIN must be set",!0,1002,"WS_ERR_EXPECTED_FIN"))}if(n){return void e(this.createError(RangeError,"RSV1 must be clear",!0,1002,"WS_ERR_UNEXPECTED_RSV_1"))}if(this._payloadLength>125||8===this._opcode&&1===this._payloadLength){return void e(this.createError(RangeError,`invalid payload length ${this._payloadLength}`,!0,1002,"WS_ERR_INVALID_CONTROL_PAYLOAD_LENGTH"))}}if(this._fin||this._fragmented||(this._fragmented=this._opcode),this._masked=!(128&~t[1]),this._isServer){if(!this._masked){return void e(this.createError(RangeError,"MASK must be set",!0,1002,"WS_ERR_EXPECTED_MASK"))}}else if(this._masked){return void e(this.createError(RangeError,"MASK must be clear",!0,1002,"WS_ERR_UNEXPECTED_MASK"))}126===this._payloadLength?this._state=1:127===this._payloadLength?this._state=2:this.haveLength(e)}getPayloadLength16(e){this._bufferedBytes<2?this._loop=!1:(this._payloadLength=this.consume(2).readUInt16BE(0),this.haveLength(e))}getPayloadLength64(e){if(this._bufferedBytes<8)return void(this._loop=!1);const t=this.consume(8),n=t.readUInt32BE(0);if(n>Math.pow(2,21)-1){return void e(this.createError(RangeError,"Unsupported WebSocket frame: payload length > 2^53 - 1",!1,1009,"WS_ERR_UNSUPPORTED_DATA_PAYLOAD_LENGTH"))}this._payloadLength=n*Math.pow(2,32)+t.readUInt32BE(4),this.haveLength(e)}haveLength(e){if(this._payloadLength&&this._opcode<8&&(this._totalPayloadLength+=this._payloadLength,this._totalPayloadLength>this._maxPayload&&this._maxPayload>0)){return void e(this.createError(RangeError,"Max payload size exceeded",!1,1009,"WS_ERR_UNSUPPORTED_MESSAGE_LENGTH"))}this._masked?this._state=3:this._state=4}getMask(){this._bufferedBytes<4?this._loop=!1:(this._mask=this.consume(4),this._state=4)}getData(e){let t=o;if(this._payloadLength){if(this._bufferedBytes<this._payloadLength)return void(this._loop=!1);t=this.consume(this._payloadLength),this._masked&&0!==(this._mask[0]|this._mask[1]|this._mask[2]|this._mask[3])&&u(t,this._mask)}if(this._opcode>7)this.controlMessage(t,e);else{if(this._compressed)return this._state=5,void this.decompress(t,e);t.length&&(this._messageLength=this._totalPayloadLength,this._fragments.push(t)),this.dataMessage(e)}}decompress(e,t){this._extensions[i.extensionName].decompress(e,this._fin,(e,n)=>{if(e)return t(e);if(n.length){if(this._messageLength+=n.length,this._messageLength>this._maxPayload&&this._maxPayload>0){const e=this.createError(RangeError,"Max payload size exceeded",!1,1009,"WS_ERR_UNSUPPORTED_MESSAGE_LENGTH");return void t(e)}this._fragments.push(n)}this.dataMessage(t),0===this._state&&this.startLoop(t)})}dataMessage(e){if(!this._fin)return void(this._state=0);const t=this._messageLength,n=this._fragments;if(this._totalPayloadLength=0,this._messageLength=0,this._fragmented=0,this._fragments=[],2===this._opcode){let r;r="nodebuffer"===this._binaryType?l(n,t):"arraybuffer"===this._binaryType?d(l(n,t)):"blob"===this._binaryType?new Blob(n):n,this._allowSynchronousEvents?(this.emit("message",r,!0),this._state=0):(this._state=6,setImmediate(()=>{this.emit("message",r,!0),this._state=0,this.startLoop(e)}))}else{const r=l(n,t);if(!this._skipUTF8Validation&&!p(r)){const t=this.createError(Error,"invalid UTF-8 sequence",!0,1007,"WS_ERR_INVALID_UTF8");return void e(t)}5===this._state||this._allowSynchronousEvents?(this.emit("message",r,!1),this._state=0):(this._state=6,setImmediate(()=>{this.emit("message",r,!1),this._state=0,this.startLoop(e)}))}}controlMessage(e,t){if(8!==this._opcode)this._allowSynchronousEvents?(this.emit(9===this._opcode?"ping":"pong",e),this._state=0):(this._state=6,setImmediate(()=>{this.emit(9===this._opcode?"ping":"pong",e),this._state=0,this.startLoop(t)}));else{if(0===e.length)this._loop=!1,this.emit("conclude",1005,o),this.end();else{const n=e.readUInt16BE(0);if(!h(n)){const e=this.createError(RangeError,`invalid status code ${n}`,!0,1002,"WS_ERR_INVALID_CLOSE_CODE");return void t(e)}const r=new f(e.buffer,e.byteOffset+2,e.length-2);if(!this._skipUTF8Validation&&!p(r)){const e=this.createError(Error,"invalid UTF-8 sequence",!0,1007,"WS_ERR_INVALID_UTF8");return void t(e)}this._loop=!1,this.emit("conclude",n,r),this.end()}this._state=0}}createError(e,t,n,r,i){this._loop=!1,this._errored=!0;const s=new e(n?`Invalid WebSocket frame: ${t}`:t);return Error.captureStackTrace(s,this.createError),s.code=i,s[a]=r,s}}},6329(e,t,n){"use strict";var r=this&&this.__createBinding||(Object.create?function(e,t,n,r){void 0===r&&(r=n);var i=Object.getOwnPropertyDescriptor(t,n);i&&!("get"in i?!t.__esModule:i.writable||i.configurable)||(i={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,r,i)}:function(e,t,n,r){void 0===r&&(r=n),e[r]=t[n]}),i=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),s=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&r(t,e,n);return i(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.Address6=void 0;const o=s(n(837)),a=s(n(9576)),c=s(n(8914)),l=s(n(465)),d=n(2839),u=n(321),h=n(2437),p=n(837);function f(e){if(!e)throw new Error("Assertion failed.")}function g(e){return e=(e=e.replace(/^(0{1,})([1-9]+)$/,'<span class="parse-error">$1</span>$2')).replace(/^(0{1,})(0)$/,'<span class="parse-error">$1</span>$2')}function m(e){return parseInt(e,16).toString(16).padStart(4,"0")}function y(e){return 255&e}class b{constructor(e,t){this.addressMinusSuffix="",this.parsedSubnet="",this.subnet="/128",this.subnetMask=128,this.v4=!1,this.zone="",this.isInSubnet=o.isInSubnet,this.isCorrect=o.isCorrect(c.BITS),this.groups=void 0===t?c.GROUPS:t,this.address=e;const n=c.RE_SUBNET_STRING.exec(e);if(n){if(this.parsedSubnet=n[0].replace("/",""),this.subnetMask=parseInt(this.parsedSubnet,10),this.subnet=`/${this.subnetMask}`,Number.isNaN(this.subnetMask)||this.subnetMask<0||this.subnetMask>c.BITS)throw new h.AddressError("Invalid subnet mask.");e=e.replace(c.RE_SUBNET_STRING,"")}else if(/\//.test(e))throw new h.AddressError("Invalid subnet mask.");const r=c.RE_ZONE_STRING.exec(e);r&&(this.zone=r[0],e=e.replace(c.RE_ZONE_STRING,"")),this.addressMinusSuffix=e,this.parsedAddress=this.parse(this.addressMinusSuffix)}static isValid(e){try{return new b(e),!0}catch(e){return!1}}static fromBigInt(e){const t=e.toString(16).padStart(32,"0"),n=[];let r;for(r=0;r<c.GROUPS;r++)n.push(t.slice(4*r,4*(r+1)));return new b(n.join(":"))}static fromURL(e){let t,n,r=null;if(-1!==e.indexOf("[")&&-1!==e.indexOf("]:")){if(n=c.RE_URL_WITH_PORT.exec(e),null===n)return{error:"failed to parse address with port",address:null,port:null};t=n[1],r=n[2]}else if(-1!==e.indexOf("/")){if(e=e.replace(/^[a-z0-9]+:\/\//,""),n=c.RE_URL.exec(e),null===n)return{error:"failed to parse address from URL",address:null,port:null};t=n[1]}else t=e;return r?(r=parseInt(r,10),(r<0||r>65536)&&(r=null)):r=null,{address:new b(t),port:r}}static fromAddress4(e){const t=new d.Address4(e),n=c.BITS-(a.BITS-t.subnetMask);return new b(`::ffff:${t.correctForm()}/${n}`)}static fromArpa(e){let t=e.replace(/(\.ip6\.arpa)?\.$/,"");if(63!==t.length)throw new h.AddressError("Invalid 'ip6.arpa' form.");const n=t.split(".").reverse();for(let e=7;e>0;e--){const t=4*e;n.splice(t,0,":")}return t=n.join(""),new b(t)}microsoftTranscription(){return`${this.correctForm().replace(/:/g,"-")}.ipv6-literal.net`}mask(e=this.subnetMask){return this.getBitsBase2(0,e)}possibleSubnets(e=128){const t=c.BITS-this.subnetMask-Math.abs(e-c.BITS);return t<0?"0":function(e){const t=/(\d+)(\d{3})/;for(;t.test(e);)e=e.replace(t,"$1,$2");return e}((BigInt("2")**BigInt(t)).toString(10))}_startAddress(){return BigInt(`0b${this.mask()+"0".repeat(c.BITS-this.subnetMask)}`)}startAddress(){return b.fromBigInt(this._startAddress())}startAddressExclusive(){const e=BigInt("1");return b.fromBigInt(this._startAddress()+e)}_endAddress(){return BigInt(`0b${this.mask()+"1".repeat(c.BITS-this.subnetMask)}`)}endAddress(){return b.fromBigInt(this._endAddress())}endAddressExclusive(){const e=BigInt("1");return b.fromBigInt(this._endAddress()-e)}getScope(){let e=c.SCOPES[parseInt(this.getBits(12,16).toString(10),10)];return"Global unicast"===this.getType()&&"Link local"!==e&&(e="Global"),e||"Unknown"}getType(){for(const e of Object.keys(c.TYPES))if(this.isInSubnet(new b(e)))return c.TYPES[e];return"Global unicast"}getBits(e,t){return BigInt(`0b${this.getBitsBase2(e,t)}`)}getBitsBase2(e,t){return this.binaryZeroPad().slice(e,t)}getBitsBase16(e,t){const n=t-e;if(n%4!=0)throw new Error("Length of bits to retrieve must be divisible by four");return this.getBits(e,t).toString(16).padStart(n/4,"0")}getBitsPastSubnet(){return this.getBitsBase2(this.subnetMask,c.BITS)}reverseForm(e){e||(e={});const t=Math.floor(this.subnetMask/4),n=this.canonicalForm().replace(/:/g,"").split("").slice(0,t).reverse().join(".");return t>0?e.omitSuffix?n:`${n}.ip6.arpa.`:e.omitSuffix?"":"ip6.arpa."}correctForm(){let e,t=[],n=0;const r=[];for(e=0;e<this.parsedAddress.length;e++){const t=parseInt(this.parsedAddress[e],16);0===t&&n++,0!==t&&n>0&&(n>1&&r.push([e-n,e-1]),n=0)}n>1&&r.push([this.parsedAddress.length-n,this.parsedAddress.length-1]);const i=r.map(e=>e[1]-e[0]+1);if(r.length>0){const e=i.indexOf(Math.max(...i));t=function(e,t){const n=[],r=[];let i;for(i=0;i<e.length;i++)i<t[0]?n.push(e[i]):i>t[1]&&r.push(e[i]);return n.concat(["compact"]).concat(r)}(this.parsedAddress,r[e])}else t=this.parsedAddress;for(e=0;e<t.length;e++)"compact"!==t[e]&&(t[e]=parseInt(t[e],16).toString(16));let s=t.join(":");return s=s.replace(/^compact$/,"::"),s=s.replace(/(^compact)|(compact$)/,":"),s=s.replace(/compact/,""),s}binaryZeroPad(){return this.bigInt().toString(2).padStart(c.BITS,"0")}parse4in6(e){const t=e.split(":"),n=t.slice(-1)[0].match(a.RE_ADDRESS);if(n){this.parsedAddress4=n[0],this.address4=new d.Address4(this.parsedAddress4);for(let t=0;t<this.address4.groups;t++)if(/^0[0-9]+/.test(this.address4.parsedAddress[t]))throw new h.AddressError("IPv4 addresses can't have leading zeroes.",e.replace(a.RE_ADDRESS,this.address4.parsedAddress.map(g).join(".")));this.v4=!0,t[t.length-1]=this.address4.toGroup6(),e=t.join(":")}return e}parse(e){const t=(e=this.parse4in6(e)).match(c.RE_BAD_CHARACTERS);if(t)throw new h.AddressError(`Bad character${t.length>1?"s":""} detected in address: ${t.join("")}`,e.replace(c.RE_BAD_CHARACTERS,'<span class="parse-error">$1</span>'));const n=e.match(c.RE_BAD_ADDRESS);if(n)throw new h.AddressError(`Address failed regex: ${n.join("")}`,e.replace(c.RE_BAD_ADDRESS,'<span class="parse-error">$1</span>'));let r=[];const i=e.split("::");if(2===i.length){let e=i[0].split(":"),t=i[1].split(":");1===e.length&&""===e[0]&&(e=[]),1===t.length&&""===t[0]&&(t=[]);const n=this.groups-(e.length+t.length);if(!n)throw new h.AddressError("Error parsing groups");this.elidedGroups=n,this.elisionBegin=e.length,this.elisionEnd=e.length+this.elidedGroups,r=r.concat(e);for(let e=0;e<n;e++)r.push("0");r=r.concat(t)}else{if(1!==i.length)throw new h.AddressError("Too many :: groups found");r=e.split(":"),this.elidedGroups=0}if(r=r.map(e=>parseInt(e,16).toString(16)),r.length!==this.groups)throw new h.AddressError("Incorrect number of groups found");return r}canonicalForm(){return this.parsedAddress.map(m).join(":")}decimal(){return this.parsedAddress.map(e=>parseInt(e,16).toString(10).padStart(5,"0")).join(":")}bigInt(){return BigInt(`0x${this.parsedAddress.map(m).join("")}`)}to4(){const e=this.binaryZeroPad().split("");return d.Address4.fromHex(BigInt(`0b${e.slice(96,128).join("")}`).toString(16))}to4in6(){const e=this.to4(),t=new b(this.parsedAddress.slice(0,6).join(":"),6).correctForm();let n="";return/:$/.test(t)||(n=":"),t+n+e.address}inspectTeredo(){const e=this.getBitsBase16(0,32),t=(this.getBits(80,96)^BigInt("0xffff")).toString(),n=d.Address4.fromHex(this.getBitsBase16(32,64)),r=this.getBits(96,128),i=d.Address4.fromHex((r^BigInt("0xffffffff")).toString(16)),s=this.getBitsBase2(64,80),o=(0,p.testBit)(s,15),a=(0,p.testBit)(s,14),c=(0,p.testBit)(s,8),l=(0,p.testBit)(s,9),u=BigInt(`0b${s.slice(2,6)+s.slice(8,16)}`).toString(10);return{prefix:`${e.slice(0,4)}:${e.slice(4,8)}`,server4:n.address,client4:i.address,flags:s,coneNat:o,microsoft:{reserved:a,universalLocal:l,groupIndividual:c,nonce:u},udpPort:t}}inspect6to4(){const e=this.getBitsBase16(0,16),t=d.Address4.fromHex(this.getBitsBase16(16,48));return{prefix:e.slice(0,4),gateway:t.address}}to6to4(){if(!this.is4())return null;const e=["2002",this.getBitsBase16(96,112),this.getBitsBase16(112,128),"","/16"].join(":");return new b(e)}toByteArray(){const e=this.bigInt().toString(16),t=`${"0".repeat(e.length%2)}${e}`,n=[];for(let e=0,r=t.length;e<r;e+=2)n.push(parseInt(t.substring(e,e+2),16));return n}toUnsignedByteArray(){return this.toByteArray().map(y)}static fromByteArray(e){return this.fromUnsignedByteArray(e.map(y))}static fromUnsignedByteArray(e){const t=BigInt("256");let n=BigInt("0"),r=BigInt("1");for(let i=e.length-1;i>=0;i--)n+=r*BigInt(e[i].toString(10)),r*=t;return b.fromBigInt(n)}isCanonical(){return this.addressMinusSuffix===this.canonicalForm()}isLinkLocal(){return"1111111010000000000000000000000000000000000000000000000000000000"===this.getBitsBase2(0,64)}isMulticast(){return"Multicast"===this.getType()}is4(){return this.v4}isTeredo(){return this.isInSubnet(new b("2001::/32"))}is6to4(){return this.isInSubnet(new b("2002::/16"))}isLoopback(){return"Loopback"===this.getType()}href(e){return e=void 0===e?"":`:${e}`,`http://[${this.correctForm()}]${e}/`}link(e){e||(e={}),void 0===e.className&&(e.className=""),void 0===e.prefix&&(e.prefix="/#address="),void 0===e.v4&&(e.v4=!1);let t=this.correctForm;e.v4&&(t=this.to4in6);const n=t.call(this);return e.className?`<a href="${e.prefix}${n}" class="${e.className}">${n}</a>`:`<a href="${e.prefix}${n}">${n}</a>`}group(){if(0===this.elidedGroups)return l.simpleGroup(this.address).join(":");f("number"==typeof this.elidedGroups),f("number"==typeof this.elisionBegin);const e=[],[t,n]=this.address.split("::");t.length?e.push(...l.simpleGroup(t)):e.push("");const r=["hover-group"];for(let e=this.elisionBegin;e<this.elisionBegin+this.elidedGroups;e++)r.push(`group-${e}`);return e.push(`<span class="${r.join(" ")}"></span>`),n.length?e.push(...l.simpleGroup(n,this.elisionEnd)):e.push(""),this.is4()&&(f(this.address4 instanceof d.Address4),e.pop(),e.push(this.address4.groupForV6())),e.join(":")}regularExpressionString(e=!1){let t=[];const n=new b(this.correctForm());if(0===n.elidedGroups)t.push((0,u.simpleRegularExpression)(n.parsedAddress));else if(n.elidedGroups===c.GROUPS)t.push((0,u.possibleElisions)(c.GROUPS));else{const e=n.address.split("::");e[0].length&&t.push((0,u.simpleRegularExpression)(e[0].split(":"))),f("number"==typeof n.elidedGroups),t.push((0,u.possibleElisions)(n.elidedGroups,0!==e[0].length,0!==e[1].length)),e[1].length&&t.push((0,u.simpleRegularExpression)(e[1].split(":"))),t=[t.join(":")]}return e||(t=["(?=^|",u.ADDRESS_BOUNDARY,"|[^\\w\\:])(",...t,")(?=[^\\w\\:]|",u.ADDRESS_BOUNDARY,"|$)"]),t.join("")}regularExpression(e=!1){return new RegExp(this.regularExpressionString(e),"i")}}t.Address6=b},6371(e,t,n){"use strict";const{format:r,inspect:i}=n(9231),{AggregateError:s}=n(4134),o=globalThis.AggregateError||s,a=Symbol("kIsNodeError"),c=["string","function","number","object","Function","Object","boolean","bigint","symbol"],l=/^([A-Z][a-z0-9]*)+$/,d={};function u(e,t){if(!e)throw new d.ERR_INTERNAL_ASSERTION(t)}function h(e){let t="",n=e.length;const r="-"===e[0]?1:0;for(;n>=r+4;n-=3)t=`_${e.slice(n-3,n)}${t}`;return`${e.slice(0,n)}${t}`}function p(e,t,n){n||(n=Error);class i extends n{constructor(...n){super(function(e,t,n){if("function"==typeof t)return u(t.length<=n.length,`Code: ${e}; The provided arguments length (${n.length}) does not match the required ones (${t.length}).`),t(...n);const i=(t.match(/%[dfijoOs]/g)||[]).length;return u(i===n.length,`Code: ${e}; The provided arguments length (${n.length}) does not match the required ones (${i}).`),0===n.length?t:r(t,...n)}(e,t,n))}toString(){return`${this.name} [${e}]: ${this.message}`}}Object.defineProperties(i.prototype,{name:{value:n.name,writable:!0,enumerable:!1,configurable:!0},toString:{value(){return`${this.name} [${e}]: ${this.message}`},writable:!0,enumerable:!1,configurable:!0}}),i.prototype.code=e,i.prototype[a]=!0,d[e]=i}function f(e){const t="__node_internal_"+e.name;return Object.defineProperty(e,"name",{value:t}),e}class g extends Error{constructor(e="The operation was aborted",t=void 0){if(void 0!==t&&"object"!=typeof t)throw new d.ERR_INVALID_ARG_TYPE("options","Object",t);super(e,t),this.code="ABORT_ERR",this.name="AbortError"}}p("ERR_ASSERTION","%s",Error),p("ERR_INVALID_ARG_TYPE",(e,t,n)=>{u("string"==typeof e,"'name' must be a string"),Array.isArray(t)||(t=[t]);let r="The ";e.endsWith(" argument")?r+=`${e} `:r+=`"${e}" ${e.includes(".")?"property":"argument"} `,r+="must be ";const s=[],o=[],a=[];for(const e of t)u("string"==typeof e,"All expected entries have to be of type string"),c.includes(e)?s.push(e.toLowerCase()):l.test(e)?o.push(e):(u("object"!==e,'The value "object" should be written as "Object"'),a.push(e));if(o.length>0){const e=s.indexOf("object");-1!==e&&(s.splice(s,e,1),o.push("Object"))}if(s.length>0){switch(s.length){case 1:r+=`of type ${s[0]}`;break;case 2:r+=`one of type ${s[0]} or ${s[1]}`;break;default:{const e=s.pop();r+=`one of type ${s.join(", ")}, or ${e}`}}(o.length>0||a.length>0)&&(r+=" or ")}if(o.length>0){switch(o.length){case 1:r+=`an instance of ${o[0]}`;break;case 2:r+=`an instance of ${o[0]} or ${o[1]}`;break;default:{const e=o.pop();r+=`an instance of ${o.join(", ")}, or ${e}`}}a.length>0&&(r+=" or ")}switch(a.length){case 0:break;case 1:a[0].toLowerCase()!==a[0]&&(r+="an "),r+=`${a[0]}`;break;case 2:r+=`one of ${a[0]} or ${a[1]}`;break;default:{const e=a.pop();r+=`one of ${a.join(", ")}, or ${e}`}}if(null==n)r+=`. Received ${n}`;else if("function"==typeof n&&n.name)r+=`. Received function ${n.name}`;else if("object"==typeof n){var d;if(null!==(d=n.constructor)&&void 0!==d&&d.name)r+=`. Received an instance of ${n.constructor.name}`;else{r+=`. Received ${i(n,{depth:-1})}`}}else{let e=i(n,{colors:!1});e.length>25&&(e=`${e.slice(0,25)}...`),r+=`. Received type ${typeof n} (${e})`}return r},TypeError),p("ERR_INVALID_ARG_VALUE",(e,t,n="is invalid")=>{let r=i(t);r.length>128&&(r=r.slice(0,128)+"...");return`The ${e.includes(".")?"property":"argument"} '${e}' ${n}. Received ${r}`},TypeError),p("ERR_INVALID_RETURN_VALUE",(e,t,n)=>{var r;return`Expected ${e} to be returned from the "${t}" function but got ${null!=n&&null!==(r=n.constructor)&&void 0!==r&&r.name?`instance of ${n.constructor.name}`:"type "+typeof n}.`},TypeError),p("ERR_MISSING_ARGS",(...e)=>{let t;u(e.length>0,"At least one arg needs to be specified");const n=e.length;switch(e=(Array.isArray(e)?e:[e]).map(e=>`"${e}"`).join(" or "),n){case 1:t+=`The ${e[0]} argument`;break;case 2:t+=`The ${e[0]} and ${e[1]} arguments`;break;default:{const n=e.pop();t+=`The ${e.join(", ")}, and ${n} arguments`}}return`${t} must be specified`},TypeError),p("ERR_OUT_OF_RANGE",(e,t,n)=>{let r;if(u(t,'Missing "range" argument'),Number.isInteger(n)&&Math.abs(n)>2**32)r=h(String(n));else if("bigint"==typeof n){r=String(n);const e=BigInt(2)**BigInt(32);(n>e||n<-e)&&(r=h(r)),r+="n"}else r=i(n);return`The value of "${e}" is out of range. It must be ${t}. Received ${r}`},RangeError),p("ERR_MULTIPLE_CALLBACK","Callback called multiple times",Error),p("ERR_METHOD_NOT_IMPLEMENTED","The %s method is not implemented",Error),p("ERR_STREAM_ALREADY_FINISHED","Cannot call %s after a stream was finished",Error),p("ERR_STREAM_CANNOT_PIPE","Cannot pipe, not readable",Error),p("ERR_STREAM_DESTROYED","Cannot call %s after a stream was destroyed",Error),p("ERR_STREAM_NULL_VALUES","May not write null values to stream",TypeError),p("ERR_STREAM_PREMATURE_CLOSE","Premature close",Error),p("ERR_STREAM_PUSH_AFTER_EOF","stream.push() after EOF",Error),p("ERR_STREAM_UNSHIFT_AFTER_END_EVENT","stream.unshift() after end event",Error),p("ERR_STREAM_WRITE_AFTER_END","write after end",Error),p("ERR_UNKNOWN_ENCODING","Unknown encoding: %s",TypeError),e.exports={AbortError:g,aggregateTwoErrors:f(function(e,t){if(e&&t&&e!==t){if(Array.isArray(t.errors))return t.errors.push(e),t;const n=new o([t,e],t.message);return n.code=t.code,n}return e||t}),hideStackFrames:f,codes:d}},6524(e,t,n){"use strict";const{ObjectSetPrototypeOf:r}=n(4134);e.exports=s;const i=n(7382);function s(e){if(!(this instanceof s))return new s(e);i.call(this,e)}r(s.prototype,i.prototype),r(s,i),s.prototype._transform=function(e,t,n){n(null,e)}},6532(e,t,n){"use strict";const r=n(4422),{PromisePrototypeThen:i,SymbolAsyncIterator:s,SymbolIterator:o}=n(4134),{Buffer:a}=n(181),{ERR_INVALID_ARG_TYPE:c,ERR_STREAM_NULL_VALUES:l}=n(6371).codes;e.exports=function(e,t,n){let d,u;if("string"==typeof t||t instanceof a)return new e({objectMode:!0,...n,read(){this.push(t),this.push(null)}});if(t&&t[s])u=!0,d=t[s]();else{if(!t||!t[o])throw new c("iterable",["Iterable"],t);u=!1,d=t[o]()}const h=new e({objectMode:!0,highWaterMark:1,...n});let p=!1;return h._read=function(){p||(p=!0,async function(){for(;;){try{const{value:e,done:t}=u?await d.next():d.next();if(t)h.push(null);else{const t=e&&"function"==typeof e.then?await e:e;if(null===t)throw p=!1,new l;if(h.push(t))continue;p=!1}}catch(e){h.destroy(e)}break}}())},h._destroy=function(e,t){i(async function(e){const t=null!=e,n="function"==typeof d.throw;if(t&&n){const{value:t,done:n}=await d.throw(e);if(await t,n)return}if("function"==typeof d.return){const{value:e}=await d.return();await e}}(e),()=>r.nextTick(t,e),n=>r.nextTick(t,n||e))},h}},6584(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(4988);class i extends r.EventTarget{constructor(){throw super(),new TypeError("AbortSignal cannot be constructed directly")}get aborted(){const e=s.get(this);if("boolean"!=typeof e)throw new TypeError("Expected 'this' to be an 'AbortSignal' object, but got "+(null===this?"null":typeof this));return e}}r.defineEventAttribute(i.prototype,"abort");const s=new WeakMap;Object.defineProperties(i.prototype,{aborted:{enumerable:!0}}),"function"==typeof Symbol&&"symbol"==typeof Symbol.toStringTag&&Object.defineProperty(i.prototype,Symbol.toStringTag,{configurable:!0,value:"AbortSignal"});class o{constructor(){a.set(this,function(){const e=Object.create(i.prototype);return r.EventTarget.call(e),s.set(e,!1),e}())}get signal(){return c(this)}abort(){var e;e=c(this),!1===s.get(e)&&(s.set(e,!0),e.dispatchEvent({type:"abort"}))}}const a=new WeakMap;function c(e){const t=a.get(e);if(null==t)throw new TypeError("Expected 'this' to be an 'AbortController' object, but got "+(null===e?"null":typeof e));return t}Object.defineProperties(o.prototype,{signal:{enumerable:!0},abort:{enumerable:!0}}),"function"==typeof Symbol&&"symbol"==typeof Symbol.toStringTag&&Object.defineProperty(o.prototype,Symbol.toStringTag,{configurable:!0,value:"AbortController"}),t.AbortController=o,t.AbortSignal=i,t.default=o,e.exports=o,e.exports.AbortController=e.exports.default=o,e.exports.AbortSignal=i},6585(e){var t=1e3,n=60*t,r=60*n,i=24*r,s=7*i,o=365.25*i;function a(e,t,n,r){var i=t>=1.5*n;return Math.round(e/n)+" "+r+(i?"s":"")}e.exports=function(e,c){c=c||{};var l=typeof e;if("string"===l&&e.length>0)return function(e){if((e=String(e)).length>100)return;var a=/^(-?(?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)?$/i.exec(e);if(!a)return;var c=parseFloat(a[1]);switch((a[2]||"ms").toLowerCase()){case"years":case"year":case"yrs":case"yr":case"y":return c*o;case"weeks":case"week":case"w":return c*s;case"days":case"day":case"d":return c*i;case"hours":case"hour":case"hrs":case"hr":case"h":return c*r;case"minutes":case"minute":case"mins":case"min":case"m":return c*n;case"seconds":case"second":case"secs":case"sec":case"s":return c*t;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return c;default:return}}(e);if("number"===l&&isFinite(e))return c.long?function(e){var s=Math.abs(e);if(s>=i)return a(e,s,i,"day");if(s>=r)return a(e,s,r,"hour");if(s>=n)return a(e,s,n,"minute");if(s>=t)return a(e,s,t,"second");return e+" ms"}(e):function(e){var s=Math.abs(e);if(s>=i)return Math.round(e/i)+"d";if(s>=r)return Math.round(e/r)+"h";if(s>=n)return Math.round(e/n)+"m";if(s>=t)return Math.round(e/t)+"s";return e+"ms"}(e);throw new Error("val is not a non-empty string or a valid number. val="+JSON.stringify(e))}},6687(e,t,n){"use strict";var r,i=this&&this.__createBinding||(Object.create?function(e,t,n,r){void 0===r&&(r=n);var i=Object.getOwnPropertyDescriptor(t,n);i&&!("get"in i?!t.__esModule:i.writable||i.configurable)||(i={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,r,i)}:function(e,t,n,r){void 0===r&&(r=n),e[r]=t[n]}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),o=this&&this.__importStar||(r=function(e){return r=Object.getOwnPropertyNames||function(e){var t=[];for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[t.length]=n);return t},r(e)},function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n=r(e),o=0;o<n.length;o++)"default"!==n[o]&&i(t,e,n[o]);return s(t,e),t});Object.defineProperty(t,"__esModule",{value:!0}),t.SpatialReasoningEngine=void 0;const a=o(n(7562)),c=n(1554),{systemManager:l}=a.default;t.SpatialReasoningEngine=class{config;console;topology=null;llmDevice=null;contextChunks=[];topologyContextCache=null;contextCacheTime=0;landmarkSuggestions=new Map;constructor(e,t){this.config=e,this.console=t}updateTopology(e){this.topology=e,this.rebuildContextChunks(),this.topologyContextCache=null,this.contextCacheTime=0}rebuildContextChunks(){if(this.topology){this.contextChunks=[],this.topology.property&&this.contextChunks.push({id:"property",type:"property",content:this.buildPropertyContext(),metadata:{...this.topology.property}});for(const e of this.topology.cameras)this.contextChunks.push({id:`camera_${e.deviceId}`,type:"camera",content:this.buildCameraContext(e),metadata:{deviceId:e.deviceId,name:e.name,isEntryPoint:e.isEntryPoint,isExitPoint:e.isExitPoint}});for(const e of this.topology.landmarks||[])this.contextChunks.push({id:`landmark_${e.id}`,type:"landmark",content:this.buildLandmarkContext(e),metadata:{id:e.id,name:e.name,type:e.type,isEntryPoint:e.isEntryPoint,isExitPoint:e.isExitPoint}});for(const e of this.topology.connections)this.contextChunks.push({id:`connection_${e.id}`,type:"connection",content:this.buildConnectionContext(e),metadata:{id:e.id,fromCameraId:e.fromCameraId,toCameraId:e.toCameraId}});this.console.log(`Built ${this.contextChunks.length} context chunks for spatial reasoning`)}}buildPropertyContext(){if(!this.topology?.property)return"";const e=this.topology.property,t=[];return e.propertyType&&t.push(`Property type: ${e.propertyType}`),e.description&&t.push(e.description),e.frontFacing&&t.push(`Front faces ${e.frontFacing}`),e.features?.length&&t.push(`Features: ${e.features.join(", ")}`),t.join(". ")}buildCameraContext(e){const t=[`Camera: ${e.name}`];if(e.context?.mountLocation&&t.push(`Mounted at: ${e.context.mountLocation}`),e.context?.coverageDescription&&t.push(`Coverage: ${e.context.coverageDescription}`),e.context?.mountHeight&&t.push(`Height: ${e.context.mountHeight} feet`),e.isEntryPoint&&t.push("Watches property entry point"),e.isExitPoint&&t.push("Watches property exit point"),this.topology&&e.context?.visibleLandmarks?.length){const n=e.context.visibleLandmarks.map(e=>(0,c.findLandmark)(this.topology,e)?.name).filter(Boolean);n.length&&t.push(`Can see: ${n.join(", ")}`)}return t.join(". ")}buildLandmarkContext(e){const t=[`${e.name} (${e.type})`];if(e.description&&t.push(e.description),e.isEntryPoint&&t.push("Property entry point"),e.isExitPoint&&t.push("Property exit point"),this.topology&&e.adjacentTo?.length){const n=e.adjacentTo.map(e=>(0,c.findLandmark)(this.topology,e)?.name).filter(Boolean);n.length&&t.push(`Adjacent to: ${n.join(", ")}`)}return t.join(". ")}buildConnectionContext(e){if(!this.topology)return"";const t=(0,c.findCamera)(this.topology,e.fromCameraId),n=(0,c.findCamera)(this.topology,e.toCameraId);if(!t||!n)return"";const r=[`Path from ${t.name} to ${n.name}`];e.name&&r.push(`Called: ${e.name}`);const i=Math.round(e.transitTime.typical/1e3);if(r.push(`Typical transit: ${i} seconds`),e.bidirectional&&r.push("Bidirectional path"),e.pathLandmarks?.length){const t=e.pathLandmarks.map(e=>(0,c.findLandmark)(this.topology,e)?.name).filter(Boolean);t.length&&r.push(`Passes: ${t.join(" → ")}`)}return r.join(". ")}getTopologyContext(){const e=Date.now();return this.topologyContextCache&&e-this.contextCacheTime<this.config.contextCacheTtl?this.topologyContextCache:this.topology?(this.topologyContextCache=(0,c.generateTopologyDescription)(this.topology),this.contextCacheTime=e,this.topologyContextCache):""}retrieveRelevantContext(e,t){const n=[],r=this.contextChunks.find(e=>"property"===e.type);r&&n.push(r);const i=this.contextChunks.find(t=>t.id===`camera_${e}`),s=this.contextChunks.find(e=>e.id===`camera_${t}`);i&&n.push(i),s&&n.push(s);const o=this.contextChunks.find(n=>"connection"===n.type&&(n.metadata.fromCameraId===e&&n.metadata.toCameraId===t||n.metadata.fromCameraId===t&&n.metadata.toCameraId===e));if(o&&n.push(o),this.topology){const r=(0,c.getLandmarksVisibleFromCamera)(this.topology,e),i=(0,c.getLandmarksVisibleFromCamera)(this.topology,t),s=new Set([...r.map(e=>e.id),...i.map(e=>e.id)]);for(const e of s){const t=this.contextChunks.find(t=>t.id===`landmark_${e}`);t&&n.push(t)}}return n}async findLlmDevice(){if(this.llmDevice)return this.llmDevice;try{for(const e of Object.keys(l.getSystemState())){const t=l.getDeviceById(e);if(t?.interfaces?.includes(a.ScryptedInterface.ObjectDetection)){const e=t.name?.toLowerCase()||"";if(e.includes("llm")||e.includes("gpt")||e.includes("claude")||e.includes("ollama")||e.includes("gemini"))return this.llmDevice=t,this.console.log(`Found LLM device: ${t.name}`),this.llmDevice}}}catch(e){this.console.warn("Error finding LLM device:",e)}return null}async generateMovementDescription(e,t,n,r,i){if(!this.topology)return{description:`${e.className} moving between cameras`,involvedLandmarks:[],confidence:.5,usedLlm:!1};const s=(0,c.findCamera)(this.topology,t),o=(0,c.findCamera)(this.topology,n);if(!s||!o)return{description:`${e.className} moving between cameras`,involvedLandmarks:[],confidence:.5,usedLlm:!1};const a=(0,c.getLandmarksVisibleFromCamera)(this.topology,t),l=(0,c.getLandmarksVisibleFromCamera)(this.topology,n),d=[...new Set([...a,...l])];let u=this.buildBasicDescription(e,s,o,r,a,l);if(this.config.enableLlm&&i){const t=await this.getLlmEnhancedDescription(e,s,o,r,a,l,i);if(t)return{description:t,involvedLandmarks:d,pathDescription:this.buildPathDescription(s,o),confidence:.9,usedLlm:!0}}return{description:u,involvedLandmarks:d,pathDescription:this.buildPathDescription(s,o),confidence:.7,usedLlm:!1}}buildBasicDescription(e,t,n,r,i,s){const o=this.capitalizeFirst(e.className),a=Math.round(r/1e3);let c=t.name;if(i.length>0){c=`near ${i[0].name}`}else t.context?.coverageDescription&&(c=t.context.coverageDescription.split(".")[0]);let l=n.name;if(s.length>0){l=`towards ${s[0].name}`}else n.context?.coverageDescription&&(l=`towards ${n.context.coverageDescription.split(".")[0]}`);return`${o} moving from ${c} ${l}${a>0?` (${a}s)`:""}`}buildPathDescription(e,t){if(!this.topology)return;const n=(0,c.findConnection)(this.topology,e.deviceId,t.deviceId);if(n){if(n.pathLandmarks?.length){const e=n.pathLandmarks.map(e=>(0,c.findLandmark)(this.topology,e)?.name).filter(Boolean);if(e.length)return`Via ${e.join(" → ")}`}return n.name||void 0}}async getLlmEnhancedDescription(e,t,n,r,i,s,o){const a=await this.findLlmDevice();if(!a)return null;try{const c=this.retrieveRelevantContext(t.deviceId,n.deviceId).map(e=>e.content).join("\n\n"),l=this.buildLlmPrompt(e,t,n,r,i,s,c),d=await a.detectObjects(o,{settings:{prompt:l}});return d.detections?.[0]?.label?d.detections[0].label:null}catch(e){return this.console.warn("LLM description generation failed:",e),null}}buildLlmPrompt(e,t,n,r,i,s,o){const a=Math.round(r/1e3);return`You are a security camera system describing movement on a property.\n\nPROPERTY CONTEXT:\n${o}\n\nCURRENT EVENT:\n- Object type: ${e.className}\n- Moving from: ${t.name}${i.length?` (near ${i.map(e=>e.name).join(", ")})`:""}\n- Moving to: ${n.name}${s.length?` (near ${s.map(e=>e.name).join(", ")})`:""}\n- Transit time: ${a} seconds\n\nINSTRUCTIONS:\nGenerate a single, concise sentence describing this movement. Include:\n1. Description of the ${e.className} (if person: gender, clothing; if vehicle: color, type)\n2. Where they came from (using landmark names if available)\n3. Where they're heading (using landmark names if available)\n\nExamples of good descriptions:\n- "Man in blue jacket walking from the driveway towards the front door"\n- "Black SUV pulling into the driveway from the street"\n- "Woman with dog walking from the backyard towards the side gate"\n- "Delivery person approaching the front porch from the mailbox"\n\nGenerate ONLY the description, nothing else:`}async suggestLandmark(e,t,n,r){if(!this.config.enableLandmarkLearning)return null;const i=await this.findLlmDevice();if(!i)return null;try{const s=`Analyze this security camera image. A ${n} was detected.\n\nLooking at the surroundings and environment, identify any notable landmarks or features visible that could help describe this location. Consider:\n- Structures (house, garage, shed, porch)\n- Features (mailbox, tree, pool, garden)\n- Access points (driveway, walkway, gate, door)\n- Boundaries (fence, wall, hedge)\n\nIf you can identify a clear landmark feature, respond with ONLY a JSON object:\n{"name": "Landmark Name", "type": "structure|feature|boundary|access|vehicle|neighbor|zone|street", "description": "Brief description"}\n\nIf no clear landmark is identifiable, respond with: {"name": null}`,o=await i.detectObjects(t,{settings:{prompt:s}});if(o.detections?.[0]?.label)try{const t=JSON.parse(o.detections[0].label);if(t.name&&t.type){const n=`suggest_${Date.now()}_${Math.random().toString(36).slice(2,8)}`,i={id:n,landmark:{id:`landmark_${Date.now()}`,name:t.name,type:t.type,position:r,description:t.description,aiSuggested:!0,aiConfidence:.7,visibleFromCameras:[e]},detectedByCameras:[e],timestamp:Date.now(),detectionCount:1,status:"pending"},s=this.findSimilarSuggestion(t.name,r);if(s){const t=this.landmarkSuggestions.get(s);return t.detectionCount++,t.landmark.aiConfidence=Math.min(.95,t.landmark.aiConfidence+.05),t.detectedByCameras.includes(e)||t.detectedByCameras.push(e),t}return this.landmarkSuggestions.set(n,i),i}}catch(e){}return null}catch(e){return this.console.warn("Landmark suggestion failed:",e),null}}findSimilarSuggestion(e,t){const n=e.toLowerCase();for(const[e,r]of this.landmarkSuggestions){if("pending"!==r.status)continue;const i=r.landmark.name.toLowerCase(),s=Math.sqrt(Math.pow(r.landmark.position.x-t.x,2)+Math.pow(r.landmark.position.y-t.y,2));if((i.includes(n)||n.includes(i))&&s<100)return e}return null}getPendingSuggestions(){return Array.from(this.landmarkSuggestions.values()).filter(e=>"pending"===e.status&&e.landmark.aiConfidence>=this.config.landmarkConfidenceThreshold).sort((e,t)=>t.detectionCount-e.detectionCount)}acceptSuggestion(e){const t=this.landmarkSuggestions.get(e);if(!t)return null;t.status="accepted";const n={...t.landmark};return n.aiSuggested=!1,this.landmarkSuggestions.delete(e),n}rejectSuggestion(e){const t=this.landmarkSuggestions.get(e);return!!t&&(t.status="rejected",this.landmarkSuggestions.delete(e),!0)}capitalizeFirst(e){return e?e.charAt(0).toUpperCase()+e.slice(1):"Object"}getLandmarkTemplates(){return c.LANDMARK_TEMPLATES}}},6698(e){"function"==typeof Object.create?e.exports=function(e,t){t&&(e.super_=t,e.prototype=Object.create(t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}))}:e.exports=function(e,t){if(t){e.super_=t;var n=function(){};n.prototype=t.prototype,e.prototype=new n,e.prototype.constructor=e}}},6706(e,t,n){const r=n(4422),i=n(181),{isReadable:s,isWritable:o,isIterable:a,isNodeStream:c,isReadableNodeStream:l,isWritableNodeStream:d,isDuplexNodeStream:u,isReadableStream:h,isWritableStream:p}=n(6115),f=n(6238),{AbortError:g,codes:{ERR_INVALID_ARG_TYPE:m,ERR_INVALID_RETURN_VALUE:y}}=n(6371),{destroyer:b}=n(5896),v=n(3370),S=n(7576),_=n(8584),{createDeferredPromise:w}=n(7760),k=n(6532),I=globalThis.Blob||i.Blob,E="undefined"!=typeof I?function(e){return e instanceof I}:function(e){return!1},x=globalThis.AbortController||n(6584).AbortController,{FunctionPrototypeCall:T}=n(4134);class C extends v{constructor(e){super(e),!1===(null==e?void 0:e.readable)&&(this._readableState.readable=!1,this._readableState.ended=!0,this._readableState.endEmitted=!0),!1===(null==e?void 0:e.writable)&&(this._writableState.writable=!1,this._writableState.ending=!0,this._writableState.ended=!0,this._writableState.finished=!0)}}function O(e){const t=e.readable&&"function"!=typeof e.readable.read?S.wrap(e.readable):e.readable,n=e.writable;let r,i,a,c,l,d=!!s(t),u=!!o(n);function h(e){const t=c;c=null,t?t(e):e&&l.destroy(e)}return l=new C({readableObjectMode:!(null==t||!t.readableObjectMode),writableObjectMode:!(null==n||!n.writableObjectMode),readable:d,writable:u}),u&&(f(n,e=>{u=!1,e&&b(t,e),h(e)}),l._write=function(e,t,i){n.write(e,t)?i():r=i},l._final=function(e){n.end(),i=e},n.on("drain",function(){if(r){const e=r;r=null,e()}}),n.on("finish",function(){if(i){const e=i;i=null,e()}})),d&&(f(t,e=>{d=!1,e&&b(t,e),h(e)}),t.on("readable",function(){if(a){const e=a;a=null,e()}}),t.on("end",function(){l.push(null)}),l._read=function(){for(;;){const e=t.read();if(null===e)return void(a=l._read);if(!l.push(e))return}}),l._destroy=function(e,s){e||null===c||(e=new g),a=null,r=null,i=null,null===c?s(e):(c=s,b(n,e),b(t,e))},l}e.exports=function e(t,n){if(u(t))return t;if(l(t))return O({readable:t});if(d(t))return O({writable:t});if(c(t))return O({writable:!1,readable:!1});if(h(t))return O({readable:S.fromWeb(t)});if(p(t))return O({writable:_.fromWeb(t)});if("function"==typeof t){const{value:e,write:i,final:s,destroy:o}=function(e){let{promise:t,resolve:n}=w();const i=new x,s=i.signal,o=e(async function*(){for(;;){const e=t;t=null;const{chunk:i,done:o,cb:a}=await e;if(r.nextTick(a),o)return;if(s.aborted)throw new g(void 0,{cause:s.reason});({promise:t,resolve:n}=w()),yield i}}(),{signal:s});return{value:o,write(e,t,r){const i=n;n=null,i({chunk:e,done:!1,cb:r})},final(e){const t=n;n=null,t({done:!0,cb:e})},destroy(e,t){i.abort(),t(e)}}}(t);if(a(e))return k(C,e,{objectMode:!0,write:i,final:s,destroy:o});const c=null==e?void 0:e.then;if("function"==typeof c){let t;const n=T(c,e,e=>{if(null!=e)throw new y("nully","body",e)},e=>{b(t,e)});return t=new C({objectMode:!0,readable:!1,write:i,final(e){s(async()=>{try{await n,r.nextTick(e,null)}catch(t){r.nextTick(e,t)}})},destroy:o})}throw new y("Iterable, AsyncIterable or AsyncFunction",n,e)}if(E(t))return e(t.arrayBuffer());if(a(t))return k(C,t,{objectMode:!0,writable:!1});if(h(null==t?void 0:t.readable)&&p(null==t?void 0:t.writable))return C.fromWeb(t);if("object"==typeof(null==t?void 0:t.writable)||"object"==typeof(null==t?void 0:t.readable)){return O({readable:null!=t&&t.readable?l(null==t?void 0:t.readable)?null==t?void 0:t.readable:e(t.readable):void 0,writable:null!=t&&t.writable?d(null==t?void 0:t.writable)?null==t?void 0:t.writable:e(t.writable):void 0})}const i=null==t?void 0:t.then;if("function"==typeof i){let e;return T(i,t,t=>{null!=t&&e.push(t),e.push(null)},t=>{b(e,t)}),e=new C({objectMode:!0,writable:!1,read(){}})}throw new m(n,["Blob","ReadableStream","WritableStream","Stream","Iterable","AsyncIterable","Function","{ readable, writable } pair","Promise"],t)}},6751(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ObjectCorrelator=void 0;const r=n(1554),i=n(441);t.ObjectCorrelator=class{topology;config;constructor(e,t){this.topology=e,this.config=t}async findBestMatch(e,t){const n=[];for(const r of t){const t=await this.evaluateCandidate(r,e);t.confidence>=this.config.correlationThreshold&&n.push(t)}if(0===n.length){const n=t.filter(t=>t.className===e.detection.className);if(1===n.length){const t=await this.evaluateCandidate(n[0],e);if(t.confidence>=.3&&t.factors.timing>0)return t}return null}return n.sort((e,t)=>t.confidence-e.confidence),n[0]}async evaluateCandidate(e,t){const n={timing:this.evaluateTimingFactor(e,t),visual:await this.evaluateVisualFactor(e,t),spatial:this.evaluateSpatialFactor(e,t),class:this.evaluateClassFactor(e,t)};if(0===n.class)return{trackedObject:e,newSighting:t,confidence:0,factors:n};if(0===n.timing)return{trackedObject:e,newSighting:t,confidence:0,factors:n};return{trackedObject:e,newSighting:t,confidence:.3*n.timing+.35*n.visual+.25*n.spatial+.1*n.class,factors:n}}evaluateTimingFactor(e,t){const n=(0,i.getLastSighting)(e);if(!n)return 0;if(n.cameraId===t.cameraId)return 1;const s=t.timestamp-n.timestamp,o=(0,r.findConnection)(this.topology,n.cameraId,t.cameraId);if(!o){return s>0&&s<3e5?s<6e4?.9:s<12e4?.7:Math.max(.4,.7-(s-12e4)/18e4*.3):.3}const{min:a,typical:c,max:l}=o.transitTime;if(s<.5*a||s>2*l)return 0;if(s<a||s>l)return s<a?s/a*.3:l/s*.3;const d=Math.abs(s-c),u=(l-a)/2;return 0===u?1:Math.max(.5,1-d/u*.5)}async evaluateVisualFactor(e,t){if(!this.config.useVisualMatching)return.5;if(!e.visualDescriptor||!t.embedding)return.5;try{return(this.cosineSimilarity(e.visualDescriptor,t.embedding)+1)/2}catch(e){return.5}}evaluateSpatialFactor(e,t){const n=(0,i.getLastSighting)(e);if(!n)return.5;if(n.cameraId===t.cameraId)return 1;const s=(0,r.findConnection)(this.topology,n.cameraId,t.cameraId);if(!s)return.5;let o=0;if(n.position&&s.exitZone.length>0){this.isPointNearZone(n.position,s.exitZone,.2)&&(o+=.5)}else o+=.25;if(t.position&&s.entryZone.length>0){this.isPointNearZone(t.position,s.entryZone,.2)&&(o+=.5)}else o+=.25;return o}evaluateClassFactor(e,t){if(e.className===t.detection.className)return 1;return({car:["vehicle","truck","suv"],vehicle:["car","truck","suv"],truck:["vehicle","car"],person:["human"],human:["person"]}[e.className]||[]).includes(t.detection.className)?.8:0}cosineSimilarity(e,t){try{const n=this.decodeEmbedding(e),r=this.decodeEmbedding(t);if(n.length!==r.length||0===n.length)return 0;let i=0,s=0,o=0;for(let e=0;e<n.length;e++)i+=n[e]*r[e],s+=n[e]*n[e],o+=r[e]*r[e];return s=Math.sqrt(s),o=Math.sqrt(o),0===s||0===o?0:i/(s*o)}catch(e){return 0}}decodeEmbedding(e){try{const t=Buffer.from(e,"base64"),n=[];for(let e=0;e<t.length;e+=4)n.push(t.readFloatLE(e));return n}catch(e){return[]}}isPointNearZone(e,t,n){if(t.length<3)return!1;const r=100*e.x,i=100*e.y;let s=!1;for(let e=0,n=t.length-1;e<t.length;n=e++){const o=t[e][0],a=t[e][1],c=t[n][0],l=t[n][1];a>i!=l>i&&r<(c-o)*(i-a)/(l-a)+o&&(s=!s)}if(s)return!0;for(const e of t){const t=Math.abs(r-e[0])/100,s=Math.abs(i-e[1])/100;if(t<n&&s<n)return!0}return!1}}},6887(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isReactNativeBrowser=t.isWebWorker=void 0;const n=()=>Boolean("object"==typeof self&&self?.constructor?.name?.includes("WorkerGlobalScope")&&"undefined"==typeof Deno),r=()=>"undefined"!=typeof navigator&&"ReactNative"===navigator.product,i=(()=>{if("undefined"!=typeof window){if("undefined"!=typeof navigator&&navigator.userAgent?.toLowerCase().indexOf(" electron/")>-1&&process?.versions){return!Object.prototype.hasOwnProperty.call(process.versions,"electron")}return"undefined"!=typeof window.document}return!1})()||n()||r();t.isWebWorker=n(),t.isReactNativeBrowser=r(),t.default=i},6912(e,t,n){"use strict";var r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const i=r(n(4959)),s=r(n(5228)),o=r(n(495)),a=r(n(1021)),c=r(n(4264));t.default=(e,t,n)=>{const{options:r}=e;if(5===r.protocolVersion&&r.properties&&r.properties.maximumPacketSize&&r.properties.maximumPacketSize<t.length)return e.emit("error",new Error(`exceeding packets size ${t.cmd}`)),e.end({reasonCode:149,properties:{reasonString:"Maximum packet size was exceeded"}}),e;switch(e.log("_handlePacket :: emitting packetreceive"),e.emit("packetreceive",t),t.cmd){case"publish":(0,i.default)(e,t,n);break;case"puback":case"pubrec":case"pubcomp":case"suback":case"unsuback":e.reschedulePing(),(0,a.default)(e,t),n();break;case"pubrel":e.reschedulePing(),(0,c.default)(e,t,n);break;case"connack":(0,o.default)(e,t),n();break;case"auth":e.reschedulePing(),(0,s.default)(e,t),n();break;case"pingresp":e.log("_handlePacket :: received pingresp"),e.reschedulePing(!0),n();break;case"disconnect":e.emit("disconnect",t),n();break;default:e.log("_handlePacket :: unknown command"),n()}}},6928(e){"use strict";e.exports=require("path")},6968(e,t,n){"use strict";var r,i=this&&this.__createBinding||(Object.create?function(e,t,n,r){void 0===r&&(r=n);var i=Object.getOwnPropertyDescriptor(t,n);i&&!("get"in i?!t.__esModule:i.writable||i.configurable)||(i={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,r,i)}:function(e,t,n,r){void 0===r&&(r=n),e[r]=t[n]}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),o=this&&this.__importStar||(r=function(e){return r=Object.getOwnPropertyNames||function(e){var t=[];for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[t.length]=n);return t},r(e)},function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n=r(e),o=0;o<n.length;o++)"default"!==n[o]&&i(t,e,n[o]);return s(t,e),t}),a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(e,t,n,r){f("SOCKS connection to %s:%d via %s",e,t,n);const i=new g;return async function(e,t,n,r,i={}){const s=i.lookup??(0,h.promisify)(u.lookup),[o,a]=function(e){const t=new URL(e);if(t.pathname||t.hash||t.search)throw m(new Error("bad SOCKS URL"));const[n,r]=function(e){switch(e){case"socks5h:":return[5,!0];case"socks4a:":return[4,!0];case"socks5:":return[5,!1];case"socks4:":return[4,!1];default:return[void 0,!1]}}(t.protocol);if(!n)throw m(new Error("bad SOCKS URL: invalid protocol"));const i=parseInt(t.port,10);if(Number.isNaN(i))throw m(new Error("bad SOCKS URL: invalid port"));const s={host:t.hostname,port:i,type:n};return[s,r]}(n);a||(f("resolving %s locally",e),e=(await s(e,{family:4===o.type?4:0})).address);f("establishing SOCKS%d connection to %s:%d via %s:%d",o.type,e,t,o.host,o.port);const c=new d.SocksClient({command:"connect",destination:{host:e,port:t},proxy:{...o},timeout:i.timeout});c.connect(),c.on("established",({socket:e})=>r._start(e)),c.on("error",e=>{f("SOCKS failed: %s",e),r.destroy(m(e))})}(e,t,n,i,r).catch(e=>{f("SOCKS failed: %s",e),i.destroy(e)}),i};const c=a(n(5753)),l=n(2203),d=n(5861),u=o(n(2250)),h=n(9023),p=a(n(2613)),f=(0,c.default)("mqttjs:socks");class g extends l.Duplex{_flowing=!1;_socket;constructor(){super({autoDestroy:!1}),this.cork()}_start(e){f("proxy stream started"),(0,p.default)(!this._socket),this.destroyed?e.destroy(this.errored):(this._socket=e,this._flowing||e.pause(),e.on("data",this._onData),e.on("end",this._onEnd),e.on("error",this._onError),e.on("close",this._onClose),e.emit("connect"),this.uncork())}_write(e,t,n){(0,p.default)(this._socket),this._socket.write(e,n)}_read(e){this._flowing=!0,this._socket?.resume?.()}_destroy(e,t){this._socket?.destroy?.(e),t(e)}_onData=e=>{(0,p.default)(this._socket),this._flowing=this.push(e),this._flowing||this._socket.pause()};_onEnd=()=>{f("proxy stream received EOF"),this.push(null)};_onClose=()=>{f("proxy stream closed"),this.destroy()};_onError=e=>{f("proxy stream died with error %s",e),this.destroy(e)}}function m(e){try{return void 0===e.code&&(e.code="SOCKS"),e}catch{return e}}},6982(e){"use strict";e.exports=require("crypto")},7016(e){"use strict";e.exports=require("url")},7130(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ipToBuffer=t.int32ToIpv4=t.ipv4ToInt32=t.validateSocksClientChainOptions=t.validateSocksClientOptions=void 0;const r=n(3763),i=n(5438),s=n(2203),o=n(9424),a=n(9278);function c(e,t){if(void 0!==e.custom_auth_method){if(e.custom_auth_method<i.SOCKS5_CUSTOM_AUTH_START||e.custom_auth_method>i.SOCKS5_CUSTOM_AUTH_END)throw new r.SocksClientError(i.ERRORS.InvalidSocksClientOptionsCustomAuthRange,t);if(void 0===e.custom_auth_request_handler||"function"!=typeof e.custom_auth_request_handler)throw new r.SocksClientError(i.ERRORS.InvalidSocksClientOptionsCustomAuthOptions,t);if(void 0===e.custom_auth_response_size)throw new r.SocksClientError(i.ERRORS.InvalidSocksClientOptionsCustomAuthOptions,t);if(void 0===e.custom_auth_response_handler||"function"!=typeof e.custom_auth_response_handler)throw new r.SocksClientError(i.ERRORS.InvalidSocksClientOptionsCustomAuthOptions,t)}}function l(e){return e&&"string"==typeof e.host&&Buffer.byteLength(e.host)<256&&"number"==typeof e.port&&e.port>=0&&e.port<=65535}function d(e){return e&&("string"==typeof e.host||"string"==typeof e.ipaddress)&&"number"==typeof e.port&&e.port>=0&&e.port<=65535&&(4===e.type||5===e.type)}function u(e){return"number"==typeof e&&e>0}t.validateSocksClientOptions=function(e,t=["connect","bind","associate"]){if(!i.SocksCommand[e.command])throw new r.SocksClientError(i.ERRORS.InvalidSocksCommand,e);if(-1===t.indexOf(e.command))throw new r.SocksClientError(i.ERRORS.InvalidSocksCommandForOperation,e);if(!l(e.destination))throw new r.SocksClientError(i.ERRORS.InvalidSocksClientOptionsDestination,e);if(!d(e.proxy))throw new r.SocksClientError(i.ERRORS.InvalidSocksClientOptionsProxy,e);if(c(e.proxy,e),e.timeout&&!u(e.timeout))throw new r.SocksClientError(i.ERRORS.InvalidSocksClientOptionsTimeout,e);if(e.existing_socket&&!(e.existing_socket instanceof s.Duplex))throw new r.SocksClientError(i.ERRORS.InvalidSocksClientOptionsExistingSocket,e)},t.validateSocksClientChainOptions=function(e){if("connect"!==e.command)throw new r.SocksClientError(i.ERRORS.InvalidSocksCommandChain,e);if(!l(e.destination))throw new r.SocksClientError(i.ERRORS.InvalidSocksClientOptionsDestination,e);if(!(e.proxies&&Array.isArray(e.proxies)&&e.proxies.length>=2))throw new r.SocksClientError(i.ERRORS.InvalidSocksClientOptionsProxiesLength,e);if(e.proxies.forEach(t=>{if(!d(t))throw new r.SocksClientError(i.ERRORS.InvalidSocksClientOptionsProxy,e);c(t,e)}),e.timeout&&!u(e.timeout))throw new r.SocksClientError(i.ERRORS.InvalidSocksClientOptionsTimeout,e)},t.ipv4ToInt32=function(e){return new o.Address4(e).toArray().reduce((e,t)=>(e<<8)+t,0)>>>0},t.int32ToIpv4=function(e){return[e>>>24&255,e>>>16&255,e>>>8&255,255&e].join(".")},t.ipToBuffer=function(e){if(a.isIPv4(e)){const t=new o.Address4(e);return Buffer.from(t.toArray())}if(a.isIPv6(e)){const t=new o.Address6(e);return Buffer.from(t.canonicalForm().split(":").map(e=>e.padStart(4,"0")).join(""),"hex")}throw new Error("Invalid IP address format")}},7136(e,t,n){"use strict";var r,i=this&&this.__createBinding||(Object.create?function(e,t,n,r){void 0===r&&(r=n);var i=Object.getOwnPropertyDescriptor(t,n);i&&!("get"in i?!t.__esModule:i.writable||i.configurable)||(i={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,r,i)}:function(e,t,n,r){void 0===r&&(r=n),e[r]=t[n]}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),o=this&&this.__importStar||(r=function(e){return r=Object.getOwnPropertyNames||function(e){var t=[];for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[t.length]=n);return t},r(e)},function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n=r(e),o=0;o<n.length;o++)"default"!==n[o]&&i(t,e,n[o]);return s(t,e),t});Object.defineProperty(t,"__esModule",{value:!0}),t.TrackingEngine=void 0;const a=o(n(7562)),c=n(1554),l=n(441),d=n(397),u=n(6751),h=n(6687),{systemManager:p}=a.default;t.TrackingEngine=class{topology;state;alertManager;config;console;correlator;spatialReasoning;listeners=new Map;pendingTimers=new Map;lostCheckInterval=null;objectLastAlertTime=new Map;onTopologyChange;lastLlmCallTime=0;llmDebounceTimer=null;observedTransits=new Map;connectionSuggestions=new Map;MIN_OBSERVATIONS_FOR_SUGGESTION=3;trainingSession=null;trainingConfig=d.DEFAULT_TRAINING_CONFIG;onTrainingStatusUpdate;constructor(e,t,n,r,i){this.topology=e,this.state=t,this.alertManager=n,this.config=r,this.console=i,this.correlator=new u.ObjectCorrelator(e,r);const s={enableLlm:r.useLlmDescriptions,enableLandmarkLearning:r.enableLandmarkLearning??!0,landmarkConfidenceThreshold:r.landmarkConfidenceThreshold??.7,contextCacheTtl:6e4};this.spatialReasoning=new h.SpatialReasoningEngine(s,i),this.spatialReasoning.updateTopology(e)}setTopologyChangeCallback(e){this.onTopologyChange=e}async startTracking(){this.console.log("Starting tracking engine..."),await this.stopTracking();for(const e of this.topology.cameras)try{const t=p.getDeviceById(e.deviceId);if(!t){this.console.warn(`Camera not found: ${e.deviceId} (${e.name})`);continue}if(!t.interfaces?.includes(a.ScryptedInterface.ObjectDetector)){this.console.warn(`Camera ${e.name} does not support object detection`);continue}const n=t.listen(a.ScryptedInterface.ObjectDetector,(t,n,r)=>{this.handleDetection(e.deviceId,e.name,r)});this.listeners.set(e.deviceId,n),this.console.log(`Listening to camera: ${e.name}`)}catch(t){this.console.error(`Failed to subscribe to camera ${e.name}:`,t)}this.lostCheckInterval=setInterval(()=>{this.checkForLostObjects()},3e4),this.console.log(`Tracking engine started with ${this.listeners.size} cameras`)}async stopTracking(){for(const[e,t]of this.listeners.entries())try{t.removeListener()}catch(t){this.console.error(`Failed to remove listener for ${e}:`,t)}this.listeners.clear();for(const e of this.pendingTimers.values())clearTimeout(e);this.pendingTimers.clear(),this.lostCheckInterval&&(clearInterval(this.lostCheckInterval),this.lostCheckInterval=null),this.console.log("Tracking engine stopped")}async handleDetection(e,t,n){if(!n.detections||0===n.detections.length)return;const r=(0,c.findCamera)(this.topology,e);if(!r)return;const i=n.timestamp||Date.now();for(const s of n.detections){if(s.score<.5)continue;if(this.isTrainingActive()&&"person"===s.className&&this.recordTrainerDetection(e,s,s.score),r.trackClasses.length>0&&!r.trackClasses.includes(s.className))continue;const o={detection:s,cameraId:e,cameraName:t,timestamp:i,confidence:s.score,embedding:s.embedding,detectionId:n.detectionId,position:s.boundingBox?{x:(s.boundingBox[0]+s.boundingBox[2]/2)/100,y:(s.boundingBox[1]+s.boundingBox[3]/2)/100}:void 0};await this.processSighting(o,r.isEntryPoint,r.isExitPoint)}}passesLoiteringThreshold(e){return e.lastSeen-e.firstSeen>=this.config.loiteringThreshold}isInAlertCooldown(e){const t=this.objectLastAlertTime.get(e);return!!t&&Date.now()-t<this.config.objectAlertCooldown}recordAlertTime(e){this.objectLastAlertTime.set(e,Date.now())}isLlmCallAllowed(){const e=this.config.llmDebounceInterval||0;if(e<=0)return!0;return Date.now()-this.lastLlmCallTime>=e}recordLlmCall(){this.lastLlmCallTime=Date.now()}async getSpatialDescription(e,t,n,r,i){const s=this.config.llmFallbackEnabled??!0,o=this.config.llmFallbackTimeout??3e3;try{if(!this.isLlmCallAllowed())return this.console.log("LLM rate-limited, using basic notification"),null;let c,l;if(this.config.useLlmDescriptions){const e=p.getDeviceById(i);e?.interfaces?.includes(a.ScryptedInterface.Camera)&&(c=await e.takePicture())}if(this.recordLlmCall(),s&&c){const i=new Promise((e,t)=>{setTimeout(()=>t(new Error("LLM timeout")),o)}),s=this.spatialReasoning.generateMovementDescription(e,t,n,r,c);try{l=await Promise.race([s,i])}catch(e){return this.console.log("LLM timed out, using basic notification"),null}}else l=await this.spatialReasoning.generateMovementDescription(e,t,n,r,c);return this.config.enableLandmarkLearning&&c&&this.tryLearnLandmark(i,c,e.className),l}catch(e){return this.console.warn("Spatial reasoning failed:",e),null}}async tryLearnLandmark(e,t,n){try{const r={x:50,y:50},i=await this.spatialReasoning.suggestLandmark(e,t,n,r);i&&this.console.log(`AI suggested landmark: ${i.landmark.name} (${i.landmark.type}, confidence: ${i.landmark.aiConfidence?.toFixed(2)})`)}catch(e){}}async processSighting(e,t,n){const r=await this.correlateDetection(e);if(r){const t=r.trackedObject,i=(0,l.getLastSighting)(t);if(i&&i.cameraId!==e.cameraId){const n=e.timestamp-i.timestamp;if(this.state.addJourney(t.globalId,{fromCameraId:i.cameraId,fromCameraName:i.cameraName,toCameraId:e.cameraId,toCameraName:e.cameraName,exitTime:i.timestamp,entryTime:e.timestamp,transitDuration:n,correlationConfidence:r.confidence}),this.recordObservedTransit(i.cameraId,e.cameraId,n),this.console.log(`Object ${t.globalId.slice(0,8)} transited: ${i.cameraName} → ${e.cameraName} (confidence: ${(100*r.confidence).toFixed(0)}%)`),this.passesLoiteringThreshold(t)&&!this.isInAlertCooldown(t.globalId)){const r=await this.getSpatialDescription(t,i.cameraId,e.cameraId,n,e.cameraId);await this.alertManager.checkAndAlert("movement",t,{fromCameraId:i.cameraId,fromCameraName:i.cameraName,toCameraId:e.cameraId,toCameraName:e.cameraName,transitTime:n,objectClass:e.detection.className,objectLabel:r?.description||e.detection.label,detectionId:e.detectionId,pathDescription:r?.pathDescription,involvedLandmarks:r?.involvedLandmarks?.map(e=>e.name),usedLlm:r?.usedLlm}),this.recordAlertTime(t.globalId)}}this.state.addSighting(t.globalId,e);const s=this.pendingTimers.get(t.globalId);s&&(clearTimeout(s),this.pendingTimers.delete(t.globalId)),this.state.reactivate(t.globalId),n&&this.isLeavingFrame(e)&&this.handlePotentialExit(t,e)}else{const n=this.state.generateId(),r=this.state.createObject(n,e,t);if(this.console.log(`New ${e.detection.className} detected on ${e.cameraName} (ID: ${n.slice(0,8)})`),t&&this.passesLoiteringThreshold(r)&&!this.isInAlertCooldown(n)){const t=await this.getSpatialDescription(r,"outside",e.cameraId,0,e.cameraId);await this.alertManager.checkAndAlert("property_entry",r,{cameraId:e.cameraId,cameraName:e.cameraName,objectClass:e.detection.className,objectLabel:t?.description||e.detection.label,detectionId:e.detectionId,involvedLandmarks:t?.involvedLandmarks?.map(e=>e.name),usedLlm:t?.usedLlm}),this.recordAlertTime(n)}}}async correlateDetection(e){const t=this.state.getActiveObjects();if(0===t.length)return null;for(const n of t){const t=(0,l.getLastSighting)(n);if(t&&t.cameraId===e.cameraId&&t.detection.id===e.detection.id)return{trackedObject:n,newSighting:e,confidence:1,factors:{timing:1,visual:1,spatial:1,class:1}}}return await this.correlator.findBestMatch(e,t)}isLeavingFrame(e){if(!e.position)return!1;const t=.1;return e.position.x<t||e.position.x>.9||e.position.y<t||e.position.y>.9}handlePotentialExit(e,t){this.state.markPending(e.globalId);const n=setTimeout(async()=>{const n=this.state.getObject(e.globalId);n&&"pending"===n.state&&(this.state.markExited(e.globalId,t.cameraId,t.cameraName),this.console.log(`Object ${e.globalId.slice(0,8)} exited via ${t.cameraName}`),await this.alertManager.checkAndAlert("property_exit",n,{cameraId:t.cameraId,cameraName:t.cameraName,objectClass:n.className,objectLabel:n.label})),this.pendingTimers.delete(e.globalId)},this.config.correlationWindow);this.pendingTimers.set(e.globalId,n)}checkForLostObjects(){const e=Date.now(),t=this.state.getActiveObjects();for(const n of t){const t=e-n.lastSeen;t>this.config.lostTimeout&&(this.state.markLost(n.globalId),this.console.log(`Object ${n.globalId.slice(0,8)} marked as lost (not seen for ${Math.round(t/1e3)}s)`),this.alertManager.checkAndAlert("lost_tracking",n,{objectClass:n.className,objectLabel:n.label}))}}updateTopology(e){this.topology=e,this.correlator=new u.ObjectCorrelator(e,this.config),this.spatialReasoning.updateTopology(e)}getPendingLandmarkSuggestions(){return this.spatialReasoning.getPendingSuggestions()}acceptLandmarkSuggestion(e){const t=this.spatialReasoning.acceptSuggestion(e);return t&&this.topology&&(this.topology.landmarks||(this.topology.landmarks=[]),this.topology.landmarks.push(t),this.onTopologyChange&&this.onTopologyChange(this.topology)),t}rejectLandmarkSuggestion(e){return this.spatialReasoning.rejectSuggestion(e)}getLandmarkTemplates(){return this.spatialReasoning.getLandmarkTemplates()}getSpatialReasoningEngine(){return this.spatialReasoning}getTopology(){return this.topology}getTrackedObjects(){return this.state.getAllObjects()}getTrackedObject(e){return this.state.getObject(e)}recordObservedTransit(e,t,n){if(!this.config.enableTransitTimeLearning)return;const r=`${e}->${t}`,i={fromCameraId:e,toCameraId:t,transitTime:n,timestamp:Date.now()};this.observedTransits.has(r)||this.observedTransits.set(r,[]);const s=this.observedTransits.get(r);s.push(i),s.length>100&&s.shift();const o=(0,c.findConnection)(this.topology,e,t);o?this.maybeUpdateConnectionTransitTime(o,s):this.config.enableConnectionSuggestions&&this.maybeCreateConnectionSuggestion(e,t,s)}maybeUpdateConnectionTransitTime(e,t){if(t.length<5)return;const n=t.map(e=>e.transitTime).sort((e,t)=>e-t),r=n[Math.floor(.1*n.length)],i=n[Math.floor(.5*n.length)],s=n[Math.floor(.9*n.length)],o=e.transitTime.typical;Math.abs(i-o)/o>.2&&t.length>=10&&(this.console.log(`Updating transit time for ${e.name}: ${Math.round(o/1e3)}s → ${Math.round(i/1e3)}s (based on ${t.length} observations)`),e.transitTime={min:r,typical:i,max:s},this.onTopologyChange&&this.onTopologyChange(this.topology))}maybeCreateConnectionSuggestion(e,t,n){if(n.length<this.MIN_OBSERVATIONS_FOR_SUGGESTION)return;const r=(0,c.findCamera)(this.topology,e),i=(0,c.findCamera)(this.topology,t);if(!r||!i)return;const s=`${e}->${t}`,o=n.map(e=>e.transitTime).sort((e,t)=>e-t),a=o[Math.floor(.1*o.length)]||o[0],l=o[Math.floor(.5*o.length)]||o[0],d=o[Math.floor(.9*o.length)]||o[o.length-1],u=o.reduce((e,t)=>e+t,0)/o.length,h=o.reduce((e,t)=>e+Math.pow(t-u,2),0)/o.length,p=Math.sqrt(h)/u,f=.6*Math.min(n.length/10,1)+.4*Math.max(0,1-p),g={id:`suggest_${s}`,fromCameraId:e,fromCameraName:r.name,toCameraId:t,toCameraName:i.name,observedTransits:n.slice(-10),suggestedTransitTime:{min:a,typical:l,max:d},confidence:f,timestamp:Date.now()};this.connectionSuggestions.set(s,g),n.length===this.MIN_OBSERVATIONS_FOR_SUGGESTION&&this.console.log(`New connection suggested: ${r.name} → ${i.name} (typical: ${Math.round(l/1e3)}s, confidence: ${Math.round(100*f)}%)`)}getConnectionSuggestions(){return Array.from(this.connectionSuggestions.values()).filter(e=>e.confidence>=.5).sort((e,t)=>t.confidence-e.confidence)}acceptConnectionSuggestion(e){const t=e.replace("suggest_",""),n=this.connectionSuggestions.get(t);if(!n)return null;const r=(0,c.findCamera)(this.topology,n.fromCameraId),i=(0,c.findCamera)(this.topology,n.toCameraId);if(!r||!i)return null;const s={id:`conn-${Date.now()}`,fromCameraId:n.fromCameraId,toCameraId:n.toCameraId,name:`${r.name} to ${i.name}`,exitZone:[],entryZone:[],transitTime:n.suggestedTransitTime,bidirectional:!0};return this.topology.connections.push(s),this.connectionSuggestions.delete(t),this.onTopologyChange&&this.onTopologyChange(this.topology),this.console.log(`Connection accepted: ${s.name}`),s}rejectConnectionSuggestion(e){const t=e.replace("suggest_","");return!!this.connectionSuggestions.has(t)&&(this.connectionSuggestions.delete(t),this.observedTransits.delete(t),!0)}getLiveTrackingState(){return{objects:this.state.getActiveObjects().map(e=>{const t=(0,l.getLastSighting)(e),n=t?(0,c.findCamera)(this.topology,t.cameraId):null;return{globalId:e.globalId,className:e.className,label:e.label,lastCameraId:t?.cameraId||"",lastCameraName:t?.cameraName||"",lastSeen:e.lastSeen,state:e.state,cameraPosition:n?.floorPlanPosition}}),timestamp:Date.now()}}getJourneyPath(e){const t=this.state.getObject(e);if(!t)return null;const n=t.journey.map(e=>{const t=(0,c.findCamera)(this.topology,e.fromCameraId),n=(0,c.findCamera)(this.topology,e.toCameraId);return{fromCamera:{id:e.fromCameraId,name:e.fromCameraName,position:t?.floorPlanPosition},toCamera:{id:e.toCameraId,name:e.toCameraName,position:n?.floorPlanPosition},transitTime:e.transitDuration,timestamp:e.entryTime}}),r=(0,l.getLastSighting)(t);let i;if(r){const e=(0,c.findCamera)(this.topology,r.cameraId);i={cameraId:r.cameraId,cameraName:r.cameraName,position:e?.floorPlanPosition}}return{segments:n,currentLocation:i}}setTrainingStatusCallback(e){this.onTrainingStatusUpdate=e}getTrainingSession(){return this.trainingSession}isTrainingActive(){return null!==this.trainingSession&&"active"===this.trainingSession.state}startTrainingSession(e,t){return this.trainingSession&&"active"===this.trainingSession.state&&this.endTrainingSession(),t&&(this.trainingConfig={...d.DEFAULT_TRAINING_CONFIG,...t}),this.trainingSession=(0,d.createTrainingSession)(e),this.trainingSession.state="active",this.console.log(`Training session started: ${this.trainingSession.id}`),this.emitTrainingStatus(),this.trainingSession}pauseTrainingSession(){return!(!this.trainingSession||"active"!==this.trainingSession.state)&&(this.trainingSession.state="paused",this.trainingSession.updatedAt=Date.now(),this.console.log("Training session paused"),this.emitTrainingStatus(),!0)}resumeTrainingSession(){return!(!this.trainingSession||"paused"!==this.trainingSession.state)&&(this.trainingSession.state="active",this.trainingSession.updatedAt=Date.now(),this.console.log("Training session resumed"),this.emitTrainingStatus(),!0)}endTrainingSession(){if(!this.trainingSession)return null;this.trainingSession.state="completed",this.trainingSession.completedAt=Date.now(),this.trainingSession.updatedAt=Date.now(),this.trainingSession.stats=(0,d.calculateTrainingStats)(this.trainingSession,this.topology.cameras.length),this.console.log(`Training session completed: ${this.trainingSession.stats.camerasVisited} cameras, ${this.trainingSession.stats.transitsRecorded} transits, ${this.trainingSession.stats.landmarksMarked} landmarks`);const e=this.trainingSession;return this.emitTrainingStatus(),e}recordTrainerDetection(e,t,n){if(!this.trainingSession||"active"!==this.trainingSession.state)return;if("person"!==t.className)return;if(n<this.trainingConfig.minDetectionConfidence)return;const r=(0,c.findCamera)(this.topology,e),i=r?.name||e,s=Date.now();if(this.trainingSession.currentCameraId===e){const r=this.trainingSession.visits.find(t=>t.cameraId===e&&null===t.departedAt);r&&(r.detectionConfidence=Math.max(r.detectionConfidence,n),t.boundingBox&&(r.boundingBox=t.boundingBox))}else{if(this.trainingSession.currentCameraId&&this.trainingSession.transitStartTime){const t=s-this.trainingSession.transitStartTime,n=this.trainingSession.previousCameraId||this.trainingSession.currentCameraId,r=(0,c.findCamera)(this.topology,n),o=this.trainingSession.visits.find(e=>e.cameraId===n&&null===e.departedAt);o&&(o.departedAt=this.trainingSession.transitStartTime);const a=this.checkTrainingOverlap(n,e,s),l={id:`transit-${s}`,fromCameraId:n,toCameraId:e,startTime:this.trainingSession.transitStartTime,endTime:s,transitSeconds:Math.round(t/1e3),hasOverlap:a};this.trainingSession.transits.push(l),this.console.log(`Training transit: ${r?.name||n} → ${i} (${l.transitSeconds}s${a?", overlap detected":""})`),a&&this.trainingConfig.autoDetectOverlaps&&this.recordTrainingOverlap(n,e)}const o={cameraId:e,cameraName:i,arrivedAt:s,departedAt:null,trainerEmbedding:t.embedding,detectionConfidence:n,boundingBox:t.boundingBox,floorPlanPosition:r?.floorPlanPosition};this.trainingSession.visits.push(o),this.trainingSession.previousCameraId=this.trainingSession.currentCameraId,this.trainingSession.currentCameraId=e,this.trainingSession.transitStartTime=s,!this.trainingSession.trainerEmbedding&&t.embedding&&(this.trainingSession.trainerEmbedding=t.embedding)}this.trainingSession.updatedAt=s,this.trainingSession.stats=(0,d.calculateTrainingStats)(this.trainingSession,this.topology.cameras.length),this.emitTrainingStatus()}checkTrainingOverlap(e,t,n){const r=this.trainingSession?.visits.find(t=>t.cameraId===e&&(null===t.departedAt||t.departedAt>n-5e3)),i=this.trainingSession?.visits.find(e=>e.cameraId===t&&e.arrivedAt<=n&&e.arrivedAt>=n-5e3);return!(!r||!i)}recordTrainingOverlap(e,t){if(!this.trainingSession)return;if(this.trainingSession.overlaps.find(n=>n.camera1Id===e&&n.camera2Id===t||n.camera1Id===t&&n.camera2Id===e))return;const n=(0,c.findCamera)(this.topology,e),r=(0,c.findCamera)(this.topology,t);let i={x:50,y:50};n?.floorPlanPosition&&r?.floorPlanPosition&&(i={x:(n.floorPlanPosition.x+r.floorPlanPosition.x)/2,y:(n.floorPlanPosition.y+r.floorPlanPosition.y)/2});const s={id:`overlap-${Date.now()}`,camera1Id:e,camera2Id:t,position:i,radius:30,markedAt:Date.now()};this.trainingSession.overlaps.push(s),this.console.log(`Camera overlap detected: ${n?.name} ↔ ${r?.name}`)}markTrainingLandmark(e){if(!this.trainingSession)return null;const t={...e,id:`landmark-${Date.now()}`,markedAt:Date.now()};return this.trainingSession.landmarks.push(t),this.trainingSession.updatedAt=Date.now(),this.trainingSession.stats=(0,d.calculateTrainingStats)(this.trainingSession,this.topology.cameras.length),this.console.log(`Landmark marked: ${t.name} (${t.type})`),this.emitTrainingStatus(),t}markTrainingStructure(e){if(!this.trainingSession)return null;const t={...e,id:`structure-${Date.now()}`,markedAt:Date.now()};return this.trainingSession.structures.push(t),this.trainingSession.updatedAt=Date.now(),this.trainingSession.stats=(0,d.calculateTrainingStats)(this.trainingSession,this.topology.cameras.length),this.console.log(`Structure marked: ${t.name} (${t.type})`),this.emitTrainingStatus(),t}confirmCameraPosition(e,t){if(!this.trainingSession)return!1;const n=this.trainingSession.visits.find(t=>t.cameraId===e);n&&(n.floorPlanPosition=t);const r=(0,c.findCamera)(this.topology,e);return r&&(r.floorPlanPosition=t,this.onTopologyChange&&this.onTopologyChange(this.topology)),this.trainingSession.updatedAt=Date.now(),this.emitTrainingStatus(),!0}getTrainingStatus(){if(!this.trainingSession)return null;const e=this.trainingSession.currentCameraId?(0,c.findCamera)(this.topology,this.trainingSession.currentCameraId):null,t=this.trainingSession.previousCameraId?(0,c.findCamera)(this.topology,this.trainingSession.previousCameraId):null,n=[],r=new Set(this.trainingSession.visits.map(e=>e.cameraId)),i=this.topology.cameras.filter(e=>!r.has(e.deviceId));if(i.length>0){const t=(e?(0,c.findConnectionsFrom)(this.topology,e.deviceId):[]).map(e=>e.toCameraId).filter(e=>!r.has(e));if(t.length>0){const e=(0,c.findCamera)(this.topology,t[0]);e&&n.push(`Walk to ${e.name}`)}else n.push(`${i.length} cameras not yet visited`)}this.trainingSession.visits.length>=2&&0===this.trainingSession.landmarks.length&&n.push("Consider marking some landmarks"),r.size>=this.topology.cameras.length&&n.push("All cameras visited! You can end training.");return{sessionId:this.trainingSession.id,state:this.trainingSession.state,currentCamera:e?{id:e.deviceId,name:e.name,detectedAt:this.trainingSession.visits.find(t=>t.cameraId===e.deviceId&&!t.departedAt)?.arrivedAt||Date.now(),confidence:this.trainingSession.visits.find(t=>t.cameraId===e.deviceId&&!t.departedAt)?.detectionConfidence||0}:void 0,activeTransit:this.trainingSession.transitStartTime&&t?{fromCameraId:t.deviceId,fromCameraName:t.name,startTime:this.trainingSession.transitStartTime,elapsedSeconds:Math.round((Date.now()-this.trainingSession.transitStartTime)/1e3)}:void 0,stats:this.trainingSession.stats,suggestions:n}}emitTrainingStatus(){if(this.onTrainingStatusUpdate){const e=this.getTrainingStatus();e&&this.onTrainingStatusUpdate(e)}}applyTrainingToTopology(){const e={camerasAdded:0,connectionsCreated:0,connectionsUpdated:0,landmarksAdded:0,zonesCreated:0,warnings:[],success:!1};if(!this.trainingSession)return e.warnings.push("No training session to apply"),e;try{for(const t of this.trainingSession.visits){const n=(0,c.findCamera)(this.topology,t.cameraId);n&&t.floorPlanPosition&&(n.floorPlanPosition||(n.floorPlanPosition=t.floorPlanPosition,e.camerasAdded++))}for(const t of this.trainingSession.transits){const n=(0,c.findConnection)(this.topology,t.fromCameraId,t.toCameraId);if(n){const r=1e3*t.transitSeconds;n.transitTime={min:Math.min(n.transitTime.min,.7*r),typical:r,max:Math.max(n.transitTime.max,1.3*r)},e.connectionsUpdated++}else{const n=(0,c.findCamera)(this.topology,t.fromCameraId),r=(0,c.findCamera)(this.topology,t.toCameraId);if(n&&r){const i=1e3*t.transitSeconds,s={id:`conn-training-${Date.now()}-${e.connectionsCreated}`,fromCameraId:t.fromCameraId,toCameraId:t.toCameraId,name:`${n.name} to ${r.name}`,exitZone:[],entryZone:[],transitTime:{min:.7*i,typical:i,max:1.3*i},bidirectional:!0};this.topology.connections.push(s),e.connectionsCreated++}}}for(const t of this.trainingSession.landmarks){const n={mailbox:"feature",garage:"structure",shed:"structure",tree:"feature",gate:"access",door:"access",driveway:"access",pathway:"access",garden:"feature",pool:"feature",deck:"structure",patio:"structure",other:"feature"},r={id:t.id,name:t.name,type:n[t.type]||"feature",position:t.position,visibleFromCameras:t.visibleFromCameras.length>0?t.visibleFromCameras:void 0,description:t.description};this.topology.landmarks||(this.topology.landmarks=[]),this.topology.landmarks.push(r),e.landmarksAdded++}for(const t of this.trainingSession.overlaps){const n=(0,c.findCamera)(this.topology,t.camera1Id),r=(0,c.findCamera)(this.topology,t.camera2Id);if(n&&r){const i=`${n.name}/${r.name} Overlap`,s=this.topology.globalZones?.find(e=>e.name===i);if(!s){this.topology.globalZones||(this.topology.globalZones=[]);const n=[{cameraId:t.camera1Id,zone:[]},{cameraId:t.camera2Id,zone:[]}];this.topology.globalZones.push({id:`zone-overlap-${t.id}`,name:i,type:"dwell",cameraZones:n}),e.zonesCreated++}}}this.onTopologyChange&&this.onTopologyChange(this.topology),e.success=!0,this.console.log(`Training applied: ${e.connectionsCreated} connections created, ${e.connectionsUpdated} updated, ${e.landmarksAdded} landmarks added`)}catch(t){e.warnings.push(`Error applying training: ${t}`)}return e}clearTrainingSession(){this.trainingSession=null,this.emitTrainingStatus()}}},7279(e,t,n){"use strict";var r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.MqttPublisher=void 0;const i=r(n(9372));t.MqttPublisher=class{client=null;config;console;connected=!1;reconnectTimer=null;constructor(e,t){this.config=e,this.console=t}async connect(){if(this.client)return;const e={clientId:`scrypted-spatial-awareness-${Date.now()}`,clean:!0,connectTimeout:1e4,reconnectPeriod:5e3};this.config.username&&(e.username=this.config.username,e.password=this.config.password);try{this.client=i.default.connect(this.config.broker,e),this.client.on("connect",()=>{this.connected=!0,this.console.log(`MQTT connected to ${this.config.broker}`),this.publishDiscovery()}),this.client.on("error",e=>{this.console.error("MQTT error:",e)}),this.client.on("close",()=>{this.connected=!1,this.console.log("MQTT connection closed")}),this.client.on("offline",()=>{this.connected=!1,this.console.log("MQTT offline")})}catch(e){this.console.error("Failed to connect to MQTT:",e)}}disconnect(){this.reconnectTimer&&(clearTimeout(this.reconnectTimer),this.reconnectTimer=null),this.client&&(this.client.end(),this.client=null,this.connected=!1)}publishDiscovery(){if(!this.client||!this.connected)return;const e=this.config.baseTopic,t={name:"Property Occupancy",unique_id:"spatial_awareness_occupancy",state_topic:`${e}/occupancy/state`,device_class:"occupancy",payload_on:"ON",payload_off:"OFF",device:{identifiers:["spatial_awareness"],name:"Spatial Awareness",model:"Cross-Camera Tracker",manufacturer:"Scrypted"}};this.client.publish("homeassistant/binary_sensor/spatial_awareness_occupancy/config",JSON.stringify(t),{retain:!0});const n={name:"Active Tracked Objects",unique_id:"spatial_awareness_count",state_topic:`${e}/count/state`,icon:"mdi:account-multiple",device:{identifiers:["spatial_awareness"]}};this.client.publish("homeassistant/sensor/spatial_awareness_count/config",JSON.stringify(n),{retain:!0});const r={name:"People on Property",unique_id:"spatial_awareness_person_count",state_topic:`${e}/person_count/state`,icon:"mdi:account-group",device:{identifiers:["spatial_awareness"]}};this.client.publish("homeassistant/sensor/spatial_awareness_person_count/config",JSON.stringify(r),{retain:!0});const i={name:"Vehicles on Property",unique_id:"spatial_awareness_vehicle_count",state_topic:`${e}/vehicle_count/state`,icon:"mdi:car",device:{identifiers:["spatial_awareness"]}};this.client.publish("homeassistant/sensor/spatial_awareness_vehicle_count/config",JSON.stringify(i),{retain:!0}),this.console.log("MQTT discovery published")}publishState(e){if(!this.client||!this.connected)return;const t=this.config.baseTopic,n=e.filter(e=>"active"===e.state||"pending"===e.state),r=n.length>0;this.client.publish(`${t}/occupancy/state`,r?"ON":"OFF",{retain:!0}),this.client.publish(`${t}/count/state`,String(n.length),{retain:!0});const i=n.filter(e=>"person"===e.className).length;this.client.publish(`${t}/person_count/state`,String(i),{retain:!0});const s=n.filter(e=>["car","vehicle","truck"].includes(e.className)).length;this.client.publish(`${t}/vehicle_count/state`,String(s),{retain:!0});const o={timestamp:Date.now(),occupied:r,activeCount:n.length,personCount:i,vehicleCount:s,objects:n.map(e=>({id:e.globalId,class:e.className,label:e.label,cameras:e.activeOnCameras,firstSeen:e.firstSeen,lastSeen:e.lastSeen,state:e.state}))};this.client.publish(`${t}/state`,JSON.stringify(o),{retain:!0})}publishAlert(e){if(!this.client||!this.connected)return;const t=this.config.baseTopic,n={id:e.id,type:e.type,severity:e.severity,message:e.message,timestamp:e.timestamp,objectId:e.trackedObjectId,details:e.details};this.client.publish(`${t}/alerts`,JSON.stringify(n)),this.client.publish(`${t}/alerts/${e.type}`,JSON.stringify(n))}publishEntry(e,t){if(!this.client||!this.connected)return;const n=this.config.baseTopic,r={event:"entry",timestamp:Date.now(),object:{id:e.globalId,class:e.className,label:e.label},camera:t};this.client.publish(`${n}/events/entry`,JSON.stringify(r))}publishExit(e,t){if(!this.client||!this.connected)return;const n=this.config.baseTopic,r={event:"exit",timestamp:Date.now(),object:{id:e.globalId,class:e.className,label:e.label,dwellTime:e.lastSeen-e.firstSeen},camera:t};this.client.publish(`${n}/events/exit`,JSON.stringify(r))}publishTransition(e,t,n){if(!this.client||!this.connected)return;const r=this.config.baseTopic,i={event:"transition",timestamp:Date.now(),object:{id:e.globalId,class:e.className,label:e.label},from:t,to:n};this.client.publish(`${r}/events/transition`,JSON.stringify(i))}isConnected(){return this.connected}}},7382(e,t,n){"use strict";const{ObjectSetPrototypeOf:r,Symbol:i}=n(4134);e.exports=l;const{ERR_METHOD_NOT_IMPLEMENTED:s}=n(6371).codes,o=n(3370),{getHighWaterMark:a}=n(5291);r(l.prototype,o.prototype),r(l,o);const c=i("kCallback");function l(e){if(!(this instanceof l))return new l(e);const t=e?a(this,e,"readableHighWaterMark",!0):null;0===t&&(e={...e,highWaterMark:null,readableHighWaterMark:t,writableHighWaterMark:e.writableHighWaterMark||0}),o.call(this,e),this._readableState.sync=!1,this[c]=null,e&&("function"==typeof e.transform&&(this._transform=e.transform),"function"==typeof e.flush&&(this._flush=e.flush)),this.on("prefinish",u)}function d(e){"function"!=typeof this._flush||this.destroyed?(this.push(null),e&&e()):this._flush((t,n)=>{t?e?e(t):this.destroy(t):(null!=n&&this.push(n),this.push(null),e&&e())})}function u(){this._final!==d&&d.call(this)}l.prototype._final=d,l.prototype._transform=function(e,t,n){throw new s("_transform()")},l.prototype._write=function(e,t,n){const r=this._readableState,i=this._writableState,s=r.length;this._transform(e,t,(e,t)=>{e?n(e):(null!=t&&this.push(t),i.ended||s===r.length||r.length<r.highWaterMark?n():this[c]=n)})},l.prototype._read=function(){if(this[c]){const e=this[c];this[c]=null,e()}}},7562(e,t,n){"use strict";var r=this&&this.__createBinding||(Object.create?function(e,t,n,r){void 0===r&&(r=n);var i=Object.getOwnPropertyDescriptor(t,n);i&&!("get"in i?!t.__esModule:i.writable||i.configurable)||(i={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,r,i)}:function(e,t,n,r){void 0===r&&(r=n),e[r]=t[n]}),i=this&&this.__exportStar||function(e,t){for(var n in e)"default"===n||Object.prototype.hasOwnProperty.call(t,n)||r(t,e,n)},s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.sdk=t.MixinDeviceBase=t.ScryptedDeviceBase=void 0,i(n(4192),t);const o=s(n(9896)),a=n(4192);n(3339);class c extends a.DeviceBase{constructor(e){super(),this.nativeId=e}get storage(){return this._storage||(this._storage=t.sdk.deviceManager.getDeviceStorage(this.nativeId)),this._storage}get log(){return this._log||(this._log=t.sdk.deviceManager.getDeviceLogger(this.nativeId)),this._log}get console(){return this._console||(this._console=t.sdk.deviceManager.getDeviceConsole(this.nativeId)),this._console}async createMediaObject(e,n){return t.sdk.mediaManager.createMediaObject(e,n,{sourceId:this.id})}getMediaObjectConsole(e){return"string"!=typeof e.sourceId?this.console:t.sdk.deviceManager.getMixinConsole(e.sourceId,this.nativeId)}_lazyLoadDeviceState(){this._deviceState||(this.nativeId?this._deviceState=t.sdk.deviceManager.getDeviceState(this.nativeId):this._deviceState=t.sdk.deviceManager.getDeviceState())}onDeviceEvent(e,n){return t.sdk.deviceManager.onDeviceEvent(this.nativeId,e,n)}}t.ScryptedDeviceBase=c;class l extends a.DeviceBase{constructor(e){super(),this._listeners=new Set,this.mixinDevice=e.mixinDevice,this.mixinDeviceInterfaces=e.mixinDeviceInterfaces,this.mixinStorageSuffix=e.mixinStorageSuffix,this._deviceState=e.mixinDeviceState,this.nativeId=t.sdk.systemManager.getDeviceById(this.id).nativeId,this.mixinProviderNativeId=e.mixinProviderNativeId,this._deviceState.__rpcproxy_traps_all_properties&&"string"==typeof this._deviceState.id&&(this._deviceState=t.sdk.deviceManager.createDeviceState(this._deviceState.id,this._deviceState.setState))}get storage(){if(!this._storage){const e=this.mixinStorageSuffix,n=this.id+(e?":"+e:"");this._storage=t.sdk.deviceManager.getMixinStorage(n,this.mixinProviderNativeId)}return this._storage}get console(){return this._console||(t.sdk.deviceManager.getMixinConsole?this._console=t.sdk.deviceManager.getMixinConsole(this.id,this.mixinProviderNativeId):this._console=t.sdk.deviceManager.getDeviceConsole(this.mixinProviderNativeId)),this._console}async createMediaObject(e,n){return t.sdk.mediaManager.createMediaObject(e,n,{sourceId:this.id})}getMediaObjectConsole(e){return"string"!=typeof e.sourceId?this.console:t.sdk.deviceManager.getMixinConsole(e.sourceId,this.mixinProviderNativeId)}onDeviceEvent(e,n){return t.sdk.deviceManager.onMixinEvent(this.id,this,e,n)}_lazyLoadDeviceState(){}manageListener(e){this._listeners.add(e)}release(){for(const e of this._listeners)e.removeListener()}}t.MixinDeviceBase=l,function(){function e(e){return function(){return this._lazyLoadDeviceState(),this._deviceState?.[e]}}function t(e){return function(t){this._lazyLoadDeviceState(),this._deviceState?this._deviceState[e]=t:console.warn("device state is unavailable. the device must be discovered with deviceManager.onDeviceDiscovered or deviceManager.onDevicesChanged before the state can be set.")}}for(const n of Object.values(a.ScryptedInterfaceProperty))n!==a.ScryptedInterfaceProperty.nativeId&&(Object.defineProperty(c.prototype,n,{set:t(n),get:e(n)}),Object.defineProperty(l.prototype,n,{set:t(n),get:e(n)}))}(),t.sdk={};try{let e=!1;try{process.env.SCRYPTED_SDK_ES_MODULE||process.env.SCRYPTED_SDK_MODULE;const r=process.env.SCRYPTED_SDK_CJS_MODULE||process.env.SCRYPTED_SDK_MODULE;if(r)if("undefined"!=typeof require){const n=require(process.env.SCRYPTED_SDK_MODULE);Object.assign(t.sdk,n.getScryptedStatic()),e=!0}else{const i=n(3891)(r);Object.assign(t.sdk,i.getScryptedStatic()),e=!0}}catch(e){throw console.warn("failed to load sdk module",e),e}if(!e){let e;try{e=pluginRuntimeAPI}catch(e){}Object.assign(t.sdk,{log:deviceManager.getDeviceLogger(void 0),deviceManager,endpointManager,mediaManager,systemManager,pluginHostAPI,...e})}try{let e={...a.ScryptedInterfaceDescriptors};try{const t=JSON.parse(o.default.readFileSync("../sdk.json").toString()).interfaceDescriptors;t&&(e={...e,...t})}catch(e){console.warn("failed to load custom interface descriptors",e)}t.sdk.systemManager.setScryptedInterfaceDescriptors?.(a.TYPES_VERSION,e)?.catch(()=>{})}catch(e){}}catch(e){console.error("sdk initialization error, import @scrypted/types or use @scrypted/client instead",e)}t.default=t.sdk},7575(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const r=n(1725);class i{constructor(e){if(this.length=0,this._encoding="utf8",this._writeOffset=0,this._readOffset=0,i.isSmartBufferOptions(e))if(e.encoding&&(r.checkEncoding(e.encoding),this._encoding=e.encoding),e.size){if(!(r.isFiniteInteger(e.size)&&e.size>0))throw new Error(r.ERRORS.INVALID_SMARTBUFFER_SIZE);this._buff=Buffer.allocUnsafe(e.size)}else if(e.buff){if(!Buffer.isBuffer(e.buff))throw new Error(r.ERRORS.INVALID_SMARTBUFFER_BUFFER);this._buff=e.buff,this.length=e.buff.length}else this._buff=Buffer.allocUnsafe(4096);else{if("undefined"!=typeof e)throw new Error(r.ERRORS.INVALID_SMARTBUFFER_OBJECT);this._buff=Buffer.allocUnsafe(4096)}}static fromSize(e,t){return new this({size:e,encoding:t})}static fromBuffer(e,t){return new this({buff:e,encoding:t})}static fromOptions(e){return new this(e)}static isSmartBufferOptions(e){const t=e;return t&&(void 0!==t.encoding||void 0!==t.size||void 0!==t.buff)}readInt8(e){return this._readNumberValue(Buffer.prototype.readInt8,1,e)}readInt16BE(e){return this._readNumberValue(Buffer.prototype.readInt16BE,2,e)}readInt16LE(e){return this._readNumberValue(Buffer.prototype.readInt16LE,2,e)}readInt32BE(e){return this._readNumberValue(Buffer.prototype.readInt32BE,4,e)}readInt32LE(e){return this._readNumberValue(Buffer.prototype.readInt32LE,4,e)}readBigInt64BE(e){return r.bigIntAndBufferInt64Check("readBigInt64BE"),this._readNumberValue(Buffer.prototype.readBigInt64BE,8,e)}readBigInt64LE(e){return r.bigIntAndBufferInt64Check("readBigInt64LE"),this._readNumberValue(Buffer.prototype.readBigInt64LE,8,e)}writeInt8(e,t){return this._writeNumberValue(Buffer.prototype.writeInt8,1,e,t),this}insertInt8(e,t){return this._insertNumberValue(Buffer.prototype.writeInt8,1,e,t)}writeInt16BE(e,t){return this._writeNumberValue(Buffer.prototype.writeInt16BE,2,e,t)}insertInt16BE(e,t){return this._insertNumberValue(Buffer.prototype.writeInt16BE,2,e,t)}writeInt16LE(e,t){return this._writeNumberValue(Buffer.prototype.writeInt16LE,2,e,t)}insertInt16LE(e,t){return this._insertNumberValue(Buffer.prototype.writeInt16LE,2,e,t)}writeInt32BE(e,t){return this._writeNumberValue(Buffer.prototype.writeInt32BE,4,e,t)}insertInt32BE(e,t){return this._insertNumberValue(Buffer.prototype.writeInt32BE,4,e,t)}writeInt32LE(e,t){return this._writeNumberValue(Buffer.prototype.writeInt32LE,4,e,t)}insertInt32LE(e,t){return this._insertNumberValue(Buffer.prototype.writeInt32LE,4,e,t)}writeBigInt64BE(e,t){return r.bigIntAndBufferInt64Check("writeBigInt64BE"),this._writeNumberValue(Buffer.prototype.writeBigInt64BE,8,e,t)}insertBigInt64BE(e,t){return r.bigIntAndBufferInt64Check("writeBigInt64BE"),this._insertNumberValue(Buffer.prototype.writeBigInt64BE,8,e,t)}writeBigInt64LE(e,t){return r.bigIntAndBufferInt64Check("writeBigInt64LE"),this._writeNumberValue(Buffer.prototype.writeBigInt64LE,8,e,t)}insertBigInt64LE(e,t){return r.bigIntAndBufferInt64Check("writeBigInt64LE"),this._insertNumberValue(Buffer.prototype.writeBigInt64LE,8,e,t)}readUInt8(e){return this._readNumberValue(Buffer.prototype.readUInt8,1,e)}readUInt16BE(e){return this._readNumberValue(Buffer.prototype.readUInt16BE,2,e)}readUInt16LE(e){return this._readNumberValue(Buffer.prototype.readUInt16LE,2,e)}readUInt32BE(e){return this._readNumberValue(Buffer.prototype.readUInt32BE,4,e)}readUInt32LE(e){return this._readNumberValue(Buffer.prototype.readUInt32LE,4,e)}readBigUInt64BE(e){return r.bigIntAndBufferInt64Check("readBigUInt64BE"),this._readNumberValue(Buffer.prototype.readBigUInt64BE,8,e)}readBigUInt64LE(e){return r.bigIntAndBufferInt64Check("readBigUInt64LE"),this._readNumberValue(Buffer.prototype.readBigUInt64LE,8,e)}writeUInt8(e,t){return this._writeNumberValue(Buffer.prototype.writeUInt8,1,e,t)}insertUInt8(e,t){return this._insertNumberValue(Buffer.prototype.writeUInt8,1,e,t)}writeUInt16BE(e,t){return this._writeNumberValue(Buffer.prototype.writeUInt16BE,2,e,t)}insertUInt16BE(e,t){return this._insertNumberValue(Buffer.prototype.writeUInt16BE,2,e,t)}writeUInt16LE(e,t){return this._writeNumberValue(Buffer.prototype.writeUInt16LE,2,e,t)}insertUInt16LE(e,t){return this._insertNumberValue(Buffer.prototype.writeUInt16LE,2,e,t)}writeUInt32BE(e,t){return this._writeNumberValue(Buffer.prototype.writeUInt32BE,4,e,t)}insertUInt32BE(e,t){return this._insertNumberValue(Buffer.prototype.writeUInt32BE,4,e,t)}writeUInt32LE(e,t){return this._writeNumberValue(Buffer.prototype.writeUInt32LE,4,e,t)}insertUInt32LE(e,t){return this._insertNumberValue(Buffer.prototype.writeUInt32LE,4,e,t)}writeBigUInt64BE(e,t){return r.bigIntAndBufferInt64Check("writeBigUInt64BE"),this._writeNumberValue(Buffer.prototype.writeBigUInt64BE,8,e,t)}insertBigUInt64BE(e,t){return r.bigIntAndBufferInt64Check("writeBigUInt64BE"),this._insertNumberValue(Buffer.prototype.writeBigUInt64BE,8,e,t)}writeBigUInt64LE(e,t){return r.bigIntAndBufferInt64Check("writeBigUInt64LE"),this._writeNumberValue(Buffer.prototype.writeBigUInt64LE,8,e,t)}insertBigUInt64LE(e,t){return r.bigIntAndBufferInt64Check("writeBigUInt64LE"),this._insertNumberValue(Buffer.prototype.writeBigUInt64LE,8,e,t)}readFloatBE(e){return this._readNumberValue(Buffer.prototype.readFloatBE,4,e)}readFloatLE(e){return this._readNumberValue(Buffer.prototype.readFloatLE,4,e)}writeFloatBE(e,t){return this._writeNumberValue(Buffer.prototype.writeFloatBE,4,e,t)}insertFloatBE(e,t){return this._insertNumberValue(Buffer.prototype.writeFloatBE,4,e,t)}writeFloatLE(e,t){return this._writeNumberValue(Buffer.prototype.writeFloatLE,4,e,t)}insertFloatLE(e,t){return this._insertNumberValue(Buffer.prototype.writeFloatLE,4,e,t)}readDoubleBE(e){return this._readNumberValue(Buffer.prototype.readDoubleBE,8,e)}readDoubleLE(e){return this._readNumberValue(Buffer.prototype.readDoubleLE,8,e)}writeDoubleBE(e,t){return this._writeNumberValue(Buffer.prototype.writeDoubleBE,8,e,t)}insertDoubleBE(e,t){return this._insertNumberValue(Buffer.prototype.writeDoubleBE,8,e,t)}writeDoubleLE(e,t){return this._writeNumberValue(Buffer.prototype.writeDoubleLE,8,e,t)}insertDoubleLE(e,t){return this._insertNumberValue(Buffer.prototype.writeDoubleLE,8,e,t)}readString(e,t){let n;"number"==typeof e?(r.checkLengthValue(e),n=Math.min(e,this.length-this._readOffset)):(t=e,n=this.length-this._readOffset),"undefined"!=typeof t&&r.checkEncoding(t);const i=this._buff.slice(this._readOffset,this._readOffset+n).toString(t||this._encoding);return this._readOffset+=n,i}insertString(e,t,n){return r.checkOffsetValue(t),this._handleString(e,!0,t,n)}writeString(e,t,n){return this._handleString(e,!1,t,n)}readStringNT(e){"undefined"!=typeof e&&r.checkEncoding(e);let t=this.length;for(let e=this._readOffset;e<this.length;e++)if(0===this._buff[e]){t=e;break}const n=this._buff.slice(this._readOffset,t);return this._readOffset=t+1,n.toString(e||this._encoding)}insertStringNT(e,t,n){return r.checkOffsetValue(t),this.insertString(e,t,n),this.insertUInt8(0,t+e.length),this}writeStringNT(e,t,n){return this.writeString(e,t,n),this.writeUInt8(0,"number"==typeof t?t+e.length:this.writeOffset),this}readBuffer(e){"undefined"!=typeof e&&r.checkLengthValue(e);const t="number"==typeof e?e:this.length,n=Math.min(this.length,this._readOffset+t),i=this._buff.slice(this._readOffset,n);return this._readOffset=n,i}insertBuffer(e,t){return r.checkOffsetValue(t),this._handleBuffer(e,!0,t)}writeBuffer(e,t){return this._handleBuffer(e,!1,t)}readBufferNT(){let e=this.length;for(let t=this._readOffset;t<this.length;t++)if(0===this._buff[t]){e=t;break}const t=this._buff.slice(this._readOffset,e);return this._readOffset=e+1,t}insertBufferNT(e,t){return r.checkOffsetValue(t),this.insertBuffer(e,t),this.insertUInt8(0,t+e.length),this}writeBufferNT(e,t){return"undefined"!=typeof t&&r.checkOffsetValue(t),this.writeBuffer(e,t),this.writeUInt8(0,"number"==typeof t?t+e.length:this._writeOffset),this}clear(){return this._writeOffset=0,this._readOffset=0,this.length=0,this}remaining(){return this.length-this._readOffset}get readOffset(){return this._readOffset}set readOffset(e){r.checkOffsetValue(e),r.checkTargetOffset(e,this),this._readOffset=e}get writeOffset(){return this._writeOffset}set writeOffset(e){r.checkOffsetValue(e),r.checkTargetOffset(e,this),this._writeOffset=e}get encoding(){return this._encoding}set encoding(e){r.checkEncoding(e),this._encoding=e}get internalBuffer(){return this._buff}toBuffer(){return this._buff.slice(0,this.length)}toString(e){const t="string"==typeof e?e:this._encoding;return r.checkEncoding(t),this._buff.toString(t,0,this.length)}destroy(){return this.clear(),this}_handleString(e,t,n,i){let s=this._writeOffset,o=this._encoding;"number"==typeof n?s=n:"string"==typeof n&&(r.checkEncoding(n),o=n),"string"==typeof i&&(r.checkEncoding(i),o=i);const a=Buffer.byteLength(e,o);return t?this.ensureInsertable(a,s):this._ensureWriteable(a,s),this._buff.write(e,s,a,o),t?this._writeOffset+=a:"number"==typeof n?this._writeOffset=Math.max(this._writeOffset,s+a):this._writeOffset+=a,this}_handleBuffer(e,t,n){const r="number"==typeof n?n:this._writeOffset;return t?this.ensureInsertable(e.length,r):this._ensureWriteable(e.length,r),e.copy(this._buff,r),t?this._writeOffset+=e.length:"number"==typeof n?this._writeOffset=Math.max(this._writeOffset,r+e.length):this._writeOffset+=e.length,this}ensureReadable(e,t){let n=this._readOffset;if("undefined"!=typeof t&&(r.checkOffsetValue(t),n=t),n<0||n+e>this.length)throw new Error(r.ERRORS.INVALID_READ_BEYOND_BOUNDS)}ensureInsertable(e,t){r.checkOffsetValue(t),this._ensureCapacity(this.length+e),t<this.length&&this._buff.copy(this._buff,t+e,t,this._buff.length),t+e>this.length?this.length=t+e:this.length+=e}_ensureWriteable(e,t){const n="number"==typeof t?t:this._writeOffset;this._ensureCapacity(n+e),n+e>this.length&&(this.length=n+e)}_ensureCapacity(e){const t=this._buff.length;if(e>t){let n=this._buff,r=3*t/2+1;r<e&&(r=e),this._buff=Buffer.allocUnsafe(r),n.copy(this._buff,0,0,t)}}_readNumberValue(e,t,n){this.ensureReadable(t,n);const r=e.call(this._buff,"number"==typeof n?n:this._readOffset);return"undefined"==typeof n&&(this._readOffset+=t),r}_insertNumberValue(e,t,n,i){return r.checkOffsetValue(i),this.ensureInsertable(t,i),e.call(this._buff,n,i),this._writeOffset+=t,this}_writeNumberValue(e,t,n,i){if("number"==typeof i){if(i<0)throw new Error(r.ERRORS.INVALID_WRITE_BEYOND_BOUNDS);r.checkOffsetValue(i)}const s="number"==typeof i?i:this._writeOffset;return this._ensureWriteable(t,s),e.call(this._buff,n,s),"number"==typeof i?this._writeOffset=Math.max(this._writeOffset,s+t):this._writeOffset+=t,this}}t.SmartBuffer=i},7576(e,t,n){"use strict";const r=n(4422),{ArrayPrototypeIndexOf:i,NumberIsInteger:s,NumberIsNaN:o,NumberParseInt:a,ObjectDefineProperties:c,ObjectKeys:l,ObjectSetPrototypeOf:d,Promise:u,SafeSet:h,SymbolAsyncDispose:p,SymbolAsyncIterator:f,Symbol:g}=n(4134);e.exports=z,z.ReadableState=V;const{EventEmitter:m}=n(4434),{Stream:y,prependListener:b}=n(4259),{Buffer:v}=n(181),{addAbortSignal:S}=n(4147),_=n(6238);let w=n(7760).debuglog("stream",e=>{w=e});const k=n(345),I=n(5896),{getHighWaterMark:E,getDefaultHighWaterMark:x}=n(5291),{aggregateTwoErrors:T,codes:{ERR_INVALID_ARG_TYPE:C,ERR_METHOD_NOT_IMPLEMENTED:O,ERR_OUT_OF_RANGE:A,ERR_STREAM_PUSH_AFTER_EOF:P,ERR_STREAM_UNSHIFT_AFTER_END_EVENT:R},AbortError:M}=n(6371),{validateObject:N}=n(277),B=g("kPaused"),{StringDecoder:L}=n(3141),j=n(6532);d(z.prototype,y.prototype),d(z,y);const D=()=>{},{errorOrDestroy:U}=I,F=2048,$=4096;function W(e){return{enumerable:!1,get(){return 0!==(this.state&e)},set(t){t?this.state|=e:this.state&=~e}}}function V(e,t,r){"boolean"!=typeof r&&(r=t instanceof n(3370)),this.state=6192,e&&e.objectMode&&(this.state|=1),r&&e&&e.readableObjectMode&&(this.state|=1),this.highWaterMark=e?E(this,e,"readableHighWaterMark",r):x(!1),this.buffer=new k,this.length=0,this.pipes=[],this.flowing=null,this[B]=null,e&&!1===e.emitClose&&(this.state&=-2049),e&&!1===e.autoDestroy&&(this.state&=-4097),this.errored=null,this.defaultEncoding=e&&e.defaultEncoding||"utf8",this.awaitDrainWriters=null,this.decoder=null,this.encoding=null,e&&e.encoding&&(this.decoder=new L(e.encoding),this.encoding=e.encoding)}function z(e){if(!(this instanceof z))return new z(e);const t=this instanceof n(3370);this._readableState=new V(e,this,t),e&&("function"==typeof e.read&&(this._read=e.read),"function"==typeof e.destroy&&(this._destroy=e.destroy),"function"==typeof e.construct&&(this._construct=e.construct),e.signal&&!t&&S(e.signal,this)),y.call(this,e),I.construct(this,()=>{this._readableState.needReadable&&Q(this,this._readableState)})}function H(e,t,n,r){w("readableAddChunk",t);const i=e._readableState;let s;if(1&i.state||("string"==typeof t?(n=n||i.defaultEncoding,i.encoding!==n&&(r&&i.encoding?t=v.from(t,n).toString(i.encoding):(t=v.from(t,n),n=""))):t instanceof v?n="":y._isUint8Array(t)?(t=y._uint8ArrayToBuffer(t),n=""):null!=t&&(s=new C("chunk",["string","Buffer","Uint8Array"],t))),s)U(e,s);else if(null===t)i.state&=-9,function(e,t){if(w("onEofChunk"),t.ended)return;if(t.decoder){const e=t.decoder.end();e&&e.length&&(t.buffer.push(e),t.length+=t.objectMode?1:e.length)}t.ended=!0,t.sync?K(e):(t.needReadable=!1,t.emittedReadable=!0,J(e))}(e,i);else if(1&i.state||t&&t.length>0)if(r)if(4&i.state)U(e,new R);else{if(i.destroyed||i.errored)return!1;q(e,i,t,!0)}else if(i.ended)U(e,new P);else{if(i.destroyed||i.errored)return!1;i.state&=-9,i.decoder&&!n?(t=i.decoder.write(t),i.objectMode||0!==t.length?q(e,i,t,!1):Q(e,i)):q(e,i,t,!1)}else r||(i.state&=-9,Q(e,i));return!i.ended&&(i.length<i.highWaterMark||0===i.length)}function q(e,t,n,r){t.flowing&&0===t.length&&!t.sync&&e.listenerCount("data")>0?(65536&t.state?t.awaitDrainWriters.clear():t.awaitDrainWriters=null,t.dataEmitted=!0,e.emit("data",n)):(t.length+=t.objectMode?1:n.length,r?t.buffer.unshift(n):t.buffer.push(n),64&t.state&&K(e)),Q(e,t)}c(V.prototype,{objectMode:W(1),ended:W(2),endEmitted:W(4),reading:W(8),constructed:W(16),sync:W(32),needReadable:W(64),emittedReadable:W(128),readableListening:W(256),resumeScheduled:W(512),errorEmitted:W(1024),emitClose:W(F),autoDestroy:W($),destroyed:W(8192),closed:W(16384),closeEmitted:W(32768),multiAwaitDrain:W(65536),readingMore:W(1<<17),dataEmitted:W(1<<18)}),z.prototype.destroy=I.destroy,z.prototype._undestroy=I.undestroy,z.prototype._destroy=function(e,t){t(e)},z.prototype[m.captureRejectionSymbol]=function(e){this.destroy(e)},z.prototype[p]=function(){let e;return this.destroyed||(e=this.readableEnded?null:new M,this.destroy(e)),new u((t,n)=>_(this,r=>r&&r!==e?n(r):t(null)))},z.prototype.push=function(e,t){return H(this,e,t,!1)},z.prototype.unshift=function(e,t){return H(this,e,t,!0)},z.prototype.isPaused=function(){const e=this._readableState;return!0===e[B]||!1===e.flowing},z.prototype.setEncoding=function(e){const t=new L(e);this._readableState.decoder=t,this._readableState.encoding=this._readableState.decoder.encoding;const n=this._readableState.buffer;let r="";for(const e of n)r+=t.write(e);return n.clear(),""!==r&&n.push(r),this._readableState.length=r.length,this};function G(e,t){return e<=0||0===t.length&&t.ended?0:1&t.state?1:o(e)?t.flowing&&t.length?t.buffer.first().length:t.length:e<=t.length?e:t.ended?t.length:0}function K(e){const t=e._readableState;w("emitReadable",t.needReadable,t.emittedReadable),t.needReadable=!1,t.emittedReadable||(w("emitReadable",t.flowing),t.emittedReadable=!0,r.nextTick(J,e))}function J(e){const t=e._readableState;w("emitReadable_",t.destroyed,t.length,t.ended),t.destroyed||t.errored||!t.length&&!t.ended||(e.emit("readable"),t.emittedReadable=!1),t.needReadable=!t.flowing&&!t.ended&&t.length<=t.highWaterMark,te(e)}function Q(e,t){!t.readingMore&&t.constructed&&(t.readingMore=!0,r.nextTick(Y,e,t))}function Y(e,t){for(;!t.reading&&!t.ended&&(t.length<t.highWaterMark||t.flowing&&0===t.length);){const n=t.length;if(w("maybeReadMore read 0"),e.read(0),n===t.length)break}t.readingMore=!1}function Z(e){const t=e._readableState;t.readableListening=e.listenerCount("readable")>0,t.resumeScheduled&&!1===t[B]?t.flowing=!0:e.listenerCount("data")>0?e.resume():t.readableListening||(t.flowing=null)}function X(e){w("readable nexttick read 0"),e.read(0)}function ee(e,t){w("resume",t.reading),t.reading||e.read(0),t.resumeScheduled=!1,e.emit("resume"),te(e),t.flowing&&!t.reading&&e.read(0)}function te(e){const t=e._readableState;for(w("flow",t.flowing);t.flowing&&null!==e.read(););}function ne(e,t){"function"!=typeof e.read&&(e=z.wrap(e,{objectMode:!0}));const n=async function*(e,t){let n,r=D;function i(t){this===e?(r(),r=D):r=t}e.on("readable",i);const s=_(e,{writable:!1},e=>{n=e?T(n,e):null,r(),r=D});try{for(;;){const t=e.destroyed?null:e.read();if(null!==t)yield t;else{if(n)throw n;if(null===n)return;await new u(i)}}}catch(e){throw n=T(n,e),n}finally{!n&&!1===(null==t?void 0:t.destroyOnReturn)||void 0!==n&&!e._readableState.autoDestroy?(e.off("readable",i),s()):I.destroyer(e,null)}}(e,t);return n.stream=e,n}function re(e,t){if(0===t.length)return null;let n;return t.objectMode?n=t.buffer.shift():!e||e>=t.length?(n=t.decoder?t.buffer.join(""):1===t.buffer.length?t.buffer.first():t.buffer.concat(t.length),t.buffer.clear()):n=t.buffer.consume(e,t.decoder),n}function ie(e){const t=e._readableState;w("endReadable",t.endEmitted),t.endEmitted||(t.ended=!0,r.nextTick(se,t,e))}function se(e,t){if(w("endReadableNT",e.endEmitted,e.length),!e.errored&&!e.closeEmitted&&!e.endEmitted&&0===e.length)if(e.endEmitted=!0,t.emit("end"),t.writable&&!1===t.allowHalfOpen)r.nextTick(oe,t);else if(e.autoDestroy){const e=t._writableState;(!e||e.autoDestroy&&(e.finished||!1===e.writable))&&t.destroy()}}function oe(e){e.writable&&!e.writableEnded&&!e.destroyed&&e.end()}let ae;function ce(){return void 0===ae&&(ae={}),ae}z.prototype.read=function(e){w("read",e),void 0===e?e=NaN:s(e)||(e=a(e,10));const t=this._readableState,n=e;if(e>t.highWaterMark&&(t.highWaterMark=function(e){if(e>1073741824)throw new A("size","<= 1GiB",e);return e--,e|=e>>>1,e|=e>>>2,e|=e>>>4,e|=e>>>8,e|=e>>>16,++e}(e)),0!==e&&(t.state&=-129),0===e&&t.needReadable&&((0!==t.highWaterMark?t.length>=t.highWaterMark:t.length>0)||t.ended))return w("read: emitReadable",t.length,t.ended),0===t.length&&t.ended?ie(this):K(this),null;if(0===(e=G(e,t))&&t.ended)return 0===t.length&&ie(this),null;let r,i=!!(64&t.state);if(w("need readable",i),(0===t.length||t.length-e<t.highWaterMark)&&(i=!0,w("length less than watermark",i)),t.ended||t.reading||t.destroyed||t.errored||!t.constructed)i=!1,w("reading, ended or constructing",i);else if(i){w("do read"),t.state|=40,0===t.length&&(t.state|=64);try{this._read(t.highWaterMark)}catch(e){U(this,e)}t.state&=-33,t.reading||(e=G(n,t))}return r=e>0?re(e,t):null,null===r?(t.needReadable=t.length<=t.highWaterMark,e=0):(t.length-=e,t.multiAwaitDrain?t.awaitDrainWriters.clear():t.awaitDrainWriters=null),0===t.length&&(t.ended||(t.needReadable=!0),n!==e&&t.ended&&ie(this)),null===r||t.errorEmitted||t.closeEmitted||(t.dataEmitted=!0,this.emit("data",r)),r},z.prototype._read=function(e){throw new O("_read()")},z.prototype.pipe=function(e,t){const n=this,i=this._readableState;1===i.pipes.length&&(i.multiAwaitDrain||(i.multiAwaitDrain=!0,i.awaitDrainWriters=new h(i.awaitDrainWriters?[i.awaitDrainWriters]:[]))),i.pipes.push(e),w("pipe count=%d opts=%j",i.pipes.length,t);const s=(!t||!1!==t.end)&&e!==r.stdout&&e!==r.stderr?a:m;function o(t,r){w("onunpipe"),t===n&&r&&!1===r.hasUnpiped&&(r.hasUnpiped=!0,function(){w("cleanup"),e.removeListener("close",f),e.removeListener("finish",g),c&&e.removeListener("drain",c);e.removeListener("error",p),e.removeListener("unpipe",o),n.removeListener("end",a),n.removeListener("end",m),n.removeListener("data",u),l=!0,c&&i.awaitDrainWriters&&(!e._writableState||e._writableState.needDrain)&&c()}())}function a(){w("onend"),e.end()}let c;i.endEmitted?r.nextTick(s):n.once("end",s),e.on("unpipe",o);let l=!1;function d(){l||(1===i.pipes.length&&i.pipes[0]===e?(w("false write response, pause",0),i.awaitDrainWriters=e,i.multiAwaitDrain=!1):i.pipes.length>1&&i.pipes.includes(e)&&(w("false write response, pause",i.awaitDrainWriters.size),i.awaitDrainWriters.add(e)),n.pause()),c||(c=function(e,t){return function(){const n=e._readableState;n.awaitDrainWriters===t?(w("pipeOnDrain",1),n.awaitDrainWriters=null):n.multiAwaitDrain&&(w("pipeOnDrain",n.awaitDrainWriters.size),n.awaitDrainWriters.delete(t)),n.awaitDrainWriters&&0!==n.awaitDrainWriters.size||!e.listenerCount("data")||e.resume()}}(n,e),e.on("drain",c))}function u(t){w("ondata");const n=e.write(t);w("dest.write",n),!1===n&&d()}function p(t){if(w("onerror",t),m(),e.removeListener("error",p),0===e.listenerCount("error")){const n=e._writableState||e._readableState;n&&!n.errorEmitted?U(e,t):e.emit("error",t)}}function f(){e.removeListener("finish",g),m()}function g(){w("onfinish"),e.removeListener("close",f),m()}function m(){w("unpipe"),n.unpipe(e)}return n.on("data",u),b(e,"error",p),e.once("close",f),e.once("finish",g),e.emit("pipe",n),!0===e.writableNeedDrain?d():i.flowing||(w("pipe resume"),n.resume()),e},z.prototype.unpipe=function(e){const t=this._readableState;if(0===t.pipes.length)return this;if(!e){const e=t.pipes;t.pipes=[],this.pause();for(let t=0;t<e.length;t++)e[t].emit("unpipe",this,{hasUnpiped:!1});return this}const n=i(t.pipes,e);return-1===n||(t.pipes.splice(n,1),0===t.pipes.length&&this.pause(),e.emit("unpipe",this,{hasUnpiped:!1})),this},z.prototype.on=function(e,t){const n=y.prototype.on.call(this,e,t),i=this._readableState;return"data"===e?(i.readableListening=this.listenerCount("readable")>0,!1!==i.flowing&&this.resume()):"readable"===e&&(i.endEmitted||i.readableListening||(i.readableListening=i.needReadable=!0,i.flowing=!1,i.emittedReadable=!1,w("on readable",i.length,i.reading),i.length?K(this):i.reading||r.nextTick(X,this))),n},z.prototype.addListener=z.prototype.on,z.prototype.removeListener=function(e,t){const n=y.prototype.removeListener.call(this,e,t);return"readable"===e&&r.nextTick(Z,this),n},z.prototype.off=z.prototype.removeListener,z.prototype.removeAllListeners=function(e){const t=y.prototype.removeAllListeners.apply(this,arguments);return"readable"!==e&&void 0!==e||r.nextTick(Z,this),t},z.prototype.resume=function(){const e=this._readableState;return e.flowing||(w("resume"),e.flowing=!e.readableListening,function(e,t){t.resumeScheduled||(t.resumeScheduled=!0,r.nextTick(ee,e,t))}(this,e)),e[B]=!1,this},z.prototype.pause=function(){return w("call pause flowing=%j",this._readableState.flowing),!1!==this._readableState.flowing&&(w("pause"),this._readableState.flowing=!1,this.emit("pause")),this._readableState[B]=!0,this},z.prototype.wrap=function(e){let t=!1;e.on("data",n=>{!this.push(n)&&e.pause&&(t=!0,e.pause())}),e.on("end",()=>{this.push(null)}),e.on("error",e=>{U(this,e)}),e.on("close",()=>{this.destroy()}),e.on("destroy",()=>{this.destroy()}),this._read=()=>{t&&e.resume&&(t=!1,e.resume())};const n=l(e);for(let t=1;t<n.length;t++){const r=n[t];void 0===this[r]&&"function"==typeof e[r]&&(this[r]=e[r].bind(e))}return this},z.prototype[f]=function(){return ne(this)},z.prototype.iterator=function(e){return void 0!==e&&N(e,"options"),ne(this,e)},c(z.prototype,{readable:{__proto__:null,get(){const e=this._readableState;return!(!e||!1===e.readable||e.destroyed||e.errorEmitted||e.endEmitted)},set(e){this._readableState&&(this._readableState.readable=!!e)}},readableDidRead:{__proto__:null,enumerable:!1,get:function(){return this._readableState.dataEmitted}},readableAborted:{__proto__:null,enumerable:!1,get:function(){return!(!1===this._readableState.readable||!this._readableState.destroyed&&!this._readableState.errored||this._readableState.endEmitted)}},readableHighWaterMark:{__proto__:null,enumerable:!1,get:function(){return this._readableState.highWaterMark}},readableBuffer:{__proto__:null,enumerable:!1,get:function(){return this._readableState&&this._readableState.buffer}},readableFlowing:{__proto__:null,enumerable:!1,get:function(){return this._readableState.flowing},set:function(e){this._readableState&&(this._readableState.flowing=e)}},readableLength:{__proto__:null,enumerable:!1,get(){return this._readableState.length}},readableObjectMode:{__proto__:null,enumerable:!1,get(){return!!this._readableState&&this._readableState.objectMode}},readableEncoding:{__proto__:null,enumerable:!1,get(){return this._readableState?this._readableState.encoding:null}},errored:{__proto__:null,enumerable:!1,get(){return this._readableState?this._readableState.errored:null}},closed:{__proto__:null,get(){return!!this._readableState&&this._readableState.closed}},destroyed:{__proto__:null,enumerable:!1,get(){return!!this._readableState&&this._readableState.destroyed},set(e){this._readableState&&(this._readableState.destroyed=e)}},readableEnded:{__proto__:null,enumerable:!1,get(){return!!this._readableState&&this._readableState.endEmitted}}}),c(V.prototype,{pipesCount:{__proto__:null,get(){return this.pipes.length}},paused:{__proto__:null,get(){return!1!==this[B]},set(e){this[B]=!!e}}}),z._fromList=re,z.from=function(e,t){return j(z,e,t)},z.fromWeb=function(e,t){return ce().newStreamReadableFromReadableStream(e,t)},z.toWeb=function(e,t){return ce().newReadableStreamFromStreamReadable(e,t)},z.wrap=function(e,t){var n,r;return new z({objectMode:null===(n=null!==(r=e.readableObjectMode)&&void 0!==r?r:e.objectMode)||void 0===n||n,...t,destroy(t,n){I.destroyer(e,t),n(t)}}).wrap(e)}},7631(e,t,n){"use strict";var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))(function(i,s){function o(e){try{c(r.next(e))}catch(e){s(e)}}function a(e){try{c(r.throw(e))}catch(e){s(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n(function(e){e(t)})).then(o,a)}c((r=r.apply(e,t||[])).next())})};Object.defineProperty(t,"__esModule",{value:!0}),t.SocksClientError=t.SocksClient=void 0;const i=n(4434),s=n(9278),o=n(7575),a=n(5438),c=n(7130),l=n(7736),d=n(3763);Object.defineProperty(t,"SocksClientError",{enumerable:!0,get:function(){return d.SocksClientError}});const u=n(9424);class h extends i.EventEmitter{constructor(e){super(),this.options=Object.assign({},e),(0,c.validateSocksClientOptions)(e),this.setState(a.SocksClientState.Created)}static createConnection(e,t){return new Promise((n,r)=>{try{(0,c.validateSocksClientOptions)(e,["connect"])}catch(e){return"function"==typeof t?(t(e),n(e)):r(e)}const i=new h(e);i.connect(e.existing_socket),i.once("established",e=>{i.removeAllListeners(),"function"==typeof t?(t(null,e),n(e)):n(e)}),i.once("error",e=>{i.removeAllListeners(),"function"==typeof t?(t(e),n(e)):r(e)})})}static createConnectionChain(e,t){return new Promise((n,i)=>r(this,void 0,void 0,function*(){try{(0,c.validateSocksClientChainOptions)(e)}catch(e){return"function"==typeof t?(t(e),n(e)):i(e)}e.randomizeChain&&(0,d.shuffleArray)(e.proxies);try{let r;for(let t=0;t<e.proxies.length;t++){const n=e.proxies[t],i=t===e.proxies.length-1?e.destination:{host:e.proxies[t+1].host||e.proxies[t+1].ipaddress,port:e.proxies[t+1].port},s=yield h.createConnection({command:"connect",proxy:n,destination:i,existing_socket:r});r=r||s.socket}"function"==typeof t?(t(null,{socket:r}),n({socket:r})):n({socket:r})}catch(e){"function"==typeof t?(t(e),n(e)):i(e)}}))}static createUDPFrame(e){const t=new o.SmartBuffer;return t.writeUInt16BE(0),t.writeUInt8(e.frameNumber||0),s.isIPv4(e.remoteHost.host)?(t.writeUInt8(a.Socks5HostType.IPv4),t.writeUInt32BE((0,c.ipv4ToInt32)(e.remoteHost.host))):s.isIPv6(e.remoteHost.host)?(t.writeUInt8(a.Socks5HostType.IPv6),t.writeBuffer((0,c.ipToBuffer)(e.remoteHost.host))):(t.writeUInt8(a.Socks5HostType.Hostname),t.writeUInt8(Buffer.byteLength(e.remoteHost.host)),t.writeString(e.remoteHost.host)),t.writeUInt16BE(e.remoteHost.port),t.writeBuffer(e.data),t.toBuffer()}static parseUDPFrame(e){const t=o.SmartBuffer.fromBuffer(e);t.readOffset=2;const n=t.readUInt8(),r=t.readUInt8();let i;i=r===a.Socks5HostType.IPv4?(0,c.int32ToIpv4)(t.readUInt32BE()):r===a.Socks5HostType.IPv6?u.Address6.fromByteArray(Array.from(t.readBuffer(16))).canonicalForm():t.readString(t.readUInt8());return{frameNumber:n,remoteHost:{host:i,port:t.readUInt16BE()},data:t.readBuffer()}}setState(e){this.state!==a.SocksClientState.Error&&(this.state=e)}connect(e){this.onDataReceived=e=>this.onDataReceivedHandler(e),this.onClose=()=>this.onCloseHandler(),this.onError=e=>this.onErrorHandler(e),this.onConnect=()=>this.onConnectHandler();const t=setTimeout(()=>this.onEstablishedTimeout(),this.options.timeout||a.DEFAULT_TIMEOUT);t.unref&&"function"==typeof t.unref&&t.unref(),this.socket=e||new s.Socket,this.socket.once("close",this.onClose),this.socket.once("error",this.onError),this.socket.once("connect",this.onConnect),this.socket.on("data",this.onDataReceived),this.setState(a.SocksClientState.Connecting),this.receiveBuffer=new l.ReceiveBuffer,e?this.socket.emit("connect"):(this.socket.connect(this.getSocketOptions()),void 0!==this.options.set_tcp_nodelay&&null!==this.options.set_tcp_nodelay&&this.socket.setNoDelay(!!this.options.set_tcp_nodelay)),this.prependOnceListener("established",e=>{setImmediate(()=>{if(this.receiveBuffer.length>0){const t=this.receiveBuffer.get(this.receiveBuffer.length);e.socket.emit("data",t)}e.socket.resume()})})}getSocketOptions(){return Object.assign(Object.assign({},this.options.socket_options),{host:this.options.proxy.host||this.options.proxy.ipaddress,port:this.options.proxy.port})}onEstablishedTimeout(){this.state!==a.SocksClientState.Established&&this.state!==a.SocksClientState.BoundWaitingForConnection&&this.closeSocket(a.ERRORS.ProxyConnectionTimedOut)}onConnectHandler(){this.setState(a.SocksClientState.Connected),4===this.options.proxy.type?this.sendSocks4InitialHandshake():this.sendSocks5InitialHandshake(),this.setState(a.SocksClientState.SentInitialHandshake)}onDataReceivedHandler(e){this.receiveBuffer.append(e),this.processData()}processData(){for(;this.state!==a.SocksClientState.Established&&this.state!==a.SocksClientState.Error&&this.receiveBuffer.length>=this.nextRequiredPacketBufferSize;)if(this.state===a.SocksClientState.SentInitialHandshake)4===this.options.proxy.type?this.handleSocks4FinalHandshakeResponse():this.handleInitialSocks5HandshakeResponse();else if(this.state===a.SocksClientState.SentAuthentication)this.handleInitialSocks5AuthenticationHandshakeResponse();else if(this.state===a.SocksClientState.SentFinalHandshake)this.handleSocks5FinalHandshakeResponse();else{if(this.state!==a.SocksClientState.BoundWaitingForConnection){this.closeSocket(a.ERRORS.InternalError);break}4===this.options.proxy.type?this.handleSocks4IncomingConnectionResponse():this.handleSocks5IncomingConnectionResponse()}}onCloseHandler(){this.closeSocket(a.ERRORS.SocketClosed)}onErrorHandler(e){this.closeSocket(e.message)}removeInternalSocketHandlers(){this.socket.pause(),this.socket.removeListener("data",this.onDataReceived),this.socket.removeListener("close",this.onClose),this.socket.removeListener("error",this.onError),this.socket.removeListener("connect",this.onConnect)}closeSocket(e){this.state!==a.SocksClientState.Error&&(this.setState(a.SocksClientState.Error),this.socket.destroy(),this.removeInternalSocketHandlers(),this.emit("error",new d.SocksClientError(e,this.options)))}sendSocks4InitialHandshake(){const e=this.options.proxy.userId||"",t=new o.SmartBuffer;t.writeUInt8(4),t.writeUInt8(a.SocksCommand[this.options.command]),t.writeUInt16BE(this.options.destination.port),s.isIPv4(this.options.destination.host)?(t.writeBuffer((0,c.ipToBuffer)(this.options.destination.host)),t.writeStringNT(e)):(t.writeUInt8(0),t.writeUInt8(0),t.writeUInt8(0),t.writeUInt8(1),t.writeStringNT(e),t.writeStringNT(this.options.destination.host)),this.nextRequiredPacketBufferSize=a.SOCKS_INCOMING_PACKET_SIZES.Socks4Response,this.socket.write(t.toBuffer())}handleSocks4FinalHandshakeResponse(){const e=this.receiveBuffer.get(8);if(e[1]!==a.Socks4Response.Granted)this.closeSocket(`${a.ERRORS.Socks4ProxyRejectedConnection} - (${a.Socks4Response[e[1]]})`);else if(a.SocksCommand[this.options.command]===a.SocksCommand.bind){const t=o.SmartBuffer.fromBuffer(e);t.readOffset=2;const n={port:t.readUInt16BE(),host:(0,c.int32ToIpv4)(t.readUInt32BE())};"0.0.0.0"===n.host&&(n.host=this.options.proxy.ipaddress),this.setState(a.SocksClientState.BoundWaitingForConnection),this.emit("bound",{remoteHost:n,socket:this.socket})}else this.setState(a.SocksClientState.Established),this.removeInternalSocketHandlers(),this.emit("established",{socket:this.socket})}handleSocks4IncomingConnectionResponse(){const e=this.receiveBuffer.get(8);if(e[1]!==a.Socks4Response.Granted)this.closeSocket(`${a.ERRORS.Socks4ProxyRejectedIncomingBoundConnection} - (${a.Socks4Response[e[1]]})`);else{const t=o.SmartBuffer.fromBuffer(e);t.readOffset=2;const n={port:t.readUInt16BE(),host:(0,c.int32ToIpv4)(t.readUInt32BE())};this.setState(a.SocksClientState.Established),this.removeInternalSocketHandlers(),this.emit("established",{remoteHost:n,socket:this.socket})}}sendSocks5InitialHandshake(){const e=new o.SmartBuffer,t=[a.Socks5Auth.NoAuth];(this.options.proxy.userId||this.options.proxy.password)&&t.push(a.Socks5Auth.UserPass),void 0!==this.options.proxy.custom_auth_method&&t.push(this.options.proxy.custom_auth_method),e.writeUInt8(5),e.writeUInt8(t.length);for(const n of t)e.writeUInt8(n);this.nextRequiredPacketBufferSize=a.SOCKS_INCOMING_PACKET_SIZES.Socks5InitialHandshakeResponse,this.socket.write(e.toBuffer()),this.setState(a.SocksClientState.SentInitialHandshake)}handleInitialSocks5HandshakeResponse(){const e=this.receiveBuffer.get(2);5!==e[0]?this.closeSocket(a.ERRORS.InvalidSocks5IntiailHandshakeSocksVersion):e[1]===a.SOCKS5_NO_ACCEPTABLE_AUTH?this.closeSocket(a.ERRORS.InvalidSocks5InitialHandshakeNoAcceptedAuthType):e[1]===a.Socks5Auth.NoAuth?(this.socks5ChosenAuthType=a.Socks5Auth.NoAuth,this.sendSocks5CommandRequest()):e[1]===a.Socks5Auth.UserPass?(this.socks5ChosenAuthType=a.Socks5Auth.UserPass,this.sendSocks5UserPassAuthentication()):e[1]===this.options.proxy.custom_auth_method?(this.socks5ChosenAuthType=this.options.proxy.custom_auth_method,this.sendSocks5CustomAuthentication()):this.closeSocket(a.ERRORS.InvalidSocks5InitialHandshakeUnknownAuthType)}sendSocks5UserPassAuthentication(){const e=this.options.proxy.userId||"",t=this.options.proxy.password||"",n=new o.SmartBuffer;n.writeUInt8(1),n.writeUInt8(Buffer.byteLength(e)),n.writeString(e),n.writeUInt8(Buffer.byteLength(t)),n.writeString(t),this.nextRequiredPacketBufferSize=a.SOCKS_INCOMING_PACKET_SIZES.Socks5UserPassAuthenticationResponse,this.socket.write(n.toBuffer()),this.setState(a.SocksClientState.SentAuthentication)}sendSocks5CustomAuthentication(){return r(this,void 0,void 0,function*(){this.nextRequiredPacketBufferSize=this.options.proxy.custom_auth_response_size,this.socket.write(yield this.options.proxy.custom_auth_request_handler()),this.setState(a.SocksClientState.SentAuthentication)})}handleSocks5CustomAuthHandshakeResponse(e){return r(this,void 0,void 0,function*(){return yield this.options.proxy.custom_auth_response_handler(e)})}handleSocks5AuthenticationNoAuthHandshakeResponse(e){return r(this,void 0,void 0,function*(){return 0===e[1]})}handleSocks5AuthenticationUserPassHandshakeResponse(e){return r(this,void 0,void 0,function*(){return 0===e[1]})}handleInitialSocks5AuthenticationHandshakeResponse(){return r(this,void 0,void 0,function*(){this.setState(a.SocksClientState.ReceivedAuthenticationResponse);let e=!1;this.socks5ChosenAuthType===a.Socks5Auth.NoAuth?e=yield this.handleSocks5AuthenticationNoAuthHandshakeResponse(this.receiveBuffer.get(2)):this.socks5ChosenAuthType===a.Socks5Auth.UserPass?e=yield this.handleSocks5AuthenticationUserPassHandshakeResponse(this.receiveBuffer.get(2)):this.socks5ChosenAuthType===this.options.proxy.custom_auth_method&&(e=yield this.handleSocks5CustomAuthHandshakeResponse(this.receiveBuffer.get(this.options.proxy.custom_auth_response_size))),e?this.sendSocks5CommandRequest():this.closeSocket(a.ERRORS.Socks5AuthenticationFailed)})}sendSocks5CommandRequest(){const e=new o.SmartBuffer;e.writeUInt8(5),e.writeUInt8(a.SocksCommand[this.options.command]),e.writeUInt8(0),s.isIPv4(this.options.destination.host)?(e.writeUInt8(a.Socks5HostType.IPv4),e.writeBuffer((0,c.ipToBuffer)(this.options.destination.host))):s.isIPv6(this.options.destination.host)?(e.writeUInt8(a.Socks5HostType.IPv6),e.writeBuffer((0,c.ipToBuffer)(this.options.destination.host))):(e.writeUInt8(a.Socks5HostType.Hostname),e.writeUInt8(this.options.destination.host.length),e.writeString(this.options.destination.host)),e.writeUInt16BE(this.options.destination.port),this.nextRequiredPacketBufferSize=a.SOCKS_INCOMING_PACKET_SIZES.Socks5ResponseHeader,this.socket.write(e.toBuffer()),this.setState(a.SocksClientState.SentFinalHandshake)}handleSocks5FinalHandshakeResponse(){const e=this.receiveBuffer.peek(5);if(5!==e[0]||e[1]!==a.Socks5Response.Granted)this.closeSocket(`${a.ERRORS.InvalidSocks5FinalHandshakeRejected} - ${a.Socks5Response[e[1]]}`);else{const t=e[3];let n,r;if(t===a.Socks5HostType.IPv4){const e=a.SOCKS_INCOMING_PACKET_SIZES.Socks5ResponseIPv4;if(this.receiveBuffer.length<e)return void(this.nextRequiredPacketBufferSize=e);r=o.SmartBuffer.fromBuffer(this.receiveBuffer.get(e).slice(4)),n={host:(0,c.int32ToIpv4)(r.readUInt32BE()),port:r.readUInt16BE()},"0.0.0.0"===n.host&&(n.host=this.options.proxy.ipaddress)}else if(t===a.Socks5HostType.Hostname){const t=e[4],i=a.SOCKS_INCOMING_PACKET_SIZES.Socks5ResponseHostname(t);if(this.receiveBuffer.length<i)return void(this.nextRequiredPacketBufferSize=i);r=o.SmartBuffer.fromBuffer(this.receiveBuffer.get(i).slice(5)),n={host:r.readString(t),port:r.readUInt16BE()}}else if(t===a.Socks5HostType.IPv6){const e=a.SOCKS_INCOMING_PACKET_SIZES.Socks5ResponseIPv6;if(this.receiveBuffer.length<e)return void(this.nextRequiredPacketBufferSize=e);r=o.SmartBuffer.fromBuffer(this.receiveBuffer.get(e).slice(4)),n={host:u.Address6.fromByteArray(Array.from(r.readBuffer(16))).canonicalForm(),port:r.readUInt16BE()}}this.setState(a.SocksClientState.ReceivedFinalResponse),a.SocksCommand[this.options.command]===a.SocksCommand.connect?(this.setState(a.SocksClientState.Established),this.removeInternalSocketHandlers(),this.emit("established",{remoteHost:n,socket:this.socket})):a.SocksCommand[this.options.command]===a.SocksCommand.bind?(this.setState(a.SocksClientState.BoundWaitingForConnection),this.nextRequiredPacketBufferSize=a.SOCKS_INCOMING_PACKET_SIZES.Socks5ResponseHeader,this.emit("bound",{remoteHost:n,socket:this.socket})):a.SocksCommand[this.options.command]===a.SocksCommand.associate&&(this.setState(a.SocksClientState.Established),this.removeInternalSocketHandlers(),this.emit("established",{remoteHost:n,socket:this.socket}))}}handleSocks5IncomingConnectionResponse(){const e=this.receiveBuffer.peek(5);if(5!==e[0]||e[1]!==a.Socks5Response.Granted)this.closeSocket(`${a.ERRORS.Socks5ProxyRejectedIncomingBoundConnection} - ${a.Socks5Response[e[1]]}`);else{const t=e[3];let n,r;if(t===a.Socks5HostType.IPv4){const e=a.SOCKS_INCOMING_PACKET_SIZES.Socks5ResponseIPv4;if(this.receiveBuffer.length<e)return void(this.nextRequiredPacketBufferSize=e);r=o.SmartBuffer.fromBuffer(this.receiveBuffer.get(e).slice(4)),n={host:(0,c.int32ToIpv4)(r.readUInt32BE()),port:r.readUInt16BE()},"0.0.0.0"===n.host&&(n.host=this.options.proxy.ipaddress)}else if(t===a.Socks5HostType.Hostname){const t=e[4],i=a.SOCKS_INCOMING_PACKET_SIZES.Socks5ResponseHostname(t);if(this.receiveBuffer.length<i)return void(this.nextRequiredPacketBufferSize=i);r=o.SmartBuffer.fromBuffer(this.receiveBuffer.get(i).slice(5)),n={host:r.readString(t),port:r.readUInt16BE()}}else if(t===a.Socks5HostType.IPv6){const e=a.SOCKS_INCOMING_PACKET_SIZES.Socks5ResponseIPv6;if(this.receiveBuffer.length<e)return void(this.nextRequiredPacketBufferSize=e);r=o.SmartBuffer.fromBuffer(this.receiveBuffer.get(e).slice(4)),n={host:u.Address6.fromByteArray(Array.from(r.readBuffer(16))).canonicalForm(),port:r.readUInt16BE()}}this.setState(a.SocksClientState.Established),this.removeInternalSocketHandlers(),this.emit("established",{remoteHost:n,socket:this.socket})}}get socksClientOptions(){return Object.assign({},this.options)}}t.SocksClient=h},7687(e,t,n){"use strict";const r=n(857),i=n(2018),s=n(5884),{env:o}=process;let a;function c(e){return 0!==e&&{level:e,hasBasic:!0,has256:e>=2,has16m:e>=3}}function l(e,t){if(0===a)return 0;if(s("color=16m")||s("color=full")||s("color=truecolor"))return 3;if(s("color=256"))return 2;if(e&&!t&&void 0===a)return 0;const n=a||0;if("dumb"===o.TERM)return n;if("win32"===process.platform){const e=r.release().split(".");return Number(e[0])>=10&&Number(e[2])>=10586?Number(e[2])>=14931?3:2:1}if("CI"in o)return["TRAVIS","CIRCLECI","APPVEYOR","GITLAB_CI","GITHUB_ACTIONS","BUILDKITE"].some(e=>e in o)||"codeship"===o.CI_NAME?1:n;if("TEAMCITY_VERSION"in o)return/^(9\.(0*[1-9]\d*)\.|\d{2,}\.)/.test(o.TEAMCITY_VERSION)?1:0;if("truecolor"===o.COLORTERM)return 3;if("TERM_PROGRAM"in o){const e=parseInt((o.TERM_PROGRAM_VERSION||"").split(".")[0],10);switch(o.TERM_PROGRAM){case"iTerm.app":return e>=3?3:2;case"Apple_Terminal":return 2}}return/-256(color)?$/i.test(o.TERM)?2:/^screen|^xterm|^vt100|^vt220|^rxvt|color|ansi|cygwin|linux/i.test(o.TERM)||"COLORTERM"in o?1:n}s("no-color")||s("no-colors")||s("color=false")||s("color=never")?a=0:(s("color")||s("colors")||s("color=true")||s("color=always"))&&(a=1),"FORCE_COLOR"in o&&(a="true"===o.FORCE_COLOR?1:"false"===o.FORCE_COLOR?0:0===o.FORCE_COLOR.length?1:Math.min(parseInt(o.FORCE_COLOR,10),3)),e.exports={supportsColor:function(e){return c(l(e,e&&e.isTTY))},stdout:c(l(!0,i.isatty(1))),stderr:c(l(!0,i.isatty(2)))}},7699(e,t,n){"use strict";const r=n(1060);r.createWebSocketStream=n(3719),r.Server=n(1722),r.Receiver=n(6286),r.Sender=n(914),r.WebSocket=r,r.WebSocketServer=r.Server,e.exports=r},7732(e,t,n){"use strict";var r,i=this&&this.__createBinding||(Object.create?function(e,t,n,r){void 0===r&&(r=n);var i=Object.getOwnPropertyDescriptor(t,n);i&&!("get"in i?!t.__esModule:i.writable||i.configurable)||(i={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,r,i)}:function(e,t,n,r){void 0===r&&(r=n),e[r]=t[n]}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),o=this&&this.__importStar||(r=function(e){return r=Object.getOwnPropertyNames||function(e){var t=[];for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[t.length]=n);return t},r(e)},function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n=r(e),o=0;o<n.length;o++)"default"!==n[o]&&i(t,e,n[o]);return s(t,e),t});Object.defineProperty(t,"__esModule",{value:!0});const a=n(8600),c=o(n(6887)),l={set:a.setInterval,clear:a.clearInterval},d={set:(e,t)=>setInterval(e,t),clear:e=>clearInterval(e)};t.default=e=>{switch(e){case"native":return d;case"worker":return l;default:return!c.default||c.isWebWorker||c.isReactNativeBrowser?d:l}}},7736(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ReceiveBuffer=void 0;t.ReceiveBuffer=class{constructor(e=4096){this.buffer=Buffer.allocUnsafe(e),this.offset=0,this.originalSize=e}get length(){return this.offset}append(e){if(!Buffer.isBuffer(e))throw new Error("Attempted to append a non-buffer instance to ReceiveBuffer.");if(this.offset+e.length>=this.buffer.length){const t=this.buffer;this.buffer=Buffer.allocUnsafe(Math.max(this.buffer.length+this.originalSize,this.buffer.length+e.length)),t.copy(this.buffer)}return e.copy(this.buffer,this.offset),this.offset+=e.length}peek(e){if(e>this.offset)throw new Error("Attempted to read beyond the bounds of the managed internal data.");return this.buffer.slice(0,e)}get(e){if(e>this.offset)throw new Error("Attempted to read beyond the bounds of the managed internal data.");const t=Buffer.allocUnsafe(e);return this.buffer.slice(0,e).copy(t),this.buffer.copyWithin(0,e,e+this.offset-e),this.offset-=e,t}}},7758(e,t,n){const r=n(4422),{ArrayIsArray:i,Promise:s,SymbolAsyncIterator:o,SymbolDispose:a}=n(4134),c=n(6238),{once:l}=n(7760),d=n(5896),u=n(3370),{aggregateTwoErrors:h,codes:{ERR_INVALID_ARG_TYPE:p,ERR_INVALID_RETURN_VALUE:f,ERR_MISSING_ARGS:g,ERR_STREAM_DESTROYED:m,ERR_STREAM_PREMATURE_CLOSE:y},AbortError:b}=n(6371),{validateFunction:v,validateAbortSignal:S}=n(277),{isIterable:_,isReadable:w,isReadableNodeStream:k,isNodeStream:I,isTransformStream:E,isWebStream:x,isReadableStream:T,isReadableFinished:C}=n(6115),O=globalThis.AbortController||n(6584).AbortController;let A,P,R;function M(e,t,n){let r=!1;e.on("close",()=>{r=!0});return{destroy:t=>{r||(r=!0,d.destroyer(e,t||new m("pipe")))},cleanup:c(e,{readable:t,writable:n},e=>{r=!e})}}function N(e){if(_(e))return e;if(k(e))return async function*(e){P||(P=n(7576));yield*P.prototype[o].call(e)}(e);throw new p("val",["Readable","Iterable","AsyncIterable"],e)}async function B(e,t,n,{end:r}){let i,o=null;const a=e=>{if(e&&(i=e),o){const e=o;o=null,e()}},l=()=>new s((e,t)=>{i?t(i):o=()=>{i?t(i):e()}});t.on("drain",a);const d=c(t,{readable:!1},a);try{t.writableNeedDrain&&await l();for await(const n of e)t.write(n)||await l();r&&(t.end(),await l()),n()}catch(e){n(i!==e?h(i,e):e)}finally{d(),t.off("drain",a)}}async function L(e,t,n,{end:r}){E(t)&&(t=t.writable);const i=t.getWriter();try{for await(const t of e)await i.ready,i.write(t).catch(()=>{});await i.ready,r&&await i.close(),n()}catch(e){try{await i.abort(e),n(e)}catch(e){n(e)}}}function j(e,t,s){if(1===e.length&&i(e[0])&&(e=e[0]),e.length<2)throw new g("streams");const o=new O,c=o.signal,l=null==s?void 0:s.signal,d=[];function h(){F(new b)}let m,y,v;S(l,"options.signal"),R=R||n(7760).addAbortListener,l&&(m=R(l,h));const C=[];let P,j=0;function U(e){F(e,0===--j)}function F(e,n){var i;if(!e||y&&"ERR_STREAM_PREMATURE_CLOSE"!==y.code||(y=e),y||n){for(;C.length;)C.shift()(y);null===(i=m)||void 0===i||i[a](),o.abort(),n&&(y||d.forEach(e=>e()),r.nextTick(t,y,v))}}for(let z=0;z<e.length;z++){const H=e[z],q=z<e.length-1,G=z>0,K=q||!1!==(null==s?void 0:s.end),J=z===e.length-1;if(I(H)){if(K){const{destroy:Q,cleanup:Y}=M(H,q,G);C.push(Q),w(H)&&J&&d.push(Y)}function $(e){e&&"AbortError"!==e.name&&"ERR_STREAM_PREMATURE_CLOSE"!==e.code&&U(e)}H.on("error",$),w(H)&&J&&d.push(()=>{H.removeListener("error",$)})}if(0===z)if("function"==typeof H){if(P=H({signal:c}),!_(P))throw new f("Iterable, AsyncIterable or Stream","source",P)}else P=_(H)||k(H)||E(H)?H:u.from(H);else if("function"==typeof H){var W;if(E(P))P=N(null===(W=P)||void 0===W?void 0:W.readable);else P=N(P);if(P=H(P,{signal:c}),q){if(!_(P,!0))throw new f("AsyncIterable",`transform[${z-1}]`,P)}else{var V;A||(A=n(6524));const Z=new A({objectMode:!0}),X=null===(V=P)||void 0===V?void 0:V.then;if("function"==typeof X)j++,X.call(P,e=>{v=e,null!=e&&Z.write(e),K&&Z.end(),r.nextTick(U)},e=>{Z.destroy(e),r.nextTick(U,e)});else if(_(P,!0))j++,B(P,Z,U,{end:K});else{if(!T(P)&&!E(P))throw new f("AsyncIterable or Promise","destination",P);{const ne=P.readable||P;j++,B(ne,Z,U,{end:K})}}P=Z;const{destroy:ee,cleanup:te}=M(P,!1,!0);C.push(ee),J&&d.push(te)}}else if(I(H)){if(k(P)){j+=2;const re=D(P,H,U,{end:K});w(H)&&J&&d.push(re)}else if(E(P)||T(P)){const ie=P.readable||P;j++,B(ie,H,U,{end:K})}else{if(!_(P))throw new p("val",["Readable","Iterable","AsyncIterable","ReadableStream","TransformStream"],P);j++,B(P,H,U,{end:K})}P=H}else if(x(H)){if(k(P))j++,L(N(P),H,U,{end:K});else if(T(P)||_(P))j++,L(P,H,U,{end:K});else{if(!E(P))throw new p("val",["Readable","Iterable","AsyncIterable","ReadableStream","TransformStream"],P);j++,L(P.readable,H,U,{end:K})}P=H}else P=u.from(H)}return(null!=c&&c.aborted||null!=l&&l.aborted)&&r.nextTick(h),P}function D(e,t,n,{end:i}){let s=!1;if(t.on("close",()=>{s||n(new y)}),e.pipe(t,{end:!1}),i){function o(){s=!0,t.end()}C(e)?r.nextTick(o):e.once("end",o)}else n();return c(e,{readable:!0,writable:!1},t=>{const r=e._readableState;t&&"ERR_STREAM_PREMATURE_CLOSE"===t.code&&r&&r.ended&&!r.errored&&!r.errorEmitted?e.once("end",n).once("error",n):n(t)}),c(t,{readable:!1,writable:!0},n)}e.exports={pipelineImpl:j,pipeline:function(...e){return j(e,l(function(e){return v(e[e.length-1],"streams[stream.length - 1]"),e.pop()}(e)))}}},7760(e,t,n){"use strict";const r=n(181),{format:i,inspect:s}=n(9231),{codes:{ERR_INVALID_ARG_TYPE:o}}=n(6371),{kResistStopPropagation:a,AggregateError:c,SymbolDispose:l}=n(4134),d=globalThis.AbortSignal||n(6584).AbortSignal,u=globalThis.AbortController||n(6584).AbortController,h=Object.getPrototypeOf(async function(){}).constructor,p=globalThis.Blob||r.Blob,f="undefined"!=typeof p?function(e){return e instanceof p}:function(e){return!1},g=(e,t)=>{if(void 0!==e&&(null===e||"object"!=typeof e||!("aborted"in e)))throw new o(t,"AbortSignal",e)};e.exports={AggregateError:c,kEmptyObject:Object.freeze({}),once(e){let t=!1;return function(...n){t||(t=!0,e.apply(this,n))}},createDeferredPromise:function(){let e,t;return{promise:new Promise((n,r)=>{e=n,t=r}),resolve:e,reject:t}},promisify:e=>new Promise((t,n)=>{e((e,...r)=>e?n(e):t(...r))}),debuglog:()=>function(){},format:i,inspect:s,types:{isAsyncFunction:e=>e instanceof h,isArrayBufferView:e=>ArrayBuffer.isView(e)},isBlob:f,deprecate:(e,t)=>e,addAbortListener:n(4434).addAbortListener||function(e,t){if(void 0===e)throw new o("signal","AbortSignal",e);let n;return g(e,"signal"),((e,t)=>{if("function"!=typeof e)throw new o(t,"Function",e)})(t,"listener"),e.aborted?queueMicrotask(()=>t()):(e.addEventListener("abort",t,{__proto__:null,once:!0,[a]:!0}),n=()=>{e.removeEventListener("abort",t)}),{__proto__:null,[l](){var e;null===(e=n)||void 0===e||e()}}},AbortSignalAny:d.any||function(e){if(1===e.length)return e[0];const t=new u,n=()=>t.abort();return e.forEach(e=>{g(e,"signals"),e.addEventListener("abort",n,{once:!0})}),t.signal.addEventListener("abort",()=>{e.forEach(e=>e.removeEventListener("abort",n))},{once:!0}),t.signal}},e.exports.promisify.custom=Symbol.for("nodejs.util.promisify.custom")},7813(e,t,n){"use strict";const{Buffer:r}=n(181),i=Symbol.for("BufferList");function s(e){if(!(this instanceof s))return new s(e);s._init.call(this,e)}s._init=function(e){Object.defineProperty(this,i,{value:!0}),this._bufs=[],this.length=0,e&&this.append(e)},s.prototype._new=function(e){return new s(e)},s.prototype._offset=function(e){if(0===e)return[0,0];let t=0;for(let n=0;n<this._bufs.length;n++){const r=t+this._bufs[n].length;if(e<r||n===this._bufs.length-1)return[n,e-t];t=r}},s.prototype._reverseOffset=function(e){const t=e[0];let n=e[1];for(let e=0;e<t;e++)n+=this._bufs[e].length;return n},s.prototype.getBuffers=function(){return this._bufs},s.prototype.get=function(e){if(e>this.length||e<0)return;const t=this._offset(e);return this._bufs[t[0]][t[1]]},s.prototype.slice=function(e,t){return"number"==typeof e&&e<0&&(e+=this.length),"number"==typeof t&&t<0&&(t+=this.length),this.copy(null,0,e,t)},s.prototype.copy=function(e,t,n,i){if(("number"!=typeof n||n<0)&&(n=0),("number"!=typeof i||i>this.length)&&(i=this.length),n>=this.length)return e||r.alloc(0);if(i<=0)return e||r.alloc(0);const s=!!e,o=this._offset(n),a=i-n;let c=a,l=s&&t||0,d=o[1];if(0===n&&i===this.length){if(!s)return 1===this._bufs.length?this._bufs[0]:r.concat(this._bufs,this.length);for(let t=0;t<this._bufs.length;t++)this._bufs[t].copy(e,l),l+=this._bufs[t].length;return e}if(c<=this._bufs[o[0]].length-d)return s?this._bufs[o[0]].copy(e,t,d,d+c):this._bufs[o[0]].slice(d,d+c);s||(e=r.allocUnsafe(a));for(let t=o[0];t<this._bufs.length;t++){const n=this._bufs[t].length-d;if(!(c>n)){this._bufs[t].copy(e,l,d,d+c),l+=n;break}this._bufs[t].copy(e,l,d),l+=n,c-=n,d&&(d=0)}return e.length>l?e.slice(0,l):e},s.prototype.shallowSlice=function(e,t){if(e=e||0,t="number"!=typeof t?this.length:t,e<0&&(e+=this.length),t<0&&(t+=this.length),e===t)return this._new();const n=this._offset(e),r=this._offset(t),i=this._bufs.slice(n[0],r[0]+1);return 0===r[1]?i.pop():i[i.length-1]=i[i.length-1].slice(0,r[1]),0!==n[1]&&(i[0]=i[0].slice(n[1])),this._new(i)},s.prototype.toString=function(e,t,n){return this.slice(t,n).toString(e)},s.prototype.consume=function(e){if(e=Math.trunc(e),Number.isNaN(e)||e<=0)return this;for(;this._bufs.length;){if(!(e>=this._bufs[0].length)){this._bufs[0]=this._bufs[0].slice(e),this.length-=e;break}e-=this._bufs[0].length,this.length-=this._bufs[0].length,this._bufs.shift()}return this},s.prototype.duplicate=function(){const e=this._new();for(let t=0;t<this._bufs.length;t++)e.append(this._bufs[t]);return e},s.prototype.append=function(e){return this._attach(e,s.prototype._appendBuffer)},s.prototype.prepend=function(e){return this._attach(e,s.prototype._prependBuffer,!0)},s.prototype._attach=function(e,t,n){if(null==e)return this;if(e.buffer)t.call(this,r.from(e.buffer,e.byteOffset,e.byteLength));else if(Array.isArray(e)){const[r,i]=n?[e.length-1,-1]:[0,1];for(let s=r;s>=0&&s<e.length;s+=i)this._attach(e[s],t,n)}else if(this._isBufferList(e)){const[r,i]=n?[e._bufs.length-1,-1]:[0,1];for(let s=r;s>=0&&s<e._bufs.length;s+=i)this._attach(e._bufs[s],t,n)}else"number"==typeof e&&(e=e.toString()),t.call(this,r.from(e));return this},s.prototype._appendBuffer=function(e){this._bufs.push(e),this.length+=e.length},s.prototype._prependBuffer=function(e){this._bufs.unshift(e),this.length+=e.length},s.prototype.indexOf=function(e,t,n){if(void 0===n&&"string"==typeof t&&(n=t,t=void 0),"function"==typeof e||Array.isArray(e))throw new TypeError('The "value" argument must be one of type string, Buffer, BufferList, or Uint8Array.');if("number"==typeof e?e=r.from([e]):"string"==typeof e?e=r.from(e,n):this._isBufferList(e)?e=e.slice():Array.isArray(e.buffer)?e=r.from(e.buffer,e.byteOffset,e.byteLength):r.isBuffer(e)||(e=r.from(e)),t=Number(t||0),isNaN(t)&&(t=0),t<0&&(t=this.length+t),t<0&&(t=0),0===e.length)return t>this.length?this.length:t;const i=this._offset(t);let s=i[0],o=i[1];for(;s<this._bufs.length;s++){const t=this._bufs[s];for(;o<t.length;){if(t.length-o>=e.length){const n=t.indexOf(e,o);if(-1!==n)return this._reverseOffset([s,n]);o=t.length-e.length+1}else{const t=this._reverseOffset([s,o]);if(this._match(t,e))return t;o++}}o=0}return-1},s.prototype._match=function(e,t){if(this.length-e<t.length)return!1;for(let n=0;n<t.length;n++)if(this.get(e+n)!==t[n])return!1;return!0},function(){const e={readDoubleBE:8,readDoubleLE:8,readFloatBE:4,readFloatLE:4,readBigInt64BE:8,readBigInt64LE:8,readBigUInt64BE:8,readBigUInt64LE:8,readInt32BE:4,readInt32LE:4,readUInt32BE:4,readUInt32LE:4,readInt16BE:2,readInt16LE:2,readUInt16BE:2,readUInt16LE:2,readInt8:1,readUInt8:1,readIntBE:null,readIntLE:null,readUIntBE:null,readUIntLE:null};for(const t in e)(function(t){s.prototype[t]=null===e[t]?function(e,n){return this.slice(e,e+n)[t](0,n)}:function(n=0){return this.slice(n,n+e[t])[t](0)}})(t)}(),s.prototype._isBufferList=function(e){return e instanceof s||s.isBufferList(e)},s.isBufferList=function(e){return null!=e&&e[i]},e.exports=s},7830(e,t,n){"use strict";const{pipeline:r}=n(7758),i=n(3370),{destroyer:s}=n(5896),{isNodeStream:o,isReadable:a,isWritable:c,isWebStream:l,isTransformStream:d,isWritableStream:u,isReadableStream:h}=n(6115),{AbortError:p,codes:{ERR_INVALID_ARG_VALUE:f,ERR_MISSING_ARGS:g}}=n(6371),m=n(6238);e.exports=function(...e){if(0===e.length)throw new g("streams");if(1===e.length)return i.from(e[0]);const t=[...e];if("function"==typeof e[0]&&(e[0]=i.from(e[0])),"function"==typeof e[e.length-1]){const t=e.length-1;e[t]=i.from(e[t])}for(let n=0;n<e.length;++n)if(o(e[n])||l(e[n])){if(n<e.length-1&&!(a(e[n])||h(e[n])||d(e[n])))throw new f(`streams[${n}]`,t[n],"must be readable");if(n>0&&!(c(e[n])||u(e[n])||d(e[n])))throw new f(`streams[${n}]`,t[n],"must be writable")}let n,y,b,v,S;const _=e[0],w=r(e,function(e){const t=v;v=null,t?t(e):e?S.destroy(e):I||k||S.destroy()}),k=!!(c(_)||u(_)||d(_)),I=!!(a(w)||h(w)||d(w));if(S=new i({writableObjectMode:!(null==_||!_.writableObjectMode),readableObjectMode:!(null==w||!w.readableObjectMode),writable:k,readable:I}),k){if(o(_))S._write=function(e,t,r){_.write(e,t)?r():n=r},S._final=function(e){_.end(),y=e},_.on("drain",function(){if(n){const e=n;n=null,e()}});else if(l(_)){const e=(d(_)?_.writable:_).getWriter();S._write=async function(t,n,r){try{await e.ready,e.write(t).catch(()=>{}),r()}catch(e){r(e)}},S._final=async function(t){try{await e.ready,e.close().catch(()=>{}),y=t}catch(e){t(e)}}}const e=d(w)?w.readable:w;m(e,()=>{if(y){const e=y;y=null,e()}})}if(I)if(o(w))w.on("readable",function(){if(b){const e=b;b=null,e()}}),w.on("end",function(){S.push(null)}),S._read=function(){for(;;){const e=w.read();if(null===e)return void(b=S._read);if(!S.push(e))return}};else if(l(w)){const e=(d(w)?w.readable:w).getReader();S._read=async function(){for(;;)try{const{value:t,done:n}=await e.read();if(!S.push(t))return;if(n)return void S.push(null)}catch{return}}}return S._destroy=function(e,t){e||null===v||(e=new p),b=null,n=null,y=null,null===v?t(e):(v=t,o(w)&&s(w,e))},S}},7833(e,t,n){t.formatArgs=function(t){if(t[0]=(this.useColors?"%c":"")+this.namespace+(this.useColors?" %c":" ")+t[0]+(this.useColors?"%c ":" ")+"+"+e.exports.humanize(this.diff),!this.useColors)return;const n="color: "+this.color;t.splice(1,0,n,"color: inherit");let r=0,i=0;t[0].replace(/%[a-zA-Z%]/g,e=>{"%%"!==e&&(r++,"%c"===e&&(i=r))}),t.splice(i,0,n)},t.save=function(e){try{e?t.storage.setItem("debug",e):t.storage.removeItem("debug")}catch(e){}},t.load=function(){let e;try{e=t.storage.getItem("debug")||t.storage.getItem("DEBUG")}catch(e){}!e&&"undefined"!=typeof process&&"env"in process&&(e=process.env.DEBUG);return e},t.useColors=function(){if("undefined"!=typeof window&&window.process&&("renderer"===window.process.type||window.process.__nwjs))return!0;if("undefined"!=typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/(edge|trident)\/(\d+)/))return!1;let e;return"undefined"!=typeof document&&document.documentElement&&document.documentElement.style&&document.documentElement.style.WebkitAppearance||"undefined"!=typeof window&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||"undefined"!=typeof navigator&&navigator.userAgent&&(e=navigator.userAgent.toLowerCase().match(/firefox\/(\d+)/))&&parseInt(e[1],10)>=31||"undefined"!=typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/applewebkit\/(\d+)/)},t.storage=function(){try{return localStorage}catch(e){}}(),t.destroy=(()=>{let e=!1;return()=>{e||(e=!0,console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`."))}})(),t.colors=["#0000CC","#0000FF","#0033CC","#0033FF","#0066CC","#0066FF","#0099CC","#0099FF","#00CC00","#00CC33","#00CC66","#00CC99","#00CCCC","#00CCFF","#3300CC","#3300FF","#3333CC","#3333FF","#3366CC","#3366FF","#3399CC","#3399FF","#33CC00","#33CC33","#33CC66","#33CC99","#33CCCC","#33CCFF","#6600CC","#6600FF","#6633CC","#6633FF","#66CC00","#66CC33","#9900CC","#9900FF","#9933CC","#9933FF","#99CC00","#99CC33","#CC0000","#CC0033","#CC0066","#CC0099","#CC00CC","#CC00FF","#CC3300","#CC3333","#CC3366","#CC3399","#CC33CC","#CC33FF","#CC6600","#CC6633","#CC9900","#CC9933","#CCCC00","#CCCC33","#FF0000","#FF0033","#FF0066","#FF0099","#FF00CC","#FF00FF","#FF3300","#FF3333","#FF3366","#FF3399","#FF33CC","#FF33FF","#FF6600","#FF6633","#FF9900","#FF9933","#FFCC00","#FFCC33"],t.log=console.debug||console.log||(()=>{}),e.exports=n(736)(t);const{formatters:r}=e.exports;r.j=function(e){try{return JSON.stringify(e)}catch(e){return"[UnexpectedJSONParseError]: "+e.message}}},7927(e,t,n){"use strict";var r,i=this&&this.__createBinding||(Object.create?function(e,t,n,r){void 0===r&&(r=n);var i=Object.getOwnPropertyDescriptor(t,n);i&&!("get"in i?!t.__esModule:i.writable||i.configurable)||(i={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,r,i)}:function(e,t,n,r){void 0===r&&(r=n),e[r]=t[n]}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),o=this&&this.__importStar||(r=function(e){return r=Object.getOwnPropertyNames||function(e){var t=[];for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[t.length]=n);return t},r(e)},function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n=r(e),o=0;o<n.length;o++)"default"!==n[o]&&i(t,e,n[o]);return s(t,e),t});Object.defineProperty(t,"__esModule",{value:!0}),t.SpatialAwarenessPlugin=void 0;const a=o(n(7562)),c=n(6117),l=o(n(9896)),d=o(n(6928)),u=n(1554),h=n(4997),p=n(5389),f=n(7136),g=n(4386),m=n(5471),y=n(2846),b=n(7279),v=n(3874),S=n(1711),{deviceManager:_,systemManager:w,mediaManager:k}=a.default,I="tracking-zone:",E="global-tracker";class x extends a.ScryptedDeviceBase{trackingEngine=null;trackingState;alertManager;mqttPublisher=null;devices=new Map;storageSettings=new c.StorageSettings(this,{topology:{title:"Camera Topology",type:"string",description:"JSON configuration of camera relationships",hide:!0},floorPlanImage:{title:"Floor Plan Image",type:"string",hide:!0},correlationWindow:{title:"Correlation Window (seconds)",type:"number",defaultValue:30,description:"Maximum time to wait for an object to appear on connected camera",group:"Tracking"},correlationThreshold:{title:"Correlation Confidence Threshold",type:"number",defaultValue:.35,description:"Minimum confidence (0-1) for automatic object correlation. Lower values allow more matches.",group:"Tracking"},lostTimeout:{title:"Lost Object Timeout (seconds)",type:"number",defaultValue:300,description:"Time before marking a tracked object as lost",group:"Tracking"},useVisualMatching:{title:"Use Visual Matching",type:"boolean",defaultValue:!0,description:"Use visual embeddings for object correlation (requires compatible detectors)",group:"Tracking"},loiteringThreshold:{title:"Loitering Threshold (seconds)",type:"number",defaultValue:3,description:"Object must be visible for this duration before triggering movement alerts",group:"Tracking"},objectAlertCooldown:{title:"Per-Object Alert Cooldown (seconds)",type:"number",defaultValue:30,description:"Minimum time between alerts for the same tracked object",group:"Tracking"},useLlmDescriptions:{title:"Use LLM for Rich Descriptions",type:"boolean",defaultValue:!0,description:'Use LLM plugin (if installed) to generate descriptive alerts like "Man walking from garage towards front door"',group:"AI & Spatial Reasoning"},llmDebounceInterval:{title:"LLM Rate Limit (seconds)",type:"number",defaultValue:10,description:"Minimum time between LLM calls to prevent API overload (0 = no limit)",group:"AI & Spatial Reasoning"},llmFallbackEnabled:{title:"Fallback to Basic Notifications",type:"boolean",defaultValue:!0,description:"When LLM is rate-limited or slow, fall back to basic notifications immediately",group:"AI & Spatial Reasoning"},llmFallbackTimeout:{title:"LLM Timeout (seconds)",type:"number",defaultValue:3,description:"Maximum time to wait for LLM response before falling back to basic notification",group:"AI & Spatial Reasoning"},enableTransitTimeLearning:{title:"Learn Transit Times",type:"boolean",defaultValue:!0,description:"Automatically adjust connection transit times based on observed movement patterns",group:"AI & Spatial Reasoning"},enableConnectionSuggestions:{title:"Suggest Camera Connections",type:"boolean",defaultValue:!0,description:"Automatically suggest new camera connections based on observed movement patterns",group:"AI & Spatial Reasoning"},enableLandmarkLearning:{title:"Learn Landmarks from AI",type:"boolean",defaultValue:!0,description:"Allow AI to suggest new landmarks based on detected objects and camera context",group:"AI & Spatial Reasoning"},landmarkConfidenceThreshold:{title:"Landmark Suggestion Confidence",type:"number",defaultValue:.7,description:"Minimum AI confidence (0-1) to suggest a landmark",group:"AI & Spatial Reasoning"},enableMqtt:{title:"Enable MQTT",type:"boolean",defaultValue:!1,group:"MQTT Integration"},mqttBroker:{title:"MQTT Broker URL",type:"string",placeholder:"mqtt://localhost:1883",group:"MQTT Integration"},mqttUsername:{title:"MQTT Username",type:"string",group:"MQTT Integration"},mqttPassword:{title:"MQTT Password",type:"password",group:"MQTT Integration"},mqttBaseTopic:{title:"MQTT Base Topic",type:"string",defaultValue:"scrypted/spatial-awareness",group:"MQTT Integration"},enableAlerts:{title:"Enable Alerts",type:"boolean",defaultValue:!0,group:"Alerts"},defaultNotifiers:{title:"Notifiers",type:"device",multiple:!0,deviceFilter:`interfaces.includes('${a.ScryptedInterface.Notifier}')`,description:"Select one or more notifiers to receive alerts",group:"Alerts"},trackedCameras:{title:"Cameras to Track",type:"device",multiple:!0,deviceFilter:`interfaces.includes('${a.ScryptedInterface.ObjectDetector}')`,group:"Cameras",description:"Select cameras with object detection to track"},alertRules:{title:"Alert Rules",type:"string",hide:!0}});constructor(e){super(e),this.trackingState=new p.TrackingState(this.storage,this.console),this.alertManager=new g.AlertManager(this.console,this.storage),process.nextTick(()=>this.initialize())}async initialize(){this.console.log("Initializing Spatial Awareness Plugin"),await _.onDeviceDiscovered({nativeId:E,name:"Global Object Tracker",type:a.ScryptedDeviceType.Sensor,interfaces:[a.ScryptedInterface.OccupancySensor,a.ScryptedInterface.Settings,a.ScryptedInterface.Readme]});const e=this.storage.getItem("topology");if(e)try{const t=JSON.parse(e);await this.startTrackingEngine(t)}catch(e){this.console.error("Failed to parse topology:",e)}const t=this.storage.getItem("alertRules");if(t)try{const e=JSON.parse(t);this.alertManager.setRules(e)}catch(e){this.console.error("Failed to parse alert rules:",e),this.alertManager.setRules((0,h.createDefaultRules)())}else this.alertManager.setRules((0,h.createDefaultRules)());this.storageSettings.values.enableMqtt&&await this.initializeMqtt(),this.console.log("Spatial Awareness Plugin initialized")}async initializeMqtt(){const e=this.storageSettings.values.mqttBroker;if(!e)return void this.console.warn("MQTT enabled but no broker URL configured");const t={broker:e,username:this.storageSettings.values.mqttUsername,password:this.storageSettings.values.mqttPassword,baseTopic:this.storageSettings.values.mqttBaseTopic||"scrypted/spatial-awareness"};this.mqttPublisher=new b.MqttPublisher(t,this.console),await this.mqttPublisher.connect(),this.trackingState.onStateChange(e=>{this.mqttPublisher?.publishState(e)}),this.console.log("MQTT publisher initialized")}async startTrackingEngine(e){this.trackingEngine&&await this.trackingEngine.stopTracking();const t={correlationWindow:1e3*(this.storageSettings.values.correlationWindow||30),correlationThreshold:this.storageSettings.values.correlationThreshold||.35,lostTimeout:1e3*(this.storageSettings.values.lostTimeout||300),useVisualMatching:this.storageSettings.values.useVisualMatching??!0,loiteringThreshold:1e3*(this.storageSettings.values.loiteringThreshold||3),objectAlertCooldown:1e3*(this.storageSettings.values.objectAlertCooldown||30),useLlmDescriptions:this.storageSettings.values.useLlmDescriptions??!0,llmDebounceInterval:1e3*(this.storageSettings.values.llmDebounceInterval||10),llmFallbackEnabled:this.storageSettings.values.llmFallbackEnabled??!0,llmFallbackTimeout:1e3*(this.storageSettings.values.llmFallbackTimeout||3),enableTransitTimeLearning:this.storageSettings.values.enableTransitTimeLearning??!0,enableConnectionSuggestions:this.storageSettings.values.enableConnectionSuggestions??!0,enableLandmarkLearning:this.storageSettings.values.enableLandmarkLearning??!0,landmarkConfidenceThreshold:this.storageSettings.values.landmarkConfidenceThreshold??.7};this.trackingEngine=new f.TrackingEngine(e,this.trackingState,this.alertManager,t,this.console),this.trackingEngine.setTopologyChangeCallback(e=>{this.storage.setItem("topology",JSON.stringify(e)),this.console.log("Topology auto-saved after change")}),await this.trackingEngine.startTracking(),this.console.log("Tracking engine started")}async getDevice(e){let t=this.devices.get(e);return t||(e===E?t=new m.GlobalTrackerSensor(this,e,this.trackingState):e.startsWith(I)&&(t=new y.TrackingZone(this,e,this.trackingState)),t&&this.devices.set(e,t)),t}async releaseDevice(e,t){this.devices.delete(t)}async getCreateDeviceSettings(){return[{key:"name",title:"Zone Name",description:"Name for this tracking zone",type:"string"},{key:"type",title:"Zone Type",type:"string",choices:["entry","exit","dwell","restricted"],value:"entry"},{key:"cameras",title:"Cameras",type:"device",multiple:!0,deviceFilter:`interfaces.includes('${a.ScryptedInterface.ObjectDetector}')`}]}async createDevice(e){const t=I+Date.now().toString();return await _.onDeviceDiscovered({nativeId:t,name:e.name||"Tracking Zone",type:a.ScryptedDeviceType.Sensor,interfaces:[a.ScryptedInterface.OccupancySensor,a.ScryptedInterface.MotionSensor,a.ScryptedInterface.Settings]}),this.storage.setItem(`zone:${t}`,JSON.stringify({type:e.type,cameras:e.cameras})),t}async getSettings(){const e=await this.storageSettings.getSettings(),t=[],n=n=>{e.filter(e=>e.group===n).forEach(e=>t.push(e))};t.push({key:"trainingMode",title:"Training Mode",type:"html",value:"\n        <style>\n          .sa-training-container {\n            padding: 16px;\n            background: rgba(255,255,255,0.03);\n            border-radius: 4px;\n            border: 1px solid rgba(255,255,255,0.08);\n          }\n          .sa-training-title {\n            color: #4fc3f7;\n            font-size: 14px;\n            font-weight: 500;\n            margin-bottom: 8px;\n            font-family: inherit;\n          }\n          .sa-training-desc {\n            color: rgba(255,255,255,0.6);\n            margin-bottom: 12px;\n            font-size: 13px;\n            line-height: 1.5;\n            font-family: inherit;\n          }\n          .sa-training-btn {\n            background: #4fc3f7;\n            color: #000;\n            border: none;\n            padding: 10px 20px;\n            border-radius: 4px;\n            font-size: 14px;\n            font-weight: 500;\n            cursor: pointer;\n            display: inline-flex;\n            align-items: center;\n            gap: 8px;\n            transition: background 0.2s;\n            font-family: inherit;\n          }\n          .sa-training-btn:hover {\n            background: #81d4fa;\n          }\n          .sa-training-steps {\n            color: rgba(255,255,255,0.5);\n            font-size: 12px;\n            margin-top: 12px;\n            padding-top: 12px;\n            border-top: 1px solid rgba(255,255,255,0.05);\n            font-family: inherit;\n          }\n          .sa-training-steps ol {\n            margin: 6px 0 0 16px;\n            padding: 0;\n          }\n          .sa-training-steps li {\n            margin-bottom: 2px;\n          }\n        </style>\n        <div class=\"sa-training-container\">\n          <div class=\"sa-training-title\">Guided Property Training</div>\n          <p class=\"sa-training-desc\">Walk your property while the system learns your camera layout, transit times, and landmarks automatically.</p>\n          <button class=\"sa-training-btn\" onclick=\"(function(){var e=document.getElementById('sa-training-modal');if(e)e.remove();var m=document.createElement('div');m.id='sa-training-modal';m.style.cssText='position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.85);z-index:2147483647;display:flex;align-items:center;justify-content:center;';var c=document.createElement('div');c.style.cssText='width:min(420px,95vw);height:92vh;max-height:900px;background:#121212;border-radius:8px;overflow:hidden;position:relative;box-shadow:0 8px 32px rgba(0,0,0,0.5);border:1px solid rgba(255,255,255,0.1);';var b=document.createElement('button');b.innerHTML='×';b.style.cssText='position:absolute;top:8px;right:8px;z-index:2147483647;background:rgba(255,255,255,0.1);color:white;border:none;width:32px;height:32px;border-radius:4px;font-size:18px;cursor:pointer;line-height:1;';b.onclick=function(){m.remove();};var f=document.createElement('iframe');f.src='/endpoint/@blueharford/scrypted-spatial-awareness/ui/training';f.style.cssText='width:100%;height:100%;border:none;';c.appendChild(b);c.appendChild(f);m.appendChild(c);m.onclick=function(ev){if(ev.target===m)m.remove();};document.body.appendChild(m);})()\">\n            Start Training Mode\n          </button>\n          <div class=\"sa-training-steps\">\n            <strong>How it works:</strong>\n            <ol>\n              <li>Start training and walk to each camera</li>\n              <li>System auto-detects you and records transit times</li>\n              <li>Mark landmarks as you encounter them</li>\n              <li>Apply results to generate your topology</li>\n            </ol>\n          </div>\n        </div>\n      ",group:"Getting Started"});t.push({key:"topologyEditor",title:"Topology Editor",type:"html",value:"\n        <style>\n          .sa-open-btn {\n            background: #4fc3f7;\n            color: #000;\n            border: none;\n            padding: 10px 20px;\n            border-radius: 4px;\n            font-size: 14px;\n            font-weight: 500;\n            cursor: pointer;\n            display: inline-flex;\n            align-items: center;\n            gap: 8px;\n            transition: background 0.2s;\n            font-family: inherit;\n          }\n          .sa-open-btn:hover {\n            background: #81d4fa;\n          }\n          .sa-btn-container {\n            padding: 16px;\n            background: rgba(255,255,255,0.03);\n            border-radius: 4px;\n            text-align: center;\n            border: 1px solid rgba(255,255,255,0.08);\n          }\n          .sa-btn-desc {\n            color: rgba(255,255,255,0.6);\n            margin-bottom: 12px;\n            font-size: 13px;\n            font-family: inherit;\n          }\n        </style>\n        <div class=\"sa-btn-container\">\n          <p class=\"sa-btn-desc\">Configure camera positions, connections, and transit times</p>\n          <button class=\"sa-open-btn\" onclick=\"(function(){var e=document.getElementById('sa-topology-modal');if(e)e.remove();var m=document.createElement('div');m.id='sa-topology-modal';m.style.cssText='position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.85);z-index:2147483647;display:flex;align-items:center;justify-content:center;';var c=document.createElement('div');c.style.cssText='width:95vw;height:92vh;max-width:1800px;background:#121212;border-radius:8px;overflow:hidden;position:relative;box-shadow:0 8px 32px rgba(0,0,0,0.5);border:1px solid rgba(255,255,255,0.1);';var b=document.createElement('button');b.innerHTML='×';b.style.cssText='position:absolute;top:8px;right:8px;z-index:2147483647;background:rgba(255,255,255,0.1);color:white;border:none;width:32px;height:32px;border-radius:4px;font-size:18px;cursor:pointer;line-height:1;';b.onclick=function(){m.remove();};var f=document.createElement('iframe');f.src='/endpoint/@blueharford/scrypted-spatial-awareness/ui/editor';f.style.cssText='width:100%;height:100%;border:none;';c.appendChild(b);c.appendChild(f);m.appendChild(c);m.onclick=function(ev){if(ev.target===m)m.remove();};document.body.appendChild(m);})()\">\n            Open Topology Editor\n          </button>\n        </div>\n      ",group:"Topology"}),n("Cameras");const r=this.trackingState.getActiveCount(),i=this.storage.getItem("topology");let s="Not configured - add cameras and configure topology";if(this.trackingEngine)s=`Active: Tracking ${r} object${1!==r?"s":""}`;else if(i)try{const e=JSON.parse(i);e.cameras&&e.cameras.length>0&&(s=`Configured (${e.cameras.length} cameras) - Starting...`,this.startTrackingEngine(e).catch(e=>{this.console.error("Failed to restart tracking engine:",e)}))}catch(e){s="Error loading topology"}t.push({key:"status",title:"Tracking Status",type:"string",readonly:!0,value:s,group:"Status"});const o=this.alertManager.getRecentAlerts(5);o.length>0&&t.push({key:"recentAlerts",title:"Recent Alerts",type:"string",readonly:!0,value:o.map(e=>`${e.type}: ${e.message}`).join("\n"),group:"Status"}),n("Tracking"),n("AI & Spatial Reasoning"),n("Alerts");const a=this.alertManager.getRules(),c=this.generateAlertRulesHtml(a);return t.push({key:"alertRulesEditor",title:"Alert Rules",type:"html",value:c,group:"Alerts"}),n("MQTT Integration"),t}generateAlertRulesHtml(e){return`\n      <style>\n        .sa-rules-table { width:100%; border-collapse:collapse; margin-top:10px; }\n        .sa-rules-table th { text-align:left; padding:10px 8px; border-bottom:2px solid #e94560; color:#e94560; font-size:13px; }\n        .sa-save-rules-btn {\n          background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);\n          color: white;\n          border: none;\n          padding: 10px 20px;\n          border-radius: 6px;\n          font-size: 14px;\n          font-weight: 600;\n          cursor: pointer;\n          margin-top: 15px;\n        }\n        .sa-save-rules-btn:hover { opacity: 0.9; }\n        .sa-rules-container { background:#16213e; border-radius:8px; padding:15px; }\n        .sa-rules-desc { color:#888; font-size:13px; margin-bottom:10px; }\n      </style>\n      <div class="sa-rules-container">\n        <p class="sa-rules-desc">Enable or disable alert types. Movement alerts notify you when someone moves between cameras.</p>\n        <table class="sa-rules-table">\n          <thead>\n            <tr>\n              <th style="width:40px;">On</th>\n              <th>Alert Type</th>\n              <th>Event</th>\n              <th>Severity</th>\n              <th>Cooldown</th>\n            </tr>\n          </thead>\n          <tbody>\n            ${e.map(e=>`\n      <tr data-rule-id="${e.id}">\n        <td style="padding:8px;border-bottom:1px solid #333;">\n          <input type="checkbox" ${e.enabled?"checked":""}\n                 onchange="(function(el){var rules=JSON.parse(localStorage.getItem('sa-temp-rules')||'[]');var r=rules.find(x=>x.id==='${e.id}');if(r)r.enabled=el.checked;localStorage.setItem('sa-temp-rules',JSON.stringify(rules));})(this)" />\n        </td>\n        <td style="padding:8px;border-bottom:1px solid #333;color:#fff;">${e.name}</td>\n        <td style="padding:8px;border-bottom:1px solid #333;color:#888;">${e.type}</td>\n        <td style="padding:8px;border-bottom:1px solid #333;">\n          <span style="padding:2px 8px;border-radius:4px;font-size:12px;background:${"critical"===e.severity?"#e94560":"warning"===e.severity?"#f39c12":"#3498db"};color:white;">${e.severity}</span>\n        </td>\n        <td style="padding:8px;border-bottom:1px solid #333;color:#888;">${Math.round(e.cooldown/1e3)}s</td>\n      </tr>\n    `).join("")}\n          </tbody>\n        </table>\n        <button class="sa-save-rules-btn" onclick="(function(){var rules=JSON.parse(localStorage.getItem('sa-temp-rules')||'[]');fetch('/endpoint/@blueharford/scrypted-spatial-awareness/api/alert-rules',{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify(rules)}).then(r=>r.json()).then(d=>{if(d.success)alert('Alert rules saved!');else alert('Error: '+d.error);}).catch(e=>alert('Error: '+e));})()">Save Alert Rules</button>\n        <script>(function(){${`localStorage.setItem('sa-temp-rules',JSON.stringify(${JSON.stringify(e)}))`}})();<\/script>\n      </div>\n    `}async putSetting(e,t){if(await this.storageSettings.putSetting(e,t),"trackedCameras"===e||"correlationWindow"===e||"correlationThreshold"===e||"lostTimeout"===e||"useVisualMatching"===e||"loiteringThreshold"===e||"objectAlertCooldown"===e||"useLlmDescriptions"===e||"llmDebounceInterval"===e||"llmFallbackEnabled"===e||"llmFallbackTimeout"===e||"enableTransitTimeLearning"===e||"enableConnectionSuggestions"===e||"enableLandmarkLearning"===e||"landmarkConfidenceThreshold"===e){const e=this.storage.getItem("topology");if(e)try{const t=JSON.parse(e);await this.startTrackingEngine(t)}catch(e){this.console.error("Failed to restart tracking engine:",e)}}"enableMqtt"!==e&&"mqttBroker"!==e&&"mqttUsername"!==e&&"mqttPassword"!==e&&"mqttBaseTopic"!==e||(this.mqttPublisher&&(this.mqttPublisher.disconnect(),this.mqttPublisher=null),this.storageSettings.values.enableMqtt&&await this.initializeMqtt())}async onRequest(e,t){const n=new URL(e.url,"http://localhost").pathname;try{if(n.endsWith("/api/tracked-objects"))return this.handleTrackedObjectsRequest(e,t);if(n.match(/\/api\/journey\/[\w-]+$/)){const e=n.split("/").pop();return this.handleJourneyRequest(e,t)}if(n.endsWith("/api/topology"))return await this.handleTopologyRequest(e,t);if(n.endsWith("/api/alerts"))return this.handleAlertsRequest(e,t);if(n.endsWith("/api/alert-rules"))return this.handleAlertRulesRequest(e,t);if(n.endsWith("/api/cameras"))return this.handleCamerasRequest(t);if(n.endsWith("/api/floor-plan"))return this.handleFloorPlanRequest(e,t);if(n.endsWith("/api/landmarks"))return this.handleLandmarksRequest(e,t);if(n.match(/\/api\/landmarks\/[\w-]+$/)){const r=n.split("/").pop();return this.handleLandmarkRequest(r,e,t)}if(n.endsWith("/api/landmark-suggestions"))return this.handleLandmarkSuggestionsRequest(e,t);if(n.match(/\/api\/landmark-suggestions\/[\w-]+\/(accept|reject)$/)){const e=n.split("/"),r=e.pop(),i=e.pop();return this.handleSuggestionActionRequest(i,r,t)}if(n.endsWith("/api/landmark-templates"))return this.handleLandmarkTemplatesRequest(t);if(n.endsWith("/api/infer-relationships"))return this.handleInferRelationshipsRequest(t);if(n.endsWith("/api/connection-suggestions"))return this.handleConnectionSuggestionsRequest(e,t);if(n.match(/\/api\/connection-suggestions\/[\w->]+\/(accept|reject)$/)){const e=n.split("/"),r=e.pop(),i=e.pop();return this.handleConnectionSuggestionActionRequest(i,r,t)}if(n.endsWith("/api/live-tracking"))return this.handleLiveTrackingRequest(t);if(n.match(/\/api\/journey-path\/[\w-]+$/)){const e=n.split("/").pop();return this.handleJourneyPathRequest(e,t)}if(n.endsWith("/api/training/start"))return this.handleTrainingStartRequest(e,t);if(n.endsWith("/api/training/pause"))return this.handleTrainingPauseRequest(t);if(n.endsWith("/api/training/resume"))return this.handleTrainingResumeRequest(t);if(n.endsWith("/api/training/end"))return this.handleTrainingEndRequest(t);if(n.endsWith("/api/training/status"))return this.handleTrainingStatusRequest(t);if(n.endsWith("/api/training/landmark"))return this.handleTrainingLandmarkRequest(e,t);if(n.endsWith("/api/training/apply"))return this.handleTrainingApplyRequest(t);if(n.endsWith("/ui/editor")||n.endsWith("/ui/editor/"))return this.serveEditorUI(t);if(n.endsWith("/ui/training")||n.endsWith("/ui/training/"))return this.serveTrainingUI(t);if(n.includes("/ui/"))return this.serveStaticFile(n,t);t.send(JSON.stringify({name:"Spatial Awareness Plugin",version:"0.4.0",endpoints:{api:{trackedObjects:"/api/tracked-objects",journey:"/api/journey/{globalId}",journeyPath:"/api/journey-path/{globalId}",topology:"/api/topology",alerts:"/api/alerts",floorPlan:"/api/floor-plan",liveTracking:"/api/live-tracking",connectionSuggestions:"/api/connection-suggestions",landmarkSuggestions:"/api/landmark-suggestions",training:{start:"/api/training/start",pause:"/api/training/pause",resume:"/api/training/resume",end:"/api/training/end",status:"/api/training/status",landmark:"/api/training/landmark",apply:"/api/training/apply"}},ui:{editor:"/ui/editor",training:"/ui/training"}}}),{headers:{"Content-Type":"application/json"}})}catch(e){this.console.error("HTTP request error:",e),t.send(JSON.stringify({error:e.message}),{code:500,headers:{"Content-Type":"application/json"}})}}handleTrackedObjectsRequest(e,t){const n=this.trackingState.getAllObjects();t.send(JSON.stringify(n),{headers:{"Content-Type":"application/json"}})}handleJourneyRequest(e,t){const n=this.trackingState.getObject(e);n?t.send(JSON.stringify({globalId:n.globalId,className:n.className,label:n.label,journey:n.journey,sightings:n.sightings.map(e=>({cameraId:e.cameraId,cameraName:e.cameraName,timestamp:e.timestamp})),firstSeen:n.firstSeen,lastSeen:n.lastSeen,state:n.state}),{headers:{"Content-Type":"application/json"}}):t.send(JSON.stringify({error:"Object not found"}),{code:404,headers:{"Content-Type":"application/json"}})}async handleTopologyRequest(e,t){if("GET"===e.method){const e=this.storage.getItem("topology"),n=e?JSON.parse(e):(0,u.createEmptyTopology)();t.send(JSON.stringify(n),{headers:{"Content-Type":"application/json"}})}else if("PUT"===e.method||"POST"===e.method)try{const n=JSON.parse(e.body);this.storage.setItem("topology",JSON.stringify(n)),await this.startTrackingEngine(n),t.send(JSON.stringify({success:!0}),{headers:{"Content-Type":"application/json"}})}catch(e){t.send(JSON.stringify({error:"Invalid topology JSON"}),{code:400,headers:{"Content-Type":"application/json"}})}}handleAlertsRequest(e,t){const n=this.alertManager.getRecentAlerts();t.send(JSON.stringify(n),{headers:{"Content-Type":"application/json"}})}handleAlertRulesRequest(e,t){if("GET"===e.method){const e=this.alertManager.getRules();t.send(JSON.stringify(e),{headers:{"Content-Type":"application/json"}})}else if("PUT"===e.method||"POST"===e.method)try{const n=JSON.parse(e.body);this.alertManager.setRules(n),t.send(JSON.stringify({success:!0}),{headers:{"Content-Type":"application/json"}})}catch(e){t.send(JSON.stringify({error:"Invalid rules JSON"}),{code:400,headers:{"Content-Type":"application/json"}})}}handleCamerasRequest(e){try{const t=[];for(const e of Object.keys(w.getSystemState()))try{const n=w.getDeviceById(e);n&&n.interfaces?.includes(a.ScryptedInterface.ObjectDetector)&&t.push({id:e,name:n.name||`Camera ${e}`})}catch(e){}e.send(JSON.stringify(t),{headers:{"Content-Type":"application/json"}})}catch(t){this.console.error("Error getting cameras:",t),e.send(JSON.stringify([]),{headers:{"Content-Type":"application/json"}})}}async getFloorPlanPath(){const e=await k.getFilesPath();return this.console.log("Files path from mediaManager:",e),l.existsSync(e)||l.mkdirSync(e,{recursive:!0}),d.join(e,"floorplan.jpg")}async handleFloorPlanRequest(e,t){if("GET"===e.method)try{const e=await this.getFloorPlanPath();if(this.console.log("Loading floor plan from:",e,"exists:",l.existsSync(e)),l.existsSync(e)){const n=l.readFileSync(e),r="data:image/jpeg;base64,"+n.toString("base64");this.console.log("Floor plan loaded, size:",n.length),t.send(JSON.stringify({imageData:r}),{headers:{"Content-Type":"application/json"}})}else t.send(JSON.stringify({imageData:null}),{headers:{"Content-Type":"application/json"}})}catch(e){this.console.error("Failed to read floor plan:",e),t.send(JSON.stringify({imageData:null}),{headers:{"Content-Type":"application/json"}})}else if("POST"===e.method)try{const n=JSON.parse(e.body),r=n.imageData.replace(/^data:image\/\w+;base64,/,""),i=Buffer.from(r,"base64"),s=await this.getFloorPlanPath();l.writeFileSync(s,i),this.console.log("Floor plan saved to:",s,"size:",i.length),t.send(JSON.stringify({success:!0}),{headers:{"Content-Type":"application/json"}})}catch(e){this.console.error("Failed to save floor plan:",e),t.send(JSON.stringify({error:"Failed to save floor plan"}),{code:500,headers:{"Content-Type":"application/json"}})}}handleLandmarksRequest(e,t){const n=this.getTopology();if(n){if("GET"===e.method)t.send(JSON.stringify({landmarks:n.landmarks||[]}),{headers:{"Content-Type":"application/json"}});else if("POST"===e.method)try{const r=JSON.parse(e.body);r.id||(r.id=`landmark_${Date.now()}`),n.landmarks||(n.landmarks=[]),n.landmarks.push(r),this.storage.setItem("topology",JSON.stringify(n)),this.trackingEngine&&this.trackingEngine.updateTopology(n),t.send(JSON.stringify({success:!0,landmark:r}),{headers:{"Content-Type":"application/json"}})}catch(e){t.send(JSON.stringify({error:"Invalid landmark data"}),{code:400,headers:{"Content-Type":"application/json"}})}}else t.send(JSON.stringify({landmarks:[]}),{headers:{"Content-Type":"application/json"}})}handleLandmarkRequest(e,t,n){const r=this.getTopology();if(!r)return void n.send(JSON.stringify({error:"No topology configured"}),{code:404,headers:{"Content-Type":"application/json"}});const i=r.landmarks?.findIndex(t=>t.id===e)??-1;if("GET"===t.method){const e=r.landmarks?.[i];e?n.send(JSON.stringify(e),{headers:{"Content-Type":"application/json"}}):n.send(JSON.stringify({error:"Landmark not found"}),{code:404,headers:{"Content-Type":"application/json"}})}else if("PUT"===t.method)try{const s=JSON.parse(t.body);i>=0?(r.landmarks[i]={...r.landmarks[i],...s,id:e},this.storage.setItem("topology",JSON.stringify(r)),this.trackingEngine&&this.trackingEngine.updateTopology(r),n.send(JSON.stringify({success:!0,landmark:r.landmarks[i]}),{headers:{"Content-Type":"application/json"}})):n.send(JSON.stringify({error:"Landmark not found"}),{code:404,headers:{"Content-Type":"application/json"}})}catch(e){n.send(JSON.stringify({error:"Invalid landmark data"}),{code:400,headers:{"Content-Type":"application/json"}})}else"DELETE"===t.method&&(i>=0?(r.landmarks.splice(i,1),this.storage.setItem("topology",JSON.stringify(r)),this.trackingEngine&&this.trackingEngine.updateTopology(r),n.send(JSON.stringify({success:!0}),{headers:{"Content-Type":"application/json"}})):n.send(JSON.stringify({error:"Landmark not found"}),{code:404,headers:{"Content-Type":"application/json"}}))}handleLandmarkSuggestionsRequest(e,t){if(!this.trackingEngine)return void t.send(JSON.stringify({suggestions:[]}),{headers:{"Content-Type":"application/json"}});const n=this.trackingEngine.getPendingLandmarkSuggestions();t.send(JSON.stringify({suggestions:n,count:n.length}),{headers:{"Content-Type":"application/json"}})}handleSuggestionActionRequest(e,t,n){if(this.trackingEngine)if("accept"===t){const t=this.trackingEngine.acceptLandmarkSuggestion(e);t?n.send(JSON.stringify({success:!0,landmark:t}),{headers:{"Content-Type":"application/json"}}):n.send(JSON.stringify({error:"Suggestion not found"}),{code:404,headers:{"Content-Type":"application/json"}})}else if("reject"===t){this.trackingEngine.rejectLandmarkSuggestion(e)?n.send(JSON.stringify({success:!0}),{headers:{"Content-Type":"application/json"}}):n.send(JSON.stringify({error:"Suggestion not found"}),{code:404,headers:{"Content-Type":"application/json"}})}else n.send(JSON.stringify({error:"Invalid action"}),{code:400,headers:{"Content-Type":"application/json"}});else n.send(JSON.stringify({error:"Tracking engine not running"}),{code:500,headers:{"Content-Type":"application/json"}})}handleLandmarkTemplatesRequest(e){e.send(JSON.stringify({templates:u.LANDMARK_TEMPLATES}),{headers:{"Content-Type":"application/json"}})}handleInferRelationshipsRequest(e){const t=this.getTopology();if(!t)return void e.send(JSON.stringify({relationships:[]}),{headers:{"Content-Type":"application/json"}});const n=(0,u.inferRelationships)(t);e.send(JSON.stringify({relationships:n,count:n.length}),{headers:{"Content-Type":"application/json"}})}handleConnectionSuggestionsRequest(e,t){if(!this.trackingEngine)return void t.send(JSON.stringify({suggestions:[]}),{headers:{"Content-Type":"application/json"}});const n=this.trackingEngine.getConnectionSuggestions();t.send(JSON.stringify({suggestions:n,count:n.length}),{headers:{"Content-Type":"application/json"}})}handleConnectionSuggestionActionRequest(e,t,n){if(this.trackingEngine)if("accept"===t){const t=this.trackingEngine.acceptConnectionSuggestion(e);if(t){const e=this.trackingEngine.getTopology();this.storage.setItem("topology",JSON.stringify(e)),n.send(JSON.stringify({success:!0,connection:t}),{headers:{"Content-Type":"application/json"}})}else n.send(JSON.stringify({error:"Suggestion not found"}),{code:404,headers:{"Content-Type":"application/json"}})}else if("reject"===t){this.trackingEngine.rejectConnectionSuggestion(e)?n.send(JSON.stringify({success:!0}),{headers:{"Content-Type":"application/json"}}):n.send(JSON.stringify({error:"Suggestion not found"}),{code:404,headers:{"Content-Type":"application/json"}})}else n.send(JSON.stringify({error:"Invalid action"}),{code:400,headers:{"Content-Type":"application/json"}});else n.send(JSON.stringify({error:"Tracking engine not running"}),{code:500,headers:{"Content-Type":"application/json"}})}handleLiveTrackingRequest(e){if(!this.trackingEngine)return void e.send(JSON.stringify({objects:[],timestamp:Date.now()}),{headers:{"Content-Type":"application/json"}});const t=this.trackingEngine.getLiveTrackingState();e.send(JSON.stringify(t),{headers:{"Content-Type":"application/json"}})}handleJourneyPathRequest(e,t){if(!this.trackingEngine)return void t.send(JSON.stringify({error:"Tracking engine not running"}),{code:500,headers:{"Content-Type":"application/json"}});const n=this.trackingEngine.getJourneyPath(e);n?t.send(JSON.stringify(n),{headers:{"Content-Type":"application/json"}}):t.send(JSON.stringify({error:"Object not found"}),{code:404,headers:{"Content-Type":"application/json"}})}handleTrainingStartRequest(e,t){if(this.trackingEngine)try{let n,r;if(e.body){const t=JSON.parse(e.body);r=t.trainerName,n=t.config}const i=this.trackingEngine.startTrainingSession(r,n);t.send(JSON.stringify(i),{headers:{"Content-Type":"application/json"}})}catch(e){t.send(JSON.stringify({error:e.message}),{code:500,headers:{"Content-Type":"application/json"}})}else t.send(JSON.stringify({error:"Tracking engine not running. Configure topology first."}),{code:500,headers:{"Content-Type":"application/json"}})}handleTrainingPauseRequest(e){if(!this.trackingEngine)return void e.send(JSON.stringify({error:"Tracking engine not running"}),{code:500,headers:{"Content-Type":"application/json"}});this.trackingEngine.pauseTrainingSession()?e.send(JSON.stringify({success:!0}),{headers:{"Content-Type":"application/json"}}):e.send(JSON.stringify({error:"No active training session to pause"}),{code:400,headers:{"Content-Type":"application/json"}})}handleTrainingResumeRequest(e){if(!this.trackingEngine)return void e.send(JSON.stringify({error:"Tracking engine not running"}),{code:500,headers:{"Content-Type":"application/json"}});this.trackingEngine.resumeTrainingSession()?e.send(JSON.stringify({success:!0}),{headers:{"Content-Type":"application/json"}}):e.send(JSON.stringify({error:"No paused training session to resume"}),{code:400,headers:{"Content-Type":"application/json"}})}handleTrainingEndRequest(e){if(!this.trackingEngine)return void e.send(JSON.stringify({error:"Tracking engine not running"}),{code:500,headers:{"Content-Type":"application/json"}});const t=this.trackingEngine.endTrainingSession();t?e.send(JSON.stringify(t),{headers:{"Content-Type":"application/json"}}):e.send(JSON.stringify({error:"No training session to end"}),{code:400,headers:{"Content-Type":"application/json"}})}handleTrainingStatusRequest(e){if(!this.trackingEngine)return void e.send(JSON.stringify({state:"idle",stats:null}),{headers:{"Content-Type":"application/json"}});const t=this.trackingEngine.getTrainingStatus();t?e.send(JSON.stringify(t),{headers:{"Content-Type":"application/json"}}):e.send(JSON.stringify({state:"idle",stats:null}),{headers:{"Content-Type":"application/json"}})}handleTrainingLandmarkRequest(e,t){if(this.trackingEngine)try{const n=JSON.parse(e.body),r=this.trackingEngine.markTrainingLandmark(n);r?t.send(JSON.stringify({success:!0,landmark:r}),{headers:{"Content-Type":"application/json"}}):t.send(JSON.stringify({error:"No active training session"}),{code:400,headers:{"Content-Type":"application/json"}})}catch(e){t.send(JSON.stringify({error:"Invalid request body"}),{code:400,headers:{"Content-Type":"application/json"}})}else t.send(JSON.stringify({error:"Tracking engine not running"}),{code:500,headers:{"Content-Type":"application/json"}})}handleTrainingApplyRequest(e){if(!this.trackingEngine)return void e.send(JSON.stringify({error:"Tracking engine not running"}),{code:500,headers:{"Content-Type":"application/json"}});const t=this.trackingEngine.applyTrainingToTopology();if(t.success){const e=this.trackingEngine.getTopology();this.storage.setItem("topology",JSON.stringify(e))}e.send(JSON.stringify(t),{headers:{"Content-Type":"application/json"}})}serveEditorUI(e){e.send(v.EDITOR_HTML,{headers:{"Content-Type":"text/html"}})}serveTrainingUI(e){e.send(S.TRAINING_HTML,{headers:{"Content-Type":"text/html"}})}serveStaticFile(e,t){t.send("Not found",{code:404})}async getReadmeMarkdown(){return"\n# Spatial Awareness Plugin\n\nThis plugin enables cross-camera object tracking across your entire NVR system.\n\n## Features\n\n- **Cross-Camera Tracking**: Correlate objects as they move between cameras\n- **Journey History**: Complete path history for each tracked object\n- **Entry/Exit Detection**: Know when objects enter or leave your property\n- **Visual Floor Plan**: Configure camera topology with a visual editor\n- **MQTT Integration**: Export tracking data to Home Assistant\n- **REST API**: Query tracked objects and journeys programmatically\n- **Smart Alerts**: Get notified about property entry/exit, unusual paths, and more\n\n## Setup\n\n1. **Add Cameras**: Select cameras with object detection in the plugin settings\n2. **Configure Topology**: Define camera relationships and transit times\n3. **Enable Integrations**: Optionally enable MQTT for Home Assistant\n4. **Create Zones**: Add tracking zones for specific area monitoring\n\n## API Endpoints\n\n- `GET /api/tracked-objects` - List all tracked objects\n- `GET /api/journey/{id}` - Get journey for specific object\n- `GET /api/topology` - Get camera topology\n- `PUT /api/topology` - Update camera topology\n- `GET /api/alerts` - Get recent alerts\n\n## Visual Editor\n\nAccess the visual topology editor at `/ui/editor` to configure camera relationships using a floor plan.\n\n## Alert Types\n\n- **Property Entry**: Object entered the property\n- **Property Exit**: Object exited the property\n- **Unusual Path**: Object took an unexpected route\n- **Dwell Time**: Object lingered too long in an area\n- **Restricted Zone**: Object entered a restricted area\n"}getTrackingState(){return this.trackingState}getAlertManager(){return this.alertManager}getTopology(){const e=this.storage.getItem("topology");return e?JSON.parse(e):null}}t.SpatialAwarenessPlugin=x,t.default=x},7969(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const r=n(4478),i={objectMode:!0},s={clean:!0};t.default=class{options;_inflights;constructor(e){this.options=e||{},this.options={...s,...e},this._inflights=new Map}put(e,t){return this._inflights.set(e.messageId,e),t&&t(),this}createStream(){const e=new r.Readable(i),t=[];let n=!1,s=0;return this._inflights.forEach((e,n)=>{t.push(e)}),e._read=()=>{!n&&s<t.length?e.push(t[s++]):e.push(null)},e.destroy=t=>{if(!n)return n=!0,setTimeout(()=>{e.emit("close")},0),e},e}del(e,t){const n=this._inflights.get(e.messageId);return n?(this._inflights.delete(e.messageId),t(null,n)):t&&t(new Error("missing packet")),this}get(e,t){const n=this._inflights.get(e.messageId);return n?t(null,n):t&&t(new Error("missing packet")),this}close(e){this.options.clean&&(this._inflights=null),e&&e()}}},8194(e,t,n){"use strict";n.d(t,{CD:()=>_});var r,i=(r=function(e,t){return r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])},r(e,t)},function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function n(){this.constructor=e}r(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}),s=function(){function e(e,t){this.ee=1,this.u=void 0,this.p=void 0,this.K=void 0,this.N=void 0,this.rr=void 0,this.u=e,this.p=t}return e.prototype.L=function(){var e=this;if(1===e.ee&&e.rr.rr===e)e=e.N;else if(e.K)for(e=e.K;e.N;)e=e.N;else{for(var t=e.rr;t.K===e;)t=(e=t).rr;e=t}return e},e.prototype.m=function(){var e=this;if(e.N){for(e=e.N;e.K;)e=e.K;return e}for(var t=e.rr;t.N===e;)t=(e=t).rr;return e.N!==t?t:e},e.prototype.ne=function(){var e=this.rr,t=this.N,n=t.K;return e.rr===this?e.rr=t:e.K===this?e.K=t:e.N=t,t.rr=e,t.K=this,this.rr=t,this.N=n,n&&(n.rr=this),t},e.prototype.te=function(){var e=this.rr,t=this.K,n=t.N;return e.rr===this?e.rr=t:e.K===this?e.K=t:e.N=t,t.rr=e,t.N=this,this.rr=t,this.K=n,n&&(n.rr=this),t},e}(),o=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.tr=1,t}return i(t,e),t.prototype.ne=function(){var t=e.prototype.ne.call(this);return this.ie(),t.ie(),t},t.prototype.te=function(){var t=e.prototype.te.call(this);return this.ie(),t.ie(),t},t.prototype.ie=function(){this.tr=1,this.K&&(this.tr+=this.K.tr),this.N&&(this.tr+=this.N.tr)},t}(s),a=function(){var e=function(t,n){return e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])},e(t,n)};return function(t,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),c=function(){function e(e){void 0===e&&(e=0),this.iteratorType=e}return e.prototype.equals=function(e){return this.o===e.o},e}(),l=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return a(t,e),t}(function(){function e(){this.M=0}return Object.defineProperty(e.prototype,"length",{get:function(){return this.M},enumerable:!1,configurable:!0}),e.prototype.size=function(){return this.M},e.prototype.empty=function(){return 0===this.M},e}());function d(){throw new RangeError("Iterator access denied!")}var u=function(){var e=function(t,n){return e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])},e(t,n)};return function(t,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),h=function(e,t){var n="function"==typeof Symbol&&e[Symbol.iterator];if(!n)return e;var r,i,s=n.call(e),o=[];try{for(;(void 0===t||t-- >0)&&!(r=s.next()).done;)o.push(r.value)}catch(e){i={error:e}}finally{try{r&&!r.done&&(n=s.return)&&n.call(s)}finally{if(i)throw i.error}}return o},p=function(e){var t="function"==typeof Symbol&&Symbol.iterator,n=t&&e[t],r=0;if(n)return n.call(e);if(e&&"number"==typeof e.length)return{next:function(){return e&&r>=e.length&&(e=void 0),{value:e&&e[r++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")};const f=function(e){function t(t,n){void 0===t&&(t=function(e,t){return e<t?-1:e>t?1:0}),void 0===n&&(n=!1);var r=e.call(this)||this;return r.W=void 0,r.$=t,n?(r.re=o,r.v=function(e,t,n){var r=this.se(e,t,n);if(r){for(var i=r.rr;i!==this.h;)i.tr+=1,i=i.rr;var s=this.fe(r);if(s){var o=s,a=o.parentNode,c=o.grandParent,l=o.curNode;a.ie(),c.ie(),l.ie()}}return this.M},r.G=function(e){for(var t=this.he(e);t!==this.h;)t.tr-=1,t=t.rr}):(r.re=s,r.v=function(e,t,n){var r=this.se(e,t,n);return r&&this.fe(r),this.M},r.G=r.he),r.h=new r.re,r}return u(t,e),t.prototype.U=function(e,t){for(var n=this.h;e;){var r=this.$(e.u,t);if(r<0)e=e.N;else{if(!(r>0))return e;n=e,e=e.K}}return n},t.prototype.X=function(e,t){for(var n=this.h;e;){this.$(e.u,t)<=0?e=e.N:(n=e,e=e.K)}return n},t.prototype.Y=function(e,t){for(var n=this.h;e;){var r=this.$(e.u,t);if(r<0)n=e,e=e.N;else{if(!(r>0))return e;e=e.K}}return n},t.prototype.Z=function(e,t){for(var n=this.h;e;){this.$(e.u,t)<0?(n=e,e=e.N):e=e.K}return n},t.prototype.ue=function(e){for(;;){var t,n=e.rr;if(n===this.h)return;if(1===e.ee)return void(e.ee=0);if(e===n.K)if(1===(t=n.N).ee)t.ee=0,n.ee=1,n===this.W?this.W=n.ne():n.ne();else{if(t.N&&1===t.N.ee)return t.ee=n.ee,n.ee=0,t.N.ee=0,void(n===this.W?this.W=n.ne():n.ne());t.K&&1===t.K.ee?(t.ee=1,t.K.ee=0,t.te()):(t.ee=1,e=n)}else if(1===(t=n.K).ee)t.ee=0,n.ee=1,n===this.W?this.W=n.te():n.te();else{if(t.K&&1===t.K.ee)return t.ee=n.ee,n.ee=0,t.K.ee=0,void(n===this.W?this.W=n.te():n.te());t.N&&1===t.N.ee?(t.ee=1,t.N.ee=0,t.ne()):(t.ee=1,e=n)}}},t.prototype.he=function(e){var t,n;if(1===this.M)return this.clear(),this.h;for(var r=e;r.K||r.N;){if(r.N)for(r=r.N;r.K;)r=r.K;else r=r.K;t=h([r.u,e.u],2),e.u=t[0],r.u=t[1],n=h([r.p,e.p],2),e.p=n[0],r.p=n[1],e=r}this.h.K===r?this.h.K=r.rr:this.h.N===r&&(this.h.N=r.rr),this.ue(r);var i=r.rr;return r===i.K?i.K=void 0:i.N=void 0,this.M-=1,this.W.ee=0,i},t.prototype.ae=function(e,t){return void 0!==e&&(!!this.ae(e.K,t)||(!!t(e)||this.ae(e.N,t)))},t.prototype.fe=function(e){for(;;){var t=e.rr;if(0===t.ee)return;var n=t.rr;if(t===n.K){if((r=n.N)&&1===r.ee){if(r.ee=t.ee=0,n===this.W)return;n.ee=1,e=n;continue}if(e===t.N){if(e.ee=0,e.K&&(e.K.rr=t),e.N&&(e.N.rr=n),t.N=e.K,n.K=e.N,e.K=t,e.N=n,n===this.W)this.W=e,this.h.rr=e;else(i=n.rr).K===n?i.K=e:i.N=e;return e.rr=n.rr,t.rr=e,n.rr=e,n.ee=1,{parentNode:t,grandParent:n,curNode:e}}t.ee=0,n===this.W?this.W=n.te():n.te(),n.ee=1}else{var r;if((r=n.K)&&1===r.ee){if(r.ee=t.ee=0,n===this.W)return;n.ee=1,e=n;continue}if(e===t.K){var i;if(e.ee=0,e.K&&(e.K.rr=n),e.N&&(e.N.rr=t),n.N=e.K,t.K=e.N,e.K=n,e.N=t,n===this.W)this.W=e,this.h.rr=e;else(i=n.rr).K===n?i.K=e:i.N=e;return e.rr=n.rr,t.rr=e,n.rr=e,n.ee=1,{parentNode:t,grandParent:n,curNode:e}}t.ee=0,n===this.W?this.W=n.ne():n.ne(),n.ee=1}return}},t.prototype.se=function(e,t,n){if(void 0===this.W)return this.M+=1,this.W=new this.re(e,t),this.W.ee=0,this.W.rr=this.h,this.h.rr=this.W,this.h.K=this.W,void(this.h.N=this.W);var r,i=this.h.K,s=this.$(i.u,e);if(0!==s){if(s>0)i.K=new this.re(e,t),i.K.rr=i,r=i.K,this.h.K=r;else{var o=this.h.N,a=this.$(o.u,e);if(0===a)return void(o.p=t);if(a<0)o.N=new this.re(e,t),o.N.rr=o,r=o.N,this.h.N=r;else{if(void 0!==n){var c=n.o;if(c!==this.h){var l=this.$(c.u,e);if(0===l)return void(c.p=t);if(l>0){var d=c.L(),u=this.$(d.u,e);if(0===u)return void(d.p=t);u<0&&(r=new this.re(e,t),void 0===d.N?(d.N=r,r.rr=d):(c.K=r,r.rr=c))}}}if(void 0===r)for(r=this.W;;){var h=this.$(r.u,e);if(h>0){if(void 0===r.K){r.K=new this.re(e,t),r.K.rr=r,r=r.K;break}r=r.K}else{if(!(h<0))return void(r.p=t);if(void 0===r.N){r.N=new this.re(e,t),r.N.rr=r,r=r.N;break}r=r.N}}}}return this.M+=1,r}i.p=t},t.prototype.g=function(e,t){for(;e;){var n=this.$(e.u,t);if(n<0)e=e.N;else{if(!(n>0))return e;e=e.K}}return e||this.h},t.prototype.clear=function(){this.M=0,this.W=void 0,this.h.rr=void 0,this.h.K=this.h.N=void 0},t.prototype.updateKeyByIterator=function(e,t){var n=e.o;if(n===this.h&&d(),1===this.M)return n.u=t,!0;if(n===this.h.K)return this.$(n.m().u,t)>0&&(n.u=t,!0);if(n===this.h.N)return this.$(n.L().u,t)<0&&(n.u=t,!0);var r=n.L().u;if(this.$(r,t)>=0)return!1;var i=n.m().u;return!(this.$(i,t)<=0)&&(n.u=t,!0)},t.prototype.eraseElementByPos=function(e){if(e<0||e>this.M-1)throw new RangeError;var t=0,n=this;return this.ae(this.W,function(r){return e===t?(n.G(r),!0):(t+=1,!1)}),this.M},t.prototype.eraseElementByKey=function(e){if(0===this.M)return!1;var t=this.g(this.W,e);return t!==this.h&&(this.G(t),!0)},t.prototype.eraseElementByIterator=function(e){var t=e.o;t===this.h&&d();var n=void 0===t.N;return 0===e.iteratorType?n&&e.next():n&&void 0!==t.K||e.next(),this.G(t),e},t.prototype.forEach=function(e){var t,n,r=0;try{for(var i=p(this),s=i.next();!s.done;s=i.next()){e(s.value,r++,this)}}catch(e){t={error:e}}finally{try{s&&!s.done&&(n=i.return)&&n.call(i)}finally{if(t)throw t.error}}},t.prototype.getElementByPos=function(e){var t,n,r;if(e<0||e>this.M-1)throw new RangeError;var i=0;try{for(var s=p(this),o=s.next();!o.done;o=s.next()){var a=o.value;if(i===e){r=a;break}i+=1}}catch(e){t={error:e}}finally{try{o&&!o.done&&(n=s.return)&&n.call(s)}finally{if(t)throw t.error}}return r},t.prototype.getHeight=function(){if(0===this.M)return 0;var e=function(t){return t?Math.max(e(t.K),e(t.N))+1:0};return e(this.W)},t}(l);var g=function(){var e=function(t,n){return e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])},e(t,n)};return function(t,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}();const m=function(e){function t(t,n,r){var i=e.call(this,r)||this;return i.o=t,i.h=n,0===i.iteratorType?(i.pre=function(){return this.o===this.h.K&&d(),this.o=this.o.L(),this},i.next=function(){return this.o===this.h&&d(),this.o=this.o.m(),this}):(i.pre=function(){return this.o===this.h.N&&d(),this.o=this.o.m(),this},i.next=function(){return this.o===this.h&&d(),this.o=this.o.L(),this}),i}return g(t,e),Object.defineProperty(t.prototype,"index",{get:function(){var e=this.o,t=this.h.rr;if(e===this.h)return t?t.tr-1:0;var n=0;for(e.K&&(n+=e.K.tr);e!==t;){var r=e.rr;e===r.N&&(n+=1,r.K&&(n+=r.K.tr)),e=r}return n},enumerable:!1,configurable:!0}),t}(c);var y=function(){var e=function(t,n){return e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])},e(t,n)};return function(t,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),b=function(e,t){var n,r,i,s,o={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return s={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function a(e){return function(t){return c([e,t])}}function c(s){if(n)throw new TypeError("Generator is already executing.");for(;o;)try{if(n=1,r&&(i=2&s[0]?r.return:s[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,s[1])).done)return i;switch(r=0,i&&(s=[2&s[0],i.value]),s[0]){case 0:case 1:i=s;break;case 4:return o.label++,{value:s[1],done:!1};case 5:o.label++,r=s[1],s=[0];continue;case 7:s=o.ops.pop(),o.trys.pop();continue;default:if(!(i=o.trys,(i=i.length>0&&i[i.length-1])||6!==s[0]&&2!==s[0])){o=0;continue}if(3===s[0]&&(!i||s[1]>i[0]&&s[1]<i[3])){o.label=s[1];break}if(6===s[0]&&o.label<i[1]){o.label=i[1],i=s;break}if(i&&o.label<i[2]){o.label=i[2],o.ops.push(s);break}i[2]&&o.ops.pop(),o.trys.pop();continue}s=t.call(e,o)}catch(e){s=[6,e],r=0}finally{n=i=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}},v=function(e){var t="function"==typeof Symbol&&Symbol.iterator,n=t&&e[t],r=0;if(n)return n.call(e);if(e&&"number"==typeof e.length)return{next:function(){return e&&r>=e.length&&(e=void 0),{value:e&&e[r++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")},S=function(e){function t(t,n,r,i){var s=e.call(this,t,n,i)||this;return s.container=r,s}return y(t,e),Object.defineProperty(t.prototype,"pointer",{get:function(){return this.o===this.h&&d(),this.o.u},enumerable:!1,configurable:!0}),t.prototype.copy=function(){return new t(this.o,this.h,this.container,this.iteratorType)},t}(m);const _=function(e){function t(t,n,r){void 0===t&&(t=[]);var i=e.call(this,n,r)||this,s=i;return t.forEach(function(e){s.insert(e)}),i}return y(t,e),t.prototype.P=function(e){return b(this,function(t){switch(t.label){case 0:return void 0===e?[2]:[5,v(this.P(e.K))];case 1:return t.sent(),[4,e.u];case 2:return t.sent(),[5,v(this.P(e.N))];case 3:return t.sent(),[2]}})},t.prototype.begin=function(){return new S(this.h.K||this.h,this.h,this)},t.prototype.end=function(){return new S(this.h,this.h,this)},t.prototype.rBegin=function(){return new S(this.h.N||this.h,this.h,this,1)},t.prototype.rEnd=function(){return new S(this.h,this.h,this,1)},t.prototype.front=function(){return this.h.K?this.h.K.u:void 0},t.prototype.back=function(){return this.h.N?this.h.N.u:void 0},t.prototype.insert=function(e,t){return this.v(e,void 0,t)},t.prototype.find=function(e){var t=this.g(this.W,e);return new S(t,this.h,this)},t.prototype.lowerBound=function(e){var t=this.U(this.W,e);return new S(t,this.h,this)},t.prototype.upperBound=function(e){var t=this.X(this.W,e);return new S(t,this.h,this)},t.prototype.reverseLowerBound=function(e){var t=this.Y(this.W,e);return new S(t,this.h,this)},t.prototype.reverseUpperBound=function(e){var t=this.Z(this.W,e);return new S(t,this.h,this)},t.prototype.union=function(e){var t=this;return e.forEach(function(e){t.insert(e)}),this.M},t.prototype[Symbol.iterator]=function(){return this.P(this.W)},t}(f)},8203(e,t,n){"use strict";var r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.streamBuilder=t.browserStreamBuilder=void 0;const i=n(181),s=r(n(7699)),o=r(n(5753)),a=n(4478),c=r(n(6887)),l=n(2635),d=(0,o.default)("mqttjs:ws"),u=["rejectUnauthorized","ca","cert","key","pfx","passphrase"];function h(e,t){let n=`${e.protocol}://${e.hostname}:${e.port}${e.path}`;return"function"==typeof e.transformWsUrl&&(n=e.transformWsUrl(n,e,t)),n}function p(e){const t=e;return e.port||("wss"===e.protocol?t.port=443:t.port=80),e.path||(t.path="/"),e.wsOptions||(t.wsOptions={}),c.default||e.forceNativeWebSocket||"wss"!==e.protocol||u.forEach(n=>{Object.prototype.hasOwnProperty.call(e,n)&&!Object.prototype.hasOwnProperty.call(e.wsOptions,n)&&(t.wsOptions[n]=e[n])}),t}t.streamBuilder=(e,t)=>{d("streamBuilder");const n=p(t);n.hostname=n.hostname||n.host||"localhost";const r=h(n,e),i=function(e,t,n){d("createWebSocket"),d(`protocol: ${n.protocolId} ${n.protocolVersion}`);const r="MQIsdp"===n.protocolId&&3===n.protocolVersion?"mqttv3.1":"mqtt";let i;return d(`creating new Websocket for url: ${t} and protocol: ${r}`),i=n.createWebsocket?n.createWebsocket(t,[r],n):new s.default(t,[r],n.wsOptions),i}(0,r,n),o=s.default.createWebSocketStream(i,n.wsOptions);return o.url=r,i.on("close",()=>{o.destroy()}),o};t.browserStreamBuilder=(e,t)=>{let n;d("browserStreamBuilder");const r=function(e){const t=p(e);if(t.hostname||(t.hostname=t.host),!t.hostname){if("undefined"==typeof document)throw new Error("Could not determine host. Specify host manually.");const e=new URL(document.URL);t.hostname=e.hostname,t.port||(t.port=Number(e.port))}return void 0===t.objectMode&&(t.objectMode=!(!0===t.binary||void 0===t.binary)),t}(t),s=r.browserBufferSize||524288,o=t.browserBufferTimeout||1e3,c=!t.objectMode,u=function(e,t){const n="MQIsdp"===t.protocolId&&3===t.protocolVersion?"mqttv3.1":"mqtt",r=h(t,e);let i;return i=t.createWebsocket?t.createWebsocket(r,[n],t):new WebSocket(r,[n]),i.binaryType="arraybuffer",i}(e,t),f=function(e,t,n){const r=new a.Transform({objectMode:e.objectMode});return r._write=t,r._flush=n,r}(t,function e(t,n,r){if(u.bufferedAmount>s)return void setTimeout(e,o,t,n,r);c&&"string"==typeof t&&(t=i.Buffer.from(t,"utf8"));try{u.send(t)}catch(e){return r(e)}r()},function(e){u.close(),e()});t.objectMode||(f._writev=l.writev.bind(f)),f.on("close",()=>{u.close()});const g="undefined"!=typeof u.addEventListener;function m(){d("WebSocket onOpen"),n instanceof l.BufferedDuplex&&n.socketReady()}function y(e){d("WebSocket onClose",e),n.end(),n.destroy()}function b(e){d("WebSocket onError",e);const t=new Error("WebSocket error");t.event=e,n.destroy(t)}async function v(e){if(!f||!f.readable||!f.writable)return;let{data:t}=e;t=t instanceof ArrayBuffer?i.Buffer.from(t):t instanceof Blob?i.Buffer.from(await new Response(t).arrayBuffer()):i.Buffer.from(t,"utf8"),f.push(t)}return u.readyState===u.OPEN?(n=f,n.socket=u):(n=new l.BufferedDuplex(t,f,u),g?u.addEventListener("open",m):u.onopen=m),g?(u.addEventListener("close",y),u.addEventListener("error",b),u.addEventListener("message",v)):(u.onclose=y,u.onerror=b,u.onmessage=v),n}},8237(e,t,n){"use strict";const{tokenChars:r}=n(5880);e.exports={parse:function(e){const t=new Set;let n=-1,i=-1,s=0;for(;s<e.length;s++){const o=e.charCodeAt(s);if(-1===i&&1===r[o])-1===n&&(n=s);else if(0===s||32!==o&&9!==o){if(44!==o)throw new SyntaxError(`Unexpected character at index ${s}`);{if(-1===n)throw new SyntaxError(`Unexpected character at index ${s}`);-1===i&&(i=s);const r=e.slice(n,i);if(t.has(r))throw new SyntaxError(`The "${r}" subprotocol is duplicated`);t.add(r),n=i=-1}}else-1===i&&-1!==n&&(i=s)}if(-1===n||-1!==i)throw new SyntaxError("Unexpected end of input");const o=e.slice(n,s);if(t.has(o))throw new SyntaxError(`The "${o}" subprotocol is duplicated`);return t.add(o),t}}},8584(e,t,n){"use strict";const r=n(4422),{ArrayPrototypeSlice:i,Error:s,FunctionPrototypeSymbolHasInstance:o,ObjectDefineProperty:a,ObjectDefineProperties:c,ObjectSetPrototypeOf:l,StringPrototypeToLowerCase:d,Symbol:u,SymbolHasInstance:h}=n(4134);e.exports=N,N.WritableState=R;const{EventEmitter:p}=n(4434),f=n(4259).Stream,{Buffer:g}=n(181),m=n(5896),{addAbortSignal:y}=n(4147),{getHighWaterMark:b,getDefaultHighWaterMark:v}=n(5291),{ERR_INVALID_ARG_TYPE:S,ERR_METHOD_NOT_IMPLEMENTED:_,ERR_MULTIPLE_CALLBACK:w,ERR_STREAM_CANNOT_PIPE:k,ERR_STREAM_DESTROYED:I,ERR_STREAM_ALREADY_FINISHED:E,ERR_STREAM_NULL_VALUES:x,ERR_STREAM_WRITE_AFTER_END:T,ERR_UNKNOWN_ENCODING:C}=n(6371).codes,{errorOrDestroy:O}=m;function A(){}l(N.prototype,f.prototype),l(N,f);const P=u("kOnFinished");function R(e,t,r){"boolean"!=typeof r&&(r=t instanceof n(3370)),this.objectMode=!(!e||!e.objectMode),r&&(this.objectMode=this.objectMode||!(!e||!e.writableObjectMode)),this.highWaterMark=e?b(this,e,"writableHighWaterMark",r):v(!1),this.finalCalled=!1,this.needDrain=!1,this.ending=!1,this.ended=!1,this.finished=!1,this.destroyed=!1;const i=!(!e||!1!==e.decodeStrings);this.decodeStrings=!i,this.defaultEncoding=e&&e.defaultEncoding||"utf8",this.length=0,this.writing=!1,this.corked=0,this.sync=!0,this.bufferProcessing=!1,this.onwrite=D.bind(void 0,t),this.writecb=null,this.writelen=0,this.afterWriteTickInfo=null,M(this),this.pendingcb=0,this.constructed=!0,this.prefinished=!1,this.errorEmitted=!1,this.emitClose=!e||!1!==e.emitClose,this.autoDestroy=!e||!1!==e.autoDestroy,this.errored=null,this.closed=!1,this.closeEmitted=!1,this[P]=[]}function M(e){e.buffered=[],e.bufferedIndex=0,e.allBuffers=!0,e.allNoop=!0}function N(e){const t=this instanceof n(3370);if(!t&&!o(N,this))return new N(e);this._writableState=new R(e,this,t),e&&("function"==typeof e.write&&(this._write=e.write),"function"==typeof e.writev&&(this._writev=e.writev),"function"==typeof e.destroy&&(this._destroy=e.destroy),"function"==typeof e.final&&(this._final=e.final),"function"==typeof e.construct&&(this._construct=e.construct),e.signal&&y(e.signal,this)),f.call(this,e),m.construct(this,()=>{const e=this._writableState;e.writing||W(this,e),H(this,e)})}function B(e,t,n,i){const s=e._writableState;if("function"==typeof n)i=n,n=s.defaultEncoding;else{if(n){if("buffer"!==n&&!g.isEncoding(n))throw new C(n)}else n=s.defaultEncoding;"function"!=typeof i&&(i=A)}if(null===t)throw new x;if(!s.objectMode)if("string"==typeof t)!1!==s.decodeStrings&&(t=g.from(t,n),n="buffer");else if(t instanceof g)n="buffer";else{if(!f._isUint8Array(t))throw new S("chunk",["string","Buffer","Uint8Array"],t);t=f._uint8ArrayToBuffer(t),n="buffer"}let o;return s.ending?o=new T:s.destroyed&&(o=new I("write")),o?(r.nextTick(i,o),O(e,o,!0),o):(s.pendingcb++,function(e,t,n,r,i){const s=t.objectMode?1:n.length;t.length+=s;const o=t.length<t.highWaterMark;o||(t.needDrain=!0);t.writing||t.corked||t.errored||!t.constructed?(t.buffered.push({chunk:n,encoding:r,callback:i}),t.allBuffers&&"buffer"!==r&&(t.allBuffers=!1),t.allNoop&&i!==A&&(t.allNoop=!1)):(t.writelen=s,t.writecb=i,t.writing=!0,t.sync=!0,e._write(n,r,t.onwrite),t.sync=!1);return o&&!t.errored&&!t.destroyed}(e,s,t,n,i))}function L(e,t,n,r,i,s,o){t.writelen=r,t.writecb=o,t.writing=!0,t.sync=!0,t.destroyed?t.onwrite(new I("write")):n?e._writev(i,t.onwrite):e._write(i,s,t.onwrite),t.sync=!1}function j(e,t,n,r){--t.pendingcb,r(n),$(t),O(e,n)}function D(e,t){const n=e._writableState,i=n.sync,s=n.writecb;"function"==typeof s?(n.writing=!1,n.writecb=null,n.length-=n.writelen,n.writelen=0,t?(t.stack,n.errored||(n.errored=t),e._readableState&&!e._readableState.errored&&(e._readableState.errored=t),i?r.nextTick(j,e,n,t,s):j(e,n,t,s)):(n.buffered.length>n.bufferedIndex&&W(e,n),i?null!==n.afterWriteTickInfo&&n.afterWriteTickInfo.cb===s?n.afterWriteTickInfo.count++:(n.afterWriteTickInfo={count:1,cb:s,stream:e,state:n},r.nextTick(U,n.afterWriteTickInfo)):F(e,n,1,s))):O(e,new w)}function U({stream:e,state:t,count:n,cb:r}){return t.afterWriteTickInfo=null,F(e,t,n,r)}function F(e,t,n,r){for(!t.ending&&!e.destroyed&&0===t.length&&t.needDrain&&(t.needDrain=!1,e.emit("drain"));n-- >0;)t.pendingcb--,r();t.destroyed&&$(t),H(e,t)}function $(e){if(e.writing)return;for(let n=e.bufferedIndex;n<e.buffered.length;++n){var t;const{chunk:r,callback:i}=e.buffered[n],s=e.objectMode?1:r.length;e.length-=s,i(null!==(t=e.errored)&&void 0!==t?t:new I("write"))}const n=e[P].splice(0);for(let t=0;t<n.length;t++){var r;n[t](null!==(r=e.errored)&&void 0!==r?r:new I("end"))}M(e)}function W(e,t){if(t.corked||t.bufferProcessing||t.destroyed||!t.constructed)return;const{buffered:n,bufferedIndex:r,objectMode:s}=t,o=n.length-r;if(!o)return;let a=r;if(t.bufferProcessing=!0,o>1&&e._writev){t.pendingcb-=o-1;const r=t.allNoop?A:e=>{for(let t=a;t<n.length;++t)n[t].callback(e)},s=t.allNoop&&0===a?n:i(n,a);s.allBuffers=t.allBuffers,L(e,t,!0,t.length,s,"",r),M(t)}else{do{const{chunk:r,encoding:i,callback:o}=n[a];n[a++]=null;L(e,t,!1,s?1:r.length,r,i,o)}while(a<n.length&&!t.writing);a===n.length?M(t):a>256?(n.splice(0,a),t.bufferedIndex=0):t.bufferedIndex=a}t.bufferProcessing=!1}function V(e){return e.ending&&!e.destroyed&&e.constructed&&0===e.length&&!e.errored&&0===e.buffered.length&&!e.finished&&!e.writing&&!e.errorEmitted&&!e.closeEmitted}function z(e,t){t.prefinished||t.finalCalled||("function"!=typeof e._final||t.destroyed?(t.prefinished=!0,e.emit("prefinish")):(t.finalCalled=!0,function(e,t){let n=!1;function i(i){if(n)O(e,null!=i?i:w());else if(n=!0,t.pendingcb--,i){const n=t[P].splice(0);for(let e=0;e<n.length;e++)n[e](i);O(e,i,t.sync)}else V(t)&&(t.prefinished=!0,e.emit("prefinish"),t.pendingcb++,r.nextTick(q,e,t))}t.sync=!0,t.pendingcb++;try{e._final(i)}catch(e){i(e)}t.sync=!1}(e,t)))}function H(e,t,n){V(t)&&(z(e,t),0===t.pendingcb&&(n?(t.pendingcb++,r.nextTick((e,t)=>{V(t)?q(e,t):t.pendingcb--},e,t)):V(t)&&(t.pendingcb++,q(e,t))))}function q(e,t){t.pendingcb--,t.finished=!0;const n=t[P].splice(0);for(let e=0;e<n.length;e++)n[e]();if(e.emit("finish"),t.autoDestroy){const t=e._readableState;(!t||t.autoDestroy&&(t.endEmitted||!1===t.readable))&&e.destroy()}}R.prototype.getBuffer=function(){return i(this.buffered,this.bufferedIndex)},a(R.prototype,"bufferedRequestCount",{__proto__:null,get(){return this.buffered.length-this.bufferedIndex}}),a(N,h,{__proto__:null,value:function(e){return!!o(this,e)||this===N&&(e&&e._writableState instanceof R)}}),N.prototype.pipe=function(){O(this,new k)},N.prototype.write=function(e,t,n){return!0===B(this,e,t,n)},N.prototype.cork=function(){this._writableState.corked++},N.prototype.uncork=function(){const e=this._writableState;e.corked&&(e.corked--,e.writing||W(this,e))},N.prototype.setDefaultEncoding=function(e){if("string"==typeof e&&(e=d(e)),!g.isEncoding(e))throw new C(e);return this._writableState.defaultEncoding=e,this},N.prototype._write=function(e,t,n){if(!this._writev)throw new _("_write()");this._writev([{chunk:e,encoding:t}],n)},N.prototype._writev=null,N.prototype.end=function(e,t,n){const i=this._writableState;let o;if("function"==typeof e?(n=e,e=null,t=null):"function"==typeof t&&(n=t,t=null),null!=e){const n=B(this,e,t);n instanceof s&&(o=n)}return i.corked&&(i.corked=1,this.uncork()),o||(i.errored||i.ending?i.finished?o=new E("end"):i.destroyed&&(o=new I("end")):(i.ending=!0,H(this,i,!0),i.ended=!0)),"function"==typeof n&&(o||i.finished?r.nextTick(n,o):i[P].push(n)),this},c(N.prototype,{closed:{__proto__:null,get(){return!!this._writableState&&this._writableState.closed}},destroyed:{__proto__:null,get(){return!!this._writableState&&this._writableState.destroyed},set(e){this._writableState&&(this._writableState.destroyed=e)}},writable:{__proto__:null,get(){const e=this._writableState;return!(!e||!1===e.writable||e.destroyed||e.errored||e.ending||e.ended)},set(e){this._writableState&&(this._writableState.writable=!!e)}},writableFinished:{__proto__:null,get(){return!!this._writableState&&this._writableState.finished}},writableObjectMode:{__proto__:null,get(){return!!this._writableState&&this._writableState.objectMode}},writableBuffer:{__proto__:null,get(){return this._writableState&&this._writableState.getBuffer()}},writableEnded:{__proto__:null,get(){return!!this._writableState&&this._writableState.ending}},writableNeedDrain:{__proto__:null,get(){const e=this._writableState;return!!e&&(!e.destroyed&&!e.ending&&e.needDrain)}},writableHighWaterMark:{__proto__:null,get(){return this._writableState&&this._writableState.highWaterMark}},writableCorked:{__proto__:null,get(){return this._writableState?this._writableState.corked:0}},writableLength:{__proto__:null,get(){return this._writableState&&this._writableState.length}},errored:{__proto__:null,enumerable:!1,get(){return this._writableState?this._writableState.errored:null}},writableAborted:{__proto__:null,enumerable:!1,get:function(){return!(!1===this._writableState.writable||!this._writableState.destroyed&&!this._writableState.errored||this._writableState.finished)}}});const G=m.destroy;let K;function J(){return void 0===K&&(K={}),K}N.prototype.destroy=function(e,t){const n=this._writableState;return!n.destroyed&&(n.bufferedIndex<n.buffered.length||n[P].length)&&r.nextTick($,n),G.call(this,e,t),this},N.prototype._undestroy=m.undestroy,N.prototype._destroy=function(e,t){t(e)},N.prototype[p.captureRejectionSymbol]=function(e){this.destroy(e)},N.fromWeb=function(e,t){return J().newStreamWritableFromWritableStream(e,t)},N.toWeb=function(e){return J().newWritableStreamFromStreamWritable(e)}},8600(e,t,n){"use strict";n.r(t),n.d(t,{clearInterval:()=>S,clearTimeout:()=>_,setInterval:()=>w,setTimeout:()=>k});const r=void 0===Number.MAX_SAFE_INTEGER?9007199254740991:Number.MAX_SAFE_INTEGER,i=536870912,s=1073741824,o=new WeakMap;var a;const c=((e,t)=>n=>{const o=t.get(n);let a=void 0===o?n.size:o<s?o+1:0;if(!n.has(a))return e(n,a);if(n.size<i){for(;n.has(a);)a=Math.floor(Math.random()*s);return e(n,a)}if(n.size>r)throw new Error("Congratulations, you created a collection of unique numbers which uses all available integers!");for(;n.has(a);)a=Math.floor(Math.random()*r);return e(n,a)})((a=o,(e,t)=>(a.set(e,t),t)),o),l=((e=>{})(c),((e,t,n,r)=>i=>{const s=t(i);return t=>{const i=e(t);t.addEventListener("message",({data:e})=>{const{id:t}=e;if(null!==t&&i.has(t)){const{reject:n,resolve:r}=i.get(t);i.delete(t),void 0===e.error?r(e.result):n(new Error(e.error.message))}}),r(t)&&t.start();const o=(e,r=null,s=[])=>new Promise((o,a)=>{const c=n(i);i.set(c,{reject:a,resolve:o}),null===r?t.postMessage({id:c,method:e},s):t.postMessage({id:c,method:e,params:r},s)}),a=(e,n,r=[])=>{t.postMessage({id:null,method:e,params:n},r)};let c={};for(const[e,t]of Object.entries(s))c={...c,[e]:t({call:o,notify:a})};return{...c}}})((u=new WeakMap,e=>{if(u.has(e))return u.get(e);const t=new Map;return u.set(e,t),t}),(d=new WeakMap,e=>({...e,connect:({call:e})=>async()=>{const{port1:t,port2:n}=new MessageChannel,r=await e("connect",{port:t},[t]);return d.set(n,r),n},disconnect:({call:e})=>async t=>{const n=d.get(t);if(void 0===n)throw new Error("The given port is not connected.");await e("disconnect",{portId:n})},isSupported:({call:e})=>()=>e("isSupported")})),c,e=>"function"==typeof e.start));var d,u;const h=new Map([[0,null]]),p=new Map([[0,null]]),f=(e=>t=>n=>{"symbol"==typeof e.get(n)&&(e.set(n,null),t(n).then(()=>{e.delete(n)}))})(h),g=(e=>t=>n=>{"symbol"==typeof e.get(n)&&(e.set(n,null),t(n).then(()=>{e.delete(n)}))})(p),m=((e,t)=>n=>(r,i=0,...s)=>{const o=Symbol(),a=e(t);t.set(a,o);const c=()=>n(i,a).then(()=>{const e=t.get(a);if(void 0===e)throw new Error("The timer is in an undefined state.");e===o&&(r(...s),t.get(a)===o&&c())});return c(),a})(c,h),y=((e,t)=>n=>(r,i=0,...s)=>{const o=Symbol(),a=e(t);return t.set(a,o),n(i,a).then(()=>{const e=t.get(a);if(void 0===e)throw new Error("The timer is in an undefined state.");e===o&&(t.delete(a),r(...s))}),a})(c,p),b=l({clearInterval:({call:e})=>f(t=>e("clear",{timerId:t,timerType:"interval"})),clearTimeout:({call:e})=>g(t=>e("clear",{timerId:t,timerType:"timeout"})),setInterval:({call:e})=>m((t,n)=>e("set",{delay:t,now:performance.timeOrigin+performance.now(),timerId:n,timerType:"interval"})),setTimeout:({call:e})=>y((t,n)=>e("set",{delay:t,now:performance.timeOrigin+performance.now(),timerId:n,timerType:"timeout"}))}),v=((e,t)=>{let n=null;return()=>{if(null!==n)return n;const r=new Blob([t],{type:"application/javascript; charset=utf-8"}),i=URL.createObjectURL(r);return n=e(i),setTimeout(()=>URL.revokeObjectURL(i)),n}})(e=>{const t=new Worker(e);return b(t)},'(()=>{var e={455(e,t){!function(e){"use strict";var t=function(e){return function(t){var r=e(t);return t.add(r),r}},r=function(e){return function(t,r){return e.set(t,r),r}},n=void 0===Number.MAX_SAFE_INTEGER?9007199254740991:Number.MAX_SAFE_INTEGER,o=536870912,s=2*o,a=function(e,t){return function(r){var a=t.get(r),i=void 0===a?r.size:a<s?a+1:0;if(!r.has(i))return e(r,i);if(r.size<o){for(;r.has(i);)i=Math.floor(Math.random()*s);return e(r,i)}if(r.size>n)throw new Error("Congratulations, you created a collection of unique numbers which uses all available integers!");for(;r.has(i);)i=Math.floor(Math.random()*n);return e(r,i)}},i=new WeakMap,u=r(i),c=a(u,i),l=t(c);e.addUniqueNumber=l,e.generateUniqueNumber=c}(t)}},t={};function r(n){var o=t[n];if(void 0!==o)return o.exports;var s=t[n]={exports:{}};return e[n].call(s.exports,s,s.exports,r),s.exports}(()=>{"use strict";const e=-32603,t=-32602,n=-32601,o=(e,t)=>Object.assign(new Error(e),{status:t}),s=t=>o(\'The handler of the method called "\'.concat(t,\'" returned an unexpected result.\'),e),a=(t,r)=>async({data:{id:a,method:i,params:u}})=>{const c=r[i];try{if(void 0===c)throw(e=>o(\'The requested method called "\'.concat(e,\'" is not supported.\'),n))(i);const r=void 0===u?c():c(u);if(void 0===r)throw(t=>o(\'The handler of the method called "\'.concat(t,\'" returned no required result.\'),e))(i);const l=r instanceof Promise?await r:r;if(null===a){if(void 0!==l.result)throw s(i)}else{if(void 0===l.result)throw s(i);const{result:e,transferables:r=[]}=l;t.postMessage({id:a,result:e},r)}}catch(e){const{message:r,status:n=-32603}=e;t.postMessage({error:{code:n,message:r},id:a})}};var i=r(455);const u=new Map,c=(e,r,n)=>({...r,connect:({port:t})=>{t.start();const n=e(t,r),o=(0,i.generateUniqueNumber)(u);return u.set(o,()=>{n(),t.close(),u.delete(o)}),{result:o}},disconnect:({portId:e})=>{const r=u.get(e);if(void 0===r)throw(e=>o(\'The specified parameter called "portId" with the given value "\'.concat(e,\'" does not identify a port connected to this worker.\'),t))(e);return r(),{result:null}},isSupported:async()=>{if(await new Promise(e=>{const t=new ArrayBuffer(0),{port1:r,port2:n}=new MessageChannel;r.onmessage=({data:t})=>e(null!==t),n.postMessage(t,[t])})){const e=n();return{result:e instanceof Promise?await e:e}}return{result:!1}}}),l=(e,t,r=()=>!0)=>{const n=c(l,t,r),o=a(e,n);return e.addEventListener("message",o),()=>e.removeEventListener("message",o)},d=(e,t)=>r=>{const n=t.get(r);if(void 0===n)return Promise.resolve(!1);const[o,s]=n;return e(o),t.delete(r),s(!1),Promise.resolve(!0)},m=(e,t,r,n)=>(o,s,a)=>{const i=o+s-t.timeOrigin,u=i-t.now();return new Promise(t=>{e.set(a,[r(n,u,i,e,t,a),t])})},f=new Map,h=d(globalThis.clearTimeout,f),p=new Map,v=d(globalThis.clearTimeout,p),w=((e,t)=>{const r=(n,o,s,a)=>{const i=n-e.now();i>0?o.set(a,[t(r,i,n,o,s,a),s]):(o.delete(a),s(!0))};return r})(performance,globalThis.setTimeout),g=m(f,performance,globalThis.setTimeout,w),T=m(p,performance,globalThis.setTimeout,w);l(self,{clear:async({timerId:e,timerType:t})=>({result:await("interval"===t?h(e):v(e))}),set:async({delay:e,now:t,timerId:r,timerType:n})=>({result:await("interval"===n?g:T)(e,t,r)})})})()})();'),S=e=>v().clearInterval(e),_=e=>v().clearTimeout(e),w=(...e)=>v().setInterval(...e),k=(...e)=>v().setTimeout(...e)},8611(e){"use strict";e.exports=require("http")},8914(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.RE_URL_WITH_PORT=t.RE_URL=t.RE_ZONE_STRING=t.RE_SUBNET_STRING=t.RE_BAD_ADDRESS=t.RE_BAD_CHARACTERS=t.TYPES=t.SCOPES=t.GROUPS=t.BITS=void 0,t.BITS=128,t.GROUPS=8,t.SCOPES={0:"Reserved",1:"Interface local",2:"Link local",4:"Admin local",5:"Site local",8:"Organization local",14:"Global",15:"Reserved"},t.TYPES={"ff01::1/128":"Multicast (All nodes on this interface)","ff01::2/128":"Multicast (All routers on this interface)","ff02::1/128":"Multicast (All nodes on this link)","ff02::2/128":"Multicast (All routers on this link)","ff05::2/128":"Multicast (All routers in this site)","ff02::5/128":"Multicast (OSPFv3 AllSPF routers)","ff02::6/128":"Multicast (OSPFv3 AllDR routers)","ff02::9/128":"Multicast (RIP routers)","ff02::a/128":"Multicast (EIGRP routers)","ff02::d/128":"Multicast (PIM routers)","ff02::16/128":"Multicast (MLDv2 reports)","ff01::fb/128":"Multicast (mDNSv6)","ff02::fb/128":"Multicast (mDNSv6)","ff05::fb/128":"Multicast (mDNSv6)","ff02::1:2/128":"Multicast (All DHCP servers and relay agents on this link)","ff05::1:2/128":"Multicast (All DHCP servers and relay agents in this site)","ff02::1:3/128":"Multicast (All DHCP servers on this link)","ff05::1:3/128":"Multicast (All DHCP servers in this site)","::/128":"Unspecified","::1/128":"Loopback","ff00::/8":"Multicast","fe80::/10":"Link-local unicast"},t.RE_BAD_CHARACTERS=/([^0-9a-f:/%])/gi,t.RE_BAD_ADDRESS=/([0-9a-f]{5,}|:{3,}|[^:]:$|^:[^:]|\/$)/gi,t.RE_SUBNET_STRING=/\/\d{1,3}(?=%|$)/,t.RE_ZONE_STRING=/%.*$/,t.RE_URL=/^\[{0,1}([0-9a-f:]+)\]{0,1}/,t.RE_URL_WITH_PORT=/\[([0-9a-f:]+)\]:([0-9]{1,5})/},9023(e){"use strict";e.exports=require("util")},9231(e){"use strict";e.exports={format:(e,...t)=>e.replace(/%([sdifj])/g,function(...[e,n]){const r=t.shift();if("f"===n)return r.toFixed(6);if("j"===n)return JSON.stringify(r);if("s"===n&&"object"==typeof r){return`${r.constructor!==Object?r.constructor.name:""} {}`.trim()}return r.toString()}),inspect(e){switch(typeof e){case"string":if(e.includes("'")){if(!e.includes('"'))return`"${e}"`;if(!e.includes("`")&&!e.includes("${"))return`\`${e}\``}return`'${e}'`;case"number":return isNaN(e)?"NaN":Object.is(e,-0)?String(e):e;case"bigint":return`${String(e)}n`;case"boolean":case"undefined":return String(e);case"object":return"{}"}}}},9278(e){"use strict";e.exports=require("net")},9291(e,t,n){"use strict";const r=n(8194).CD,i=n(5753)("number-allocator:trace"),s=n(5753)("number-allocator:error");function o(e,t){this.low=e,this.high=t}function a(e,t){if(!(this instanceof a))return new a(e,t);this.min=e,this.max=t,this.ss=new r([],(e,t)=>e.compare(t)),i("Create"),this.clear()}o.prototype.equals=function(e){return this.low===e.low&&this.high===e.high},o.prototype.compare=function(e){return this.low<e.low&&this.high<e.low?-1:e.low<this.low&&e.high<this.low?1:0},a.prototype.firstVacant=function(){return 0===this.ss.size()?null:this.ss.front().low},a.prototype.alloc=function(){if(0===this.ss.size())return i("alloc():empty"),null;const e=this.ss.begin(),t=e.pointer.low,n=e.pointer.high,r=t;return r+1<=n?this.ss.updateKeyByIterator(e,new o(t+1,n)):this.ss.eraseElementByPos(0),i("alloc():"+r),r},a.prototype.use=function(e){const t=new o(e,e),n=this.ss.lowerBound(t);if(!n.equals(this.ss.end())){const r=n.pointer.low,s=n.pointer.high;return n.pointer.equals(t)?(this.ss.eraseElementByIterator(n),i("use():"+e),!0):!(r>e)&&(r===e?(this.ss.updateKeyByIterator(n,new o(r+1,s)),i("use():"+e),!0):s===e?(this.ss.updateKeyByIterator(n,new o(r,s-1)),i("use():"+e),!0):(this.ss.updateKeyByIterator(n,new o(e+1,s)),this.ss.insert(new o(r,e-1)),i("use():"+e),!0))}return i("use():failed"),!1},a.prototype.free=function(e){if(e<this.min||e>this.max)return void s("free():"+e+" is out of range");const t=new o(e,e),n=this.ss.upperBound(t);if(n.equals(this.ss.end())){if(n.equals(this.ss.begin()))return void this.ss.insert(t);n.pre();const r=n.pointer.high;n.pointer.high+1===e?this.ss.updateKeyByIterator(n,new o(r,e)):this.ss.insert(t)}else if(n.equals(this.ss.begin()))if(e+1===n.pointer.low){const t=n.pointer.high;this.ss.updateKeyByIterator(n,new o(e,t))}else this.ss.insert(t);else{const r=n.pointer.low,i=n.pointer.high;n.pre();const s=n.pointer.low;n.pointer.high+1===e?e+1===r?(this.ss.eraseElementByIterator(n),this.ss.updateKeyByIterator(n,new o(s,i))):this.ss.updateKeyByIterator(n,new o(s,e)):e+1===r?(this.ss.eraseElementByIterator(n.next()),this.ss.insert(new o(e,i))):this.ss.insert(t)}i("free():"+e)},a.prototype.clear=function(){i("clear()"),this.ss.clear(),this.ss.insert(new o(this.min,this.max))},a.prototype.intervalCount=function(){return this.ss.size()},a.prototype.dump=function(){console.log("length:"+this.ss.size());for(const e of this.ss)console.log(e)},e.exports=a},9372(e,t,n){"use strict";var r,i=this&&this.__createBinding||(Object.create?function(e,t,n,r){void 0===r&&(r=n);var i=Object.getOwnPropertyDescriptor(t,n);i&&!("get"in i?!t.__esModule:i.writable||i.configurable)||(i={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,r,i)}:function(e,t,n,r){void 0===r&&(r=n),e[r]=t[n]}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),o=this&&this.__importStar||(r=function(e){return r=Object.getOwnPropertyNames||function(e){var t=[];for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[t.length]=n);return t},r(e)},function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n=r(e),o=0;o<n.length;o++)"default"!==n[o]&&i(t,e,n[o]);return s(t,e),t}),a=this&&this.__exportStar||function(e,t){for(var n in e)"default"===n||Object.prototype.hasOwnProperty.call(t,n)||i(t,e,n)};Object.defineProperty(t,"__esModule",{value:!0});const c=o(n(1676));t.default=c,a(n(1676),t)},9424(e,t,n){"use strict";var r=this&&this.__createBinding||(Object.create?function(e,t,n,r){void 0===r&&(r=n);var i=Object.getOwnPropertyDescriptor(t,n);i&&!("get"in i?!t.__esModule:i.writable||i.configurable)||(i={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,r,i)}:function(e,t,n,r){void 0===r&&(r=n),e[r]=t[n]}),i=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),s=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&r(t,e,n);return i(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.v6=t.AddressError=t.Address6=t.Address4=void 0;var o=n(2839);Object.defineProperty(t,"Address4",{enumerable:!0,get:function(){return o.Address4}});var a=n(6329);Object.defineProperty(t,"Address6",{enumerable:!0,get:function(){return a.Address6}});var c=n(2437);Object.defineProperty(t,"AddressError",{enumerable:!0,get:function(){return c.AddressError}});const l=s(n(465));t.v6={helpers:l}},9576(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.RE_SUBNET_STRING=t.RE_ADDRESS=t.GROUPS=t.BITS=void 0,t.BITS=32,t.GROUPS=4,t.RE_ADDRESS=/^(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/g,t.RE_SUBNET_STRING=/\/\d{1,2}$/},9777(e,t,n){"use strict";var r,i=this&&this.__createBinding||(Object.create?function(e,t,n,r){void 0===r&&(r=n);var i=Object.getOwnPropertyDescriptor(t,n);i&&!("get"in i?!t.__esModule:i.writable||i.configurable)||(i={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,r,i)}:function(e,t,n,r){void 0===r&&(r=n),e[r]=t[n]}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),o=this&&this.__importStar||(r=function(e){return r=Object.getOwnPropertyNames||function(e){var t=[];for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[t.length]=n);return t},r(e)},function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n=r(e),o=0;o<n.length;o++)"default"!==n[o]&&i(t,e,n[o]);return s(t,e),t}),a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const c=a(n(1278)),l=n(4478),d=a(n(3885)),u=a(n(5753)),h=o(n(128)),p=a(n(7969)),f=a(n(6912)),g=a(n(579)),m=a(n(2639)),y=n(4723),b=n(4152),v=a(n(3175)),S=o(n(6887)),_=globalThis.setImmediate||((...e)=>{const t=e.shift();(0,y.nextTick)(()=>{t(...e)})}),w={keepalive:60,reschedulePings:!0,protocolId:"MQTT",protocolVersion:4,reconnectPeriod:1e3,connectTimeout:3e4,clean:!0,resubscribe:!0,subscribeBatchSize:null,writeCache:!0,timerVariant:"auto"};class k extends b.TypedEventEmitter{static VERSION=y.MQTTJS_VERSION;connected;disconnecting;disconnected;reconnecting;incomingStore;outgoingStore;options;queueQoSZero;_reconnectCount;log;messageIdProvider;outgoing;messageIdToTopic;noop;keepaliveManager;stream;queue;streamBuilder;_resubscribeTopics;connackTimer;reconnectTimer;_storeProcessing;_packetIdsDuringStoreProcessing;_storeProcessingQueue;_firstConnection;topicAliasRecv;topicAliasSend;_deferredReconnect;connackPacket;static defaultId(){return`mqttjs_${Math.random().toString(16).substr(2,8)}`}constructor(e,t){super(),this.options=t||{};for(const e in w)"undefined"==typeof this.options[e]?this.options[e]=w[e]:this.options[e]=t[e];this.log=this.options.log||(0,u.default)("mqttjs:client"),this.noop=this._noop.bind(this),this.log("MqttClient :: version:",k.VERSION),S.isWebWorker?this.log("MqttClient :: environment","webworker"):this.log("MqttClient :: environment",S.default?"browser":"node"),this.log("MqttClient :: options.protocol",t.protocol),this.log("MqttClient :: options.protocolVersion",t.protocolVersion),this.log("MqttClient :: options.username",t.username),this.log("MqttClient :: options.keepalive",t.keepalive),this.log("MqttClient :: options.reconnectPeriod",t.reconnectPeriod),this.log("MqttClient :: options.rejectUnauthorized",t.rejectUnauthorized),this.log("MqttClient :: options.properties.topicAliasMaximum",t.properties?t.properties.topicAliasMaximum:void 0),this.options.clientId="string"==typeof t.clientId?t.clientId:k.defaultId(),this.log("MqttClient :: clientId",this.options.clientId),this.options.customHandleAcks=5===t.protocolVersion&&t.customHandleAcks?t.customHandleAcks:(...e)=>{e[3](null,0)},this.options.writeCache||(c.default.writeToStream.cacheNumbers=!1),this.streamBuilder=e,this.messageIdProvider="undefined"==typeof this.options.messageIdProvider?new g.default:this.options.messageIdProvider,this.outgoingStore=t.outgoingStore||new p.default,this.incomingStore=t.incomingStore||new p.default,this.queueQoSZero=void 0===t.queueQoSZero||t.queueQoSZero,this._resubscribeTopics={},this.messageIdToTopic={},this.keepaliveManager=null,this.connected=!1,this.disconnecting=!1,this.reconnecting=!1,this.queue=[],this.connackTimer=null,this.reconnectTimer=null,this._storeProcessing=!1,this._packetIdsDuringStoreProcessing={},this._storeProcessingQueue=[],this.outgoing={},this._firstConnection=!0,t.properties&&t.properties.topicAliasMaximum>0&&(t.properties.topicAliasMaximum>65535?this.log("MqttClient :: options.properties.topicAliasMaximum is out of range"):this.topicAliasRecv=new m.default(t.properties.topicAliasMaximum)),this.on("connect",()=>{const{queue:e}=this,t=()=>{const n=e.shift();this.log("deliver :: entry %o",n);let r=null;if(!n)return void this._resubscribe();r=n.packet,this.log("deliver :: call _sendPacket for %o",r);let i=!0;r.messageId&&0!==r.messageId&&(this.messageIdProvider.register(r.messageId)||(i=!1)),i?this._sendPacket(r,e=>{n.cb&&n.cb(e),t()}):(this.log("messageId: %d has already used. The message is skipped and removed.",r.messageId),t())};this.log("connect :: sending queued packets"),t()}),this.on("close",()=>{this.log("close :: connected set to `false`"),this.connected=!1,this.log("close :: clearing connackTimer"),clearTimeout(this.connackTimer),this._destroyKeepaliveManager(),this.topicAliasRecv&&this.topicAliasRecv.clear(),this.log("close :: calling _setupReconnect"),this._setupReconnect()}),this.options.manualConnect||(this.log("MqttClient :: setting up stream"),this.connect())}handleAuth(e,t){t()}handleMessage(e,t){t()}_nextId(){return this.messageIdProvider.allocate()}getLastMessageId(){return this.messageIdProvider.getLastAllocated()}connect(){const e=new l.Writable,t=c.default.parser(this.options);let n=null;const r=[];this.log("connect :: calling method to clear reconnect"),this._clearReconnect(),this.disconnected&&!this.reconnecting&&(this.incomingStore=this.options.incomingStore||new p.default,this.outgoingStore=this.options.outgoingStore||new p.default,this.disconnecting=!1,this.disconnected=!1),this.log("connect :: using streamBuilder provided to client to create stream"),this.stream=this.streamBuilder(this),t.on("packet",e=>{this.log("parser :: on packet push to packets array."),r.push(e)});const i=()=>{this.log("work :: getting next packet in queue");const e=r.shift();if(e)this.log("work :: packet pulled from queue"),(0,f.default)(this,e,s);else{this.log("work :: no packets in queue");const e=n;n=null,this.log("work :: done flag is %s",!!e),e&&e()}},s=()=>{if(r.length)(0,y.nextTick)(i);else{const e=n;n=null,e()}};e._write=(e,r,s)=>{n=s,this.log("writable stream :: parsing buffer"),t.parse(e),i()};this.log("connect :: pipe stream to writable stream"),this.stream.pipe(e),this.stream.on("error",e=>{this.log("streamErrorHandler :: error",e.message),e.code?(this.log("streamErrorHandler :: emitting error"),this.emit("error",e)):this.noop(e)}),this.stream.on("close",()=>{this.log("(%s)stream :: on close",this.options.clientId),this._flushVolatile(),this.log("stream: emit close to MqttClient"),this.emit("close")}),this.log("connect: sending packet `connect`");const o={cmd:"connect",protocolId:this.options.protocolId,protocolVersion:this.options.protocolVersion,clean:this.options.clean,clientId:this.options.clientId,keepalive:this.options.keepalive,username:this.options.username,password:this.options.password,properties:this.options.properties};if(this.options.will&&(o.will={...this.options.will,payload:this.options.will?.payload}),this.topicAliasRecv&&(o.properties||(o.properties={}),this.topicAliasRecv&&(o.properties.topicAliasMaximum=this.topicAliasRecv.max)),this._writePacket(o),t.on("error",this.emit.bind(this,"error")),this.options.properties){if(!this.options.properties.authenticationMethod&&this.options.properties.authenticationData)return this.end(()=>this.emit("error",new Error("Packet has no Authentication Method"))),this;if(this.options.properties.authenticationMethod&&this.options.authPacket&&"object"==typeof this.options.authPacket){const e={cmd:"auth",reasonCode:0,...this.options.authPacket};this._writePacket(e)}}return this.stream.setMaxListeners(1e3),clearTimeout(this.connackTimer),this.connackTimer=setTimeout(()=>{this.log("!!connectTimeout hit!! Calling _cleanUp with force `true`"),this.emit("error",new Error("connack timeout")),this._cleanUp(!0)},this.options.connectTimeout),this}publish(e,t,n,r){this.log("publish :: message `%s` to topic `%s`",t,e);const{options:i}=this;"function"==typeof n&&(r=n,n=null),n=n||{};n={qos:0,retain:!1,dup:!1,...n};const{qos:s,retain:o,dup:a,properties:c,cbStorePut:l}=n;if(this._checkDisconnecting(r))return this;const d=()=>{let n=0;if((1===s||2===s)&&(n=this._nextId(),null===n))return this.log("No messageId left"),!1;const d={cmd:"publish",topic:e,payload:t,qos:s,retain:o,messageId:n,dup:a};switch(5===i.protocolVersion&&(d.properties=c),this.log("publish :: qos",s),s){case 1:case 2:this.outgoing[d.messageId]={volatile:!1,cb:r||this.noop},this.log("MqttClient:publish: packet cmd: %s",d.cmd),this._sendPacket(d,void 0,l);break;default:this.log("MqttClient:publish: packet cmd: %s",d.cmd),this._sendPacket(d,r,l)}return!0};return(this._storeProcessing||this._storeProcessingQueue.length>0||!d())&&this._storeProcessingQueue.push({invoke:d,cbStorePut:n.cbStorePut,callback:r}),this}publishAsync(e,t,n){return new Promise((r,i)=>{this.publish(e,t,n,(e,t)=>{e?i(e):r(t)})})}subscribe(e,t,n){const r=this.options.protocolVersion;"function"==typeof t&&(n=t),n=n||this.noop;let i=!1,s=[];"string"==typeof e?s=e=[e]:Array.isArray(e)?s=e:"object"==typeof e&&(i=e.resubscribe,delete e.resubscribe,s=Object.keys(e));const o=h.validateTopics(s);if(null!==o)return _(n,new Error(`Invalid topic ${o}`)),this;if(this._checkDisconnecting(n))return this.log("subscribe: discconecting true"),this;const a={qos:0};5===r&&(a.nl=!1,a.rap=!1,a.rh=0),t={...a,...t};const{properties:c}=t,l=[],d=(e,n)=>{if(n=n||t,!Object.prototype.hasOwnProperty.call(this._resubscribeTopics,e)||this._resubscribeTopics[e].qos<n.qos||i){const t={topic:e,qos:n.qos};5===r&&(t.nl=n.nl,t.rap=n.rap,t.rh=n.rh,t.properties=c),this.log("subscribe: pushing topic `%s` and qos `%s` to subs list",t.topic,t.qos),l.push(t)}};if(Array.isArray(e)?e.forEach(e=>{this.log("subscribe: array topic %s",e),d(e)}):Object.keys(e).forEach(t=>{this.log("subscribe: object topic %s, %o",t,e[t]),d(t,e[t])}),!l.length)return n(null,[]),this;const u=(e,t)=>{const n={cmd:"subscribe",subscriptions:e,messageId:t};if(c&&(n.properties=c),this.options.resubscribe){this.log("subscribe :: resubscribe true");const t=[];e.forEach(e=>{if(this.options.reconnectPeriod>0){const n={qos:e.qos};5===r&&(n.nl=e.nl||!1,n.rap=e.rap||!1,n.rh=e.rh||0,n.properties=e.properties),this._resubscribeTopics[e.topic]=n,t.push(e.topic)}}),this.messageIdToTopic[n.messageId]=t}const i=new Promise((t,r)=>{this.outgoing[n.messageId]={volatile:!0,cb(n,i){if(!n){const{granted:t}=i;for(let n=0;n<t.length;n+=1)e[n].qos=t[n]}n?r(new y.ErrorWithSubackPacket(n.message,i)):t(i)}}});return this.log("subscribe :: call _sendPacket"),this._sendPacket(n),i},p=()=>{const e=this.options.subscribeBatchSize??l.length,t=[];for(let n=0;n<l.length;n+=e){const r=l.slice(n,n+e),i=this._nextId();if(null===i)return this.log("No messageId left"),!1;t.push(u(r,i))}return Promise.all(t).then(e=>{n(null,l,e.at(-1))}).catch(e=>{n(e,l,e.packet)}),!0};return(this._storeProcessing||this._storeProcessingQueue.length>0||!p())&&this._storeProcessingQueue.push({invoke:p,callback:n}),this}subscribeAsync(e,t){return new Promise((n,r)=>{this.subscribe(e,t,(e,t)=>{e?r(e):n(t)})})}unsubscribe(e,t,n){"string"==typeof e&&(e=[e]),"function"==typeof t&&(n=t),n=n||this.noop;const r=h.validateTopics(e);if(null!==r)return _(n,new Error(`Invalid topic ${r}`)),this;if(this._checkDisconnecting(n))return this;const i=()=>{const r=this._nextId();if(null===r)return this.log("No messageId left"),!1;const i={cmd:"unsubscribe",messageId:r,unsubscriptions:[]};return"string"==typeof e?i.unsubscriptions=[e]:Array.isArray(e)&&(i.unsubscriptions=e),this.options.resubscribe&&i.unsubscriptions.forEach(e=>{delete this._resubscribeTopics[e]}),"object"==typeof t&&t.properties&&(i.properties=t.properties),this.outgoing[i.messageId]={volatile:!0,cb:n},this.log("unsubscribe: call _sendPacket"),this._sendPacket(i),!0};return(this._storeProcessing||this._storeProcessingQueue.length>0||!i())&&this._storeProcessingQueue.push({invoke:i,callback:n}),this}unsubscribeAsync(e,t){return new Promise((n,r)=>{this.unsubscribe(e,t,(e,t)=>{e?r(e):n(t)})})}end(e,t,n){this.log("end :: (%s)",this.options.clientId),null!=e&&"boolean"==typeof e||(n=n||t,t=e,e=!1),"object"!=typeof t&&(n=n||t,t=null),this.log("end :: cb? %s",!!n),n&&"function"==typeof n||(n=this.noop);const r=()=>{this.log("end :: closeStores: closing incoming and outgoing stores"),this.disconnected=!0,this.incomingStore.close(e=>{this.outgoingStore.close(t=>{if(this.log("end :: closeStores: emitting end"),this.emit("end"),n){const r=e||t;this.log("end :: closeStores: invoking callback with args"),n(r)}})}),this._deferredReconnect?this._deferredReconnect():(0===this.options.reconnectPeriod||this.options.manualConnect)&&(this.disconnecting=!1)},i=()=>{this.log("end :: (%s) :: finish :: calling _cleanUp with force %s",this.options.clientId,e),this._cleanUp(e,()=>{this.log("end :: finish :: calling process.nextTick on closeStores"),(0,y.nextTick)(r)},t)};return this.disconnecting?(n(),this):(this._clearReconnect(),this.disconnecting=!0,!e&&Object.keys(this.outgoing).length>0?(this.log("end :: (%s) :: calling finish in 10ms once outgoing is empty",this.options.clientId),this.once("outgoingEmpty",setTimeout.bind(null,i,10))):(this.log("end :: (%s) :: immediately calling finish",this.options.clientId),i()),this)}endAsync(e,t){return new Promise((n,r)=>{this.end(e,t,e=>{e?r(e):n()})})}removeOutgoingMessage(e){if(this.outgoing[e]){const{cb:t}=this.outgoing[e];this._removeOutgoingAndStoreMessage(e,()=>{t(new Error("Message removed"))})}return this}reconnect(e){this.log("client reconnect");const t=()=>{e?(this.options.incomingStore=e.incomingStore,this.options.outgoingStore=e.outgoingStore):(this.options.incomingStore=null,this.options.outgoingStore=null),this.incomingStore=this.options.incomingStore||new p.default,this.outgoingStore=this.options.outgoingStore||new p.default,this.disconnecting=!1,this.disconnected=!1,this._deferredReconnect=null,this._reconnect()};return this.disconnecting&&!this.disconnected?this._deferredReconnect=t:t(),this}_flushVolatile(){this.outgoing&&(this.log("_flushVolatile :: deleting volatile messages from the queue and setting their callbacks as error function"),Object.keys(this.outgoing).forEach(e=>{this.outgoing[e].volatile&&"function"==typeof this.outgoing[e].cb&&(this.outgoing[e].cb(new Error("Connection closed")),delete this.outgoing[e])}))}_flush(){this.outgoing&&(this.log("_flush: queue exists? %b",!!this.outgoing),Object.keys(this.outgoing).forEach(e=>{"function"==typeof this.outgoing[e].cb&&(this.outgoing[e].cb(new Error("Connection closed")),delete this.outgoing[e])}))}_removeTopicAliasAndRecoverTopicName(e){let t;e.properties&&(t=e.properties.topicAlias);let n=e.topic.toString();if(this.log("_removeTopicAliasAndRecoverTopicName :: alias %d, topic %o",t,n),0===n.length){if("undefined"==typeof t)return new Error("Unregistered Topic Alias");if(n=this.topicAliasSend.getTopicByAlias(t),"undefined"==typeof n)return new Error("Unregistered Topic Alias");e.topic=n}t&&delete e.properties.topicAlias}_checkDisconnecting(e){return this.disconnecting&&(e&&e!==this.noop?e(new Error("client disconnecting")):this.emit("error",new Error("client disconnecting"))),this.disconnecting}_reconnect(){this.log("_reconnect: emitting reconnect to client"),this.emit("reconnect"),this.connected?(this.end(()=>{this.connect()}),this.log("client already connected. disconnecting first.")):(this.log("_reconnect: calling connect"),this.connect())}_setupReconnect(){!this.disconnecting&&!this.reconnectTimer&&this.options.reconnectPeriod>0?(this.reconnecting||(this.log("_setupReconnect :: emit `offline` state"),this.emit("offline"),this.log("_setupReconnect :: set `reconnecting` to `true`"),this.reconnecting=!0),this.log("_setupReconnect :: setting reconnectTimer for %d ms",this.options.reconnectPeriod),this.reconnectTimer=setInterval(()=>{this.log("reconnectTimer :: reconnect triggered!"),this._reconnect()},this.options.reconnectPeriod)):this.log("_setupReconnect :: doing nothing...")}_clearReconnect(){this.log("_clearReconnect : clearing reconnect timer"),this.reconnectTimer&&(clearInterval(this.reconnectTimer),this.reconnectTimer=null)}_cleanUp(e,t,n={}){if(t&&(this.log("_cleanUp :: done callback provided for on stream close"),this.stream.on("close",t)),this.log("_cleanUp :: forced? %s",e),e)0===this.options.reconnectPeriod&&this.options.clean&&this._flush(),this.log("_cleanUp :: (%s) :: destroying stream",this.options.clientId),this.stream.destroy();else{const e={cmd:"disconnect",...n};this.log("_cleanUp :: (%s) :: call _sendPacket with disconnect packet",this.options.clientId),this._sendPacket(e,()=>{this.log("_cleanUp :: (%s) :: destroying stream",this.options.clientId),_(()=>{this.stream.end(()=>{this.log("_cleanUp :: (%s) :: stream destroyed",this.options.clientId)})})})}this.disconnecting||this.reconnecting||(this.log("_cleanUp :: client not disconnecting/reconnecting. Clearing and resetting reconnect."),this._clearReconnect(),this._setupReconnect()),this._destroyKeepaliveManager(),t&&!this.connected&&(this.log("_cleanUp :: (%s) :: removing stream `done` callback `close` listener",this.options.clientId),this.stream.removeListener("close",t),t())}_storeAndSend(e,t,n){this.log("storeAndSend :: store packet with cmd %s to outgoingStore",e.cmd);let r,i=e;if("publish"===i.cmd&&(i=(0,d.default)(e),r=this._removeTopicAliasAndRecoverTopicName(i),r))return t&&t(r);this.outgoingStore.put(i,r=>{if(r)return t&&t(r);n(),this._writePacket(e,t)})}_applyTopicAlias(e){if(5===this.options.protocolVersion&&"publish"===e.cmd){let t;e.properties&&(t=e.properties.topicAlias);const n=e.topic.toString();if(this.topicAliasSend)if(t){if(0!==n.length&&(this.log("applyTopicAlias :: register topic: %s - alias: %d",n,t),!this.topicAliasSend.put(n,t)))return this.log("applyTopicAlias :: error out of range. topic: %s - alias: %d",n,t),new Error("Sending Topic Alias out of range")}else 0!==n.length&&(this.options.autoAssignTopicAlias?(t=this.topicAliasSend.getAliasByTopic(n),t?(e.topic="",e.properties={...e.properties,topicAlias:t},this.log("applyTopicAlias :: auto assign(use) topic: %s - alias: %d",n,t)):(t=this.topicAliasSend.getLruAlias(),this.topicAliasSend.put(n,t),e.properties={...e.properties,topicAlias:t},this.log("applyTopicAlias :: auto assign topic: %s - alias: %d",n,t))):this.options.autoUseTopicAlias&&(t=this.topicAliasSend.getAliasByTopic(n),t&&(e.topic="",e.properties={...e.properties,topicAlias:t},this.log("applyTopicAlias :: auto use topic: %s - alias: %d",n,t))));else if(t)return this.log("applyTopicAlias :: error out of range. topic: %s - alias: %d",n,t),new Error("Sending Topic Alias out of range")}}_noop(e){this.log("noop ::",e)}_writePacket(e,t){this.log("_writePacket :: packet: %O",e),this.log("_writePacket :: emitting `packetsend`"),this.emit("packetsend",e),this.log("_writePacket :: writing to stream");const n=c.default.writeToStream(e,this.stream,this.options);this.log("_writePacket :: writeToStream result %s",n),!n&&t&&t!==this.noop?(this.log("_writePacket :: handle events on `drain` once through callback."),this.stream.once("drain",t)):t&&(this.log("_writePacket :: invoking cb"),t())}_sendPacket(e,t,n,r){this.log("_sendPacket :: (%s) ::  start",this.options.clientId),n=n||this.noop,t=t||this.noop;const i=this._applyTopicAlias(e);if(i)t(i);else{if(!this.connected)return"auth"===e.cmd?void this._writePacket(e,t):(this.log("_sendPacket :: client not connected. Storing packet offline."),void this._storePacket(e,t,n));if(r)this._writePacket(e,t);else{switch(e.cmd){case"publish":break;case"pubrel":return void this._storeAndSend(e,t,n);default:return void this._writePacket(e,t)}switch(e.qos){case 2:case 1:this._storeAndSend(e,t,n);break;default:this._writePacket(e,t)}this.log("_sendPacket :: (%s) ::  end",this.options.clientId)}}}_storePacket(e,t,n){this.log("_storePacket :: packet: %o",e),this.log("_storePacket :: cb? %s",!!t),n=n||this.noop;let r=e;if("publish"===r.cmd){r=(0,d.default)(e);const n=this._removeTopicAliasAndRecoverTopicName(r);if(n)return t&&t(n)}const i=r.qos||0;0===i&&this.queueQoSZero||"publish"!==r.cmd?this.queue.push({packet:r,cb:t}):i>0?(t=this.outgoing[r.messageId]?this.outgoing[r.messageId].cb:null,this.outgoingStore.put(r,e=>{if(e)return t&&t(e);n()})):t&&t(new Error("No connection to broker"))}_setupKeepaliveManager(){this.log("_setupKeepaliveManager :: keepalive %d (seconds)",this.options.keepalive),!this.keepaliveManager&&this.options.keepalive&&(this.keepaliveManager=new v.default(this,this.options.timerVariant))}_destroyKeepaliveManager(){this.keepaliveManager&&(this.log("_destroyKeepaliveManager :: destroying keepalive manager"),this.keepaliveManager.destroy(),this.keepaliveManager=null)}reschedulePing(e=!1){this.keepaliveManager&&this.options.keepalive&&(e||this.options.reschedulePings)&&this._reschedulePing()}_reschedulePing(){this.log("_reschedulePing :: rescheduling ping"),this.keepaliveManager.reschedule()}sendPing(){this.log("_sendPing :: sending pingreq"),this._sendPacket({cmd:"pingreq"})}onKeepaliveTimeout(){this.emit("error",new Error("Keepalive timeout")),this.log("onKeepaliveTimeout :: calling _cleanUp with force true"),this._cleanUp(!0)}_resubscribe(){this.log("_resubscribe");const e=Object.keys(this._resubscribeTopics);if(!this._firstConnection&&(this.options.clean||this.options.protocolVersion>=4&&!this.connackPacket.sessionPresent)&&e.length>0)if(this.options.resubscribe)if(5===this.options.protocolVersion){this.log("_resubscribe: protocolVersion 5");for(let t=0;t<e.length;t++){const n={};n[e[t]]=this._resubscribeTopics[e[t]],n.resubscribe=!0,this.subscribe(n,{properties:n[e[t]].properties})}}else this._resubscribeTopics.resubscribe=!0,this.subscribe(this._resubscribeTopics);else this._resubscribeTopics={};this._firstConnection=!1}_onConnect(e){if(this.disconnected)return void this.emit("connect",e);this.connackPacket=e,this.messageIdProvider.clear(),this._setupKeepaliveManager(),this.connected=!0;const t=()=>{let n=this.outgoingStore.createStream();const r=()=>{n.destroy(),n=null,this._flushStoreProcessingQueue(),i()},i=()=>{this._storeProcessing=!1,this._packetIdsDuringStoreProcessing={}};this.once("close",r),n.on("error",e=>{i(),this._flushStoreProcessingQueue(),this.removeListener("close",r),this.emit("error",e)});const s=()=>{if(!n)return;const e=n.read(1);let t;e?(this._storeProcessing=!0,this._packetIdsDuringStoreProcessing[e.messageId]?s():this.disconnecting||this.reconnectTimer?n.destroy&&n.destroy():(t=this.outgoing[e.messageId]?this.outgoing[e.messageId].cb:null,this.outgoing[e.messageId]={volatile:!1,cb(e,n){t&&t(e,n),s()}},this._packetIdsDuringStoreProcessing[e.messageId]=!0,this.messageIdProvider.register(e.messageId)?this._sendPacket(e,void 0,void 0,!0):this.log("messageId: %d has already used.",e.messageId))):n.once("readable",s)};n.on("end",()=>{let n=!0;for(const e in this._packetIdsDuringStoreProcessing)if(!this._packetIdsDuringStoreProcessing[e]){n=!1;break}this.removeListener("close",r),n?(i(),this._invokeAllStoreProcessingQueue(),this.emit("connect",e)):t()}),s()};t()}_invokeStoreProcessingQueue(){if(!this._storeProcessing&&this._storeProcessingQueue.length>0){const e=this._storeProcessingQueue[0];if(e&&e.invoke())return this._storeProcessingQueue.shift(),!0}return!1}_invokeAllStoreProcessingQueue(){for(;this._invokeStoreProcessingQueue(););}_flushStoreProcessingQueue(){for(const e of this._storeProcessingQueue)e.cbStorePut&&e.cbStorePut(new Error("Connection closed")),e.callback&&e.callback(new Error("Connection closed"));this._storeProcessingQueue.splice(0)}_removeOutgoingAndStoreMessage(e,t){delete this.outgoing[e],this.outgoingStore.del({messageId:e},(n,r)=>{t(n,r),this.messageIdProvider.deallocate(e),this._invokeStoreProcessingQueue()})}}t.default=k},9844(e){"use strict";function t(e){return e instanceof Buffer?Buffer.from(e):new e.constructor(e.buffer.slice(),e.byteOffset,e.length)}e.exports=function(e){if((e=e||{}).circles)return function(e){const n=[],r=[],i=new Map;if(i.set(Date,e=>new Date(e)),i.set(Map,(e,t)=>new Map(o(Array.from(e),t))),i.set(Set,(e,t)=>new Set(o(Array.from(e),t))),e.constructorHandlers)for(const t of e.constructorHandlers)i.set(t[0],t[1]);let s=null;return e.proto?c:a;function o(e,o){const a=Object.keys(e),c=new Array(a.length);for(let l=0;l<a.length;l++){const d=a[l],u=e[d];if("object"!=typeof u||null===u)c[d]=u;else if(u.constructor!==Object&&(s=i.get(u.constructor)))c[d]=s(u,o);else if(ArrayBuffer.isView(u))c[d]=t(u);else{const e=n.indexOf(u);c[d]=-1!==e?r[e]:o(u)}}return c}function a(e){if("object"!=typeof e||null===e)return e;if(Array.isArray(e))return o(e,a);if(e.constructor!==Object&&(s=i.get(e.constructor)))return s(e,a);const c={};n.push(e),r.push(c);for(const o in e){if(!1===Object.hasOwnProperty.call(e,o))continue;const l=e[o];if("object"!=typeof l||null===l)c[o]=l;else if(l.constructor!==Object&&(s=i.get(l.constructor)))c[o]=s(l,a);else if(ArrayBuffer.isView(l))c[o]=t(l);else{const e=n.indexOf(l);c[o]=-1!==e?r[e]:a(l)}}return n.pop(),r.pop(),c}function c(e){if("object"!=typeof e||null===e)return e;if(Array.isArray(e))return o(e,c);if(e.constructor!==Object&&(s=i.get(e.constructor)))return s(e,c);const a={};n.push(e),r.push(a);for(const o in e){const l=e[o];if("object"!=typeof l||null===l)a[o]=l;else if(l.constructor!==Object&&(s=i.get(l.constructor)))a[o]=s(l,c);else if(ArrayBuffer.isView(l))a[o]=t(l);else{const e=n.indexOf(l);a[o]=-1!==e?r[e]:c(l)}}return n.pop(),r.pop(),a}}(e);const n=new Map;if(n.set(Date,e=>new Date(e)),n.set(Map,(e,t)=>new Map(i(Array.from(e),t))),n.set(Set,(e,t)=>new Set(i(Array.from(e),t))),e.constructorHandlers)for(const t of e.constructorHandlers)n.set(t[0],t[1]);let r=null;return e.proto?function e(s){if("object"!=typeof s||null===s)return s;if(Array.isArray(s))return i(s,e);if(s.constructor!==Object&&(r=n.get(s.constructor)))return r(s,e);const o={};for(const i in s){const a=s[i];"object"!=typeof a||null===a?o[i]=a:a.constructor!==Object&&(r=n.get(a.constructor))?o[i]=r(a,e):ArrayBuffer.isView(a)?o[i]=t(a):o[i]=e(a)}return o}:function e(s){if("object"!=typeof s||null===s)return s;if(Array.isArray(s))return i(s,e);if(s.constructor!==Object&&(r=n.get(s.constructor)))return r(s,e);const o={};for(const i in s){if(!1===Object.hasOwnProperty.call(s,i))continue;const a=s[i];"object"!=typeof a||null===a?o[i]=a:a.constructor!==Object&&(r=n.get(a.constructor))?o[i]=r(a,e):ArrayBuffer.isView(a)?o[i]=t(a):o[i]=e(a)}return o};function i(e,i){const s=Object.keys(e),o=new Array(s.length);for(let a=0;a<s.length;a++){const c=s[a],l=e[c];"object"!=typeof l||null===l?o[c]=l:l.constructor!==Object&&(r=n.get(l.constructor))?o[c]=r(l,i):ArrayBuffer.isView(l)?o[c]=t(l):o[c]=i(l)}return o}}},9896(e){"use strict";e.exports=require("fs")}},t={};function n(r){var i=t[r];if(void 0!==i)return i.exports;var s=t[r]={exports:{}};return e[r].call(s.exports,s,s.exports,n),s.exports}n.d=(e,t)=>{for(var r in t)n.o(t,r)&&!n.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:t[r]})},n.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),n.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var r=n(7927),i=exports="undefined"==typeof exports?{}:exports;for(var s in r)i[s]=r[s];r.__esModule&&Object.defineProperty(i,"__esModule",{value:!0})})();
//# sourceMappingURL=main.nodejs.js.map